<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#00d4aa">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="WalkStory">
  <title>WalkStory ¬∑ Í±∏ÏùåÏúºÎ°ú ÌÇ§Ïö∞Îäî ÎÇòÎßåÏùò ÎèôÎ¨º ÏπúÍµ¨</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="./walkstory-logo.png">
  <link rel="apple-touch-icon" href="./walkstory-logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;600;700&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
  <script>
    // Ïπ¥Ïπ¥Ïò§ SDK Ï¥àÍ∏∞Ìôî
    if (typeof window !== 'undefined' && window.APP_CONFIG && window.APP_CONFIG.kakao) {
      Kakao.init(window.APP_CONFIG.kakao.javascriptKey);
    }
  </script>
  <style>
    /* ÎÇòÏù¥Ìä∏ (Í∏∞Î≥∏) - Î∂ÄÎìúÎü¨Ïö¥ Îã§ÌÅ¨ Í∑∏Î¶∞ ÌÜ§ */
    :root, [data-theme="night"] {
      --bg: #0f1419;
      --bg-soft: #151c23;
      --card: #1a222c;
      --card-hover: #1f2935;
      --accent: #4ade80;
      --accent-dim: rgba(74, 222, 128, 0.16);
      --accent-glow: rgba(74, 222, 128, 0.28);
      --gold: #fcd34d;
      --gold-dim: rgba(252, 211, 77, 0.18);
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --goal: 10000;
      --radius: 1rem;
      --radius-lg: 1.25rem;
      --shadow: 0 4px 20px rgba(0,0,0,0.3);
      --shadow-glow: 0 0 28px var(--accent-glow);
      --rarity-common: #94a3b8;
      --rarity-rare: #60a5fa;
      --rarity-epic: #a78bfa;
      --rarity-legend: #fcd34d;
    }
    /* Î™®Îãù - Îî∞ÎúªÌïú ÏïÑÏπ® ÌÜ§ */
    [data-theme="morning"] {
      --bg: #f0f7f0;
      --bg-soft: #f7fbf7;
      --card: #ffffff;
      --card-hover: #ecf5ec;
      --accent: #16a34a;
      --accent-dim: rgba(22, 163, 74, 0.12);
      --accent-glow: rgba(22, 163, 74, 0.22);
      --gold: #ca8a04;
      --gold-dim: rgba(202, 138, 4, 0.15);
      --text: #14532d;
      --text-muted: #4d7c5c;
      --shadow: 0 2px 16px rgba(0,0,0,0.06);
      --shadow-glow: 0 0 20px var(--accent-glow);
      --rarity-common: #64748b;
      --rarity-rare: #2563eb;
      --rarity-epic: #7c3aed;
      --rarity-legend: #ca8a04;
    }
    [data-theme="morning"] body::before {
      background: radial-gradient(ellipse 85% 60% at 50% -10%, rgba(22,163,74,0.1), transparent 50%);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Outfit', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 0 5.5rem;
      padding-right: max(0, env(safe-area-inset-right, 0));
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 55vh;
      background: radial-gradient(ellipse 90% 70% at 50% -15%, var(--accent-dim), transparent 55%);
      pointer-events: none;
      z-index: 0;
    }

    .container { width: 100%; max-width: 420px; position: relative; z-index: 1; padding-left: 1rem; padding-right: max(1rem, env(safe-area-inset-right, 0)); box-sizing: border-box; }

    header { text-align: center; margin-bottom: 1rem; padding-top: 0.75rem; position: relative; }
    h1 { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.03em; color: var(--text); }
    .subtitle { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.35rem; font-weight: 400; }
    .header-level { display: inline-flex; align-items: center; gap: 0.35rem; margin-top: 0.5rem; padding: 0.35rem 0.75rem; background: var(--card); border-radius: 999px; border: 1px solid rgba(255,255,255,0.08); font-size: 0.8rem; font-weight: 600; color: var(--accent); }
    .header-level .lv-num { font-size: 1rem; }
    .level-bar-wrap { width: 120px; height: 6px; background: var(--bg-soft); border-radius: 999px; overflow: hidden; margin-left: 0.25rem; }
    .level-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #10b981); border-radius: 999px; transition: width 0.3s ease; }
    .header-right { position: absolute; top: 0.75rem; right: 0; display: flex; align-items: center; gap: 0.5rem; }
    .theme-toggle { width: 36px; height: 36px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); background: var(--card); color: var(--text-muted); font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    [data-theme="morning"] .theme-toggle { border-color: rgba(0,0,0,0.1); }
    .gold-display { font-size: 0.85rem; font-weight: 700; color: var(--gold); display: flex; align-items: center; gap: 0.25rem; }
    .header-auth-btn { font-size: 0.7rem; padding: 0.3rem 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: var(--card); color: var(--text-muted); cursor: pointer; font-family: inherit; font-weight: 500; }
    .header-auth-btn:hover { color: var(--accent); border-color: var(--accent); }
    .header-auth-btn.logged-in { border-color: var(--accent); color: var(--accent); }
    .header-logout-btn { font-size: 0.7rem; padding: 0.3rem 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: var(--card); color: var(--text-muted); cursor: pointer; font-family: inherit; font-weight: 500; }
    .header-logout-btn:hover { color: #ef4444; border-color: #ef4444; }
    .auth-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 1rem; transition: opacity 0.3s ease, visibility 0.3s ease; }
    .auth-overlay.fade-out { opacity: 0; visibility: hidden; }
    .auth-modal { background: var(--card); border-radius: var(--radius-lg); padding: 1.5rem; max-width: 320px; width: 100%; border: 1px solid rgba(255,255,255,0.08); box-shadow: var(--shadow); position: relative; transition: transform 0.3s ease, opacity 0.3s ease; }
    .auth-overlay.fade-out .auth-modal { transform: scale(0.95); opacity: 0; }
    .auth-loading { display: none; text-align: center; padding: 2rem; }
    .auth-loading.active { display: block; }
    .auth-loading-spinner { width: 40px; height: 40px; border: 3px solid var(--accent-dim); border-top-color: var(--accent); border-radius: 50%; margin: 0 auto 1rem; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .welcome-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 300; align-items: center; justify-content: center; padding: 1rem; animation: fadeIn 0.3s ease; }
    .welcome-modal.show { display: flex; }
    .welcome-content { background: var(--card); border-radius: var(--radius-lg); padding: 2rem; max-width: 320px; width: 100%; text-align: center; border: 1px solid rgba(255,255,255,0.08); box-shadow: var(--shadow); animation: slideUp 0.4s ease; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .welcome-icon { font-size: 4rem; margin-bottom: 1rem; animation: bounce 0.6s ease; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    .welcome-title { font-size: 1.25rem; font-weight: 600; color: var(--accent); margin-bottom: 0.5rem; }
    .welcome-message { color: var(--text-muted); margin-bottom: 1.5rem; }
    .btn-welcome-close { background: var(--accent); color: var(--bg); border: none; border-radius: var(--radius); padding: 0.75rem 2rem; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .btn-welcome-close:active { transform: scale(0.95); }
    .auth-tabs { display: flex; gap: 0.25rem; margin-bottom: 1rem; }
    .auth-tab { flex: 1; padding: 0.5rem; border: none; border-radius: var(--radius); background: var(--bg-soft); color: var(--text-muted); font-size: 0.85rem; font-family: inherit; cursor: pointer; }
    .auth-tab.active { background: var(--accent-dim); color: var(--accent); font-weight: 600; }
    .auth-title { font-size: 1rem; margin-bottom: 1rem; color: var(--text); }
    .auth-panel label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-top: 0.75rem; margin-bottom: 0.25rem; }
    .auth-panel input { width: 100%; padding: 0.6rem; border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.15); background: var(--bg-soft); color: var(--text); font-size: 0.9rem; box-sizing: border-box; }
    .btn-auth-submit { width: 100%; margin-top: 1rem; padding: 0.65rem; border: none; border-radius: var(--radius); background: linear-gradient(145deg, var(--accent), #10b981); color: var(--bg); font-weight: 600; font-family: inherit; cursor: pointer; font-size: 0.9rem; }
    .auth-hint { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.75rem; }
    .auth-link-btn { font-size: 0.8rem; }
    .auth-divider { display: flex; align-items: center; margin: 1rem 0; text-align: center; }
    .auth-divider::before, .auth-divider::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.1); }
    .auth-divider span { padding: 0 0.75rem; color: var(--text-muted); font-size: 0.75rem; }
    .btn-social { width: 100%; padding: 0.65rem; border: none; border-radius: var(--radius); font-weight: 600; font-family: inherit; cursor: pointer; font-size: 0.9rem; margin-top: 0.5rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
    .btn-kakao { background: #FEE500; color: #000; }
    .btn-kakao:hover { background: #FDD835; }
    .btn-google { background: #fff; color: #000; border: 1px solid rgba(255,255,255,0.2); }
    .btn-google:hover { background: #f5f5f5; }
    .auth-close { position: absolute; top: 0.75rem; right: 0.75rem; width: 28px; height: 28px; border: none; border-radius: 50%; background: var(--bg-soft); color: var(--text-muted); cursor: pointer; font-size: 1rem; line-height: 1; }
    .auth-overlay.auth-gate { align-items: center; justify-content: center; }
    .auth-overlay.auth-gate .auth-close { display: none; }
    .pet-section { background: var(--card); border-radius: var(--radius-lg); padding: 1rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.08); }
    .pet-display { text-align: center; }
    .pet-preview { display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-bottom: 1rem; }
    .pet-emoji { font-size: 4rem; line-height: 1; }
    .pet-info { width: 100%; }
    .pet-name { font-size: 1.1rem; font-weight: 600; color: var(--text); margin-bottom: 0.5rem; }
    .pet-level { font-size: 0.9rem; color: var(--accent); font-weight: 600; margin-bottom: 0.5rem; }
    .pet-exp-bar { width: 100%; height: 8px; background: var(--bg-soft); border-radius: 999px; overflow: hidden; margin-bottom: 0.5rem; }
    .pet-exp-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #10b981); border-radius: 999px; transition: width 0.3s ease; }
    .pet-exp-text { font-size: 0.75rem; color: var(--text-muted); }
    .btn-select-pet { width: 100%; padding: 0.65rem; border: none; border-radius: var(--radius); background: linear-gradient(145deg, var(--accent), #10b981); color: var(--bg); font-weight: 600; font-family: inherit; cursor: pointer; font-size: 0.9rem; }
    .pet-select-modal { background: var(--card); border-radius: var(--radius-lg); padding: 1.5rem; max-width: 400px; width: 100%; border: 1px solid rgba(255,255,255,0.08); box-shadow: var(--shadow); }
    .pet-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-top: 1rem; }
    .pet-item { background: var(--bg-soft); border: 2px solid rgba(255,255,255,0.1); border-radius: var(--radius); padding: 1rem; cursor: pointer; transition: all 0.2s; text-align: center; }
    .pet-item:hover { border-color: var(--accent); background: var(--accent-dim); }
    .pet-item.selected { border-color: var(--accent); background: var(--accent-dim); }
    .pet-item-emoji { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .pet-item-name { font-size: 0.9rem; font-weight: 600; color: var(--text); margin-bottom: 0.25rem; }
    .pet-item-desc { font-size: 0.7rem; color: var(--text-muted); }
    #appMain { display: block; }
    #appMain.hidden { display: none !important; }
    .attendance-card { background: linear-gradient(145deg, var(--card), rgba(251,191,36,0.06)); border: 1px solid rgba(251,191,36,0.2); border-radius: var(--radius-lg); padding: 1rem; margin-bottom: 1rem; box-shadow: var(--shadow); }
    .attendance-desc { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.75rem; }
    .attendance-status { font-size: 0.9rem; color: var(--text); margin-bottom: 0.5rem; }
    .btn-attendance { width: 100%; padding: 0.65rem; border: none; border-radius: var(--radius); background: linear-gradient(145deg, var(--gold), #d97706); color: #1a1a1a; font-weight: 700; font-family: inherit; cursor: pointer; font-size: 0.9rem; }
    .title-badge { font-size: 0.7rem; color: var(--accent); margin-top: 0.35rem; font-weight: 600; }
    .walk-stat.walk-total { grid-column: 1 / -1; }

    /* ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */
    .tab-nav {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.35rem;
      background: var(--card);
      border-radius: var(--radius);
      padding: 0.5rem;
      margin-bottom: 1.25rem;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: var(--shadow);
    }
    .tab-btn {
      min-width: 3rem;
      padding: 0.4rem 0.2rem;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.65rem;
      font-family: inherit;
      font-weight: 500;
      cursor: pointer;
      border-radius: 0.65rem;
      transition: all 0.25s ease;
    }
    .tab-btn:hover { color: var(--text); }
    .tab-btn.active { background: linear-gradient(135deg, var(--accent-dim), rgba(52,211,153,0.08)); color: var(--accent); font-weight: 600; box-shadow: 0 0 0 1px rgba(52,211,153,0.2); }
    .tab-btn .tab-emoji { display: block; font-size: 1.15rem; margin-bottom: 0.2rem; }

    .page { display: none; width: 100%; animation: fadeIn 0.25s ease; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ===== Ïπ¥Îìú Í≥µÌÜµ ===== */
    .step-card, .walk-card, .avatar-section, .story-section {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      margin-bottom: 1rem;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: var(--shadow);
      transition: box-shadow 0.2s ease;
    }
    .step-card:hover, .walk-card:hover, .avatar-section:hover { box-shadow: var(--shadow), 0 0 0 1px rgba(255,255,255,0.03); }
    .story-section { min-height: 200px; }

    /* ===== Í±∏Ïùå ÌÉ≠ ===== */
    .step-value-wrap { display: flex; align-items: baseline; justify-content: center; gap: 0.3rem; margin-bottom: 0.3rem; }
    .step-value { font-size: 3.25rem; font-weight: 700; letter-spacing: -0.04em; background: linear-gradient(135deg, var(--accent), #10b981); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; line-height: 1; }
    .step-unit { font-size: 1.1rem; font-weight: 600; color: var(--text-muted); }
    .step-label { text-align: center; font-size: 0.9rem; color: var(--text-muted); font-weight: 400; }
    .lifetime-hint { text-align: center; font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem; }
    .progress-wrap { margin-top: 1.25rem; }
    .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.45rem; font-size: 0.8rem; color: var(--text-muted); }
    .progress-bar-bg { height: 10px; background: var(--bg-soft); border-radius: 999px; overflow: hidden; }
    .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #10b981); border-radius: 999px; width: 0%; transition: width 0.45s ease; box-shadow: 0 0 12px var(--accent-glow); }
    .manual-area { text-align: center; margin-top: 1.25rem; }
    .btn-add {
      width: 58px; height: 58px; border-radius: 50%; border: none; background: linear-gradient(145deg, var(--accent), #10b981); color: var(--bg);
      font-size: 1.6rem; font-weight: 700; cursor: pointer; box-shadow: 0 4px 20px var(--accent-glow);
      transition: transform 0.2s ease, box-shadow 0.2s ease; font-family: inherit; line-height: 1;
    }
    .btn-add:hover { transform: scale(1.06); box-shadow: 0 6px 28px var(--accent-glow); }
    .btn-add:active { transform: scale(0.97); }
    .manual-hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; }
    .status { font-size: 0.75rem; color: var(--text-muted); text-align: center; margin-top: 0.75rem; }
    .status.sensor-ok { color: var(--accent); }
    .actions { display: flex; justify-content: center; gap: 0.75rem; margin-top: 1rem; }
    .btn-reset {
      padding: 0.55rem 1.1rem; border-radius: 999px; border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04); color: var(--text-muted); font-size: 0.8rem; font-family: inherit; cursor: pointer; transition: all 0.2s;
    }
    .btn-reset:hover { color: var(--text); border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.06); }
    .goal-badge { display: none; text-align: center; margin-top: 0.75rem; padding: 0.45rem 1rem; background: var(--accent-dim); color: var(--accent); border-radius: 999px; font-size: 0.85rem; font-weight: 600; }
    .step-card.goal-reached .goal-badge { display: block; }
    .step-card.goal-reached .step-value { animation: pulse 1.5s ease infinite; }
    @keyframes pulse { 50% { opacity: 0.9; } }

    /* ===== ÏïÑÎ∞îÌÉÄ ÌÉ≠ ===== */
    /* Ï†úÌéòÌÜ† Ïä§ÌÉÄÏùº 3D Ï∫êÎ¶≠ÌÑ∞ ÏòÅÏó≠ (ÌîåÎ†àÏù¥Ïä§ÌôÄÎçî) */
    .avatar-3d-placeholder {
      width: 100%; min-height: 220px; margin: 0 auto 1rem;
      background: linear-gradient(180deg, rgba(52,211,153,0.06) 0%, rgba(0,0,0,0.2) 100%);
      border: 2px dashed rgba(52,211,153,0.35);
      border-radius: var(--radius-lg);
      display: flex; align-items: center; justify-content: center;
      flex-direction: column;
      color: var(--text-muted);
      font-size: 0.85rem;
      text-align: center;
      padding: 1.5rem;
    }
    .avatar-3d-placeholder .ph-title { color: var(--accent); font-weight: 600; margin-bottom: 0.35rem; font-size: 0.95rem; }
    .avatar-3d-placeholder .ph-desc { font-size: 0.75rem; opacity: 0.9; }
    .avatar-preview-wrap {
      width: 150px; height: 200px; margin: 0 auto 1.25rem;
      background: linear-gradient(180deg, rgba(52,211,153,0.08) 0%, rgba(255,255,255,0.03) 100%); border-radius: var(--radius-lg);
      display: flex; align-items: flex-end; justify-content: center;
      position: relative;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
    }
    .avatar-preview {
      width: 80px; height: 120px;
      position: relative;
    }
    /* Ï†úÌéòÌÜ† Ïä§ÌÉÄÏùº ÏπòÎπÑ: Î®∏Î¶¨ ÌÅ¨Í≤å, Î™∏ ÏûëÍ≤å */
    .avatar-body { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 42px; height: 48px; border-radius: 21px 21px 8px 8px; }
    .avatar-head { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 44px; height: 44px; border-radius: 50%; }
    .avatar-hair { position: absolute; bottom: 52px; left: 50%; transform: translateX(-50%); width: 52px; height: 22px; border-radius: 50% 50% 0 0; }
    .avatar-armor { position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); width: 46px; height: 42px; border-radius: 20px 20px 8px 8px; pointer-events: none; }
    .avatar-weapon { position: absolute; bottom: 28px; right: -26px; font-size: 1.4rem; }
    .avatar-hat { position: absolute; bottom: 72px; left: 50%; transform: translateX(-50%); font-size: 1.5rem; }
    .avatar-name { text-align: center; font-size: 1.05rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--accent); }
    .customize-row { display: flex; gap: 0.5rem; align-items: center; margin-top: 0.75rem; flex-wrap: wrap; }
    .customize-row label { font-size: 0.8rem; color: var(--text-muted); min-width: 3.5rem; font-weight: 500; }
    .customize-row select, .customize-row input[type="text"] {
      flex: 1; min-width: 0; padding: 0.5rem 0.75rem; border-radius: 0.6rem;
      border: 1px solid rgba(255,255,255,0.1); background: var(--bg-soft); color: var(--text);
      font-size: 0.85rem; font-family: inherit;
    }
    .color-swatch { width: 30px; height: 30px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.25); cursor: pointer; flex-shrink: 0; transition: transform 0.2s, box-shadow 0.2s; }
    .color-swatch:hover { transform: scale(1.08); }
    .color-swatch.active { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-dim), 0 0 12px var(--accent-glow); }

    /* ===== ÏÇ∞Ï±ÖÎ°ú ÌÉ≠ ===== */
    .route-list { display: flex; flex-direction: column; gap: 0.65rem; }
    .route-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 1rem 1.25rem;
      border: 1px solid rgba(255,255,255,0.06);
      display: flex; align-items: center; gap: 1rem;
      transition: background 0.2s, border-color 0.2s;
    }
    .route-card:not(.locked):hover { background: var(--card-hover); border-color: rgba(52,211,153,0.15); }
    .route-card.locked { opacity: 0.6; }
    .route-icon { font-size: 2rem; width: 48px; text-align: center; flex-shrink: 0; }
    .route-info { flex: 1; min-width: 0; }
    .route-name { font-weight: 600; font-size: 0.95rem; margin-bottom: 0.2rem; }
    .route-steps { font-size: 0.8rem; color: var(--text-muted); }
    .route-reward { font-size: 0.8rem; color: var(--accent); margin-top: 0.25rem; }
    .route-status { font-size: 0.72rem; padding: 0.4rem 0.65rem; border-radius: 999px; flex-shrink: 0; font-weight: 500; }
    .route-status.locked { background: var(--bg-soft); color: var(--text-muted); }
    .route-status.claim { background: var(--accent-dim); color: var(--accent); }
    .route-status.done { background: rgba(52,211,153,0.2); color: var(--accent); }

    /* ===== Ïû•ÎπÑ ÌÉ≠ ===== */
    .equipped-section { margin-bottom: 1.25rem; }
    .equipped-title { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
    .equipped-slots { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
    .equipped-slot {
      min-height: 4.2rem; background: var(--bg-soft); border-radius: var(--radius);
      border: 1px dashed rgba(255,255,255,0.12); display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 1.5rem; cursor: pointer; transition: all 0.2s; position: relative; padding: 0.5rem 0.35rem 0.4rem;
      gap: 0.2rem;
    }
    .equipped-slot:hover { border-color: rgba(52,211,153,0.3); background: var(--card-hover); }
    .equipped-slot.filled { border-style: solid; border-color: rgba(52,211,153,0.4); background: var(--accent-dim); }
    .equipped-slot .slot-label { font-size: 0.65rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
    .equipped-slot .slot-item-name { font-size: 0.7rem; color: var(--text); font-weight: 500; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; line-height: 1.2; }
    .equipped-slot .inv-tier { font-size: 0.6rem; font-weight: 600; color: var(--text-muted); }
    .equipped-slot.tier-standard .inv-tier { color: #94a3b8; }
    .equipped-slot.tier-pro .inv-tier { color: #60a5fa; }
    .equipped-slot.tier-prime .inv-tier { color: #a78bfa; }
    .equipped-slot.tier-signature .inv-tier { color: #fbbf24; }
    .inventory-title { font-size: 0.8rem; color: var(--text-muted); margin: 1rem 0 0.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
    .inventory-slot-section { margin-bottom: 1rem; }
    .inventory-slot-section h4 { font-size: 0.8rem; color: var(--accent); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.35rem; }
    .inventory-slot-list { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .inventory-slot-list .inv-item { width: calc(25% - 0.4rem); min-width: 72px; box-sizing: border-box; }
    .inventory-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
    .inv-item {
      aspect-ratio: 1; background: var(--card); border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.08);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 1.4rem; cursor: pointer; transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s; position: relative;
    }
    .inv-item:hover { transform: scale(1.05); border-color: rgba(52,211,153,0.25); box-shadow: 0 4px 16px rgba(0,0,0,0.2); }
    .inv-item .inv-name { font-size: 0.58rem; color: var(--text-muted); margin-top: 0.2rem; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .inv-item.equipped { border-color: var(--accent); background: var(--accent-dim); box-shadow: 0 0 0 1px rgba(52,211,153,0.3); }
    .inv-item-kit .inv-open { font-size: 0.55rem; color: var(--accent); margin-top: 0.1rem; font-weight: 600; }
    .storage-actions { display: flex; gap: 0.35rem; margin-top: 0.4rem; justify-content: center; flex-wrap: wrap; }
    .btn-storage-inv, .btn-storage-open { padding: 0.35rem 0.6rem; font-size: 0.7rem; border-radius: 0.5rem; border: none; cursor: pointer; font-family: inherit; font-weight: 600; }
    .btn-storage-inv { background: var(--bg-soft); color: var(--text); border: 1px solid rgba(255,255,255,0.15); }
    .btn-storage-open { background: linear-gradient(145deg, var(--accent), #10b981); color: var(--bg); }
    .inv-item .rarity-dot { position: absolute; top: 0.2rem; right: 0.2rem; width: 6px; height: 6px; border-radius: 50%; }
    .inv-item.rarity-common .rarity-dot { background: var(--rarity-common); }
    .inv-item.rarity-rare .rarity-dot { background: var(--rarity-rare); box-shadow: 0 0 6px var(--rarity-rare); }
    .inv-item.rarity-epic .rarity-dot { background: var(--rarity-epic); box-shadow: 0 0 8px var(--rarity-epic); }
    .inv-item.rarity-legend .rarity-dot { background: var(--rarity-legend); box-shadow: 0 0 10px var(--rarity-legend); }
    .inv-item.rarity-rare { border-color: rgba(96,165,250,0.4); }
    .inv-item.rarity-epic { border-color: rgba(167,139,250,0.5); box-shadow: 0 0 12px rgba(167,139,250,0.2); }
    .inv-item.rarity-legend { border-color: rgba(251,191,36,0.6); box-shadow: 0 0 16px rgba(251,191,36,0.25); }
    /* Îì±Í∏â(Ìã∞Ïñ¥)Î≥Ñ Ïû•ÎπÑ Ïä§ÌÉÄÏùº */
    .inv-item .inv-tier { font-size: 0.55rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; margin-top: 0.15rem; }
    .inv-item .inv-enhance { font-size: 0.85rem; font-weight: 800; color: var(--accent); margin-top: 0.1rem; }
    .inv-item.tier-standard { border-color: rgba(148,163,184,0.4); }
    .inv-item.tier-standard .inv-tier { color: #94a3b8; }
    .inv-item.tier-pro { border-color: rgba(96,165,250,0.5); box-shadow: 0 0 10px rgba(96,165,250,0.15); }
    .inv-item.tier-pro .inv-tier { color: #60a5fa; }
    .inv-item.tier-prime { border-color: rgba(167,139,250,0.6); box-shadow: 0 0 14px rgba(167,139,250,0.2); }
    .inv-item.tier-prime .inv-tier { color: #a78bfa; }
    .inv-item.tier-signature { border-color: rgba(251,191,36,0.7); box-shadow: 0 0 18px rgba(251,191,36,0.25); background: linear-gradient(145deg, var(--card), rgba(251,191,36,0.06)); }
    .inv-item.tier-signature .inv-tier { color: #fbbf24; }
    .equipped-slot.tier-standard.filled { border-color: rgba(148,163,184,0.5); }
    .equipped-slot.tier-pro.filled { border-color: rgba(96,165,250,0.5); box-shadow: 0 0 8px rgba(96,165,250,0.2); }
    .equipped-slot.tier-prime.filled { border-color: rgba(167,139,250,0.5); box-shadow: 0 0 10px rgba(167,139,250,0.25); }
    .equipped-slot.tier-signature.filled { border-color: rgba(251,191,36,0.6); box-shadow: 0 0 12px rgba(251,191,36,0.3); }

    /* ===== Ïä§ÌÜ†Î¶¨ ÌÉ≠ ===== */
    .story-title { font-size: 0.95rem; color: var(--accent); margin-bottom: 0.75rem; font-weight: 600; }
    .story-text { font-size: 0.9rem; line-height: 1.7; color: var(--text); font-weight: 400; white-space: pre-line; }
    .story-milestone { font-size: 0.78rem; color: var(--text-muted); margin-top: 1rem; }

    /* Î≥¥ÏÉÅ ÌåùÏóÖ */
    .toast {
      position: fixed; bottom: 5.5rem; left: 50%; transform: translateX(-50%) translateY(100px);
      background: var(--card); border: 1px solid var(--accent);
      color: var(--accent); padding: 0.8rem 1.35rem; border-radius: var(--radius);
      font-size: 0.9rem; font-weight: 600; z-index: 100; opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
      box-shadow: var(--shadow), 0 0 24px var(--accent-glow);
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* Ïò§ÎäòÏùò ÌÄòÏä§Ìä∏ */
    .quest-card { background: var(--card); border-radius: var(--radius-lg); padding: 1rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.06); box-shadow: var(--shadow); }
    .quest-desc { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.75rem; }
    .quest-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .quest-item { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; padding: 0.6rem 0.75rem; background: var(--bg-soft); border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.06); }
    .quest-item.done { border-color: rgba(52,211,153,0.3); background: var(--accent-dim); }
    .quest-item .quest-info { flex: 1; min-width: 0; }
    .quest-item .quest-name { font-size: 0.85rem; font-weight: 600; color: var(--text); }
    .quest-item .quest-progress { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.2rem; }
    .quest-item .quest-reward { font-size: 0.8rem; font-weight: 700; color: var(--gold); white-space: nowrap; }
    .quest-item .btn-claim { padding: 0.35rem 0.65rem; font-size: 0.75rem; border-radius: 0.5rem; border: none; background: linear-gradient(145deg, var(--gold), #d97706); color: #1a1a1a; font-weight: 600; cursor: pointer; font-family: inherit; }
    .quest-item .quest-done-label { font-size: 0.75rem; color: var(--accent); font-weight: 600; }

    /* ===== ÏÇ∞Ï±Ö ÌÉ≠ (ÏΩîÏä§ + GPS) ===== */
    .walk-title { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--accent); }
    .course-set { margin-bottom: 1rem; }
    .course-label { display: block; font-size: 0.82rem; color: var(--text-muted); margin-bottom: 0.4rem; font-weight: 500; }
    .course-input { width: 100%; padding: 0.65rem 0.85rem; border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.1); background: var(--bg-soft); color: var(--text); font-size: 1rem; }
    .walk-actions { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    .btn-walk-start, .btn-walk-stop { flex: 1; padding: 0.8rem; border-radius: var(--radius); font-size: 0.95rem; font-weight: 600; font-family: inherit; cursor: pointer; border: none; transition: transform 0.15s, box-shadow 0.15s; }
    .btn-walk-start { background: linear-gradient(145deg, var(--accent), #10b981); color: var(--bg); box-shadow: 0 4px 16px var(--accent-glow); }
    .btn-walk-start:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 6px 20px var(--accent-glow); }
    .btn-walk-stop { background: rgba(248,113,113,0.25); color: #f87171; border: 1px solid rgba(248,113,113,0.4); }
    .btn-walk-stop:hover:not(:disabled) { transform: translateY(-1px); }
    .btn-walk-start:disabled, .btn-walk-stop:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .walk-live { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.75rem; }
    .walk-stat { background: var(--bg-soft); border-radius: 0.6rem; padding: 0.65rem; text-align: center; font-size: 0.85rem; color: var(--text-muted); border: 1px solid rgba(255,255,255,0.05); }
    .walk-stat-value { color: var(--accent); font-weight: 700; font-size: 1.15rem; }
    .walk-next { grid-column: 1 / -1; font-size: 0.8rem; color: var(--gold); text-align: center; font-weight: 500; }
    .walk-status { font-size: 0.8rem; color: var(--text-muted); text-align: center; }
    .walk-route-select { margin-bottom: 1rem; }
    .walk-route-select label { display: block; font-size: 0.82rem; color: var(--text-muted); margin-bottom: 0.4rem; font-weight: 500; }
    .walk-route-select select { width: 100%; padding: 0.65rem 0.85rem; border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.1); background: var(--bg-soft); color: var(--text); font-size: 0.95rem; }
    .btn-add-route { width: 100%; padding: 0.6rem; margin-top: 0.5rem; border-radius: var(--radius); border: 1px dashed rgba(52,211,153,0.5); background: transparent; color: var(--accent); font-size: 0.85rem; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; }
    .btn-add-route:hover { background: var(--accent-dim); }
    #walkMap { width: 100%; height: 220px; border-radius: var(--radius-lg); margin-top: 1rem; overflow: hidden; position: relative; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06), 0 4px 20px rgba(0,0,0,0.2); background: linear-gradient(180deg, var(--bg-soft) 0%, var(--card) 100%); }
    .our-map-wrap { width: 100%; height: 100%; position: relative; border-radius: inherit; }
    .our-map-wrap svg { width: 100%; height: 100%; display: block; }
    .our-map-path { fill: none; stroke: var(--accent); stroke-width: 4; stroke-linecap: round; stroke-linejoin: round; opacity: 0.9; filter: drop-shadow(0 0 6px var(--accent-glow)); transition: d 0.2s ease; }
    [data-theme="morning"] .our-map-path { stroke: var(--accent); filter: drop-shadow(0 0 4px rgba(22,163,74,0.35)); }
    .our-map-char { transition: transform 0.2s ease-out; }
    .our-map-char .char-body { fill: var(--accent); stroke: var(--bg); stroke-width: 2; }
    .our-map-char .char-head { fill: var(--accent); stroke: var(--bg); stroke-width: 1.5; }
    .our-map-char .char-shadow { fill: rgba(0,0,0,0.2); }
    .our-map-grid line { stroke: rgba(255,255,255,0.06); stroke-width: 0.4; stroke-dasharray: 3 4; }
    [data-theme="morning"] .our-map-grid line { stroke: rgba(0,0,0,0.08); stroke-dasharray: 3 4; }
    .our-map-label { position: absolute; bottom: 10px; left: 12px; font-size: 0.72rem; color: var(--text-muted); font-weight: 500; }
    .routes-map-box { border-radius: var(--radius-lg); overflow: hidden; background: linear-gradient(180deg, var(--bg-soft) 0%, var(--card) 100%); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06); }
    .route-create-card { margin-bottom: 1rem; padding: 1rem; background: var(--card); border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.06); }
    .route-create-card input { margin-bottom: 0.5rem; }
    .achievement-section { margin-bottom: 1.25rem; }
    .achievement-title { font-size: 0.9rem; font-weight: 600; color: var(--accent); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
    .achievement-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
    .achievement-item { background: var(--bg-soft); border-radius: var(--radius); padding: 0.75rem; border: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; gap: 0.6rem; }
    .achievement-item.unlocked { border-color: rgba(52,211,153,0.3); background: var(--accent-dim); }
    .achievement-item .ach-icon { font-size: 1.75rem; width: 40px; text-align: center; flex-shrink: 0; }
    .achievement-item.locked .ach-icon { filter: grayscale(1); opacity: 0.6; }
    .achievement-item .ach-name { font-size: 0.8rem; font-weight: 600; }
    .achievement-item .ach-desc { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.15rem; }

    /* Í∞ÄÏ±†(Î≥¥Í∏â ÎΩëÍ∏∞) */
    .gacha-card { background: var(--card); border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.06); text-align: center; }
    .gacha-gold { font-size: 1.5rem; font-weight: 700; color: var(--gold); margin-bottom: 0.5rem; }
    .gacha-buttons { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-top: 0.75rem; }
    .btn-gacha { padding: 0.75rem 1.25rem; border-radius: var(--radius); background: linear-gradient(145deg, var(--gold), #d97706); color: #1a1a1a; font-weight: 700; font-size: 0.9rem; border: none; cursor: pointer; font-family: inherit; }
    .btn-gacha:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-gacha-premium { padding: 0.75rem 1.25rem; border-radius: var(--radius); background: linear-gradient(145deg, #a78bfa, #7c3aed); color: #fff; font-weight: 700; font-size: 0.9rem; border: none; cursor: pointer; font-family: inherit; }
    .btn-gacha-premium:disabled { opacity: 0.5; cursor: not-allowed; }
    .gacha-cost { font-size: 0.78rem; color: var(--text-muted); margin-top: 0.35rem; }
    .share-card { background: var(--card); border-radius: var(--radius-lg); padding: 1.25rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.06); text-align: center; }
    .btn-share { width: 100%; padding: 0.8rem; border-radius: var(--radius); background: #fee500; color: #191919; font-weight: 700; font-size: 0.9rem; border: none; cursor: pointer; font-family: inherit; }
    .payment-card { background: var(--card); border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.06); }
    .payment-desc { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem; }
    .payment-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.65rem; }
    .payment-item-card { background: var(--bg-soft); border-radius: var(--radius); padding: 1rem; text-align: center; border: 1px solid rgba(255,255,255,0.06); display: flex; flex-direction: column; gap: 0.35rem; align-items: center; }
    .payment-item-card.highlight { border-color: rgba(251,191,36,0.4); background: linear-gradient(145deg, var(--bg-soft), rgba(251,191,36,0.06)); }
    .payment-amount { font-size: 1.1rem; font-weight: 700; color: var(--gold); }
    .payment-price { font-size: 0.7rem; color: var(--text-muted); }
    .btn-payment { padding: 0.45rem 0.75rem; font-size: 0.8rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.06); color: var(--text-muted); cursor: not-allowed; font-family: inherit; }

    /* Ïû•ÎπÑ Í∞ïÌôî */
    .enhance-section { margin-bottom: 1rem; }
    .enhance-select { width: 100%; padding: 0.65rem; border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.1); background: var(--bg-soft); color: var(--text); margin-bottom: 0.5rem; font-size: 0.9rem; }
    .btn-enhance { width: 100%; padding: 0.75rem; border-radius: var(--radius); background: linear-gradient(145deg, var(--rarity-epic), #7c3aed); color: #fff; font-weight: 600; border: none; cursor: pointer; font-family: inherit; }
    .btn-enhance:disabled { opacity: 0.5; cursor: not-allowed; }
    .enhance-warn { font-size: 0.75rem; color: #f87171; margin-top: 0.5rem; }
    .enhance-table-wrap { margin: 1rem 0; overflow-x: auto; }
    .enhance-table { width: 100%; font-size: 0.8rem; border-collapse: collapse; }
    .enhance-table th, .enhance-table td { padding: 0.5rem 0.6rem; text-align: center; border: 1px solid rgba(255,255,255,0.08); }
    .enhance-table .enhance-col { font-size: 1rem; font-weight: 700; color: var(--accent); }
    .enhance-table th { background: var(--bg-soft); color: var(--text-muted); font-weight: 600; }
    .enhance-table tr:nth-child(even) { background: rgba(255,255,255,0.02); }
    .enhance-table .rate-ok { color: var(--accent); }
    .enhance-table .rate-mid { color: var(--gold); }
    .enhance-table .rate-low { color: #f87171; }
    .enhance-note { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem; line-height: 1.5; }
    .equip-bonus-summary { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.75rem; padding: 0.6rem; background: var(--bg-soft); border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.06); }
    .equip-bonus-summary strong { color: var(--accent); }

    /* 2D Ï∫êÎ¶≠ÌÑ∞ Ïù∏Í∞ÑÌòï - Î∂ÄÎìúÎü¨Ïö¥ ÎπÑÏú®Í≥º Í∑∏Î¶ºÏûê */
    .avatar-human { width: 100px; height: 168px; margin: 0 auto; position: relative; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.2)); }
    .avatar-human .ah-head { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 38px; height: 38px; border-radius: 50%; box-shadow: inset -2px -1px 0 rgba(0,0,0,0.06), 0 2px 6px rgba(0,0,0,0.12); }
    .avatar-human .ah-face { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); width: 24px; height: 10px; display: flex; justify-content: space-between; align-items: center; }
    .avatar-human .ah-face .eye { width: 4px; height: 4px; border-radius: 50%; background: rgba(0,0,0,0.5); }
    .avatar-human .ah-neck { position: absolute; top: 36px; left: 50%; transform: translateX(-50%); width: 10px; height: 12px; border-radius: 0 0 4px 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .avatar-human .ah-torso { position: absolute; top: 48px; left: 50%; transform: translateX(-50%); width: 46px; height: 44px; border-radius: 12px 12px 8px 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.1); }
    .avatar-human .ah-arm-l, .avatar-human .ah-arm-r { position: absolute; top: 52px; width: 10px; height: 34px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    .avatar-human .ah-arm-l { left: 0; transform-origin: top right; }
    .avatar-human .ah-arm-r { right: 0; transform-origin: top left; }
    .avatar-human .ah-leg-l, .avatar-human .ah-leg-r { position: absolute; top: 90px; width: 14px; height: 44px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.12); }
    .avatar-human .ah-leg-l { left: 24px; }
    .avatar-human .ah-leg-r { right: 24px; }
    .avatar-human .ah-slot-head { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); font-size: 1.35rem; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2)); }
    .avatar-human .ah-slot-accessory { position: absolute; top: 6px; right: -12px; font-size: 1.1rem; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2)); }
    .avatar-preview-wrap { padding: 1.25rem; background: linear-gradient(180deg, var(--bg-soft) 0%, var(--card) 100%); border-radius: var(--radius-lg); margin-bottom: 1.25rem; border: 1px solid rgba(255,255,255,0.06); }
    .avatar-section .customize-row { margin-bottom: 1rem; }
    .avatar-section .customize-row label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.4rem; }
    .avatar-section .customize-section-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--accent); margin: 1.25rem 0 0.5rem; padding-bottom: 0.35rem; border-bottom: 1px solid rgba(255,255,255,0.06); }
    .avatar-section .customize-section-title:first-of-type { margin-top: 0; }

    /* Î™®Î∞îÏùº ÏµúÏ†ÅÌôî */
    @media (max-width: 480px) {
      .container { padding-left: 0.75rem; padding-right: 0.75rem; }
      header { padding-top: 0.5rem; }
      h1 { font-size: 1.3rem; }
      .step-value { font-size: 2.75rem; }
      .btn-add { width: 64px; height: 64px; font-size: 1.8rem; }
      .tab-btn { min-width: 2.5rem; padding: 0.5rem 0.25rem; font-size: 0.7rem; }
      .tab-btn .tab-emoji { font-size: 1.25rem; }
      .step-card, .walk-card, .avatar-section, .story-section { padding: 1.25rem; }
      .auth-modal { padding: 1.25rem; max-width: 100%; }
      .btn-auth-submit, .btn-gacha, .btn-gacha-premium, .btn-share, .btn-attendance { min-height: 44px; padding: 0.75rem; }
      .btn-reset, .btn-claim { min-height: 36px; padding: 0.5rem 0.9rem; }
      .header-auth-btn { min-height: 36px; padding: 0.4rem 0.6rem; font-size: 0.75rem; }
      .theme-toggle { width: 40px; height: 40px; }
      input[type="text"], input[type="password"], input[type="number"], select { min-height: 44px; font-size: 16px; }
      .inv-item { min-height: 80px; }
      .equipped-slot { min-height: 5rem; }
    }
    @media (hover: none) and (pointer: coarse) {
      .btn-add:hover, .btn-reset:hover, .tab-btn:hover, .header-auth-btn:hover { transform: none; }
      .btn-add:active { transform: scale(0.95); }
      .btn-reset:active, .tab-btn:active { opacity: 0.7; }
    }
    html { -webkit-overflow-scrolling: touch; height: 100%; }
    body { -webkit-tap-highlight-color: transparent; height: 100%; overflow-y: auto; }
    button, a, input, select, .tab-btn, .inv-item, .equipped-slot { -webkit-tap-highlight-color: rgba(255,255,255,0.1); touch-action: manipulation; }
    input, textarea, select { font-size: 16px; }
    @supports (-webkit-touch-callout: none) {
      input, textarea, select { font-size: 16px; }
    }
    @media (max-width: 480px) {
      .auth-overlay { padding: 0.5rem; align-items: flex-start; padding-top: max(1rem, env(safe-area-inset-top)); }
      .auth-modal { margin-top: auto; margin-bottom: auto; max-height: calc(100vh - 2rem); overflow-y: auto; }
    }
  </style>
</head>
<body data-theme="night">
  <div class="container">
    <div id="appMain" class="hidden">
    <header>
      <button type="button" class="theme-toggle" id="themeToggle" title="Î™®Îãù/ÎÇòÏù¥Ìä∏ Ï†ÑÌôò">üåô</button>
      <h1>WalkStory</h1>
      <p class="subtitle">Í±∏ÏùåÏúºÎ°ú ÌÇ§Ïö∞Îäî ÎÇòÎßåÏùò ÎèôÎ¨º ÏπúÍµ¨</p>
      <div class="header-level" id="headerLevel">
        <span>Lv.<span class="lv-num" id="levelNum">1</span></span>
        <div class="level-bar-wrap"><div class="level-bar-fill" id="levelBarFill" style="width:0%"></div></div>
      </div>
      <p class="title-badge" id="titleBadge">ÏÇ∞Ï±ÖÎü¨</p>
      <div class="header-right">
        <button type="button" class="header-auth-btn" id="btnHeaderAuth" aria-label="Î°úÍ∑∏Ïù∏">üîê Î°úÍ∑∏Ïù∏</button>
        <button type="button" class="header-logout-btn" id="btnLogout" aria-label="Î°úÍ∑∏ÏïÑÏõÉ" style="display:none;">Î°úÍ∑∏ÏïÑÏõÉ</button>
        <span class="gold-display">ü™ô <span id="headerGold">0</span> G</span>
      </div>
    </header>

    <nav class="tab-nav" role="tablist">
      <button type="button" class="tab-btn active" data-tab="walk" aria-selected="true"><span class="tab-emoji">üö∂</span>ÏÇ∞Ï±Ö</button>
      <button type="button" class="tab-btn" data-tab="avatar"><span class="tab-emoji">üßë</span>ÏïÑÎ∞îÌÉÄ</button>
      <button type="button" class="tab-btn" data-tab="storage"><span class="tab-emoji">üì•</span>Î≥¥Í¥ÄÌï®</button>
      <button type="button" class="tab-btn" data-tab="shop"><span class="tab-emoji">üõí</span>ÏÉÅÏ†ê</button>
      <button type="button" class="tab-btn" data-tab="equipment"><span class="tab-emoji">üéí</span>Ïû•ÎπÑ</button>
      <button type="button" class="tab-btn" data-tab="story"><span class="tab-emoji">üìñ</span>Ïä§ÌÜ†Î¶¨</button>
    </nav>

    <!-- ÏÇ∞Ï±Ö ÌÉ≠ (Í±∏Ïùå + ÏΩîÏä§ + ÏßÄÎèÑ + ÏÇ∞Ï±ÖÎ°ú ÌÜµÌï©) -->
    <section class="page active" id="page-walk" role="tabpanel">
      <div class="attendance-card" id="attendanceCard" style="display:none;">
        <h2 class="walk-title">üìÖ Ï∂úÏÑù Ïù¥Î≤§Ìä∏</h2>
        <p class="attendance-desc">Îß§Ïùº Ï∂úÏÑùÌïòÍ≥† Î≥¥ÏÉÅÏùÑ Î∞õÏïÑÍ∞ÄÏöî. 7Ïùº Ïó∞ÏÜç Ïãú <strong>ÏúÑÌÅ¥Î¶¨ ÎßàÏä§ÌÑ∞ ÏÑ†Î¨ºÏÉÅÏûê</strong> ÏßÄÍ∏â!</p>
        <div class="attendance-status" id="attendanceStatus"></div>
        <button type="button" class="btn-attendance" id="btnAttendance" style="display:none;">Ï∂úÏÑù Ï≤¥ÌÅ¨</button>
      </div>
      <div class="quest-card">
        <h2 class="walk-title">üìã Ïò§ÎäòÏùò ÌÄòÏä§Ìä∏</h2>
        <p class="quest-desc">ÏôÑÎ£å ÌõÑ Î≥¥ÏÉÅÏùÑ ÏàòÎ†πÌïòÎ©¥ Í≥®ÎìúÎ•º Î∞õÏùÑ Ïàò ÏûàÏñ¥Ïöî.</p>
        <div id="questList" class="quest-list"></div>
      </div>
      <div class="step-card" id="stepCard">
        <div class="step-value-wrap">
          <span class="step-value" id="stepValue">0</span>
          <span class="step-unit">Í±∏Ïùå</span>
        </div>
        <p class="step-label">Ïò§Îäò Í±∏ÏùÄ Í±∏Ïùå</p>
        <p class="lifetime-hint">ÎàÑÏ†Å <span id="lifetimeSteps">0</span>Í±∏ÏùåÏúºÎ°ú ÏÇ∞Ï±ÖÎ°úÎ•º Ïó¥Ïñ¥Í∞ÄÏöî</p>
        <div class="progress-wrap">
          <div class="progress-header">
            <span>Ïò§Îäò Î™©Ìëú</span>
            <span id="progressText">0 / 10,000</span>
          </div>
          <div class="progress-bar-bg">
            <div class="progress-bar-fill" id="progressFill"></div>
          </div>
        </div>
        <div class="goal-badge" id="goalBadge">üéâ Î™©Ìëú Îã¨ÏÑ±!</div>
        <div class="manual-area">
          <button type="button" class="btn-add" id="btnAdd" title="Í±∏Ïùå Ï∂îÍ∞Ä">+</button>
          <p class="manual-hint" id="manualHint">Î≤ÑÌäºÏúºÎ°ú Í±∏ÏùåÏùÑ Ï∂îÍ∞ÄÌï† Ïàò ÏûàÏñ¥Ïöî</p>
        </div>
      </div>
      <p class="status" id="status">Ï§ÄÎπÑ Ï§ë...</p>
      <div class="actions">
        <button type="button" class="btn-reset" id="btnReset">Ïò§Îäò Í±∏Ïùå Ï¥àÍ∏∞Ìôî</button>
      </div>
      <div class="walk-card">
        <h2 class="walk-title">ÎÇòÎßåÏùò ÏÇ∞Ï±Ö ÏΩîÏä§</h2>
        <div class="walk-route-select">
          <label>ÏßÑÌñâÌï† ÏΩîÏä§ ÏÑ†ÌÉù</label>
          <select id="selectActiveRoute">
            <option value="">-- ÏΩîÏä§Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî --</option>
          </select>
          <button type="button" class="btn-add-route" id="btnAddRoute">+ ÏÉà ÏΩîÏä§ ÎßåÎì§Í∏∞</button>
        </div>
        <div class="route-create-card" id="routeCreateCard" style="display:none;">
          <label class="course-label">ÏΩîÏä§ Ïù¥Î¶Ñ</label>
          <input type="text" id="newRouteName" placeholder="Ïòà: ÎèôÎÑ§ Ìïú Î∞îÌÄ¥" class="course-input" maxlength="20" inputmode="text" />
          <label class="course-label">Î™©Ìëú Í±∞Î¶¨ (km, ÏµúÏÜå 0.5)</label>
          <input type="number" id="newRouteGoalKm" min="0.5" max="50" step="0.5" value="1" class="course-input" inputmode="decimal" />
          <button type="button" class="btn-walk-start" id="btnSaveRoute" style="margin-top:0.5rem;">Ï†ÄÏû•</button>
        </div>
        <div class="walk-actions">
          <button type="button" class="btn-walk-start" id="btnWalkStart">ÏÇ∞Ï±Ö ÏãúÏûë</button>
          <button type="button" class="btn-walk-stop" id="btnWalkStop" disabled>ÏÇ∞Ï±Ö Ï¢ÖÎ£å</button>
        </div>
        <div class="walk-live" id="walkLive">
          <div class="walk-stat"><span class="walk-stat-value" id="walkDistance">0.00</span> km</div>
          <div class="walk-stat">XP <span class="walk-stat-value" id="walkXp">0</span></div>
          <div class="walk-stat walk-total">Ï¥ù Ïù¥Îèô Í±∞Î¶¨ <span class="walk-stat-value" id="walkTotalKm">0.00</span> km</div>
          <div class="walk-next" id="walkNext">ÏΩîÏä§Î•º ÏôÑÏ£ºÌïòÎ©¥ Î≥¥Í∏â ÌÇ§Ìä∏Í∞Ä Î≥¥Í¥ÄÌï®Ïóê ÎèÑÏ∞©Ìï¥Ïöî!</div>
        </div>
        <div id="walkMap" class="our-map-wrap"></div>
        <p class="walk-status" id="walkStatus">ÏΩîÏä§Î•º ÏÑ†ÌÉùÌïòÍ≥† ÏÇ∞Ï±Ö ÏãúÏûëÏùÑ ÎàÑÎ•¥ÏÑ∏Ïöî.</p>
      </div>
      <p class="inventory-title">ÎÇ¥ ÏÇ∞Ï±Ö ÏΩîÏä§</p>
      <div id="routesMap" class="our-map-wrap routes-map-box" style="height:180px;margin-bottom:1rem;"></div>
      <div class="route-list" id="routeList"></div>
    </section>

    <!-- ÏïÑÎ∞îÌÉÄ ÌÉ≠ -->
    <section class="page" id="page-avatar" role="tabpanel">
      <div class="avatar-section">
        <p class="avatar-name" id="avatarName">ÏÇ∞Ï±ÖÎü¨</p>
        <div class="avatar-3d-placeholder" id="avatar3dPlaceholder">
          <span class="ph-title">3D Ï∫êÎ¶≠ÌÑ∞ ÏòÅÏó≠ (Unity WebGL Ïó∞Îèô)</span>
          <span class="ph-desc">UnityÎ°ú ÎßåÎì† Ï∫êÎ¶≠ÌÑ∞Î•º ÎÑ£ÏùÑ Ïàò ÏûàÏñ¥Ïöî. WebGL ÎπåÎìú ÌõÑ Ïù¥ ÏòÅÏó≠Ïóê canvasÎ•º ÎÑ£Í≥†, UNITY_Ïó∞Îèô_Í∞ÄÏù¥Îìú.mdÎ•º Ï∞∏Í≥†Ìï¥ Ïó∞ÎèôÌïòÏÑ∏Ïöî.<br>ÏïÑÎûòÎäî 2D ÎØ∏Î¶¨Î≥¥Í∏∞ÏûÖÎãàÎã§.</span>
        </div>
        <div class="avatar-preview-wrap">
          <div class="avatar-human" id="avatarHuman">
            <div class="ah-head" id="previewHead" style="background:var(--skin,#f5d0b0)"></div>
            <div class="ah-face"><span class="eye"></span><span class="eye"></span></div>
            <div class="ah-neck" style="background:var(--skin,#f5d0b0)"></div>
            <div class="ah-torso" id="previewBody" style="background:var(--top-color,#6b7280)"></div>
            <div class="ah-arm-l" id="previewArmL" style="background:var(--skin,#f5d0b0)"></div>
            <div class="ah-arm-r" id="previewArmR" style="background:var(--skin,#f5d0b0)"></div>
            <div class="ah-leg-l" id="previewLegL" style="background:var(--bottom-color,#4b5563)"></div>
            <div class="ah-leg-r" id="previewLegR" style="background:var(--bottom-color,#4b5563)"></div>
            <div class="ah-slot-head" id="previewHat"></div>
            <div class="ah-slot-accessory" id="previewWeapon"></div>
          </div>
        </div>
        <div class="pet-section" id="petSection">
          <p class="customize-section-title">ÎÇòÎßåÏùò ÎèôÎ¨º ÏπúÍµ¨</p>
          <div class="pet-display" id="petDisplay">
            <div class="pet-preview" id="petPreview">
              <div class="pet-emoji" id="petEmoji" style="font-size: 4rem;">üêæ</div>
              <div class="pet-info" id="petInfo">
                <div class="pet-name" id="petName">ÎèôÎ¨ºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</div>
                <div class="pet-level" id="petLevel">Lv.1</div>
                <div class="pet-exp-bar">
                  <div class="pet-exp-fill" id="petExpFill" style="width: 0%"></div>
                </div>
                <div class="pet-exp-text" id="petExpText">Í≤ΩÌóòÏπò: 0 / 100</div>
              </div>
            </div>
            <button type="button" class="btn-select-pet" id="btnSelectPet">ÎèôÎ¨º ÏÑ†ÌÉùÌïòÍ∏∞</button>
          </div>
        </div>
        <p class="customize-section-title">Í∏∞Î≥∏ Ï†ïÎ≥¥</p>
        <div class="customize-row">
          <label>Ïù¥Î¶Ñ</label>
          <input type="text" id="inputAvatarName" placeholder="Ïù¥Î¶Ñ ÏûÖÎ†•" maxlength="8" inputmode="text" autocomplete="name" />
        </div>
        <p class="customize-section-title">Ïô∏Ìòï</p>
        <div class="customize-row">
          <label>ÌîºÎ∂ÄÏÉâ</label>
          <div style="display:flex;gap:0.35rem;flex-wrap:wrap;">
            <button type="button" class="color-swatch active" data-skin="#f5d0b0" style="background:#f5d0b0" aria-label="ÌîºÎ∂ÄÏÉâ 1"></button>
            <button type="button" class="color-swatch" data-skin="#e8b896" style="background:#e8b896" aria-label="ÌîºÎ∂ÄÏÉâ 2"></button>
            <button type="button" class="color-swatch" data-skin="#d4a574" style="background:#d4a574" aria-label="ÌîºÎ∂ÄÏÉâ 3"></button>
            <button type="button" class="color-swatch" data-skin="#c4956a" style="background:#c4956a" aria-label="ÌîºÎ∂ÄÏÉâ 4"></button>
          </div>
        </div>
        <p class="customize-section-title">Î®∏Î¶¨</p>
        <div class="customize-row">
          <label>Ïä§ÌÉÄÏùº</label>
          <select id="selectHair">
            <option value="short">ÏßßÏùÄ Î®∏Î¶¨</option>
            <option value="long">Í∏¥ Î®∏Î¶¨</option>
            <option value="curly">Í≥±Ïä¨Î®∏Î¶¨</option>
            <option value="spiky">ÎªóÏπú Î®∏Î¶¨</option>
          </select>
        </div>
        <div class="customize-row">
          <label>Î®∏Î¶¨ ÏÉâ</label>
          <div style="display:flex;gap:0.35rem;flex-wrap:wrap;">
            <button type="button" class="color-swatch hair-color active" data-hair="#4a3728" style="background:#4a3728"></button>
            <button type="button" class="color-swatch hair-color" data-hair="#2c1810" style="background:#2c1810"></button>
            <button type="button" class="color-swatch hair-color" data-hair="#8b6914" style="background:#8b6914"></button>
            <button type="button" class="color-swatch hair-color" data-hair="#5c4033" style="background:#5c4033"></button>
          </div>
        </div>
      </div>
    </section>

    <!-- Î≥¥Í¥ÄÌï® ÌÉ≠ -->
    <section class="page" id="page-storage" role="tabpanel">
      <div class="walk-card">
        <h2 class="walk-title">üì• Î≥¥Í¥ÄÌï®</h2>
        <p class="story-text" style="font-size:0.85rem;color:var(--text-muted);margin-bottom:1rem;">ÏÇ∞Ï±Ö ÏΩîÏä§ ÏôÑÏ£º Ïãú Î∞õÏùÄ Î≥¥Í∏â ÌÇ§Ìä∏Í∞Ä Ïó¨Í∏∞Î°ú ÏòµÎãàÎã§. Ïù∏Î≤§ÏúºÎ°ú Í∞ÄÏ†∏Í∞ÄÍ±∞ÎÇò Î∞îÎ°ú Ïó¥ Ïàò ÏûàÏñ¥Ïöî.</p>
        <div class="inventory-slot-list" id="storageList"></div>
      </div>
    </section>

    <!-- ÏÉÅÏ†ê ÌÉ≠ (Î≥¥Í∏â + Í≥µÏú† + Í≤∞Ï†ú) -->
    <section class="page" id="page-shop" role="tabpanel">
      <div class="gacha-card">
        <h2 class="walk-title">üì¶ Î≥¥Í∏â ÎΩëÍ∏∞</h2>
        <p class="gacha-gold">ü™ô <span id="gachaGold">0</span> G</p>
        <div class="gacha-buttons">
          <button type="button" class="btn-gacha" id="btnGacha">1Ìöå ÎΩëÍ∏∞ (30 G)</button>
          <button type="button" class="btn-gacha-premium" id="btnGachaPremium">Í∞ïÌôî ÎΩëÍ∏∞ (60 G)</button>
        </div>
        <p class="gacha-cost">Í∞ïÌôî ÎΩëÍ∏∞Îäî Ï¢ãÏùÄ Îì±Í∏â¬∑Ìù¨Í∑ÄÎèÑ ÌôïÎ•† ÏÉÅÏäπ</p>
      </div>
      <div class="share-card">
        <h2 class="walk-title">üîó ÎßÅÌÅ¨ Í≥µÏú† Î≥¥ÏÉÅ</h2>
        <p class="story-text" style="font-size:0.85rem;margin-bottom:0.75rem;">Ïπ¥Ïπ¥Ïò§ÌÜ° Îì±ÏúºÎ°ú Í≥µÏú†ÌïòÎ©¥ <strong>+40 G</strong> (Ïùº 1Ìöå)</p>
        <button type="button" class="btn-share" id="btnShare">Ïπ¥Ïπ¥Ïò§ÌÜ°ÏúºÎ°ú Í≥µÏú†ÌïòÍ≥† 40 G Î∞õÍ∏∞</button>
      </div>
      <div class="payment-card">
        <h2 class="walk-title">üí≥ Í≥®Îìú Íµ¨Îß§</h2>
        <p class="payment-desc">Ïä§ÌÜ†Ïñ¥ Ïó∞Îèô ÌõÑ ÏÇ¨Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§.</p>
        <div class="payment-grid">
          <div class="payment-item-card">
            <span class="payment-amount">100 G</span>
            <span class="payment-price">ÏÜåÏï°</span>
            <button type="button" class="btn-payment" disabled>Ï§ÄÎπÑ Ï§ë</button>
          </div>
          <div class="payment-item-card">
            <span class="payment-amount">500 G</span>
            <span class="payment-price">Ïù∏Í∏∞</span>
            <button type="button" class="btn-payment" disabled>Ï§ÄÎπÑ Ï§ë</button>
          </div>
          <div class="payment-item-card highlight">
            <span class="payment-amount">1,200 G</span>
            <span class="payment-price">20% Î≥¥ÎÑàÏä§</span>
            <button type="button" class="btn-payment" disabled>Ï§ÄÎπÑ Ï§ë</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Ïû•ÎπÑ ÌÉ≠ (Ï∞©Ïö©/Î≥¥Ïú† + Í∞ïÌôî) -->
    <section class="page" id="page-equipment" role="tabpanel">
      <div class="equipped-section">
        <p class="equipped-title">Ï∞©Ïö© Ï§ë (ÌÉ≠ÌïòÏó¨ Î≥ÄÍ≤Ω)</p>
        <div class="equipped-slots" id="equippedSlots"></div>
        <div class="equip-bonus-summary" id="equipBonusSummary"></div>
      </div>
      <p class="inventory-title">Ïû•ÎπÑ Ïπ∏Î≥Ñ Î≥¥Ïú† Î™©Î°ù (ÌÉ≠ÌïòÎ©¥ Ï∞©Ïö©)</p>
      <div id="inventoryBySlot"></div>
      <div class="walk-card" style="margin-top:1.25rem;">
        <h2 class="walk-title">‚¨ÜÔ∏è Ïû•ÎπÑ Í∞ïÌôî</h2>
        <div class="enhance-table-wrap">
          <table class="enhance-table" aria-label="Í∞ïÌôî ÏÑ±Í≥µÎ•†">
            <thead>
              <tr><th>Í∞ïÌôî</th><th>ÏÑ±Í≥µ ÌôïÎ•†</th><th>ÏãúÎèÑ/Ïã§Ìå® Ïãú</th></tr>
            </thead>
            <tbody id="enhanceTableBody"></tbody>
          </table>
        </div>
        <p class="course-label">Í∞ïÌôîÌï† Ïû•ÎπÑ ÏÑ†ÌÉù</p>
        <select class="enhance-select" id="enhanceSelect">
          <option value="">-- Ïû•ÎπÑ ÏÑ†ÌÉù --</option>
        </select>
        <button type="button" class="btn-enhance" id="btnEnhance">Í∞ïÌôî ÏãúÎèÑ</button>
        <p class="enhance-note">1~3Í∞ï Ïã§Ìå® Ïãú Ïû•ÎπÑ ÌååÍ¥¥. 4~7Í∞ïÏùÄ ÏãúÎèÑÌï† Îïå Í≥®ÎìúÎ•º Î®ºÏ†Ä Ï∞®Í∞êÌïòÍ≥†, Ïã§Ìå®Ìï¥ÎèÑ Ïû•ÎπÑÎäî Ïú†ÏßÄÎèºÏöî.</p>
      </div>
    </section>

    <!-- Ïä§ÌÜ†Î¶¨ ÌÉ≠ -->
    <section class="page" id="page-story" role="tabpanel">
      <div class="story-section">
        <p class="story-title">ÎÇòÏùò ÏÇ∞Ï±Ö ÏùºÏßÄ</p>
        <div class="story-text" id="storyText"></div>
        <p class="story-milestone" id="storyMilestone"></p>
        <div class="achievement-section">
          <p class="achievement-title">üèÜ ÏóÖÏ†Å</p>
          <div class="achievement-grid" id="achievementGrid"></div>
        </div>
      </div>
    </section>
    </div>

    <!-- Î°úÍ∑∏Ïù∏/ÌöåÏõêÍ∞ÄÏûÖ (ÎπÑÎ°úÍ∑∏Ïù∏ Ïãú Ï≤´ ÌôîÎ©¥, Î°úÍ∑∏Ïù∏ ÌõÑ Î©îÏù∏Îßå ÌëúÏãú) -->
    <!-- ÌôòÏòÅ Î™®Îã¨ -->
    <div class="welcome-modal" id="welcomeModal">
      <div class="welcome-content">
        <div class="welcome-icon">üéâ</div>
        <div class="welcome-title" id="welcomeTitle">ÌôòÏòÅÌï©ÎãàÎã§!</div>
        <div class="welcome-message" id="welcomeMessage">Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ</div>
        <button type="button" class="btn-welcome-close" id="btnWelcomeClose">ÏãúÏûëÌïòÍ∏∞</button>
      </div>
    </div>

    <!-- Î°úÎî© Ïò§Î≤ÑÎ†àÏù¥ -->
    <div class="auth-loading" id="authLoading">
      <div class="auth-loading-spinner"></div>
      <div style="color: var(--text-muted); font-size: 0.9rem;">Î°úÍ∑∏Ïù∏ Ï§ë...</div>
    </div>

    <div class="auth-overlay auth-gate" id="authOverlay" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <div class="auth-modal">
        <div class="auth-tabs">
          <button type="button" class="auth-tab active" data-auth-tab="login">Î°úÍ∑∏Ïù∏</button>
          <button type="button" class="auth-tab" data-auth-tab="signup">ÌöåÏõêÍ∞ÄÏûÖ</button>
        </div>
        <h2 class="auth-title" id="authTitle">Î°úÍ∑∏Ïù∏</h2>
        <div id="authLoginPanel" class="auth-panel">
          <label>ÎãâÎÑ§ÏûÑ</label>
          <input type="text" id="authLoginNick" placeholder="ÎãâÎÑ§ÏûÑ" maxlength="12" inputmode="text" autocomplete="username" />
          <label>ÎπÑÎ∞ÄÎ≤àÌò∏</label>
          <input type="password" id="authLoginPw" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" autocomplete="current-password" />
          <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.75rem;">
            <button type="button" class="auth-link-btn" id="btnFindId" style="background: none; border: none; color: var(--accent); cursor: pointer; padding: 0;">ÏïÑÏù¥Îîî Ï∞æÍ∏∞</button>
            <button type="button" class="auth-link-btn" id="btnFindPw" style="background: none; border: none; color: var(--accent); cursor: pointer; padding: 0;">ÎπÑÎ∞ÄÎ≤àÌò∏ Ï∞æÍ∏∞</button>
          </div>
          <button type="button" class="btn-auth-submit" id="btnAuthLogin">Î°úÍ∑∏Ïù∏</button>
          <div class="auth-divider">
            <span>ÎòêÎäî</span>
          </div>
          <button type="button" class="btn-social btn-kakao" id="btnKakaoLogin">
            <span>Ïπ¥Ïπ¥Ïò§Î°ú ÏãúÏûëÌïòÍ∏∞</span>
          </button>
          <button type="button" class="btn-social btn-google" id="btnGoogleLogin">
            <span>Íµ¨Í∏ÄÎ°ú ÏãúÏûëÌïòÍ∏∞</span>
          </button>
        </div>
        <div id="authSignupPanel" class="auth-panel" style="display:none;">
          <label>ÎãâÎÑ§ÏûÑ</label>
          <input type="text" id="authSignupNick" placeholder="2~12Ïûê" maxlength="12" inputmode="text" autocomplete="username" />
          <label>Ïù¥Î©îÏùº <span style="color: #ef4444;">*</span></label>
          <input type="email" id="authSignupEmail" placeholder="example@email.com" required inputmode="email" autocomplete="email" />
          <label>ÎπÑÎ∞ÄÎ≤àÌò∏</label>
          <input type="password" id="authSignupPw" placeholder="6Ïûê Ïù¥ÏÉÅ" autocomplete="new-password" />
          <label>ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏</label>
          <input type="password" id="authSignupPw2" placeholder="Îã§Ïãú ÏûÖÎ†•" autocomplete="new-password" />
          <button type="button" class="btn-auth-submit" id="btnAuthSignup">Í∞ÄÏûÖÌïòÍ∏∞</button>
          <div class="auth-divider">
            <span>ÎòêÎäî</span>
          </div>
          <button type="button" class="btn-social btn-kakao" id="btnKakaoSignup">
            <span>Ïπ¥Ïπ¥Ïò§Î°ú ÏãúÏûëÌïòÍ∏∞</span>
          </button>
          <button type="button" class="btn-social btn-google" id="btnGoogleSignup">
            <span>Íµ¨Í∏ÄÎ°ú ÏãúÏûëÌïòÍ∏∞</span>
          </button>
        </div>
        <div id="authFindIdPanel" class="auth-panel" style="display:none;">
          <label>Ïù¥Î©îÏùº</label>
          <input type="email" id="authFindIdEmail" placeholder="Í∞ÄÏûÖ Ïãú ÏûÖÎ†•Ìïú Ïù¥Î©îÏùº" inputmode="email" autocomplete="email" />
          <button type="button" class="btn-auth-submit" id="btnFindIdSubmit">ÏïÑÏù¥Îîî Ï∞æÍ∏∞</button>
          <div id="findIdResult" style="margin-top: 1rem; padding: 0.75rem; background: var(--bg-soft); border-radius: var(--radius); display: none;"></div>
          <button type="button" class="auth-link-btn" id="btnBackToLogin" style="width: 100%; margin-top: 0.5rem; background: none; border: none; color: var(--accent); cursor: pointer; padding: 0.5rem;">‚Üê Î°úÍ∑∏Ïù∏ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</button>
        </div>
        <div id="authFindPwPanel" class="auth-panel" style="display:none;">
          <label>Ïù¥Î©îÏùº</label>
          <input type="email" id="authFindPwEmail" placeholder="Í∞ÄÏûÖ Ïãú ÏûÖÎ†•Ìïú Ïù¥Î©îÏùº" inputmode="email" autocomplete="email" />
          <button type="button" class="btn-auth-submit" id="btnFindPwSubmit">ÎπÑÎ∞ÄÎ≤àÌò∏ Ïû¨ÏÑ§Ï†ï ÎßÅÌÅ¨ Î∞úÏÜ°</button>
          <div id="findPwResult" style="margin-top: 1rem; padding: 0.75rem; background: var(--bg-soft); border-radius: var(--radius); display: none;"></div>
          <div id="authResetPwPanel" style="display:none; margin-top: 1rem;">
            <label>Ïû¨ÏÑ§Ï†ï ÌÜ†ÌÅ∞</label>
            <input type="text" id="authResetToken" placeholder="Ïù¥Î©îÏùºÎ°ú Î∞õÏùÄ ÌÜ†ÌÅ∞ ÏûÖÎ†•" />
            <label>ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏</label>
            <input type="password" id="authResetPw" placeholder="6Ïûê Ïù¥ÏÉÅ" autocomplete="new-password" />
            <label>ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏</label>
            <input type="password" id="authResetPw2" placeholder="Îã§Ïãú ÏûÖÎ†•" autocomplete="new-password" />
            <button type="button" class="btn-auth-submit" id="btnResetPwSubmit">ÎπÑÎ∞ÄÎ≤àÌò∏ Ïû¨ÏÑ§Ï†ï</button>
          </div>
          <button type="button" class="auth-link-btn" id="btnBackToLogin2" style="width: 100%; margin-top: 0.5rem; background: none; border: none; color: var(--accent); cursor: pointer; padding: 0.5rem;">‚Üê Î°úÍ∑∏Ïù∏ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</button>
        </div>
        <p class="auth-hint">‚Äª ÎπÑÎ∞ÄÎ≤àÌò∏Îäî ÏÑúÎ≤ÑÏóêÏÑú ÏïîÌò∏ÌôîÎêòÏñ¥ Ï†ÄÏû•ÎêòÎ©∞, Í≤åÏûÑ Îç∞Ïù¥ÌÑ∞Îäî DBÏóê ÎèôÍ∏∞ÌôîÎê©ÎãàÎã§.</p>
        <button type="button" class="auth-close" id="authClose" aria-label="Îã´Í∏∞">‚úï</button>
      </div>
    </div>
    
    <!-- ÎèôÎ¨º ÏÑ†ÌÉù Î™®Îã¨ -->
    <div class="auth-overlay" id="petSelectOverlay" style="display:none;" role="dialog" aria-modal="true">
      <div class="pet-select-modal">
        <h2 class="auth-title">ÎèôÎ¨º ÏπúÍµ¨ ÏÑ†ÌÉùÌïòÍ∏∞</h2>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem;">Í±∏ÏùåÏùÑ Í±∏Ïñ¥ Ìï®Íªò ÏÑ±Ïû•Ìï† ÎèôÎ¨º ÏπúÍµ¨Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!</p>
        <div class="pet-grid" id="petGrid"></div>
        <button type="button" class="btn-auth-submit" id="btnConfirmPet" style="margin-top: 1rem;">ÏÑ†ÌÉùÌïòÍ∏∞</button>
        <button type="button" class="auth-close" id="petSelectClose" aria-label="Îã´Í∏∞">‚úï</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="alert"></div>

  <script>
(function () {
  const GOAL = 10000;
  var API_BASE = (typeof location !== 'undefined' && location.protocol === 'file:') ? 'http://localhost:3000' : '';
  const TOKEN_KEY = 'walk_token';
  function getAuthToken() { try { return localStorage.getItem(TOKEN_KEY); } catch (e) { return null; } }
  function setAuthToken(t) { try { if (t) localStorage.setItem(TOKEN_KEY, t); else localStorage.removeItem(TOKEN_KEY); } catch (e) {} }
  function clearAuthToken() { setAuthToken(null); }
  const STORAGE_KEYS = {
    pet: 'walk_pet',
    steps: 'pedometer_steps',
    date: 'pedometer_date',
    lifetime: 'walk_lifetime_steps',
    avatar: 'walk_avatar',
    inventory: 'walk_inventory',
    equipped: 'walk_equipped',
    claimed: 'walk_claimed_routes',
    courseGoal: 'walk_course_goal_km',
    totalXp: 'walk_total_xp',
    supplyDate: 'walk_supply_date',
    supplyCount: 'walk_supply_count',
    userRoutes: 'walk_user_routes',
    gold: 'walk_gold',
    theme: 'walk_theme',
    totalWalkKm: 'walk_total_km',
    currentTitle: 'walk_current_title',
    storage: 'walk_storage',
    questProgress: 'walk_quest_progress',
    questDate: 'walk_quest_date',
    sharedDate: 'walk_shared_date',
    user: 'walk_user',
    loggedIn: 'walk_logged_in',
    attendanceDate: 'walk_attendance_date',
    attendanceStreak: 'walk_attendance_streak'
  };
  var ATTENDANCE_DAILY_GOLD = [10, 15, 20, 25, 30, 40];
  var ATTENDANCE_7DAY_BOX_NAME = 'ÏúÑÌÅ¥Î¶¨ ÎßàÏä§ÌÑ∞ ÏÑ†Î¨ºÏÉÅÏûê';
  var ATTENDANCE_7DAY_GOLD = 100;
  const XP_PER_KM = 100;
  const GACHA_COST = 30;
  const GACHA_PREMIUM_COST = 60;
  const STARTING_GOLD = 500;
  const ENHANCE_MAX = 7;
  var ENHANCE_RATES = [95, 90, 85, 75, 60, 45, 30];
  var ENHANCE_ATTEMPT_GOLD = [0, 0, 0, 20, 35, 50, 50];
  var DAILY_QUESTS = [
    { id: 'q_steps', name: 'Í±∏Ïùå Í±∏Í∏∞', desc: 'Ïò§Îäò 3,000Í±∏Ïùå', goal: 3000, reward: 25, getProgress: function() { return steps; } },
    { id: 'q_walk', name: 'ÏÇ∞Ï±Ö ÏôÑÏ£º', desc: 'ÏΩîÏä§ 1Ìöå ÏôÑÏ£º', goal: 1, reward: 60, getProgress: function() { return userRoutes.filter(function(r){ return r.completedAt && new Date(r.completedAt).toISOString().slice(0,10) === todayStr(); }).length; } },
    { id: 'q_gacha', name: 'Î≥¥Í∏â ÎΩëÍ∏∞', desc: 'Î≥¥Í∏â 1Ìöå ÎΩëÍ∏∞', goal: 1, reward: 15, getProgress: function() { return questGachaCount; } },
    { id: 'q_share', name: 'ÎßÅÌÅ¨ Í≥µÏú†', desc: 'Ïπ¥Ïπ¥Ïò§ÌÜ° Îì±ÏúºÎ°ú Í≥µÏú†', goal: 1, reward: 40, getProgress: function() { return sharedToday ? 1 : 0; } }
  ];
  var questGachaCount = 0;
  var questClaimed = {};
  var sharedToday = false;
  var TITLES = [
    { id: 'walker', name: 'ÏÇ∞Ï±ÖÎü¨', minKm: 0 },
    { id: 'short', name: 'Îã®Í±∞Î¶¨ ÏÑ†Ïàò', minKm: 1 },
    { id: 'long', name: 'Ïû•Í±∞Î¶¨ ÏÑ†Ïàò', minKm: 10 },
    { id: 'marathon', name: 'ÎßàÎùºÌÜ†ÎÑà', minKm: 42.195 },
    { id: 'master', name: 'ÎßàÏä§ÌÑ∞ Îü¨ÎÑà', minKm: 100 }
  ];
  function getTitleForKm(km) {
    var t = TITLES[0];
    for (var i = TITLES.length - 1; i >= 0; i--) {
      if (km >= TITLES[i].minKm) { t = TITLES[i]; break; }
    }
    return t;
  }
  function xpToLevel(xp) {
    if (xp <= 0) return { level: 1, current: 0, need: 100 };
    var level = 1 + Math.floor(Math.sqrt(xp / 50));
    var prevXp = 50 * (level - 1) * (level - 1);
    var nextXp = 50 * level * level;
    return { level: level, current: xp - prevXp, need: nextXp - prevXp };
  }
  var ACHIEVEMENTS = [
    { id: 'first_walk', name: 'Ï≤´ Í±∏Ïùå', desc: 'Ï≤´ ÏÇ∞Ï±Ö ÏãúÏûë', icon: 'üë£', check: function() { return totalXp >= 10; } },
    { id: 'km1', name: '1km Îã¨ÏÑ±', desc: 'Ï¥ù 1km ÏÇ∞Ï±Ö', icon: 'üõ§Ô∏è', check: function() { return totalXp >= 100; } },
    { id: 'km5', name: '5km Îã¨ÏÑ±', desc: 'Ï¥ù 5km ÏÇ∞Ï±Ö', icon: 'üèÉ', check: function() { return totalXp >= 500; } },
    { id: 'course1', name: 'ÏΩîÏä§ ÏôÑÏ£º', desc: 'Ï≤´ ÏΩîÏä§ ÏôÑÏ£º', icon: 'üèÅ', check: function() { return (userRoutes.filter(function(r){ return r.completedAt; }).length) >= 1; } },
    { id: 'steps10k', name: 'ÎßåÎ≥¥ Îã¨Ïù∏', desc: 'ÌïòÎ£® 10,000Í±∏Ïùå', icon: 'üéØ', check: function() { return steps >= 10000 || lifetimeSteps >= 10000; } },
    { id: 'rare', name: 'Î†àÏñ¥ ÏàòÏßëÍ∞Ä', desc: 'Î†àÏñ¥ Ïù¥ÏÉÅ Ïû•ÎπÑ ÌöçÎìù', icon: '‚ú®', check: function() { return inventory.some(function(i){ return i.rarity === 'rare' || i.rarity === 'epic' || i.rarity === 'legend'; }); } },
    { id: 'legend', name: 'Î†àÏ†ÑÎìú', desc: 'Î†àÏ†ÑÎìú Ïû•ÎπÑ ÌöçÎìù', icon: 'üåü', check: function() { return inventory.some(function(i){ return i.rarity === 'legend'; }); } },
    { id: 'level5', name: 'Î†àÎ≤® 5', desc: 'Lv.5 Îã¨ÏÑ±', icon: '‚¨ÜÔ∏è', check: function() { return xpToLevel(totalXp).level >= 5; } }
  ];
  var RARITY_WEIGHTS = [60, 25, 12, 3];
  var RARITY_NAMES = ['common', 'rare', 'epic', 'legend'];
  var TIER_LABELS = { standard: 'Ïä§ÌÉ†Îã§Îìú', pro: 'ÌîÑÎ°ú', prime: 'ÌîÑÎùºÏûÑ', signature: 'ÏãúÍ∑∏ÎãàÏ≤ò' };
  var SUPPLY_POOL = [
    { id: 'shoe_1', name: 'Î†àÎ≥ºÎ£®ÏÖò', type: 'shoes', emoji: 'üëü', tier: 'standard' },
    { id: 'shoe_2', name: 'Îã§Ïö¥ÏãúÌîÑÌÑ∞', type: 'shoes', emoji: 'üëü', tier: 'standard' },
    { id: 'shoe_3', name: 'ÏúàÌîåÎ°ú', type: 'shoes', emoji: 'üëü', tier: 'standard' },
    { id: 'shoe_4', name: 'Í∞§Îü≠Ïãú Îü¨ÎãùÌôî', type: 'shoes', emoji: 'üëü', tier: 'standard' },
    { id: 'shoe_5', name: 'ÌéòÍ∞ÄÏàòÏä§', type: 'shoes', emoji: 'üëü', tier: 'pro' },
    { id: 'shoe_6', name: 'Î¶¨Ïï°Ìä∏', type: 'shoes', emoji: 'üëü', tier: 'pro' },
    { id: 'shoe_7', name: 'ÎÖ∏Î∞îÎ∏îÎùºÏä§Ìä∏', type: 'shoes', emoji: 'üëü', tier: 'pro' },
    { id: 'shoe_8', name: 'ÌÅ¥ÎùºÏö∞Îìú', type: 'shoes', emoji: 'üëü', tier: 'pro' },
    { id: 'shoe_9', name: 'ÌîÑÎùºÏûÑ', type: 'shoes', emoji: 'üëü', tier: 'prime' },
    { id: 'shoe_10', name: 'Ïö∏Ìä∏ÎùºÎ∂ÄÏä§Ìä∏', type: 'shoes', emoji: 'üëü', tier: 'prime' },
    { id: 'shoe_11', name: 'Ìò∏Ïπ¥ ÌÅ¥Î¶¨ÌîÑÌÜ§', type: 'shoes', emoji: 'üëü', tier: 'prime' },
    { id: 'shoe_12', name: 'Ï†§ Ïπ¥ÏïºÎÖ∏', type: 'shoes', emoji: 'üëü', tier: 'prime' },
    { id: 'shoe_13', name: 'ÏóîÎèåÌïÄ Ïä§ÌîºÎìú', type: 'shoes', emoji: 'üëü', tier: 'prime' },
    { id: 'shoe_14', name: 'ÏïåÌååÌîåÎùºÏù¥', type: 'shoes', emoji: 'üëü', tier: 'signature' },
    { id: 'shoe_15', name: 'Î≤†Ïù¥ÌçºÌîåÎùºÏù¥', type: 'shoes', emoji: 'üëü', tier: 'signature' },
    { id: 'shoe_16', name: 'ÏïÑÎîîÏ†úÎ°ú ÏïÑÎîîÏò§Ïä§ ÌîÑÎ°ú', type: 'shoes', emoji: 'üëü', tier: 'signature' },
    { id: 'shoe_17', name: 'Î©îÌÉÄÏä§ÌîºÎìú Ïä§Ïπ¥Ïù¥', type: 'shoes', emoji: 'üëü', tier: 'signature' },
    { id: 'watch_1', name: 'ÏÉ§Ïò§ÎØ∏ Î∞¥Îìú', type: 'accessory', emoji: '‚åö', tier: 'standard' },
    { id: 'watch_2', name: 'Í∞§Îü≠Ïãú Ìïè', type: 'accessory', emoji: '‚åö', tier: 'standard' },
    { id: 'watch_3', name: 'ÎØ∏Î∞¥Îìú', type: 'accessory', emoji: '‚åö', tier: 'standard' },
    { id: 'watch_4', name: 'ÌïèÎπó Ï∞®ÏßÄ', type: 'accessory', emoji: '‚åö', tier: 'pro' },
    { id: 'watch_5', name: 'Í∞§Îü≠Ïãú ÏõåÏπò', type: 'accessory', emoji: '‚åö', tier: 'pro' },
    { id: 'watch_6', name: 'Ïï†ÌîåÏõåÏπò SE', type: 'accessory', emoji: '‚åö', tier: 'pro' },
    { id: 'watch_7', name: 'Í∞ÄÎØº Ìè¨Îü¨ÎÑà', type: 'accessory', emoji: '‚åö', tier: 'prime' },
    { id: 'watch_8', name: 'Í∞ÄÎØº Î≤†Îâ¥', type: 'accessory', emoji: '‚åö', tier: 'prime' },
    { id: 'watch_9', name: 'Ïï†ÌîåÏõåÏπò Ïö∏Ìä∏Îùº', type: 'accessory', emoji: '‚åö', tier: 'prime' },
    { id: 'watch_10', name: 'Í∞ÄÎØº ÌîºÎãâÏä§', type: 'accessory', emoji: '‚åö', tier: 'signature' },
    { id: 'watch_11', name: 'ÏΩîÎ°úÏä§ Î≤ÑÌÖçÏä§', type: 'accessory', emoji: '‚åö', tier: 'signature' },
    { id: 'watch_12', name: 'ÏàúÌÜ† Î≤ÑÌã∞Ïª¨', type: 'accessory', emoji: '‚åö', tier: 'signature' },
    { id: 'ear_1', name: 'QCY', type: 'accessory', emoji: 'üéß', tier: 'standard' },
    { id: 'ear_2', name: 'ÏÉ§Ïò§ÎØ∏ Î≤ÑÏ¶à', type: 'accessory', emoji: 'üéß', tier: 'standard' },
    { id: 'ear_3', name: 'Ïú†ÏÑ† Ïä§Ìè¨Ï∏† Ïù¥Ïñ¥Ìè∞', type: 'accessory', emoji: 'üéß', tier: 'standard' },
    { id: 'ear_4', name: 'ÏóêÏñ¥Ìåü', type: 'accessory', emoji: 'üéß', tier: 'pro' },
    { id: 'ear_5', name: 'Í∞§Îü≠Ïãú Î≤ÑÏ¶à', type: 'accessory', emoji: 'üéß', tier: 'pro' },
    { id: 'ear_6', name: 'Ï†úÏù¥Î≤ÑÎìú', type: 'accessory', emoji: 'üéß', tier: 'pro' },
    { id: 'ear_7', name: 'Î≥¥Ïä§ Ïä§Ìè¨Ï∏†', type: 'accessory', emoji: 'üéß', tier: 'prime' },
    { id: 'ear_8', name: 'ÏÉ•Ï¶à Ïò§ÌîàÎü∞', type: 'accessory', emoji: 'üéß', tier: 'prime' },
    { id: 'ear_9', name: 'Ï††ÌïòÏù¥Ï†Ä Ïä§Ìè¨Ï∏†', type: 'accessory', emoji: 'üéß', tier: 'prime' },
    { id: 'ear_10', name: 'ÏÉ•Ï¶à Ïò§ÌîàÎü∞ ÌîÑÎ°ú', type: 'accessory', emoji: 'üéß', tier: 'signature' },
    { id: 'ear_11', name: 'Î≥¥Ïä§ Ïö∏Ìä∏Îùº', type: 'accessory', emoji: 'üéß', tier: 'signature' },
    { id: 'ear_12', name: 'ÏÜåÎãà XM', type: 'accessory', emoji: 'üéß', tier: 'signature' },
    { id: 'bag_1', name: 'ÎÇòÏù¥ÌÇ§ Ïä¨ÎßÅÎ∞±', type: 'accessory', emoji: 'üéí', tier: 'standard' },
    { id: 'bag_2', name: 'Îç∞Ïπ¥Ìä∏Î°† Î∞±', type: 'accessory', emoji: 'üéí', tier: 'standard' },
    { id: 'bag_3', name: 'ÎØ∏Îãà Ïõ®Ïù¥Ïä§Ìä∏Î∞±', type: 'accessory', emoji: 'üéí', tier: 'standard' },
    { id: 'bag_4', name: 'ÎÇòÏù¥ÌÇ§ Îü¨Îãù Î≤†Ïä§Ìä∏', type: 'accessory', emoji: 'üéí', tier: 'pro' },
    { id: 'bag_5', name: 'ÏÇ¥Î°úÎ™¨ Ïï°Ìã∞Î∏å', type: 'accessory', emoji: 'üéí', tier: 'pro' },
    { id: 'bag_6', name: 'Ïñ∏ÎçîÏïÑÎ®∏ Îü¨ÎãùÎ∞±', type: 'accessory', emoji: 'üéí', tier: 'pro' },
    { id: 'bag_7', name: 'Ïò§Ïä§ÌîÑÎ¶¨ ÌÉ§Îü∞', type: 'accessory', emoji: 'üéí', tier: 'prime' },
    { id: 'bag_8', name: 'ÏÇ¥Î°úÎ™¨ ADV Ïä§ÌÇ®', type: 'accessory', emoji: 'üéí', tier: 'prime' },
    { id: 'bag_9', name: 'ÎÖ∏Ïä§ÌéòÏù¥Ïä§ Îü¨ÎãùÌå©', type: 'accessory', emoji: 'üéí', tier: 'prime' },
    { id: 'bag_10', name: 'ÏïÑÌÅ¨ÌÖåÎ¶≠Ïä§ Î∞±Ìå©', type: 'accessory', emoji: 'üéí', tier: 'signature' },
    { id: 'bag_11', name: 'ÏÇ¥Î°úÎ™¨ S/LAB', type: 'accessory', emoji: 'üéí', tier: 'signature' },
    { id: 'bag_12', name: 'ÌååÌÉÄÍ≥†ÎãàÏïÑ ÌÖåÌÅ¨Ìå©', type: 'accessory', emoji: 'üéí', tier: 'signature' },
    { id: 'top_1', name: 'ÎìúÎùºÏù¥Ìïè Ìã∞', type: 'top', emoji: 'üëï', tier: 'standard' },
    { id: 'top_2', name: 'Ïø®Î°† Ìã∞', type: 'top', emoji: 'üëï', tier: 'standard' },
    { id: 'top_3', name: 'ÏóêÏñ¥Î¶¨Ï¶ò', type: 'top', emoji: 'üëï', tier: 'standard' },
    { id: 'top_4', name: 'Ïñ∏ÎçîÏïÑÎ®∏ ÌÖåÌÅ¨Ìïè', type: 'top', emoji: 'üëï', tier: 'pro' },
    { id: 'top_5', name: 'ÎÇòÏù¥ÌÇ§ Îü¨Îãù ÌÉë', type: 'top', emoji: 'üëï', tier: 'pro' },
    { id: 'top_6', name: 'ÏïÑÎîîÎã§Ïä§ ÏóêÏñ¥Î°úÎ†àÎîî', type: 'top', emoji: 'üëï', tier: 'pro' },
    { id: 'top_7', name: 'ÎÇòÏù¥ÌÇ§ ÎìúÎùºÏù¥Ìïè ADV', type: 'top', emoji: 'üëï', tier: 'prime' },
    { id: 'top_8', name: 'Î£∞Î£®Î†àÎ™¨ Îü¨ÎãùÌÉë', type: 'top', emoji: 'üëï', tier: 'prime' },
    { id: 'top_9', name: 'ÌååÌÉÄÍ≥†ÎãàÏïÑ Îü¨ÎãùÌÉë', type: 'top', emoji: 'üëï', tier: 'prime' },
    { id: 'top_10', name: 'ÏïÑÌÅ¨ÌÖåÎ¶≠Ïä§ ÌîÑÎ°úÌÜ§', type: 'top', emoji: 'üëï', tier: 'signature' },
    { id: 'top_11', name: 'ÏïÑÌÅ¨ÌÖåÎ¶≠Ïä§ ÏΩîÏñ¥Î°úÌîÑÌä∏', type: 'top', emoji: 'üëï', tier: 'signature' },
    { id: 'top_12', name: 'ÎÖ∏Ïä§ÌéòÏù¥Ïä§ ÏÑúÎ∞ã', type: 'top', emoji: 'üëï', tier: 'signature' },
    { id: 'bottom_1', name: 'Îü¨Îãù ÏáºÏ∏†', type: 'bottom', emoji: 'üëñ', tier: 'standard' },
    { id: 'bottom_2', name: 'Ïø®Î°† Ìå¨Ï∏†', type: 'bottom', emoji: 'üëñ', tier: 'standard' },
    { id: 'bottom_3', name: 'Ìä∏Î†àÏù¥Îãù Ìå¨Ï∏†', type: 'bottom', emoji: 'üëñ', tier: 'standard' },
    { id: 'bottom_4', name: 'ÎÇòÏù¥ÌÇ§ ÌîåÎ†âÏä§', type: 'bottom', emoji: 'üëñ', tier: 'pro' },
    { id: 'bottom_5', name: 'Ïñ∏ÎçîÏïÑÎ®∏ Îü¨Îãù ÏáºÏ∏†', type: 'bottom', emoji: 'üëñ', tier: 'pro' },
    { id: 'bottom_6', name: 'ÏïÑÎîîÎã§Ïä§ Îü¨Îãù ÌÉÄÏù¥Ï∏†', type: 'bottom', emoji: 'üëñ', tier: 'pro' },
    { id: 'bottom_7', name: 'Î£∞Î£® ÏÑúÏßÄ', type: 'bottom', emoji: 'üëñ', tier: 'prime' },
    { id: 'bottom_8', name: 'ÎÇòÏù¥ÌÇ§ ADV Ìå¨Ï∏†', type: 'bottom', emoji: 'üëñ', tier: 'prime' },
    { id: 'bottom_9', name: '2XU Ïª¥ÌîÑÎ†àÏÖò', type: 'bottom', emoji: 'üëñ', tier: 'prime' },
    { id: 'bottom_10', name: 'ÏïÑÌÅ¨ÌÖåÎ¶≠Ïä§ Í∞êÎßà', type: 'bottom', emoji: 'üëñ', tier: 'signature' },
    { id: 'bottom_11', name: 'ÏïÑÌÅ¨ÌÖåÎ¶≠Ïä§ Îü¨Îãù ÌÉÄÏù¥Ï∏†', type: 'bottom', emoji: 'üëñ', tier: 'signature' },
    { id: 'bottom_12', name: 'CEP ÌîÑÎ°úÎùºÏù∏', type: 'bottom', emoji: 'üëñ', tier: 'signature' },
    { id: 'guard_1', name: 'ÏùºÎ∞ò Î¨¥Î¶é Î≥¥Ìò∏ÎåÄ', type: 'guard', emoji: 'üõ°', tier: 'standard' },
    { id: 'guard_2', name: 'Í∏∞Î≥∏ ÏïïÎ∞ï Ïä¨Î¶¨Î∏å', type: 'guard', emoji: 'üõ°', tier: 'standard' },
    { id: 'guard_3', name: 'Îß•Îç∞Ïù¥ÎπÑÎìú', type: 'guard', emoji: 'üõ°', tier: 'pro' },
    { id: 'guard_4', name: 'ÎÇòÏù¥ÌÇ§ ÌîÑÎ°ú', type: 'guard', emoji: 'üõ°', tier: 'pro' },
    { id: 'guard_5', name: '2XU', type: 'guard', emoji: 'üõ°', tier: 'prime' },
    { id: 'guard_6', name: 'Ïä§ÌÇ®Ïä§', type: 'guard', emoji: 'üõ°', tier: 'prime' },
    { id: 'guard_7', name: 'CEP', type: 'guard', emoji: 'üõ°', tier: 'signature' },
    { id: 'guard_8', name: 'BV SPORT', type: 'guard', emoji: 'üõ°', tier: 'signature' },
    { id: 'glove_1', name: 'Í∏∞Î≥∏ Îü¨Îãù Ïû•Í∞ë', type: 'accessory', emoji: 'üß§', tier: 'standard' },
    { id: 'glove_2', name: 'ÌÑ∞Ïπò Ïû•Í∞ë', type: 'accessory', emoji: 'üß§', tier: 'standard' },
    { id: 'glove_3', name: 'ÎÇòÏù¥ÌÇ§ Îü¨ÎãùÍ∏ÄÎü¨Î∏å', type: 'accessory', emoji: 'üß§', tier: 'pro' },
    { id: 'glove_4', name: 'Ïñ∏ÎçîÏïÑÎ®∏ Ïû•Í∞ë', type: 'accessory', emoji: 'üß§', tier: 'pro' },
    { id: 'glove_5', name: 'Î∏îÎûôÎã§Ïù¥ÏïÑÎ™¨Îìú', type: 'accessory', emoji: 'üß§', tier: 'prime' },
    { id: 'glove_6', name: 'ÎÖ∏Ïä§ÌéòÏù¥Ïä§ Îü¨ÎãùÍ∏ÄÎü¨Î∏å', type: 'accessory', emoji: 'üß§', tier: 'prime' },
    { id: 'glove_7', name: 'Ìó§Ïä§Ìä∏Îùº', type: 'accessory', emoji: 'üß§', tier: 'signature' },
    { id: 'glove_8', name: 'ÏïÑÌÅ¨ÌÖåÎ¶≠Ïä§ Í∏ÄÎü¨Î∏å', type: 'accessory', emoji: 'üß§', tier: 'signature' },
    { id: 'outer_1', name: 'Î∞îÎûåÎßâÏù¥', type: 'top', emoji: 'üß•', tier: 'standard' },
    { id: 'outer_2', name: 'Í≤ΩÎüâ ÏûêÏºì', type: 'top', emoji: 'üß•', tier: 'standard' },
    { id: 'outer_3', name: 'ÎÇòÏù¥ÌÇ§ Îü¨Îãù ÏûêÏºì', type: 'top', emoji: 'üß•', tier: 'pro' },
    { id: 'outer_4', name: 'ÏïÑÎîîÎã§Ïä§ ÏúàÎìúÏûêÏºì', type: 'top', emoji: 'üß•', tier: 'pro' },
    { id: 'outer_5', name: 'ÌååÌÉÄÍ≥†ÎãàÏïÑ ÌõÑÎîîÎãà', type: 'top', emoji: 'üß•', tier: 'prime' },
    { id: 'outer_6', name: 'ÎÖ∏Ïä§ÌéòÏù¥Ïä§ ÌîåÎùºÏù¥Ìä∏', type: 'top', emoji: 'üß•', tier: 'prime' },
    { id: 'outer_7', name: 'ÏïÑÌÅ¨ÌÖåÎ¶≠Ïä§ ÏïåÌåå', type: 'top', emoji: 'üß•', tier: 'signature' },
    { id: 'outer_8', name: 'ÏïÑÌÅ¨ÌÖåÎ¶≠Ïä§ Î≤†ÌÉÄ', type: 'top', emoji: 'üß•', tier: 'signature' },
    { id: 'outer_9', name: 'ÎÖ∏Ïä§ÌéòÏù¥Ïä§ ÏÑúÎ∞ã ÏãúÎ¶¨Ï¶à', type: 'top', emoji: 'üß•', tier: 'signature' }
  ];

  const ROUTES = [
    { id: 'r1', name: 'ÎèôÎÑ§ Í≥®Î™©', steps: 500, icon: 'üèòÔ∏è', reward: { id: 'shoe_1', name: 'Î†àÎ≥ºÎ£®ÏÖò', type: 'shoes', emoji: 'üëü', tier: 'standard' } },
    { id: 'r2', name: 'ÏûëÏùÄ Í≥µÏõê', steps: 1000, icon: 'üå≥', reward: { id: 'top_1', name: 'ÎìúÎùºÏù¥Ìïè Ìã∞', type: 'top', emoji: 'üëï', tier: 'standard' } },
    { id: 'r3', name: 'ÏãúÎÇ¥ ÏÇ∞Ï±ÖÎ°ú', steps: 2000, icon: 'üõ§Ô∏è', reward: { id: 'shoe_5', name: 'ÌéòÍ∞ÄÏàòÏä§', type: 'shoes', emoji: 'üëü', tier: 'pro' } },
    { id: 'r4', name: 'Í∞ïÎëë Í∏∏', steps: 3500, icon: 'üåä', reward: { id: 'top_4', name: 'Ïñ∏ÎçîÏïÑÎ®∏ ÌÖåÌÅ¨Ìïè', type: 'top', emoji: 'üëï', tier: 'pro' } },
    { id: 'r5', name: 'Ïà≤ ÏûÖÍµ¨', steps: 5000, icon: 'üå≤', reward: { id: 'watch_4', name: 'ÌïèÎπó Ï∞®ÏßÄ', type: 'accessory', emoji: '‚åö', tier: 'pro' } },
    { id: 'r6', name: 'Ìò∏Ïàò ÎëòÎ†àÍ∏∏', steps: 7500, icon: 'üèûÔ∏è', reward: { id: 'ear_4', name: 'ÏóêÏñ¥Ìåü', type: 'accessory', emoji: 'üéß', tier: 'pro' } },
    { id: 'r7', name: 'Îì±ÏÇ∞Î°ú Ï†ïÏÉÅ', steps: 10000, icon: '‚õ∞Ô∏è', reward: { id: 'shoe_14', name: 'ÏïåÌååÌîåÎùºÏù¥', type: 'shoes', emoji: 'üëü', tier: 'signature' } }
  ];

  const SLOT_ORDER = ['shoes', 'watch', 'earphones', 'bag', 'top', 'bottom', 'guard', 'glove', 'outer'];
  const SLOT_LABELS = { shoes: 'üëü Ïã†Î∞ú', watch: '‚åö ÏãúÍ≥Ñ/ÎîîÎ∞îÏù¥Ïä§', earphones: 'üéß Ïù¥Ïñ¥Ìè∞', bag: 'üéí Í∞ÄÎ∞©/Îü¨ÎãùÎ≤†Ïä§Ìä∏', top: 'üëï ÏÉÅÏùò', bottom: 'üëñ ÌïòÏùò', guard: 'üõ° Î≥¥Ìò∏ÎåÄ/Ïª¥ÌîÑÎ†àÏÖò', glove: 'üß§ Ïû•Í∞ë', outer: 'üß• ÏïÑÏö∞ÌÑ∞' };
  var TIER_WEIGHTS = { standard: 50, pro: 30, prime: 15, signature: 5 };
  /* Í±∏Ïùå Î≥¥ÎÑàÏä§ Ï†úÍ±∞: Î™©Ìëú Í±∏Ïùå/Í±∞Î¶¨ Ï†ïÌôïÎèÑ Ïú†ÏßÄÎ•º ÏúÑÌï¥ step Î≥¥ÎÑàÏä§ ÏóÜÏùå */
  var SLOT_BONUS_TYPE = { shoes: 'distance', watch: 'gold', earphones: 'gold', bag: 'xp', top: 'xp', bottom: 'xp', guard: 'xp', glove: 'xp', outer: 'xp' };
  var TIER_PERCENT = { standard: 1, pro: 2, prime: 3, signature: 5 };
  var SLOT_BONUS_LABEL = { xp: 'XP Î≥¥ÎÑàÏä§', distance: 'Ïù¥Îèô Í±∞Î¶¨', gold: 'Í≥®Îìú Î≥¥ÎÑàÏä§' };
  function itemSlot(item) {
    if (!item || !item.id) return 'top';
    var id = item.id.replace(/_\d+$/, '');
    if (id.indexOf('shoe') === 0) return 'shoes';
    if (id.indexOf('watch') === 0) return 'watch';
    if (id.indexOf('ear') === 0) return 'earphones';
    if (id.indexOf('bag') === 0) return 'bag';
    if (id.indexOf('outer') === 0) return 'outer';
    if (id.indexOf('top') === 0) return 'top';
    if (id.indexOf('bottom') === 0) return 'bottom';
    if (id.indexOf('guard') === 0) return 'guard';
    if (id.indexOf('glove') === 0) return 'glove';
    var t = item.type;
    if (t === 'shoes') return 'shoes';
    if (t === 'bottom') return 'bottom';
    if (t === 'guard') return 'guard';
    if (t === 'accessory') return 'watch';
    return 'top';
  }
  function getItemIcon(item) {
    if (!item || item.type === 'supply_kit') return 'üì¶';
    var slot = itemSlot(item);
    var icons = { shoes: ['üëü','ü•æ','üèÉ','‚ö°','üî•','üí®','‚ú®','üåü','‚≠ê','üí´','üéØ','üèÅ','üëü','ü•æ','üèÉ','‚ö°','üî•'], watch: ['‚åö','‚åö','‚åö','‚åö','‚åö','‚åö','‚åö','‚åö','‚åö','‚åö','‚åö','‚åö'], earphones: ['üéß','üéß','üéß','üéß','üéß','üéß','üéß','üéß','üéß','üéß','üéß','üéß'], bag: ['üéí','üéí','üéí','üéí','üéí','üéí','üéí','üéí','üéí','üéí','üéí','üéí'], top: ['üëï','üëï','üëï','üëï','üëï','üëï','üëï','üëï','üëï','üëï','üëï','üëï'], bottom: ['üëñ','ü©≥','üëñ','ü©≥','üëñ','ü©≥','üëñ','ü©≥','üëñ','ü©≥','üëñ','ü©≥'], guard: ['üõ°','üõ°','üõ°','üõ°','üõ°','üõ°','üõ°','üõ°'], glove: ['üß§','üß§','üß§','üß§','üß§','üß§','üß§','üß§'], outer: ['üß•','üß•','üß•','üß•','üß•','üß•','üß•','üß•','üß•'] };
    var arr = icons[slot] || ['üì¶'];
    var baseId = (item.id || '').replace(/_\d+$/, '');
    var h = 0; for (var i = 0; i < baseId.length; i++) h = (h * 31 + baseId.charCodeAt(i)) | 0;
    return arr[Math.abs(h) % arr.length];
  }
  function getEquipmentBonus() {
    var b = { xp: 0, distance: 0, gold: 0, step: 0 };
    SLOT_ORDER.forEach(function(slot) {
      var itemId = equipped[slot];
      var item = itemId ? inventory.find(function(i){ return i.id === itemId; }) : null;
      if (!item) return;
      var pct = TIER_PERCENT[item.tier] || 1;
      var typ = SLOT_BONUS_TYPE[slot];
      if (typ && b[typ] !== undefined) b[typ] += pct;
    });
    return b;
  }
  function pickItemByTierWeight(premium) {
    var w = premium ? { standard: 35, pro: 30, prime: 22, signature: 13 } : TIER_WEIGHTS;
    var r = Math.random() * 100;
    var tier = 'standard';
    if (r < w.standard) tier = 'standard';
    else if (r < w.standard + w.pro) tier = 'pro';
    else if (r < w.standard + w.pro + w.prime) tier = 'prime';
    else tier = 'signature';
    var pool = SUPPLY_POOL.filter(function(i){ return (i.tier || 'standard') === tier; });
    if (pool.length === 0) pool = SUPPLY_POOL;
    return pool[Math.floor(Math.random() * pool.length)];
  }
  function rollRarityPremium() {
    var r = Math.random() * 100;
    if (r < 40) return 'common';
    if (r < 72) return 'rare';
    if (r < 92) return 'epic';
    return 'legend';
  }

  let steps = 0, lastDate = '', lifetimeSteps = 0;
  // ÎèôÎ¨º Îç∞Ïù¥ÌÑ∞
  const PET_TYPES = [
    { id: 'dog', name: 'Í∞ïÏïÑÏßÄ', emoji: 'üêï', description: 'Ï∂©Ïã§ÌïòÍ≥† ÌôúÎ∞úÌïú ÏπúÍµ¨', color: '#fbbf24' },
    { id: 'cat', name: 'Í≥†ÏñëÏù¥', emoji: 'üê±', description: 'Ïö∞ÏïÑÌïòÍ≥† ÎèÖÎ¶ΩÏ†ÅÏù∏ ÏπúÍµ¨', color: '#f97316' },
    { id: 'lion', name: 'ÏÇ¨Ïûê', emoji: 'ü¶Å', description: 'Ïö©ÎßπÌïòÍ≥† ÎãπÎãπÌïú ÏπúÍµ¨', color: '#eab308' },
    { id: 'rabbit', name: 'ÌÜ†ÎÅº', emoji: 'üê∞', description: 'Í∑ÄÏóΩÍ≥† ÎØºÏ≤©Ìïú ÏπúÍµ¨', color: '#fda4af' },
    { id: 'bear', name: 'Í≥∞', emoji: 'üêª', description: 'ÌûòÏ∞®Í≥† Îì†Îì†Ìïú ÏπúÍµ¨', color: '#92400e' },
    { id: 'panda', name: 'ÌåêÎã§', emoji: 'üêº', description: 'ÌèâÌôîÎ°≠Í≥† ÏÇ¨ÎûëÏä§Îü¨Ïö¥ ÏπúÍµ¨', color: '#ffffff' },
    { id: 'fox', name: 'Ïó¨Ïö∞', emoji: 'ü¶ä', description: 'ÏòÅÎ¶¨ÌïòÍ≥† ÍµêÌôúÌïú ÏπúÍµ¨', color: '#f97316' },
    { id: 'tiger', name: 'Ìò∏ÎûëÏù¥', emoji: 'üêØ', description: 'Í∞ïÏù∏ÌïòÍ≥† Ïö©ÎßπÌïú ÏπúÍµ¨', color: '#fbbf24' }
  ];
  
  let pet = { type: null, level: 1, exp: 0, name: '' }; // ÏÑ†ÌÉùÌïú ÎèôÎ¨º Ï†ïÎ≥¥
  
  let avatar = { name: 'ÏÇ∞Ï±ÖÎü¨', skin: '#f5d0b0', hair: 'short', hairColor: '#4a3728' };
  let inventory = [];
  var storage = [];
  let equipped = { shoes: null, watch: null, earphones: null, bag: null, top: null, bottom: null, guard: null, glove: null, outer: null };
  let claimedRoutes = [];
  var userRoutes = [];
  var activeRouteId = null;
  var activeRouteGoalKm = 0;
  var walkState = 'idle';
  var courseGoalKm = 1;
  var totalXp = 0;
  var pathCoords = [];
  var sessionDistanceKm = 0;
  var sessionXp = 0;
  var watchId = null;
  var lastPositionTime = 0;
  var MIN_SEGMENT_KM = 0.005;
  var MAX_SPEED_KMH = 12;
  var supplyDateToday = '';
  var supplyCountToday = 0;
  var walkMapEl = null;
  var walkMapPathEl = null;
  var walkMapCharEl = null;
  var DEFAULT_BOUNDS = { minLat: 37.4, maxLat: 37.6, minLon: 126.9, maxLon: 127.2 };
  function ourMapBounds(coords) {
    if (!coords || coords.length === 0) return null;
    var minLat = coords[0].lat, maxLat = coords[0].lat, minLon = coords[0].lon, maxLon = coords[0].lon;
    coords.forEach(function(c) {
      if (c.lat < minLat) minLat = c.lat;
      if (c.lat > maxLat) maxLat = c.lat;
      if (c.lon < minLon) minLon = c.lon;
      if (c.lon > maxLon) maxLon = c.lon;
    });
    var padLat = Math.max(0.002, (maxLat - minLat) * 0.15);
    var padLon = Math.max(0.003, (maxLon - minLon) * 0.15);
    return { minLat: minLat - padLat, maxLat: maxLat + padLat, minLon: minLon - padLon, maxLon: maxLon + padLon };
  }
  function ourMapLatLonToXY(lat, lon, bounds, w, h) {
    var x = ((lon - bounds.minLon) / (bounds.maxLon - bounds.minLon)) * w;
    var y = (1 - (lat - bounds.minLat) / (bounds.maxLat - bounds.minLat)) * h;
    return { x: x, y: y };
  }
  var gold = STARTING_GOLD;
  var totalWalkDistanceKm = 0;
  var currentTitleId = 'walker';
  var userProfile = null;
  var isLoggedIn = false;
  var lastAttendanceDate = '';
  var attendanceStreak = 0;

  function todayStr() {
    const d = new Date();
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
  }

  function loadAll() {
    try {
      const saved = localStorage.getItem(STORAGE_KEYS.steps);
      const savedDate = localStorage.getItem(STORAGE_KEYS.date);
      const today = todayStr();
      if (saved != null && savedDate === today) {
        steps = parseInt(saved, 10) || 0;
      } else {
        if (saved != null && savedDate) lifetimeSteps += parseInt(localStorage.getItem(STORAGE_KEYS.steps) || '0', 10);
        steps = 0;
        localStorage.setItem(STORAGE_KEYS.date, today);
      }
      lifetimeSteps = parseInt(localStorage.getItem(STORAGE_KEYS.lifetime) || '0', 10) + steps;
    } catch (e) {}
    try {
      const a = localStorage.getItem(STORAGE_KEYS.avatar);
      if (a) avatar = { ...avatar, ...JSON.parse(a) };
    } catch (e) {}
    try {
      const inv = localStorage.getItem(STORAGE_KEYS.inventory);
      if (inv) inventory = JSON.parse(inv);
    } catch (e) {}
    try {
      const eq = localStorage.getItem(STORAGE_KEYS.equipped);
      if (eq) {
        var parsed = JSON.parse(eq);
        SLOT_ORDER.forEach(function(s) { if (parsed[s] != null) equipped[s] = parsed[s]; });
        if (parsed.accessory != null && equipped.watch == null) equipped.watch = parsed.accessory;
        if (parsed.armor != null && equipped.top == null) equipped.top = parsed.armor;
        if (parsed.weapon != null && equipped.watch == null) equipped.watch = parsed.weapon;
      }
    } catch (e) {}
    try {
      var sd = localStorage.getItem(STORAGE_KEYS.supplyDate);
      var sc = localStorage.getItem(STORAGE_KEYS.supplyCount);
      var today = todayStr();
      if (sd === today && sc != null) {
        supplyDateToday = sd;
        supplyCountToday = parseInt(sc, 10) || 0;
      } else {
        supplyDateToday = today;
        supplyCountToday = 0;
      }
    } catch (e) {}
    try {
      const cr = localStorage.getItem(STORAGE_KEYS.claimed);
      if (cr) claimedRoutes = JSON.parse(cr);
    } catch (e) {}
    try {
      var cg = localStorage.getItem(STORAGE_KEYS.courseGoal);
      if (cg) courseGoalKm = parseFloat(cg) || 1;
      var tx = localStorage.getItem(STORAGE_KEYS.totalXp);
      if (tx) totalXp = parseInt(tx, 10) || 0;
    } catch (e) {}
    try {
      var ur = localStorage.getItem(STORAGE_KEYS.userRoutes);
      if (ur) userRoutes = JSON.parse(ur);
    } catch (e) {}
    try {
      var g = localStorage.getItem(STORAGE_KEYS.gold);
      if (g != null) { gold = parseInt(g, 10); if (gold === 0) gold = 500; }
      else gold = STARTING_GOLD;
    } catch (e) {}
    try {
      var tw = localStorage.getItem(STORAGE_KEYS.totalWalkKm);
      if (tw != null) totalWalkDistanceKm = parseFloat(tw);
    } catch (e) {}
    try {
      var ct = localStorage.getItem(STORAGE_KEYS.currentTitle);
      if (ct) currentTitleId = ct;
    } catch (e) {}
    try {
      var st = localStorage.getItem(STORAGE_KEYS.storage);
      if (st) storage = JSON.parse(st);
    } catch (e) {}
    try {
      var qd = localStorage.getItem(STORAGE_KEYS.questDate);
      var today = todayStr();
      if (qd === today) {
        var qc = localStorage.getItem(STORAGE_KEYS.questProgress);
        if (qc) questGachaCount = parseInt(qc, 10) || 0;
        var qcl = localStorage.getItem('walk_quest_claimed');
        if (qcl) questClaimed = JSON.parse(qcl);
      } else {
        questGachaCount = 0;
        questClaimed = {};
      }
    } catch (e) {}
    try {
      var sd = localStorage.getItem(STORAGE_KEYS.sharedDate);
      sharedToday = sd === todayStr();
    } catch (e) {}
    try {
      var ad = localStorage.getItem(STORAGE_KEYS.attendanceDate);
      var as = localStorage.getItem(STORAGE_KEYS.attendanceStreak);
      if (ad) lastAttendanceDate = ad;
      if (as != null) attendanceStreak = parseInt(as, 10) || 0;
    } catch (e) {}
    try {
      var p = localStorage.getItem(STORAGE_KEYS.pet);
      if (p) pet = { ...pet, ...JSON.parse(p) };
    } catch (e) {}
    var th = localStorage.getItem(STORAGE_KEYS.theme);
    if (th === 'morning' || th === 'night') document.body.setAttribute('data-theme', th);
    lastDate = todayStr();
  }

  function saveAll() {
    try {
      localStorage.setItem(STORAGE_KEYS.steps, String(steps));
      localStorage.setItem(STORAGE_KEYS.date, todayStr());
      localStorage.setItem(STORAGE_KEYS.lifetime, String(lifetimeSteps));
      localStorage.setItem(STORAGE_KEYS.avatar, JSON.stringify(avatar));
      localStorage.setItem(STORAGE_KEYS.inventory, JSON.stringify(inventory));
      localStorage.setItem(STORAGE_KEYS.equipped, JSON.stringify(equipped));
      localStorage.setItem(STORAGE_KEYS.storage, JSON.stringify(storage));
      localStorage.setItem(STORAGE_KEYS.claimed, JSON.stringify(claimedRoutes));
      localStorage.setItem(STORAGE_KEYS.courseGoal, String(courseGoalKm));
      localStorage.setItem(STORAGE_KEYS.totalXp, String(totalXp));
      if (supplyDateToday) localStorage.setItem(STORAGE_KEYS.supplyDate, supplyDateToday);
      localStorage.setItem(STORAGE_KEYS.supplyCount, String(supplyCountToday));
      localStorage.setItem(STORAGE_KEYS.userRoutes, JSON.stringify(userRoutes));
      localStorage.setItem(STORAGE_KEYS.gold, String(gold));
      localStorage.setItem(STORAGE_KEYS.totalWalkKm, String(totalWalkDistanceKm));
      localStorage.setItem(STORAGE_KEYS.currentTitle, currentTitleId);
      localStorage.setItem(STORAGE_KEYS.questDate, todayStr());
      localStorage.setItem(STORAGE_KEYS.questProgress, String(questGachaCount));
      localStorage.setItem('walk_quest_claimed', JSON.stringify(questClaimed));
      if (sharedToday) localStorage.setItem(STORAGE_KEYS.sharedDate, todayStr());
      localStorage.setItem(STORAGE_KEYS.attendanceDate, lastAttendanceDate);
      localStorage.setItem(STORAGE_KEYS.attendanceStreak, String(attendanceStreak));
      localStorage.setItem(STORAGE_KEYS.pet, JSON.stringify(pet));
    } catch (e) {}
    if (isLoggedIn && getAuthToken()) syncGameStateToServer();
  }
  function getGameStatePayload() {
    return {
      steps: steps,
      date: todayStr(),
      lifetimeSteps: lifetimeSteps,
      avatar: avatar,
      pet: pet,
      inventory: inventory,
      equipped: equipped,
      storage: storage,
      claimedRoutes: claimedRoutes,
      courseGoalKm: courseGoalKm,
      totalXp: totalXp,
      supplyDateToday: supplyDateToday,
      supplyCountToday: supplyCountToday,
      userRoutes: userRoutes,
      gold: gold,
      totalWalkDistanceKm: totalWalkDistanceKm,
      currentTitleId: currentTitleId,
      questDate: todayStr(),
      questProgress: questGachaCount,
      questClaimed: questClaimed,
      sharedDate: sharedToday ? todayStr() : '',
      lastAttendanceDate: lastAttendanceDate,
      attendanceStreak: attendanceStreak
    };
  }
  function applyGameState(obj) {
    if (!obj || typeof obj !== 'object') return;
    if (obj.steps != null) steps = obj.steps;
    if (obj.date != null) lastDate = obj.date;
    if (obj.lifetimeSteps != null) lifetimeSteps = obj.lifetimeSteps;
    if (obj.avatar && typeof obj.avatar === 'object') avatar = { ...avatar, ...obj.avatar };
    if (obj.pet && typeof obj.pet === 'object') pet = { ...pet, ...obj.pet };
    if (Array.isArray(obj.inventory)) inventory = obj.inventory;
    if (obj.equipped && typeof obj.equipped === 'object') { Object.keys(obj.equipped).forEach(function (k) { if (obj.equipped[k] != null) equipped[k] = obj.equipped[k]; }); }
    if (Array.isArray(obj.storage)) storage = obj.storage;
    if (Array.isArray(obj.claimedRoutes)) claimedRoutes = obj.claimedRoutes;
    if (obj.courseGoalKm != null) courseGoalKm = obj.courseGoalKm;
    if (obj.totalXp != null) totalXp = obj.totalXp;
    if (obj.supplyDateToday != null) supplyDateToday = obj.supplyDateToday;
    if (obj.supplyCountToday != null) supplyCountToday = obj.supplyCountToday;
    if (Array.isArray(obj.userRoutes)) userRoutes = obj.userRoutes;
    if (obj.gold != null) gold = obj.gold;
    if (obj.totalWalkDistanceKm != null) totalWalkDistanceKm = obj.totalWalkDistanceKm;
    if (obj.currentTitleId != null) currentTitleId = obj.currentTitleId;
    if (obj.questProgress != null) questGachaCount = obj.questProgress;
    if (obj.questClaimed && typeof obj.questClaimed === 'object') questClaimed = obj.questClaimed;
    if (obj.sharedDate != null) sharedToday = obj.sharedDate === todayStr();
    if (obj.lastAttendanceDate != null) lastAttendanceDate = obj.lastAttendanceDate;
    if (obj.attendanceStreak != null) attendanceStreak = obj.attendanceStreak;
    if (obj.pet && typeof obj.pet === 'object') {
      pet = { ...pet, ...obj.pet };
      renderPet();
    }
  }
  function syncGameStateToServer() {
    var token = getAuthToken();
    if (!token) return;
    var payload = getGameStatePayload();
    fetch(API_BASE + '/api/user/data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
      body: JSON.stringify(payload)
    }).catch(function () {});
  }
  function initAuth() {
    var token = getAuthToken();
    if (!token) return Promise.resolve();
    return fetch(API_BASE + '/api/user/me', { headers: { 'Authorization': 'Bearer ' + token } })
      .then(function (r) {
        if (!r.ok) { clearAuthToken(); return null; }
        return r.json();
      })
      .then(function (me) {
        if (!me) return null;
        userProfile = { id: me.id, nickname: me.nickname };
        isLoggedIn = true;
        return fetch(API_BASE + '/api/user/data', { headers: { 'Authorization': 'Bearer ' + token } });
      })
      .then(function (r) {
        if (!r) return null;
        return r.json();
      })
      .then(function (body) {
        if (body && body.data) {
          try {
            var data = typeof body.data === 'string' ? JSON.parse(body.data) : body.data;
            applyGameState(data);
            renderPet();
          } catch (e) {}
        }
      })
      .catch(function () { clearAuthToken(); });
  }

  function addStep() {
    steps++;
    lifetimeSteps++;
    // ÎèôÎ¨º Í≤ΩÌóòÏπò ÌöçÎìù (10Í±∏ÏùåÎãπ 1 Í≤ΩÌóòÏπò)
    if (steps % 10 === 0 && pet.type) {
      addPetExp(1);
    }
    saveAll();
    renderSteps();
    checkRouteRewards();
    var pw = document.getElementById('page-walk');
    var ps = document.getElementById('page-story');
    if (pw && pw.classList.contains('active')) { renderRoutes(); renderQuests(); }
    if (ps && ps.classList.contains('active')) renderStory();
  }

  function checkRouteRewards() {
    ROUTES.forEach(function (r) {
      if (claimedRoutes.indexOf(r.id) !== -1) return;
      if (lifetimeSteps < r.steps) return;
      claimedRoutes.push(r.id);
      inventory.push({ id: r.reward.id + '_' + Date.now(), name: r.reward.name, type: r.reward.type, emoji: r.reward.emoji, rarity: 'common', enhance: 0, tier: r.reward.tier || 'standard' });
      saveAll();
      showToast('üéÅ ' + r.name + 'ÏóêÏÑú ' + r.reward.name + ' ÌöçÎìù!');
      renderRoutes();
      renderInventory();
      renderStory();
    });
  }

  function showToast(msg) {
    var el = document.getElementById('toast');
    if (!el) return;
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(function () { el.classList.remove('show'); }, 2500);
  }

  function haversineKm(lat1, lon1, lat2, lon2) {
    var R = 6371;
    var dLat = (lat2 - lat1) * Math.PI / 180;
    var dLon = (lon2 - lon1) * Math.PI / 180;
    var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function getDailyKitChance() {
    var n = supplyCountToday + 1;
    if (n <= 3) return 1;
    if (n === 4) return 0.5;
    if (n === 5) return 0.25;
    return 0.1;
  }

  function checkRouteComplete() {
    if (!activeRouteId || sessionDistanceKm < activeRouteGoalKm) return;
    var route = userRoutes.find(function(r) { return r.id === activeRouteId; });
    if (!route || route.completedAt) return;
    var today = todayStr();
    if (today !== supplyDateToday) {
      supplyDateToday = today;
      supplyCountToday = 0;
    }
    var chance = getDailyKitChance();
    if (Math.random() > chance) {
      route.completedAt = Date.now();
      route.path = pathCoords.slice();
      activeRouteId = null;
      activeRouteGoalKm = 0;
      saveAll();
      renderWalk();
      renderRouteSelect();
      showToast('üèÅ ÏΩîÏä§ ÏôÑÏ£º! (Î≥¥Í∏â ÌÇ§Ìä∏Îäî ÏùºÏùº ÌïúÎèÑÏóê Îî∞Îùº ÏßÄÍ∏âÎèºÏöî)');
      return;
    }
    supplyCountToday += 1;
    route.completedAt = Date.now();
    route.path = pathCoords.slice();
    activeRouteId = null;
    activeRouteGoalKm = 0;
    storage.push({ id: 'kit_' + Date.now(), type: 'supply_kit', name: 'Ìä∏Î†àÏù¥Îãù Î≥¥Í∏â ÌÇ§Ìä∏', receivedAt: Date.now() });
    saveAll();
    showToast('üì¶ Î≥¥Í∏â ÌÇ§Ìä∏Í∞Ä Î≥¥Í¥ÄÌï®Ïóê ÎèÑÏ∞©ÌñàÏñ¥Ïöî');
    renderWalk();
    renderRouteSelect();
    renderStorage();
    renderQuests();
  }

  function rollRarity() {
    var r = Math.random() * 100;
    if (r < 60) return 'common';
    if (r < 85) return 'rare';
    if (r < 97) return 'epic';
    return 'legend';
  }

  function openSupplyKit() {
    var idx = inventory.findIndex(function (i) { return i.type === 'supply_kit'; });
    if (idx === -1) { showToast('Ìä∏Î†àÏù¥Îãù Î≥¥Í∏â ÌÇ§Ìä∏Í∞Ä ÏóÜÏñ¥Ïöî'); return; }
    inventory.splice(idx, 1);
    openOneSupplyKit();
  }
  function openOneSupplyKit() {
    var item = pickItemByTierWeight();
    var rarity = rollRarity();
    var newItem = { id: item.id + '_' + Date.now(), name: item.name, type: item.type, emoji: item.emoji, rarity: rarity, enhance: 0, tier: item.tier || 'standard' };
    inventory.push(newItem);
    saveAll();
    var rarityLabel = { common: 'Ïª§Î®º', rare: 'Î†àÏñ¥', epic: 'ÏóêÌîΩ', legend: 'Î†àÏ†ÑÎìú' }[rarity];
    var tierLabel = TIER_LABELS[item.tier] || 'Ïä§ÌÉ†Îã§Îìú';
    showToast(getItemIcon(newItem) + ' ' + item.name + ' (' + tierLabel + ' ¬∑ ' + rarityLabel + ') ÌöçÎìù!');
    renderEquipped();
    renderInventory();
    renderAvatar();
  }
  function moveKitToInventory() {
    if (storage.length === 0) { showToast('Î≥¥Í¥ÄÌï®Ïóê ÌÇ§Ìä∏Í∞Ä ÏóÜÏñ¥Ïöî'); return; }
    var one = storage.pop();
    inventory.push({ id: 'supply_kit_' + Date.now(), name: 'Ìä∏Î†àÏù¥Îãù Î≥¥Í∏â ÌÇ§Ìä∏', type: 'supply_kit', emoji: 'üì¶' });
    saveAll();
    renderStorage();
    renderInventory();
    showToast('Î≥¥Í∏â ÌÇ§Ìä∏Î•º Ïù∏Î≤§ÌÜ†Î¶¨Î°ú Í∞ÄÏ†∏ÏôîÏñ¥Ïöî');
  }
  function openKitFromStorage() {
    if (storage.length === 0) { showToast('Î≥¥Í¥ÄÌï®Ïóê ÌÇ§Ìä∏Í∞Ä ÏóÜÏñ¥Ïöî'); return; }
    storage.pop();
    saveAll();
    openOneSupplyKit();
    renderStorage();
  }
  function renderStorage() {
    var wrap = document.getElementById('storageList');
    if (!wrap) return;
    wrap.innerHTML = '';
    if (storage.length === 0) {
      wrap.innerHTML = '<p class="story-text" style="color:var(--text-muted);">Î≥¥Í¥ÄÌï®Ïù¥ ÎπÑÏñ¥ ÏûàÏñ¥Ïöî.<br>ÏÇ∞Ï±Ö ÏΩîÏä§Î•º ÏôÑÏ£ºÌïòÎ©¥ Î≥¥Í∏â ÌÇ§Ìä∏Í∞Ä Ïó¨Í∏∞Î°ú ÎèÑÏ∞©Ìï¥Ïöî.</p>';
      return;
    }
    storage.forEach(function(k, i) {
      var card = document.createElement('div');
      card.className = 'inv-item inv-item-kit';
      card.innerHTML = '<span>üì¶</span><span class="inv-name">Ìä∏Î†àÏù¥Îãù Î≥¥Í∏â ÌÇ§Ìä∏</span><div class="storage-actions"><button type="button" class="btn-storage-inv">Ïù∏Î≤§ÏúºÎ°ú</button><button type="button" class="btn-storage-open">Ïó¥Í∏∞</button></div>';
      card.querySelector('.btn-storage-inv').onclick = function() { moveKitToInventory(); };
      card.querySelector('.btn-storage-open').onclick = function() { openKitFromStorage(); };
      wrap.appendChild(card);
    });
  }

  function onPosition(pos) {
    if (walkState !== 'walking') return;
    var lat = pos.coords.latitude;
    var lon = pos.coords.longitude;
    var nowMs = pos.timestamp != null ? pos.timestamp : Date.now();
    if (pathCoords.length > 0) {
      var last = pathCoords[pathCoords.length - 1];
      var seg = haversineKm(last.lat, last.lon, lat, lon);
      if (seg < MIN_SEGMENT_KM) return;
      var timeDeltaH = (nowMs - lastPositionTime) / 3600000;
      if (timeDeltaH > 0) {
        var speedKmh = seg / timeDeltaH;
        if (speedKmh > MAX_SPEED_KMH) return;
      }
      var bonus = getEquipmentBonus();
      var distMult = 1 + (bonus.distance / 100);
      var xpMult = 1 + (bonus.xp / 100);
      sessionDistanceKm += seg * distMult;
      sessionXp = Math.floor(sessionDistanceKm * XP_PER_KM);
      totalXp += Math.floor(seg * XP_PER_KM * xpMult);
      totalWalkDistanceKm += seg * distMult;
      checkRouteComplete();
      saveAll();
      pathCoords.push({ lat: lat, lon: lon });
      lastPositionTime = nowMs;
    } else {
      pathCoords.push({ lat: lat, lon: lon });
      lastPositionTime = nowMs;
    }
    renderWalk();
  }

  function startWalk() {
    var sel = document.getElementById('selectActiveRoute');
    var val = sel ? sel.value : '';
    if (val) {
      var r = userRoutes.find(function(x) { return x.id === val; });
      if (r && !r.completedAt) {
        activeRouteId = r.id;
        activeRouteGoalKm = r.goalKm;
      }
    }
    if (!activeRouteId) {
      showToast('ÏßÑÌñâÌï† ÏΩîÏä§Î•º ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.');
      return;
    }
    if (!navigator.geolocation) { showToast('Ïù¥ Í∏∞Í∏∞Îäî GPSÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÏïÑÏöî'); return; }
    walkState = 'walking';
    pathCoords = [];
    sessionDistanceKm = 0;
    sessionXp = 0;
    var statusEl = document.getElementById('walkStatus');
    if (statusEl) statusEl.textContent = 'ÏúÑÏπò ÌôïÏù∏ Ï§ë...';
    var opts = { enableHighAccuracy: true, maximumAge: 0, timeout: 20000 };
    navigator.geolocation.getCurrentPosition(
      function (pos) {
        pathCoords.push({ lat: pos.coords.latitude, lon: pos.coords.longitude });
        lastPositionTime = pos.timestamp != null ? pos.timestamp : Date.now();
        watchId = navigator.geolocation.watchPosition(onPosition, function () {}, opts);
        if (statusEl) statusEl.textContent = 'ÏÇ∞Ï±Ö Ï§ë! Í±∏ÏúºÎ©¥ Í±∞Î¶¨Í∞Ä ÎàÑÏ†ÅÎèºÏöî.';
        var startBtn = document.getElementById('btnWalkStart');
        var stopBtn = document.getElementById('btnWalkStop');
        if (startBtn) startBtn.disabled = true;
        if (stopBtn) stopBtn.disabled = false;
        renderWalk();
      },
      function (err) {
        if (err.code === 1) {
          if (statusEl) statusEl.textContent = 'ÏúÑÏπò Í∂åÌïúÏùÑ ÌóàÏö©Ìï¥ Ï£ºÏÑ∏Ïöî.';
          showToast('ÏúÑÏπò Í∂åÌïúÏù¥ ÌïÑÏöîÌï¥Ïöî');
          walkState = 'idle';
        } else if (err.code === 3) {
          if (statusEl) statusEl.textContent = 'ÏúÑÏπò ÌôïÏù∏ Ï§ëÏù¥ÏóêÏöî. ÏïºÏô∏ÏóêÏÑú ÏãúÎèÑÌïòÍ±∞ÎÇò Ïû†Ïãú ÌõÑ Îã§Ïãú ÎàåÎü¨ Ï£ºÏÑ∏Ïöî.';
          showToast('ÏãúÍ∞Ñ Ï¥àÍ≥º. Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.');
          walkState = 'idle';
        } else {
          if (statusEl) statusEl.textContent = 'ÏúÑÏπòÎ•º ÏºúÍ≥† Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.';
          showToast('ÏúÑÏπòÎ•º Ïºú Ï£ºÏÑ∏Ïöî.');
          walkState = 'idle';
        }
      },
      opts
    );
  }

  function stopWalk() {
    walkState = 'idle';
    if (watchId != null && navigator.geolocation) navigator.geolocation.clearWatch(watchId);
    watchId = null;
    var startBtn = document.getElementById('btnWalkStart');
    var stopBtn = document.getElementById('btnWalkStop');
    if (startBtn) startBtn.disabled = false;
    if (stopBtn) stopBtn.disabled = true;
    var statusEl = document.getElementById('walkStatus');
    if (statusEl) statusEl.textContent = 'Ïù¥Î≤à ÏÇ∞Ï±Ö ' + sessionDistanceKm.toFixed(2) + ' km, XP +' + sessionXp + ' (Ï¥ù XP ' + totalXp + ')';
    saveAll();
    renderWalk();
  }

  function renderWalk() {
    var distEl = document.getElementById('walkDistance');
    var xpEl = document.getElementById('walkXp');
    var nextEl = document.getElementById('walkNext');
    if (distEl) distEl.textContent = sessionDistanceKm.toFixed(2);
    if (xpEl) xpEl.textContent = totalXp + (sessionXp > 0 ? ' (+' + sessionXp + ')' : '');
    if (nextEl) {
      if (activeRouteId && activeRouteGoalKm > 0) {
        var remain = activeRouteGoalKm - sessionDistanceKm;
        nextEl.textContent = remain <= 0 ? 'ÏΩîÏä§ ÏôÑÏ£º!' : 'ÏôÑÏ£ºÍπåÏßÄ ' + remain.toFixed(2) + ' km';
      } else {
        nextEl.textContent = 'ÏΩîÏä§Î•º ÏôÑÏ£ºÌïòÎ©¥ Î≥¥Í∏â ÌÇ§Ìä∏Í∞Ä Î≥¥Í¥ÄÌï®Ïóê ÎèÑÏ∞©Ìï¥Ïöî!';
      }
    }
    var totalKmEl = document.getElementById('walkTotalKm');
    if (totalKmEl) totalKmEl.textContent = totalWalkDistanceKm.toFixed(3);
    var titleObj = getTitleForKm(totalWalkDistanceKm);
    currentTitleId = titleObj.id;
    var titleBadge = document.getElementById('titleBadge');
    if (titleBadge) titleBadge.textContent = titleObj.name;
    renderLevel();
    renderGold();
    updateWalkMap();
  }
  function renderLevel() {
    var info = xpToLevel(totalXp);
    var numEl = document.getElementById('levelNum');
    var barEl = document.getElementById('levelBarFill');
    if (numEl) numEl.textContent = info.level;
    if (barEl) barEl.style.width = (info.need ? (info.current / info.need * 100) : 0) + '%';
  }
  function renderGold() {
    var h = document.getElementById('headerGold');
    var g = document.getElementById('gachaGold');
    var btnGacha = document.getElementById('btnGacha');
    var btnGachaPremium = document.getElementById('btnGachaPremium');
    if (h) h.textContent = gold;
    if (g) g.textContent = gold;
    if (btnGacha) btnGacha.disabled = gold < GACHA_COST;
    if (btnGachaPremium) btnGachaPremium.disabled = gold < GACHA_PREMIUM_COST;
  }
  function renderRouteSelect() {
    var sel = document.getElementById('selectActiveRoute');
    if (!sel) return;
    sel.innerHTML = '<option value="">-- ÏΩîÏä§Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî --</option>';
    userRoutes.forEach(function(r) {
      var opt = document.createElement('option');
      opt.value = r.id;
      opt.textContent = r.name + ' (' + r.goalKm + ' km)' + (r.completedAt ? ' ‚úì ÏôÑÏ£º' : '');
      opt.disabled = !!r.completedAt;
      sel.appendChild(opt);
    });
  }
  function addNewRoute() {
    var name = document.getElementById('newRouteName');
    var goal = document.getElementById('newRouteGoalKm');
    if (!name || !goal) return;
    var n = (name.value || '').trim();
    var g = parseFloat(goal.value) || 1;
    if (n.length < 1) { showToast('ÏΩîÏä§ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.'); return; }
    if (g < 0.5) g = 0.5;
    userRoutes.push({ id: 'r_' + Date.now(), name: n, goalKm: g, path: [], completedAt: null });
    saveAll();
    name.value = '';
    goal.value = '1';
    document.getElementById('routeCreateCard').style.display = 'none';
    renderRouteSelect();
    showToast('ÏΩîÏä§Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏñ¥Ïöî.');
  }
  function initWalkMap() {
    if (walkMapPathEl) return;
    var el = document.getElementById('walkMap');
    if (!el) return;
    el.innerHTML = '';
    var w = 400, h = 220;
    var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('viewBox', '0 0 ' + w + ' ' + h);
    svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
    var grid = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    grid.setAttribute('class', 'our-map-grid');
    for (var i = 0; i <= 10; i++) {
      var v = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      v.setAttribute('x1', (i * w / 10));
      v.setAttribute('y1', 0);
      v.setAttribute('x2', (i * w / 10));
      v.setAttribute('y2', h);
      grid.appendChild(v);
      var hor = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      hor.setAttribute('x1', 0);
      hor.setAttribute('y1', (i * h / 10));
      hor.setAttribute('x2', w);
      hor.setAttribute('y2', (i * h / 10));
      grid.appendChild(hor);
    }
    svg.appendChild(grid);
    var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('class', 'our-map-path');
    path.setAttribute('d', '');
    svg.appendChild(path);
    var charG = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    charG.setAttribute('class', 'our-map-char');
    var shadow = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
    shadow.setAttribute('class', 'char-shadow');
    shadow.setAttribute('cx', 0);
    shadow.setAttribute('cy', 10);
    shadow.setAttribute('rx', 12);
    shadow.setAttribute('ry', 4);
    charG.appendChild(shadow);
    var charHead = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    charHead.setAttribute('class', 'char-head');
    charHead.setAttribute('r', 7);
    charHead.setAttribute('cx', 0);
    charHead.setAttribute('cy', -8);
    charG.appendChild(charHead);
    var charBody = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    charBody.setAttribute('class', 'char-body');
    charBody.setAttribute('r', 10);
    charBody.setAttribute('cx', 0);
    charBody.setAttribute('cy', 6);
    charG.appendChild(charBody);
    svg.appendChild(charG);
    el.appendChild(svg);
    var label = document.createElement('span');
    label.className = 'our-map-label';
    label.textContent = 'Ïã§ÏãúÍ∞Ñ Ïù¥Îèô Í≤ΩÎ°ú';
    el.appendChild(label);
    walkMapEl = el;
    walkMapPathEl = path;
    walkMapCharEl = charG;
  }
  function updateWalkMap() {
    if (!walkMapPathEl || !walkMapCharEl) return;
    var coords = pathCoords.length ? pathCoords : (activeRouteId ? (userRoutes.find(function(r){ return r.id === activeRouteId; }) || {}).path : []);
    var w = 400, h = 220;
    if (coords.length === 0) {
      walkMapPathEl.setAttribute('d', '');
      walkMapCharEl.setAttribute('transform', 'translate(-1000,-1000)');
      return;
    }
    var bounds = ourMapBounds(coords);
    var pts = coords.map(function(c) { return ourMapLatLonToXY(c.lat, c.lon, bounds, w, h); });
    var d = 'M ' + pts[0].x + ' ' + pts[0].y;
    for (var i = 1; i < pts.length; i++) d += ' L ' + pts[i].x + ' ' + pts[i].y;
    walkMapPathEl.setAttribute('d', d);
    var last = pts[pts.length - 1];
    walkMapCharEl.setAttribute('transform', 'translate(' + last.x + ',' + last.y + ')');
  }

  function renderSteps() {
    var today = todayStr();
    if (today !== lastDate) {
      steps = 0;
      lastDate = today;
      saveAll();
    }
    var stepVal = document.getElementById('stepValue');
    var lifeVal = document.getElementById('lifetimeSteps');
    var progressFill = document.getElementById('progressFill');
    var progressText = document.getElementById('progressText');
    var card = document.getElementById('stepCard');
    if (stepVal) stepVal.textContent = steps.toLocaleString();
    if (lifeVal) lifeVal.textContent = lifetimeSteps.toLocaleString();
    var pct = Math.min(100, (steps / GOAL) * 100);
    if (progressFill) progressFill.style.width = pct + '%';
    if (progressText) progressText.textContent = steps.toLocaleString() + ' / ' + GOAL.toLocaleString();
    if (card) {
      if (steps >= GOAL) card.classList.add('goal-reached');
      else card.classList.remove('goal-reached');
    }
  }

  function switchTab(tabId) {
    document.querySelectorAll('.tab-btn').forEach(function (b) {
      b.classList.toggle('active', b.getAttribute('data-tab') === tabId);
      b.setAttribute('aria-selected', b.getAttribute('data-tab') === tabId ? 'true' : 'false');
    });
    document.querySelectorAll('.page').forEach(function (p) {
      p.classList.toggle('active', p.id === 'page-' + tabId);
    });
    if (tabId === 'walk') {
      renderSteps();
      renderWalk();
      renderRouteSelect();
      renderRoutes();
      renderQuests();
      renderAttendance();
      initWalkMap();
      setTimeout(function () { initWalkMap(); updateWalkMap(); }, 150);
    }
    if (tabId === 'avatar') { renderAvatar(); renderPet(); }
    if (tabId === 'storage') renderStorage();
    if (tabId === 'shop') { renderGold(); }
    if (tabId === 'equipment') { renderEquipped(); renderInventory(); renderEnhanceSelect(); }
    if (tabId === 'story') { renderStory(); renderAchievements(); }
  }
  function doGachaPull(premium) {
    var cost = premium ? GACHA_PREMIUM_COST : GACHA_COST;
    if (gold < cost) { showToast('GÍ∞Ä Î∂ÄÏ°±Ìï¥Ïöî. (ÌïÑÏöî: ' + cost + ' G)'); return; }
    gold -= cost;
    var item = pickItemByTierWeight(!!premium);
    var rarity = premium ? rollRarityPremium() : rollRarity();
    var newItem = { id: item.id + '_' + Date.now(), name: item.name, type: item.type, emoji: item.emoji, rarity: rarity, enhance: 0, tier: item.tier || 'standard' };
    inventory.push(newItem);
    questGachaCount += 1;
    saveAll();
    renderGold();
    renderInventory();
    renderQuests();
    var rarityLabel = { common: 'Ïª§Î®º', rare: 'Î†àÏñ¥', epic: 'ÏóêÌîΩ', legend: 'Î†àÏ†ÑÎìú' }[rarity];
    var tierLabel = TIER_LABELS[item.tier] || 'Ïä§ÌÉ†Îã§Îìú';
    showToast(getItemIcon(newItem) + ' ' + item.name + ' (' + tierLabel + ' ¬∑ ' + rarityLabel + ') ÎΩëÍ∏∞ ÏÑ±Í≥µ!');
  }
  function renderEnhanceTable() {
    var tbody = document.getElementById('enhanceTableBody');
    if (!tbody) return;
    tbody.innerHTML = '';
    for (var i = 0; i <= ENHANCE_MAX; i++) {
      var tr = document.createElement('tr');
      var next = i + 1;
      var rate = i < ENHANCE_MAX ? ENHANCE_RATES[i] : 0;
      var failText = i < 4 ? 'Ïû•ÎπÑ ÌååÍ¥¥' : (i < ENHANCE_MAX ? 'ÏãúÎèÑ Ïãú ' + ENHANCE_ATTEMPT_GOLD[i] + ' G' : 'ÏµúÎåÄ Í∞ïÌôî');
      var col1 = i < ENHANCE_MAX ? ('+' + i + ' ‚Üí +' + next) : ('+' + i + ' (ÏµúÎåÄ)');
      var rateClass = rate >= 75 ? 'rate-ok' : (rate >= 45 ? 'rate-mid' : 'rate-low');
      tr.innerHTML = '<td class="enhance-col">' + col1 + '</td><td class="' + rateClass + '">' + (i < ENHANCE_MAX ? rate + '%' : '-') + '</td><td>' + failText + '</td>';
      tbody.appendChild(tr);
    }
  }
  function renderEnhanceSelect() {
    renderEnhanceTable();
    var sel = document.getElementById('enhanceSelect');
    if (!sel) return;
    sel.innerHTML = '<option value="">-- Ïû•ÎπÑ ÏÑ†ÌÉù --</option>';
    inventory.forEach(function(item) {
      if (item.type === 'supply_kit') return;
      var enh = item.enhance != null ? item.enhance : 0;
      var opt = document.createElement('option');
      opt.value = item.id;
      opt.textContent = (item.emoji || '') + ' ' + item.name + ' +' + enh + (enh >= ENHANCE_MAX ? ' (ÏµúÎåÄ)' : '');
      sel.appendChild(opt);
    });
  }
  function tryEnhance() {
    var sel = document.getElementById('enhanceSelect');
    if (!sel || !sel.value) { showToast('Í∞ïÌôîÌï† Ïû•ÎπÑÎ•º ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.'); return; }
    var item = inventory.find(function(i){ return i.id === sel.value; });
    if (!item) { showToast('Ïû•ÎπÑÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏñ¥Ïöî.'); return; }
    var enh = item.enhance != null ? item.enhance : 0;
    if (enh >= ENHANCE_MAX) { showToast('Ïù¥ÎØ∏ ÏµúÎåÄ Í∞ïÌôî(+7)ÏûÖÎãàÎã§.'); return; }
    var attemptGold = ENHANCE_ATTEMPT_GOLD[enh];
    if (attemptGold > 0) {
      if (gold < attemptGold) { showToast('Í∞ïÌôî ÏãúÎèÑÏóê ' + attemptGold + ' GÍ∞Ä ÌïÑÏöîÌï¥Ïöî.'); return; }
      gold -= attemptGold;
      saveAll();
      renderGold();
    }
    var successRate = ENHANCE_RATES[enh];
    if (Math.random() * 100 >= successRate) {
      if (enh < 4) {
        var idx = inventory.indexOf(item);
        inventory.splice(idx, 1);
        saveAll();
        renderEnhanceSelect();
        renderInventory();
        renderEquipped();
        renderAvatar();
        showToast('Í∞ïÌôî Ïã§Ìå®... ' + item.name + 'Ïù¥(Í∞Ä) ÌååÍ¥¥ÎêòÏóàÏñ¥Ïöî.');
      } else {
        renderEnhanceSelect();
        showToast('Í∞ïÌôî Ïã§Ìå®. (Ïû•ÎπÑ Ïú†ÏßÄ, ÏãúÎèÑ ÎπÑÏö© ' + attemptGold + ' G ÏÜåÎ™®)');
      }
      return;
    }
    item.enhance = enh + 1;
    saveAll();
    renderEnhanceSelect();
    renderInventory();
    showToast(item.name + ' +' + (enh + 1) + ' Í∞ïÌôî ÏÑ±Í≥µ!');
  }
  function renderAchievements() {
    var grid = document.getElementById('achievementGrid');
    if (!grid) return;
    grid.innerHTML = '';
    ACHIEVEMENTS.forEach(function(a) {
      var unlocked = a.check();
      var div = document.createElement('div');
      div.className = 'achievement-item' + (unlocked ? ' unlocked' : ' locked');
      div.innerHTML = '<span class="ach-icon">' + a.icon + '</span><div><span class="ach-name">' + a.name + '</span><div class="ach-desc">' + a.desc + '</div></div>';
      grid.appendChild(div);
    });
  }

  function renderQuests() {
    var list = document.getElementById('questList');
    if (!list) return;
    list.innerHTML = '';
    DAILY_QUESTS.forEach(function(q) {
      var progress = q.getProgress();
      var done = progress >= q.goal;
      var claimed = questClaimed[q.id];
      var item = document.createElement('div');
      item.className = 'quest-item' + (claimed ? ' done' : '');
      var progressText = q.goal === 1 ? (progress + ' / ' + q.goal) : (progress.toLocaleString() + ' / ' + q.goal.toLocaleString());
      if (claimed) {
        item.innerHTML = '<div class="quest-info"><span class="quest-name">' + q.name + '</span><div class="quest-progress">' + q.desc + '</div></div><span class="quest-done-label">‚úì ÏôÑÎ£å</span>';
      } else if (done) {
        item.innerHTML = '<div class="quest-info"><span class="quest-name">' + q.name + '</span><div class="quest-progress">' + progressText + '</div></div><span class="quest-reward">+' + q.reward + ' G</span><button type="button" class="btn-claim" data-quest="' + q.id + '">Î≥¥ÏÉÅ ÏàòÎ†π</button>';
      } else {
        item.innerHTML = '<div class="quest-info"><span class="quest-name">' + q.name + '</span><div class="quest-progress">' + progressText + '</div></div><span class="quest-reward">+' + q.reward + ' G</span>';
      }
      list.appendChild(item);
    });
    list.querySelectorAll('.btn-claim').forEach(function(btn) {
      btn.addEventListener('click', function() { claimQuest(this.getAttribute('data-quest')); });
    });
  }
  function claimQuest(questId) {
    var q = DAILY_QUESTS.find(function(x){ return x.id === questId; });
    if (!q || questClaimed[questId]) return;
    if (q.getProgress() < q.goal) { showToast('ÏïÑÏßÅ Î™©ÌëúÎ•º Îã¨ÏÑ±ÌïòÏßÄ Î™ªÌñàÏñ¥Ïöî'); return; }
    questClaimed[questId] = true;
    gold += q.reward;
    saveAll();
    renderQuests();
    renderGold();
    showToast('+' + q.reward + ' G ÌöçÎìù!');
  }
  function doShare() {
    var url = location.href;
    var text = 'WalkStory - Í±∏ÏùåÏúºÎ°ú ÌÇ§Ïö∞Îäî ÎÇòÎßåÏùò ÎèôÎ¨º ÏπúÍµ¨';
    if (navigator.share) {
      navigator.share({ title: 'WalkStory', text: text, url: url }).then(function() {
        onShareSuccess();
      }).catch(function() { onShareSuccess(); });
    } else {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(function() { onShareSuccess(); }).catch(function() { onShareSuccess(); });
      } else { onShareSuccess(); }
    }
  }
  function onShareSuccess() {
    if (sharedToday) { showToast('Ïò§ÎäòÏùÄ Ïù¥ÎØ∏ Í≥µÏú† Î≥¥ÏÉÅÏùÑ Î∞õÏïòÏñ¥Ïöî'); return; }
    sharedToday = true;
    gold += 40;
    saveAll();
    renderGold();
    renderQuests();
    showToast('Í≥µÏú† Í∞êÏÇ¨Ìï¥Ïöî! +40 G');
  }
  function renderHeaderAuth() {
    var btn = document.getElementById('btnHeaderAuth');
    var logoutBtn = document.getElementById('btnLogout');
    if (!btn) return;
    if (isLoggedIn && userProfile && userProfile.nickname) {
      btn.textContent = userProfile.nickname;
      btn.classList.add('logged-in');
      btn.setAttribute('aria-label', 'ÌîÑÎ°úÌïÑ');
      if (logoutBtn) {
        logoutBtn.style.display = 'block';
      }
    } else {
      btn.textContent = 'üîê Î°úÍ∑∏Ïù∏';
      btn.classList.remove('logged-in');
      btn.setAttribute('aria-label', 'Î°úÍ∑∏Ïù∏');
      if (logoutBtn) {
        logoutBtn.style.display = 'none';
      }
    }
    renderAuthGate();
  }
  function renderAuthGate() {
    var appMain = document.getElementById('appMain');
    var authOverlay = document.getElementById('authOverlay');
    if (!appMain || !authOverlay) return;
    if (isLoggedIn) {
      appMain.classList.remove('hidden');
      authOverlay.style.display = 'none';
      authOverlay.classList.remove('auth-gate');
    } else {
      appMain.classList.add('hidden');
      authOverlay.style.display = 'flex';
      authOverlay.classList.add('auth-gate');
    }
  }
  function openAuthModal() {
    var overlay = document.getElementById('authOverlay');
    if (overlay) { overlay.style.display = 'flex'; overlay.classList.remove('auth-gate'); }
    document.getElementById('authLoginPanel').style.display = 'block';
    document.getElementById('authSignupPanel').style.display = 'none';
    document.querySelectorAll('.auth-tab').forEach(function(t){ t.classList.remove('active'); if (t.getAttribute('data-auth-tab') === 'login') t.classList.add('active'); });
    document.getElementById('authTitle').textContent = 'Î°úÍ∑∏Ïù∏';
  }
  function closeAuthModal() {
    var overlay = document.getElementById('authOverlay');
    if (overlay && isLoggedIn) {
      // ÌéòÏù¥ÎìúÏïÑÏõÉ Ïï†ÎãàÎ©îÏù¥ÏÖò
      overlay.classList.add('fade-out');
      setTimeout(function() {
        overlay.style.display = 'none';
        overlay.classList.remove('fade-out');
      }, 300);
    }
    if (overlay && !isLoggedIn) { 
      overlay.style.display = 'flex'; 
      overlay.classList.add('auth-gate'); 
    }
  }
  
  function showWelcomeModal(nickname) {
    var modal = document.getElementById('welcomeModal');
    var title = document.getElementById('welcomeTitle');
    var message = document.getElementById('welcomeMessage');
    if (modal && title && message) {
      title.textContent = nickname ? nickname + 'Îãò ÌôòÏòÅÌï©ÎãàÎã§!' : 'ÌôòÏòÅÌï©ÎãàÎã§!';
      message.textContent = 'WalkStoryÏôÄ Ìï®Íªò Í±∏Ïñ¥Ïöî!';
      modal.classList.add('show');
    }
  }
  
  function hideWelcomeModal() {
    var modal = document.getElementById('welcomeModal');
    if (modal) {
      modal.classList.remove('show');
    }
  }
  
  function showAuthLoading() {
    var loading = document.getElementById('authLoading');
    var overlay = document.getElementById('authOverlay');
    if (loading) loading.classList.add('active');
    if (overlay) overlay.style.display = 'flex';
  }
  
  function hideAuthLoading() {
    var loading = document.getElementById('authLoading');
    if (loading) loading.classList.remove('active');
  }
  function doLogin() {
    var nick = (document.getElementById('authLoginNick') || {}).value.trim();
    var pw = (document.getElementById('authLoginPw') || {}).value;
    if (!nick || !pw) { showToast('ÎãâÎÑ§ÏûÑÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.'); return; }
    var url = API_BASE + '/api/auth/login';
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nickname: nick, password: pw })
    }).then(function (r) {
      if (!r.ok) {
        return r.text().then(function (text) {
          try { return { ok: false, body: JSON.parse(text) }; }
          catch { return { ok: false, body: { error: 'HTTP ' + r.status + ': ' + text.substring(0, 50) } }; }
        });
      }
      return r.json().then(function (j) { return { ok: true, body: j }; });
    })
      .then(function (x) {
        if (!x.ok) { showToast(x.body.error || 'Î°úÍ∑∏Ïù∏Ïóê Ïã§Ìå®ÌñàÏñ¥Ïöî.'); return; }
        setAuthToken(x.body.token);
        userProfile = x.body.user;
        isLoggedIn = true;
        return fetch(API_BASE + '/api/user/data', { headers: { 'Authorization': 'Bearer ' + x.body.token } });
      })
      .then(function (r) {
        if (!r) return;
        return r.json();
      })
      .then(function (body) {
        if (body && body.data) {
          try {
            var data = typeof body.data === 'string' ? JSON.parse(body.data) : body.data;
            applyGameState(data);
          } catch (e) {}
        }
        saveAll();
        closeAuthModal();
        setTimeout(function() {
          renderHeaderAuth();
          renderAuthGate();
          renderPet();
          renderAttendance();
          var card = document.getElementById('attendanceCard');
          if (card) card.style.display = 'block';
          if (userProfile && userProfile.nickname) {
            showWelcomeModal(userProfile.nickname);
          } else {
            showWelcomeModal();
          }
        }, 300);
      })
      .catch(function (err) {
        console.error('Login error:', err, 'URL:', url, 'API_BASE:', API_BASE);
        showToast('ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏñ¥Ïöî. (API: ' + url + ')');
      });
  }
  function doSignup() {
    var nick = (document.getElementById('authSignupNick') || {}).value.trim();
    var email = (document.getElementById('authSignupEmail') || {}).value.trim();
    var pw = (document.getElementById('authSignupPw') || {}).value;
    var pw2 = (document.getElementById('authSignupPw2') || {}).value;
    if (!nick || nick.length < 2) { showToast('ÎãâÎÑ§ÏûÑÏùÄ 2Ïûê Ïù¥ÏÉÅÏù¥ÏóêÏöî.'); return; }
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showToast('Ïò¨Î∞îÎ•∏ Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.'); return; }
    if (!pw || pw.length < 6) { showToast('ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 6Ïûê Ïù¥ÏÉÅÏù¥ÏóêÏöî.'); return; }
    if (pw !== pw2) { showToast('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏïÑÏöî.'); return; }
    var url = API_BASE + '/api/auth/signup';
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nickname: nick, password: pw, email: email })
    }).then(function (r) {
      if (!r.ok) {
        return r.text().then(function (text) {
          try { return { ok: false, body: JSON.parse(text) }; }
          catch { return { ok: false, body: { error: 'HTTP ' + r.status + ': ' + text.substring(0, 50) } }; }
        });
      }
      return r.json().then(function (j) { return { ok: true, body: j }; });
    })
      .then(function (x) {
        if (!x.ok) { showToast(x.body.error || 'Í∞ÄÏûÖÏóê Ïã§Ìå®ÌñàÏñ¥Ïöî.'); return; }
        setAuthToken(x.body.token);
        userProfile = x.body.user;
        isLoggedIn = true;
        saveAll();
        closeAuthModal();
        setTimeout(function() {
          renderHeaderAuth();
          renderAuthGate();
          renderPet();
          renderAttendance();
          var card = document.getElementById('attendanceCard');
          if (card) card.style.display = 'block';
          if (userProfile && userProfile.nickname) {
            showWelcomeModal(userProfile.nickname);
          } else {
            showWelcomeModal();
          }
        }, 300);
      })
      .catch(function (err) {
        console.error('Signup error:', err, 'URL:', url);
        showToast('ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏñ¥Ïöî. (API: ' + url + ')');
      });
  }
  function doFindId() {
    var email = (document.getElementById('authFindIdEmail') || {}).value.trim();
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      showToast('Ïò¨Î∞îÎ•∏ Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.'); return;
    }
    var url = API_BASE + '/api/auth/find-id';
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: email })
    }).then(function (r) {
      if (!r.ok) {
        return r.text().then(function (text) {
          try { return { ok: false, body: JSON.parse(text) }; }
          catch { return { ok: false, body: { error: 'HTTP ' + r.status + ': ' + text.substring(0, 50) } }; }
        });
      }
      return r.json().then(function (j) { return { ok: true, body: j }; });
    }).then(function (x) {
      var resultDiv = document.getElementById('findIdResult');
      if (!x.ok) {
        if (resultDiv) {
          resultDiv.style.display = 'block';
          resultDiv.innerHTML = '<div style="color: #ef4444;">' + (x.body.error || 'ÏïÑÏù¥Îîî Ï∞æÍ∏∞Ïóê Ïã§Ìå®ÌñàÏñ¥Ïöî.') + '</div>';
        } else {
          showToast(x.body.error || 'ÏïÑÏù¥Îîî Ï∞æÍ∏∞Ïóê Ïã§Ìå®ÌñàÏñ¥Ïöî.');
        }
        return;
      }
      if (resultDiv) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div style="color: var(--accent);">ÎãâÎÑ§ÏûÑ: <strong>' + x.body.fullNickname + '</strong></div>';
      }
    }).catch(function (err) {
      console.error('Find ID error:', err);
      showToast('ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏñ¥Ïöî.');
    });
  }
  function doFindPw() {
    var email = (document.getElementById('authFindPwEmail') || {}).value.trim();
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      showToast('Ïò¨Î∞îÎ•∏ Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.'); return;
    }
    var url = API_BASE + '/api/auth/reset-password-request';
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: email })
    }).then(function (r) {
      if (!r.ok) {
        return r.text().then(function (text) {
          try { return { ok: false, body: JSON.parse(text) }; }
          catch { return { ok: false, body: { error: 'HTTP ' + r.status + ': ' + text.substring(0, 50) } }; }
        });
      }
      return r.json().then(function (j) { return { ok: true, body: j }; });
    }).then(function (x) {
      var resultDiv = document.getElementById('findPwResult');
      var resetPanel = document.getElementById('authResetPwPanel');
      if (!x.ok) {
        if (resultDiv) {
          resultDiv.style.display = 'block';
          resultDiv.innerHTML = '<div style="color: #ef4444;">' + (x.body.error || 'ÎπÑÎ∞ÄÎ≤àÌò∏ Ïû¨ÏÑ§Ï†ï ÏöîÏ≤≠Ïóê Ïã§Ìå®ÌñàÏñ¥Ïöî.') + '</div>';
        } else {
          showToast(x.body.error || 'ÎπÑÎ∞ÄÎ≤àÌò∏ Ïû¨ÏÑ§Ï†ï ÏöîÏ≤≠Ïóê Ïã§Ìå®ÌñàÏñ¥Ïöî.');
        }
        return;
      }
      if (resultDiv) {
        resultDiv.style.display = 'block';
        var msg = x.body.message || 'ÎπÑÎ∞ÄÎ≤àÌò∏ Ïû¨ÏÑ§Ï†ï ÎßÅÌÅ¨Î•º Î∞úÏÜ°ÌñàÏñ¥Ïöî.';
        if (x.body.resetToken) {
          msg += '<br><small style="color: var(--text-muted); margin-top: 0.5rem; display: block;">Í∞úÎ∞ú Î™®Îìú: ÌÜ†ÌÅ∞ = ' + x.body.resetToken + '</small>';
        }
        resultDiv.innerHTML = '<div style="color: var(--accent);">' + msg + '</div>';
      }
      if (resetPanel && x.body.resetToken) {
        resetPanel.style.display = 'block';
        document.getElementById('authResetToken').value = x.body.resetToken;
      }
    }).catch(function (err) {
      console.error('Find PW error:', err);
      showToast('ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏñ¥Ïöî.');
    });
  }
  function doResetPw() {
    var token = (document.getElementById('authResetToken') || {}).value.trim();
    var pw = (document.getElementById('authResetPw') || {}).value;
    var pw2 = (document.getElementById('authResetPw2') || {}).value;
    if (!token) { showToast('ÌÜ†ÌÅ∞ÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.'); return; }
    if (!pw || pw.length < 6) { showToast('ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 6Ïûê Ïù¥ÏÉÅÏù¥ÏóêÏöî.'); return; }
    if (pw !== pw2) { showToast('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏïÑÏöî.'); return; }
    var url = API_BASE + '/api/auth/reset-password';
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token: token, newPassword: pw })
    }).then(function (r) {
      if (!r.ok) {
        return r.text().then(function (text) {
          try { return { ok: false, body: JSON.parse(text) }; }
          catch { return { ok: false, body: { error: 'HTTP ' + r.status + ': ' + text.substring(0, 50) } }; }
        });
      }
      return r.json().then(function (j) { return { ok: true, body: j }; });
    }).then(function (x) {
      if (!x.ok) {
        showToast(x.body.error || 'ÎπÑÎ∞ÄÎ≤àÌò∏ Ïû¨ÏÑ§Ï†ïÏóê Ïã§Ìå®ÌñàÏñ¥Ïöî.');
        return;
      }
      showToast('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïû¨ÏÑ§Ï†ïÎêòÏóàÏñ¥Ïöî. Î°úÍ∑∏Ïù∏Ìï¥ Ï£ºÏÑ∏Ïöî.');
      switchAuthTab('login');
    }).catch(function (err) {
      console.error('Reset PW error:', err);
      showToast('ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏñ¥Ïöî.');
    });
  }
  function doSocialLogin(provider) {
    // Ïπ¥Ïπ¥Ïò§/Íµ¨Í∏Ä OAuthÎäî ÌîÑÎ°†Ìä∏ÏóîÎìúÏóêÏÑú Ï≤òÎ¶¨ÌïòÍ≥†, Î∞±ÏóîÎìúÏóê ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï†ÑÏÜ°
    if (provider === 'kakao') {
      // Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏ (Kakao SDK ÌïÑÏöî)
      if (typeof Kakao === 'undefined') {
        showToast('Ïπ¥Ïπ¥Ïò§ SDKÍ∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏñ¥Ïöî. Ïπ¥Ïπ¥Ïò§ Í∞úÎ∞úÏûê Ïï± ÏÑ§Ï†ïÏù¥ ÌïÑÏöîÌï¥Ïöî.');
        return;
      }
      // Î°úÎî© ÌëúÏãú
      showAuthLoading();
      Kakao.Auth.login({
        // ÎãâÎÑ§ÏûÑÎßå ÏöîÏ≤≠ (Ïù¥Î©îÏùºÏùÄ Í∂åÌïú ÏóÜÏùå ÏÉÅÌÉúÏù¥ÎØÄÎ°ú Ï†úÏô∏)
        scope: 'profile_nickname',
        success: function(authObj) {
          Kakao.API.request({
            url: '/v2/user/me',
            success: function(res) {
              console.log('Kakao API response:', res);
              console.log('Kakao account:', res.kakao_account);
              console.log('Properties:', res.properties);
              try {
                var socialId = res.id ? res.id.toString() : null;
                if (!socialId) {
                  showToast('Ïπ¥Ïπ¥Ïò§ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏñ¥Ïöî.');
                  return;
                }
                
                // ÎãâÎÑ§ÏûÑ Ï∂îÏ∂ú (ÏïàÏ†ÑÌïòÍ≤å - Ïó¨Îü¨ Í≤ΩÎ°ú ÌôïÏù∏)
                var nickname = 'Ïπ¥Ïπ¥Ïò§ÏÇ¨Ïö©Ïûê' + Math.floor(Math.random() * 1000); // Í∏∞Î≥∏Í∞íÏóê ÎûúÎç§ Ïà´Ïûê Ï∂îÍ∞Ä
                if (res.kakao_account) {
                  if (res.kakao_account.profile && res.kakao_account.profile.nickname) {
                    nickname = res.kakao_account.profile.nickname;
                  } else if (res.kakao_account.profile_nickname) {
                    nickname = res.kakao_account.profile_nickname;
                  }
                }
                if (res.properties) {
                  if (res.properties.nickname) {
                    nickname = res.properties.nickname;
                  }
                }
                
                // Ïù¥Î©îÏùºÏùÄ Í∂åÌïú ÏóÜÏùåÏù¥ÎØÄÎ°ú nullÎ°ú ÏÑ§Ï†ï
                var email = null;
                
                console.log('Extracted nickname:', nickname, 'socialId:', socialId);
                sendSocialLogin(provider, socialId, nickname, email);
              } catch (err) {
                console.error('Kakao API response processing error:', err);
                showToast('Ïπ¥Ïπ¥Ïò§ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä ÎÇ¨Ïñ¥Ïöî.');
              }
            },
            fail: function(err) {
              console.error('Kakao API error:', err);
              hideAuthLoading();
              showToast('Ïπ¥Ïπ¥Ïò§ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏñ¥Ïöî: ' + (err.error_description || err.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
            }
          });
        },
        fail: function(err) {
          console.error('Kakao Auth error:', err);
          hideAuthLoading();
          showToast('Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏Ïóê Ïã§Ìå®ÌñàÏñ¥Ïöî: ' + (err.error_description || err.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
        }
      });
    } else if (provider === 'google') {
      // Íµ¨Í∏Ä Î°úÍ∑∏Ïù∏ (Google Sign-In API ÌïÑÏöî)
      if (typeof gapi === 'undefined') {
        showToast('Íµ¨Í∏Ä SDKÍ∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏñ¥Ïöî. Google OAuth ÏÑ§Ï†ïÏù¥ ÌïÑÏöîÌï¥Ïöî.');
        return;
      }
      var googleClientId = (typeof window !== 'undefined' && window.APP_CONFIG && window.APP_CONFIG.google) 
        ? window.APP_CONFIG.google.clientId 
        : 'YOUR_GOOGLE_CLIENT_ID';
      if (googleClientId === 'YOUR_GOOGLE_CLIENT_ID') {
        showToast('Íµ¨Í∏Ä ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ IDÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏñ¥Ïöî.');
        return;
      }
      gapi.load('auth2', function() {
        gapi.auth2.init({
          client_id: googleClientId
        }).then(function() {
          var authInstance = gapi.auth2.getAuthInstance();
          authInstance.signIn().then(function(googleUser) {
            var profile = googleUser.getBasicProfile();
            var socialId = profile.getId();
            var nickname = profile.getName() || 'Íµ¨Í∏ÄÏÇ¨Ïö©Ïûê';
            var email = profile.getEmail() || null;
            sendSocialLogin(provider, socialId, nickname, email);
          }).catch(function(err) {
            console.error('Google Sign-In error:', err);
            showToast('Íµ¨Í∏Ä Î°úÍ∑∏Ïù∏Ïóê Ïã§Ìå®ÌñàÏñ¥Ïöî.');
          });
        });
      });
    }
  }
  function sendSocialLogin(provider, socialId, nickname, email) {
    console.log('sendSocialLogin called:', { provider, socialId: socialId?.substring(0, 10) + '...', nickname: nickname?.substring(0, 20), email: email ? 'provided' : 'null' });
    var url = API_BASE + '/api/auth/social';
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ provider: provider, socialId: socialId, nickname: nickname, email: email })
    }).then(function (r) {
      console.log('Social login response status:', r.status);
      if (!r.ok) {
        return r.text().then(function (text) {
          console.error('Social login error response:', text);
          try { 
            var parsed = JSON.parse(text);
            console.error('Parsed error:', parsed);
            return { ok: false, body: parsed, status: r.status }; 
          }
          catch { 
            console.error('Failed to parse error response:', text);
            return { ok: false, body: { error: 'HTTP ' + r.status + ': ' + text.substring(0, 100) }, status: r.status }; 
          }
        });
      }
      return r.json().then(function (j) { 
        console.log('Social login success:', { userId: j.user?.id, nickname: j.user?.nickname });
        return { ok: true, body: j }; 
      });
    }).catch(function(err) {
      console.error('sendSocialLogin fetch error:', err);
      return { ok: false, body: { error: 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò: ' + err.message } };
    }).then(function (x) {
      if (!x || !x.ok) {
        hideAuthLoading();
        var errorMsg = x && x.body && x.body.error ? x.body.error : 'ÏÜåÏÖú Î°úÍ∑∏Ïù∏Ïóê Ïã§Ìå®ÌñàÏñ¥Ïöî.';
        if (x && x.body && x.body.details) {
          console.error('Server error details:', x.body.details);
        }
        if (x && x.body && x.body.code) {
          console.error('Server error code:', x.body.code);
        }
        showToast(errorMsg);
        return null;
      }
      if (!x.body || !x.body.user || !x.body.token) {
        hideAuthLoading();
        showToast('ÏÑúÎ≤Ñ ÏùëÎãµÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏïÑÏöî.');
        return null;
      }
      setAuthToken(x.body.token);
      userProfile = x.body.user;
      isLoggedIn = true;
      
      // userProfileÏù¥ Ï†úÎåÄÎ°ú ÏÑ§Ï†ïÎêòÏóàÎäîÏßÄ ÌôïÏù∏
      if (!userProfile || !userProfile.nickname) {
        hideAuthLoading();
        console.error('userProfile is invalid:', userProfile);
        showToast('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä ÎÇ¨Ïñ¥Ïöî.');
        return null;
      }
      
      hideAuthLoading();
      return fetch(API_BASE + '/api/user/data', { headers: { 'Authorization': 'Bearer ' + x.body.token } });
    }).then(function (r) {
      if (!r) {
        // Î°úÍ∑∏Ïù∏ÏùÄ ÏÑ±Í≥µÌñàÏßÄÎßå Îç∞Ïù¥ÌÑ∞ Î°úÎìúÎäî Ïä§ÌÇµ
        if (userProfile && userProfile.nickname) {
          saveAll();
          closeAuthModal();
          setTimeout(function() {
            renderHeaderAuth();
            renderAuthGate();
            renderPet();
            renderAttendance();
            var card = document.getElementById('attendanceCard');
            if (card) card.style.display = 'block';
            showWelcomeModal(userProfile.nickname);
          }, 300);
        }
        return null;
      }
      if (!r.ok) {
        // Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®Ìï¥ÎèÑ Î°úÍ∑∏Ïù∏ÏùÄ ÏÑ±Í≥µ
        console.warn('Failed to load user data:', r.status);
        if (userProfile && userProfile.nickname) {
          saveAll();
          closeAuthModal();
          setTimeout(function() {
            renderHeaderAuth();
            renderAuthGate();
            renderPet();
            renderAttendance();
            var card = document.getElementById('attendanceCard');
            if (card) card.style.display = 'block';
            showWelcomeModal(userProfile.nickname);
          }, 300);
        }
        return null;
      }
      return r.json();
    }).then(function (body) {
      if (!body) return;
      if (body && body.data) {
        try {
          var data = typeof body.data === 'string' ? JSON.parse(body.data) : body.data;
          applyGameState(data);
        } catch (e) {
          console.error('Failed to apply game state:', e);
        }
      }
      saveAll();
      closeAuthModal();
      setTimeout(function() {
        renderHeaderAuth();
        renderAuthGate();
        renderPet();
        renderAttendance();
        var card = document.getElementById('attendanceCard');
        if (card) card.style.display = 'block';
        if (userProfile && userProfile.nickname) {
          showWelcomeModal(userProfile.nickname);
        } else {
          showWelcomeModal();
        }
      }, 300);
    }).catch(function(err) {
      hideAuthLoading();
      console.error('User data load error:', err);
      if (userProfile && userProfile.nickname) {
        saveAll();
        closeAuthModal();
        setTimeout(function() {
          renderHeaderAuth();
          renderAuthGate();
          renderPet();
          renderAttendance();
          var card = document.getElementById('attendanceCard');
          if (card) card.style.display = 'block';
          showWelcomeModal(userProfile.nickname);
        }, 300);
      } else {
        showToast('Î°úÍ∑∏Ïù∏ Ï§ë Ïò§Î•òÍ∞Ä ÎÇ¨Ïñ¥Ïöî: ' + (err.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
      }
    }).catch(function (err) {
      hideAuthLoading();
      console.error('Social login error:', err);
      // Î°úÍ∑∏Ïù∏ÏùÄ ÏÑ±Í≥µÌñàÏßÄÎßå Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®
      if (userProfile && userProfile.nickname) {
        saveAll();
        closeAuthModal();
        setTimeout(function() {
          renderHeaderAuth();
          renderAuthGate();
          renderPet();
          renderAttendance();
          var card = document.getElementById('attendanceCard');
          if (card) card.style.display = 'block';
          showWelcomeModal(userProfile.nickname);
        }, 300);
      } else {
        showToast('Î°úÍ∑∏Ïù∏ Ï§ë Ïò§Î•òÍ∞Ä ÎÇ¨Ïñ¥Ïöî: ' + (err.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
      }
    });
  }
  function switchAuthTab(tab) {
    document.getElementById('authLoginPanel').style.display = tab === 'login' ? 'block' : 'none';
    document.getElementById('authSignupPanel').style.display = tab === 'signup' ? 'block' : 'none';
    document.getElementById('authFindIdPanel').style.display = tab === 'findId' ? 'block' : 'none';
    document.getElementById('authFindPwPanel').style.display = tab === 'findPw' ? 'block' : 'none';
    document.querySelectorAll('.auth-tab').forEach(function(t){ 
      t.classList.remove('active'); 
      if (t.getAttribute('data-auth-tab') === tab) t.classList.add('active'); 
    });
    document.getElementById('authTitle').textContent = 
      tab === 'login' ? 'Î°úÍ∑∏Ïù∏' : 
      tab === 'signup' ? 'ÌöåÏõêÍ∞ÄÏûÖ' : 
      tab === 'findId' ? 'ÏïÑÏù¥Îîî Ï∞æÍ∏∞' : 
      tab === 'findPw' ? 'ÎπÑÎ∞ÄÎ≤àÌò∏ Ï∞æÍ∏∞' : 'Î°úÍ∑∏Ïù∏';
  }
  function doLogout() {
    // Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏Ïù∏ Í≤ΩÏö∞ Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏ÏïÑÏõÉÎèÑ Ï≤òÎ¶¨
    if (typeof Kakao !== 'undefined' && Kakao.Auth.getAccessToken()) {
      Kakao.Auth.logout(function() {
        console.log('Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏ÏïÑÏõÉ ÏôÑÎ£å');
      });
    }
    clearAuthToken();
    userProfile = null;
    isLoggedIn = false;
    saveAll();
    renderHeaderAuth();
    renderAuthGate();
    renderAttendance();
    var card = document.getElementById('attendanceCard');
    if (card) card.style.display = 'none';
    showToast('Î°úÍ∑∏ÏïÑÏõÉÎêòÏóàÏñ¥Ïöî.');
  }
  function renderAttendance() {
    var card = document.getElementById('attendanceCard');
    var statusEl = document.getElementById('attendanceStatus');
    var btn = document.getElementById('btnAttendance');
    if (!card || !statusEl) return;
    if (!isLoggedIn) {
      card.style.display = 'none';
      return;
    }
    card.style.display = 'block';
    var today = todayStr();
    var already = lastAttendanceDate === today;
    if (already) {
      statusEl.textContent = 'Ïò§Îäò Ï∂úÏÑù ÏôÑÎ£å! Ïó∞ÏÜç ' + attendanceStreak + 'Ïùº';
      if (btn) btn.style.display = 'none';
    } else {
      var nextDay = attendanceStreak + 1;
      if (nextDay <= 7) {
        statusEl.textContent = 'Ïò§Îäò Ï∂úÏÑùÌïòÎ©¥ ' + (nextDay === 7 ? ATTENDANCE_7DAY_BOX_NAME : nextDay + 'ÏùºÏ∞® Î≥¥ÏÉÅ') + ' Î∞õÍ∏∞';
        if (btn) { btn.style.display = 'block'; btn.textContent = nextDay === 7 ? 'Ï∂úÏÑùÌïòÍ≥† ÏÑ†Î¨ºÏÉÅÏûê Î∞õÍ∏∞' : 'Ï∂úÏÑù Ï≤¥ÌÅ¨'; }
      } else {
        statusEl.textContent = 'Ïó∞ÏÜç ' + attendanceStreak + 'Ïùº Îã¨ÏÑ±! ÎÇ¥Ïùº Îã§Ïãú 1ÏùºÏ∞®Î∂ÄÌÑ∞ ÏãúÏûëÌï¥Ïöî.';
        if (btn) btn.style.display = 'none';
      }
    }
  }
  function doAttendance() {
    if (!isLoggedIn) { showToast('Î°úÍ∑∏Ïù∏ ÌõÑ Ï∂úÏÑùÌï† Ïàò ÏûàÏñ¥Ïöî.'); return; }
    var today = todayStr();
    if (lastAttendanceDate === today) { showToast('Ïò§ÎäòÏùÄ Ïù¥ÎØ∏ Ï∂úÏÑùÌñàÏñ¥Ïöî.'); return; }
    var yesterday = (function(){
      var d = new Date(); d.setDate(d.getDate() - 1);
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    })();
    if (lastAttendanceDate !== yesterday && lastAttendanceDate !== '') attendanceStreak = 0;
    attendanceStreak++;
    lastAttendanceDate = today;
    if (attendanceStreak <= 6) {
      var reward = ATTENDANCE_DAILY_GOLD[attendanceStreak - 1] || 10;
      gold += reward;
      saveAll();
      renderGold();
      renderAttendance();
      showToast('Ï∂úÏÑù ' + attendanceStreak + 'ÏùºÏ∞®! +' + reward + ' G');
    } else {
      attendanceStreak = 7;
      saveAll();
      openWeekMasterBox();
    }
  }
  function openWeekMasterBox() {
    if (Math.random() < 0.5) {
      gold += ATTENDANCE_7DAY_GOLD;
      saveAll();
      renderGold();
      renderAttendance();
      showToast(ATTENDANCE_7DAY_BOX_NAME + 'ÏóêÏÑú ' + ATTENDANCE_7DAY_GOLD + ' G ÌöçÎìù!');
    } else {
      var item = pickItemByTierWeight(true);
      var rarity = rollRarityPremium();
      var newItem = { id: item.id + '_' + Date.now(), name: item.name, type: item.type, emoji: item.emoji, rarity: rarity, enhance: 0, tier: item.tier || 'standard' };
      inventory.push(newItem);
      saveAll();
      renderInventory();
      renderAttendance();
      var tierLabel = TIER_LABELS[newItem.tier] || newItem.tier;
      var rarityLabel = (RARITY_NAMES.indexOf(rarity) >= 0 ? rarity : 'common');
      showToast(getItemIcon(newItem) + ' ' + newItem.name + ' (' + tierLabel + ' ¬∑ ' + rarityLabel + ') ÌöçÎìù!');
    }
    attendanceStreak = 0;
    saveAll();
    renderAttendance();
    showToast('Í≥µÏú† Í∞êÏÇ¨Ìï¥Ïöî! +40 G');
  }

  function renderPet() {
    var petEmoji = document.getElementById('petEmoji');
    var petName = document.getElementById('petName');
    var petLevel = document.getElementById('petLevel');
    var petExpFill = document.getElementById('petExpFill');
    var petExpText = document.getElementById('petExpText');
    
    if (!pet.type) {
      if (petEmoji) petEmoji.textContent = 'üêæ';
      if (petName) petName.textContent = 'ÎèôÎ¨ºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî';
      if (petLevel) petLevel.textContent = '';
      if (petExpFill) petExpFill.style.width = '0%';
      if (petExpText) petExpText.textContent = '';
      return;
    }
    
    var petType = PET_TYPES.find(function(p) { return p.id === pet.type; });
    if (!petType) return;
    
    var expForNextLevel = pet.level * 100; // Î†àÎ≤®Îãπ 100 Í≤ΩÌóòÏπò ÌïÑÏöî
    var expPercent = (pet.exp / expForNextLevel) * 100;
    
    if (petEmoji) petEmoji.textContent = petType.emoji;
    if (petName) petName.textContent = pet.name || petType.name;
    if (petLevel) petLevel.textContent = 'Lv.' + pet.level;
    if (petExpFill) petExpFill.style.width = Math.min(expPercent, 100) + '%';
    if (petExpText) petExpText.textContent = 'Í≤ΩÌóòÏπò: ' + pet.exp + ' / ' + expForNextLevel;
  }
  
  function addPetExp(amount) {
    if (!pet.type) return;
    pet.exp += amount;
    var expForNextLevel = pet.level * 100;
    while (pet.exp >= expForNextLevel) {
      pet.exp -= expForNextLevel;
      pet.level++;
      showToast('üéâ ' + (PET_TYPES.find(function(p) { return p.id === pet.type; }) || {}).name + 'Ïù¥(Í∞Ä) Î†àÎ≤®ÏóÖÌñàÏñ¥Ïöî! Lv.' + pet.level);
      expForNextLevel = pet.level * 100;
    }
    saveAll();
    renderPet();
  }
  
  function renderAvatar() {
    var nameEl = document.getElementById('avatarName');
    var inputEl = document.getElementById('inputAvatarName');
    if (nameEl) nameEl.textContent = avatar.name || 'ÏÇ∞Ï±ÖÎü¨';
    if (inputEl) inputEl.value = avatar.name || '';
    var skin = avatar.skin || '#f5d0b0';
    var human = document.getElementById('avatarHuman');
    if (human) {
      human.style.setProperty('--skin', skin);
      var topItem = equipped.top ? inventory.find(function(i){ return i.id === equipped.top; }) : null;
      var bottomItem = equipped.bottom ? inventory.find(function(i){ return i.id === equipped.bottom; }) : null;
      human.style.setProperty('--top-color', topItem ? '#4a6fa5' : '#6b7280');
      human.style.setProperty('--bottom-color', bottomItem ? '#374151' : '#4b5563');
    }
    var headEl = document.getElementById('previewHead');
    var bodyEl = document.getElementById('previewBody');
    var armL = document.getElementById('previewArmL');
    var armR = document.getElementById('previewArmR');
    var legL = document.getElementById('previewLegL');
    var legR = document.getElementById('previewLegR');
    if (headEl) headEl.style.background = skin;
    if (bodyEl) bodyEl.style.background = (equipped.top ? inventory.find(function(i){ return i.id === equipped.top; }) : null) ? '#4a6fa5' : '#6b7280';
    if (armL) armL.style.background = skin;
    if (armR) armR.style.background = skin;
    if (legL) legL.style.background = (equipped.bottom ? inventory.find(function(i){ return i.id === equipped.bottom; }) : null) ? '#374151' : '#4b5563';
    if (legR) legR.style.background = (equipped.bottom ? inventory.find(function(i){ return i.id === equipped.bottom; }) : null) ? '#374151' : '#4b5563';
    var hatEl = document.getElementById('previewHat');
    var weaponEl = document.getElementById('previewWeapon');
    if (hatEl) { hatEl.textContent = ''; hatEl.style.display = 'none'; }
    var accSlot = equipped.watch || equipped.earphones || equipped.bag || equipped.glove;
    var accItem = accSlot ? inventory.find(function(i){ return i.id === accSlot; }) : null;
    if (weaponEl) { weaponEl.textContent = accItem ? getItemIcon(accItem) : ''; weaponEl.style.display = accItem ? 'block' : 'none'; }
    var selectHair = document.getElementById('selectHair');
    if (selectHair) selectHair.value = avatar.hair || 'short';
  }

  var routesMapPathEl = null;
  function initRoutesMap() {
    var el = document.getElementById('routesMap');
    if (!el) return;
    if (routesMapPathEl) return;
    el.innerHTML = '';
    var w = 400, h = 180;
    var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('viewBox', '0 0 ' + w + ' ' + h);
    svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
    var grid = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    grid.setAttribute('class', 'our-map-grid');
    for (var i = 0; i <= 8; i++) {
      var v = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      v.setAttribute('x1', (i * w / 8));
      v.setAttribute('y1', 0);
      v.setAttribute('x2', (i * w / 8));
      v.setAttribute('y2', h);
      grid.appendChild(v);
      var hor = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      hor.setAttribute('x1', 0);
      hor.setAttribute('y1', (i * h / 8));
      hor.setAttribute('x2', w);
      hor.setAttribute('y2', (i * h / 8));
      grid.appendChild(hor);
    }
    svg.appendChild(grid);
    var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('class', 'our-map-path');
    path.setAttribute('d', '');
    svg.appendChild(path);
    el.appendChild(svg);
    var label = document.createElement('span');
    label.className = 'our-map-label';
    label.textContent = 'ÏôÑÏ£ºÌïú Í≤ΩÎ°ú';
    el.appendChild(label);
    routesMapPathEl = path;
  }
  function updateRoutesMap(routeId) {
    if (!routesMapPathEl) return;
    var r = routeId ? userRoutes.find(function(x){ return x.id === routeId; }) : null;
    var coords = (r && r.path && r.path.length) ? r.path : [];
    var w = 400, h = 180;
    if (coords.length === 0) {
      routesMapPathEl.setAttribute('d', '');
      return;
    }
    var bounds = ourMapBounds(coords);
    var pts = coords.map(function(c) { return ourMapLatLonToXY(c.lat, c.lon, bounds, w, h); });
    var d = 'M ' + pts[0].x + ' ' + pts[0].y;
    for (var i = 1; i < pts.length; i++) d += ' L ' + pts[i].x + ' ' + pts[i].y;
    routesMapPathEl.setAttribute('d', d);
  }
  function renderRoutes() {
    initRoutesMap();
    var list = document.getElementById('routeList');
    if (!list) return;
    list.innerHTML = '';
    if (userRoutes.length === 0) {
      list.innerHTML = '<p class="story-text" style="color:var(--text-muted);font-size:0.9rem;">ÏïÑÏßÅ ÎßåÎì† ÏΩîÏä§Í∞Ä ÏóÜÏñ¥Ïöî.<br>ÏÇ∞Ï±Ö ÌÉ≠ÏóêÏÑú ÏÉà ÏΩîÏä§Î•º ÎßåÎì§Ïñ¥ Î≥¥ÏÑ∏Ïöî!</p>';
      return;
    }
    userRoutes.forEach(function (r) {
      var card = document.createElement('div');
      card.className = 'route-card' + (r.completedAt ? '' : '');
      card.setAttribute('data-route-id', r.id);
      var status = r.completedAt ? 'done' : 'claim';
      var statusText = r.completedAt ? 'ÏôÑÏ£º' : r.goalKm + ' km';
      card.innerHTML =
        '<div class="route-icon">' + (r.completedAt ? '‚úÖ' : 'üó∫Ô∏è') + '</div>' +
        '<div class="route-info">' +
          '<div class="route-name">' + r.name + '</div>' +
          '<div class="route-steps">Î™©Ìëú ' + r.goalKm + ' km' + (r.path && r.path.length ? ' ¬∑ Í≤ΩÎ°ú Í∏∞Î°ùÎê®' : '') + '</div>' +
        '</div>' +
        '<span class="route-status ' + status + '">' + statusText + '</span>';
      card.onclick = function () { updateRoutesMap(r.id); };
      list.appendChild(card);
    });
  }

  function renderEquipped() {
    var wrap = document.getElementById('equippedSlots');
    if (!wrap) return;
    wrap.innerHTML = '';
    SLOT_ORDER.forEach(function (slot) {
      var itemId = equipped[slot];
      var item = itemId ? inventory.find(function (i) { return i.id === itemId; }) : null;
      var slotEl = document.createElement('div');
      slotEl.className = 'equipped-slot' + (item ? ' filled tier-' + (item.tier || 'standard') : '');
      slotEl.setAttribute('data-slot', slot);
      var tierLabel = item ? (TIER_LABELS[item.tier] || 'Ïä§ÌÉ†Îã§Îìú') : '';
      var icon = item ? getItemIcon(item) : 'Ôºã';
      var nameLine = item ? '<span class="slot-item-name" title="' + (item.name || '') + '">' + (item.name || '') + '</span>' : '';
      slotEl.innerHTML = '<span class="slot-label">' + SLOT_LABELS[slot] + '</span>' + icon + nameLine + (item ? '<span class="inv-tier">' + tierLabel + (item.enhance > 0 ? ' +' + item.enhance : '') + '</span>' : '');
      slotEl.onclick = function () { openEquipModal(slot); };
      wrap.appendChild(slotEl);
    });
    var sumEl = document.getElementById('equipBonusSummary');
    if (sumEl) {
      var b = getEquipmentBonus();
      var parts = [];
      if (b.xp > 0) parts.push('XP +' + b.xp + '%');
      if (b.distance > 0) parts.push('Ïù¥Îèô Í±∞Î¶¨ +' + b.distance + '%');
      if (b.gold > 0) parts.push('Í≥®Îìú +' + b.gold + '%');
      sumEl.innerHTML = parts.length ? '<strong>Ïû•ÎπÑ Î≥¥ÎÑàÏä§</strong>: ' + parts.join(', ') : '<strong>Ïû•ÎπÑ Î≥¥ÎÑàÏä§</strong>: Ï∞©Ïö© Ïû•ÎπÑÏóê Îî∞Îùº XP¬∑Í±∞Î¶¨¬∑Í≥®Îìú Î≥¥ÎÑàÏä§ Ï†ÅÏö© (Í±∏Ïùå ÏàòÎäî Ï†ïÌôïÌïú Í∏∞Î°ù Ïú†ÏßÄÎ•º ÏúÑÌï¥ Î≥¥ÎÑàÏä§ ÏóÜÏùå)';
    }
  }

  function openEquipModal(slot) {
    var list = inventory.filter(function (i) { return itemSlot(i) === slot; });
    if (list.length === 0) { showToast('Ìï¥Îãπ Ïä¨Î°ØÏóê Ï∞©Ïö©Ìï† Ïû•ÎπÑÍ∞Ä ÏóÜÏñ¥Ïöî'); return; }
    var current = equipped[slot];
    var idx = list.findIndex(function (i) { return i.id === current; });
    idx = (idx + 1) % list.length;
    equipped[slot] = list[idx].id;
    saveAll();
    renderEquipped();
    renderInventory();
    renderAvatar();
    showToast(list[idx].name + ' Ï∞©Ïö©');
  }

  function renderInventory() {
    var wrap = document.getElementById('inventoryBySlot');
    if (!wrap) return;
    wrap.innerHTML = '';
    var kits = inventory.filter(function(i){ return i.type === 'supply_kit'; });
    if (kits.length > 0) {
      var kitSec = document.createElement('div');
      kitSec.className = 'inventory-slot-section';
      kitSec.innerHTML = '<h4>üì¶ Î≥¥Í∏â ÌÇ§Ìä∏</h4>';
      var kitList = document.createElement('div');
      kitList.className = 'inventory-slot-list';
      kits.forEach(function() {
        var div = document.createElement('div');
        div.className = 'inv-item inv-item-kit';
        div.innerHTML = '<span>üì¶</span><span class="inv-name">Ìä∏Î†àÏù¥Îãù Î≥¥Í∏â ÌÇ§Ìä∏</span><span class="inv-open">Ïó¥Í∏∞</span>';
        div.onclick = function () { openSupplyKit(); };
        kitList.appendChild(div);
      });
      kitSec.appendChild(kitList);
      wrap.appendChild(kitSec);
    }
    SLOT_ORDER.forEach(function (slot) {
      var list = inventory.filter(function (i) { return i.type !== 'supply_kit' && itemSlot(i) === slot; });
      if (list.length === 0) return;
      var sec = document.createElement('div');
      sec.className = 'inventory-slot-section';
      sec.innerHTML = '<h4>' + SLOT_LABELS[slot] + '</h4>';
      var listEl = document.createElement('div');
      listEl.className = 'inventory-slot-list';
      list.forEach(function (item) {
        var isEquipped = equipped[slot] === item.id;
        var rarity = item.rarity || 'common';
        var tier = item.tier || 'standard';
        var tierLabel = TIER_LABELS[tier] || 'Ïä§ÌÉ†Îã§Îìú';
        var div = document.createElement('div');
        div.className = 'inv-item rarity-' + rarity + ' tier-' + tier + (isEquipped ? ' equipped' : '');
        var enh = (item.enhance != null && item.enhance > 0) ? item.enhance : 0;
        var enhHtml = enh > 0 ? '<span class="inv-enhance">+' + enh + '</span>' : '';
        div.innerHTML = '<span class="rarity-dot"></span><span>' + getItemIcon(item) + '</span><span class="inv-name">' + (item.name || item.id) + '</span>' + enhHtml + '<span class="inv-tier">' + tierLabel + '</span>';
        div.onclick = function () {
          equipped[slot] = equipped[slot] === item.id ? null : item.id;
          saveAll();
          renderEquipped();
          renderInventory();
          renderAvatar();
        };
        listEl.appendChild(div);
      });
      sec.appendChild(listEl);
      wrap.appendChild(sec);
    });
  }

  function getStoryContent() {
    var completedCourses = userRoutes.filter(function(r){ return r.completedAt; });
    var lines = [];
    if (lifetimeSteps < 500 && totalXp < 10) {
      lines.push('ÏïÑÏßÅ ÏÇ∞Ï±ÖÏù¥ ÏãúÏûëÎêòÏßÄ ÏïäÏïòÏñ¥Ïöî.');
      lines.push('ÏÇ∞Ï±Ö ÌÉ≠ÏóêÏÑú ÏΩîÏä§Î•º ÎßåÎì§Í≥† Í±∏Ïñ¥ Î≥¥ÏÑ∏Ïöî.');
    } else {
      lines.push('ÎãπÏã†ÏùÄ Í±∏ÏùåÏùÑ Í±∏ÏúºÎ©∞ ÏÑ∏ÏÉÅÏùÑ ÌÉêÌóòÌïòÍ≥† ÏûàÏäµÎãàÎã§.');
      if (completedCourses.length > 0) {
        var lastCourse = completedCourses[completedCourses.length - 1];
        lines.push('ÏµúÍ∑ºÏóê ' + lastCourse.name + ' ÏΩîÏä§Î•º ÏôÑÏ£ºÌñàÏñ¥Ïöî.');
      }
      if (totalXp > 0) lines.push('Ìä∏Î†àÏù¥Îãù Î≥¥Í∏â ÌÇ§Ìä∏Î°ú Ïû•ÎπÑÎ•º Î™®ÏúºÎ©∞ ÏÑ±Ïû•ÌïòÍ≥† ÏûàÏñ¥Ïöî. (Ï¥ù XP ' + totalXp + ')');
      if (lifetimeSteps >= 10000) lines.push('Îì±ÏÇ∞Î°ú Ï†ïÏÉÅÍπåÏßÄ Ïò§Î•∏ ÎãπÏã†ÏùÄ Ïù¥Ï†ú ÏßÑÏ†ïÌïú ÏÇ∞Ï±ÖÏùò Îã¨Ïù∏ÏûÖÎãàÎã§.');
      else if (lifetimeSteps >= 5000) lines.push('Ïà≤Í≥º Ìò∏ÏàòÎ•º ÏßÄÎÇò Îçî ÎÜíÏùÄ Í≥≥ÏùÑ Î∞îÎùºÎ≥¥Í≥† ÏûàÏñ¥Ïöî.');
      else if (lifetimeSteps >= 2000) lines.push('ÏãúÎÇ¥Î•º Î≤óÏñ¥ÎÇò Í∞ïÍ≥º Í≥µÏõêÏùÑ ÌÉêÌóòÌïòÍ≥† ÏûàÏñ¥Ïöî.');
    }
    var coursesDone = userRoutes.filter(function(r){ return r.completedAt; }).length;
    return { text: lines.join('\n\n'), milestone: 'ÎàÑÏ†Å ' + lifetimeSteps.toLocaleString() + 'Í±∏Ïùå ¬∑ Lv.' + xpToLevel(totalXp).level + ' ¬∑ ÏôÑÏ£º ÏΩîÏä§ ' + coursesDone + 'Í∞ú' };
  }

  function renderStory() {
    var s = getStoryContent();
    var st = document.getElementById('storyText');
    var sm = document.getElementById('storyMilestone');
    if (st) st.textContent = s.text;
    if (sm) sm.textContent = s.milestone;
  }
  
  function openPetSelectModal() {
    var overlay = document.getElementById('petSelectOverlay');
    var grid = document.getElementById('petGrid');
    if (!overlay || !grid) return;
    
    grid.innerHTML = '';
    var selectedPetId = pet.type;
    
    PET_TYPES.forEach(function(petType) {
      var item = document.createElement('div');
      item.className = 'pet-item' + (selectedPetId === petType.id ? ' selected' : '');
      item.setAttribute('data-pet-id', petType.id);
      item.innerHTML = '<div class="pet-item-emoji">' + petType.emoji + '</div><div class="pet-item-name">' + petType.name + '</div><div class="pet-item-desc">' + petType.description + '</div>';
      item.onclick = function() {
        document.querySelectorAll('.pet-item').forEach(function(el) { el.classList.remove('selected'); });
        item.classList.add('selected');
        selectedPetId = petType.id;
      };
      grid.appendChild(item);
    });
    
    overlay.style.display = 'flex';
  }
  
  function closePetSelectModal() {
    var overlay = document.getElementById('petSelectOverlay');
    if (overlay) overlay.style.display = 'none';
  }
  
  function confirmPetSelection() {
    var selectedItem = document.querySelector('.pet-item.selected');
    if (!selectedItem) {
      showToast('ÎèôÎ¨ºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
      return;
    }
    
    var petTypeId = selectedItem.getAttribute('data-pet-id');
    if (!petTypeId) return;
    
    var petType = PET_TYPES.find(function(p) { return p.id === petTypeId; });
    if (!petType) return;
    
    pet.type = petTypeId;
    pet.name = petType.name;
    if (!pet.level) pet.level = 1;
    if (pet.exp == null) pet.exp = 0;
    
    saveAll();
    renderPet();
    closePetSelectModal();
    showToast(petType.name + 'ÏùÑ(Î•º) ÏÑ†ÌÉùÌñàÏñ¥Ïöî! Ìï®Íªò Í±∏Ïñ¥ ÏÑ±Ïû•Ìï¥Î¥êÏöî! üêæ');
  }

  function attachListeners() {
    document.querySelectorAll('.tab-btn').forEach(function (btn) {
      btn.addEventListener('click', function () { switchTab(btn.getAttribute('data-tab')); });
    });
    var btnAdd = document.getElementById('btnAdd');
    var btnReset = document.getElementById('btnReset');
    if (btnAdd) btnAdd.addEventListener('click', addStep);
    if (btnReset) btnReset.addEventListener('click', function () {
      if (confirm('Ïò§ÎäòÏùò Í±∏Ïùå ÏàòÎßå 0ÏúºÎ°ú Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî? (ÎàÑÏ†Å Í±∏ÏùåÍ≥º Ïû•ÎπÑÎäî Ïú†ÏßÄÎê©ÎãàÎã§)')) {
        steps = 0;
        saveAll();
        renderSteps();
      }
    });
    var inputName = document.getElementById('inputAvatarName');
    if (inputName) {
      inputName.addEventListener('input', function () {
        avatar.name = this.value.trim() || 'ÏÇ∞Ï±ÖÎü¨';
        var an = document.getElementById('avatarName');
        if (an) an.textContent = avatar.name;
        saveAll();
      });
      inputName.addEventListener('blur', saveAll);
    }
    document.querySelectorAll('.color-swatch[data-skin]').forEach(function (sw) {
      sw.addEventListener('click', function () {
        document.querySelectorAll('.color-swatch[data-skin]').forEach(function (s) { s.classList.remove('active'); });
        sw.classList.add('active');
        avatar.skin = sw.getAttribute('data-skin');
        var b = document.getElementById('previewBody'), h = document.getElementById('previewHead');
        if (b) b.style.background = avatar.skin;
        if (h) h.style.background = avatar.skin;
        saveAll();
      });
    });
    document.querySelectorAll('.color-swatch.hair-color').forEach(function (sw) {
      sw.addEventListener('click', function () {
        document.querySelectorAll('.color-swatch.hair-color').forEach(function (s) { s.classList.remove('active'); });
        sw.classList.add('active');
        avatar.hairColor = sw.getAttribute('data-hair');
        var hair = document.getElementById('previewHair');
        if (hair) hair.style.background = avatar.hairColor;
        saveAll();
      });
    });
    var selectHair = document.getElementById('selectHair');
    if (selectHair) selectHair.addEventListener('change', function () {
      avatar.hair = this.value;
      renderAvatar();
      saveAll();
    });
    var btnWalkStart = document.getElementById('btnWalkStart');
    var btnWalkStop = document.getElementById('btnWalkStop');
    if (btnWalkStart) btnWalkStart.addEventListener('click', startWalk);
    if (btnWalkStop) btnWalkStop.addEventListener('click', stopWalk);
    var courseInput = document.getElementById('courseGoalKm');
    var routeCreateCard = document.getElementById('routeCreateCard');
    var btnAddRoute = document.getElementById('btnAddRoute');
    var btnSaveRoute = document.getElementById('btnSaveRoute');
    if (btnAddRoute) btnAddRoute.addEventListener('click', function () { routeCreateCard.style.display = routeCreateCard.style.display === 'none' ? 'block' : 'none'; });
    if (btnSaveRoute) btnSaveRoute.addEventListener('click', addNewRoute);
    var themeToggle = document.getElementById('themeToggle');
    if (themeToggle) themeToggle.addEventListener('click', function () {
      var next = document.body.getAttribute('data-theme') === 'night' ? 'morning' : 'night';
      document.body.setAttribute('data-theme', next);
      localStorage.setItem(STORAGE_KEYS.theme, next);
      themeToggle.textContent = next === 'night' ? 'üåô' : '‚òÄÔ∏è';
    });
    if (document.body.getAttribute('data-theme') === 'morning') themeToggle.textContent = '‚òÄÔ∏è';
    var btnGacha = document.getElementById('btnGacha');
    if (btnGacha) btnGacha.addEventListener('click', function() { doGachaPull(false); });
    var btnGachaPremium = document.getElementById('btnGachaPremium');
    if (btnGachaPremium) btnGachaPremium.addEventListener('click', function() { doGachaPull(true); });
    var btnShare = document.getElementById('btnShare');
    if (btnShare) btnShare.addEventListener('click', doShare);
    var btnEnhance = document.getElementById('btnEnhance');
    if (btnEnhance) btnEnhance.addEventListener('click', tryEnhance);
    var btnHeaderAuth = document.getElementById('btnHeaderAuth');
    if (btnHeaderAuth) btnHeaderAuth.addEventListener('click', function() {
      if (isLoggedIn) {
        // Î°úÍ∑∏Ïù∏ ÏÉÅÌÉúÏùº ÎïåÎäî ÌîÑÎ°úÌïÑ ÌëúÏãú (ÎòêÎäî ÏïÑÎ¨¥ ÎèôÏûë Ïïà Ìï®)
        // Î°úÍ∑∏ÏïÑÏõÉÏùÄ Î≥ÑÎèÑ Î≤ÑÌäºÏúºÎ°ú Ï≤òÎ¶¨
      } else {
        openAuthModal();
      }
    });
    var btnLogout = document.getElementById('btnLogout');
    if (btnLogout) btnLogout.addEventListener('click', function() {
      if (confirm('Î°úÍ∑∏ÏïÑÏõÉÌï†ÍπåÏöî?')) {
        doLogout();
      }
    });
    document.querySelectorAll('.auth-tab').forEach(function(t) {
      t.addEventListener('click', function() {
        var tab = this.getAttribute('data-auth-tab');
        switchAuthTab(tab);
      });
    });
    var authClose = document.getElementById('authClose');
    if (authClose) authClose.addEventListener('click', closeAuthModal);
    var authOverlay = document.getElementById('authOverlay');
    if (authOverlay) authOverlay.addEventListener('click', function(e) { if (e.target === authOverlay && !authOverlay.classList.contains('auth-gate')) closeAuthModal(); });
    var btnAuthLogin = document.getElementById('btnAuthLogin');
    if (btnAuthLogin) btnAuthLogin.addEventListener('click', doLogin);
    var btnAuthSignup = document.getElementById('btnAuthSignup');
    if (btnAuthSignup) btnAuthSignup.addEventListener('click', doSignup);
    var btnFindId = document.getElementById('btnFindId');
    if (btnFindId) btnFindId.addEventListener('click', function() { switchAuthTab('findId'); });
    var btnFindPw = document.getElementById('btnFindPw');
    if (btnFindPw) btnFindPw.addEventListener('click', function() { switchAuthTab('findPw'); });
    var btnFindIdSubmit = document.getElementById('btnFindIdSubmit');
    if (btnFindIdSubmit) btnFindIdSubmit.addEventListener('click', doFindId);
    var btnFindPwSubmit = document.getElementById('btnFindPwSubmit');
    if (btnFindPwSubmit) btnFindPwSubmit.addEventListener('click', doFindPw);
    var btnResetPwSubmit = document.getElementById('btnResetPwSubmit');
    if (btnResetPwSubmit) btnResetPwSubmit.addEventListener('click', doResetPw);
    var btnBackToLogin = document.getElementById('btnBackToLogin');
    if (btnBackToLogin) btnBackToLogin.addEventListener('click', function() { switchAuthTab('login'); });
    var btnBackToLogin2 = document.getElementById('btnBackToLogin2');
    if (btnBackToLogin2) btnBackToLogin2.addEventListener('click', function() { switchAuthTab('login'); });
    var btnKakaoLogin = document.getElementById('btnKakaoLogin');
    if (btnKakaoLogin) btnKakaoLogin.addEventListener('click', function() { doSocialLogin('kakao'); });
    var btnKakaoSignup = document.getElementById('btnKakaoSignup');
    if (btnKakaoSignup) btnKakaoSignup.addEventListener('click', function() { doSocialLogin('kakao'); });
    var btnGoogleLogin = document.getElementById('btnGoogleLogin');
    if (btnGoogleLogin) btnGoogleLogin.addEventListener('click', function() { doSocialLogin('google'); });
    var btnGoogleSignup = document.getElementById('btnGoogleSignup');
    if (btnGoogleSignup) btnGoogleSignup.addEventListener('click', function() { doSocialLogin('google'); });
    var btnWelcomeClose = document.getElementById('btnWelcomeClose');
    if (btnWelcomeClose) btnWelcomeClose.addEventListener('click', hideWelcomeModal);
    var welcomeModal = document.getElementById('welcomeModal');
    if (welcomeModal) welcomeModal.addEventListener('click', function(e) {
      if (e.target === welcomeModal) hideWelcomeModal();
    });
    var btnSelectPet = document.getElementById('btnSelectPet');
    if (btnSelectPet) btnSelectPet.addEventListener('click', openPetSelectModal);
    var btnConfirmPet = document.getElementById('btnConfirmPet');
    if (btnConfirmPet) btnConfirmPet.addEventListener('click', confirmPetSelection);
    var petSelectClose = document.getElementById('petSelectClose');
    if (petSelectClose) petSelectClose.addEventListener('click', closePetSelectModal);
    var petSelectOverlay = document.getElementById('petSelectOverlay');
    if (petSelectOverlay) petSelectOverlay.addEventListener('click', function(e) {
      if (e.target === petSelectOverlay) closePetSelectModal();
    });
    var btnAttendance = document.getElementById('btnAttendance');
    if (btnAttendance) btnAttendance.addEventListener('click', doAttendance);
  }

  var lastAcc = 0, lastPeakTime = 0;
  function onMotion(e) {
    var acc = e.accelerationIncludingGravity;
    if (acc.x == null || acc.y == null || acc.z == null) return;
    var magnitude = Math.sqrt(acc.x * acc.x + acc.y * acc.y + acc.z * acc.z);
    var now = Date.now();
    if (magnitude > 12 && (now - lastPeakTime) > 400 && lastAcc > 0 && lastAcc < magnitude) {
      lastPeakTime = now;
      addStep();
    }
    lastAcc = magnitude;
  }
  function initSensorAndStatus() {
    var statusEl = document.getElementById('status');
    if (!statusEl) return;
    if (typeof DeviceMotionEvent !== 'undefined') {
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        statusEl.textContent = 'iOS: ÌôîÎ©¥ÏùÑ Ìïú Î≤à ÌÉ≠ÌïòÎ©¥ ÏÑºÏÑúÎ•º Ïº§ Ïàò ÏûàÏñ¥Ïöî. Î≤ÑÌäºÏúºÎ°úÎèÑ Í±∏ÏùåÏùÑ Ï∂îÍ∞ÄÌï† Ïàò ÏûàÏñ¥Ïöî.';
        document.body.addEventListener('click', function req() {
          DeviceMotionEvent.requestPermission()
            .then(function (p) {
              if (p === 'granted') {
                window.addEventListener('devicemotion', onMotion);
                statusEl.textContent = 'Í±∏Ïùå Í∞êÏßÄ ÏºúÏßê';
                statusEl.classList.add('sensor-ok');
              }
            }, function () { statusEl.textContent = 'ÏÑºÏÑú ÏÇ¨Ïö© Î∂àÍ∞Ä. Î≤ÑÌäºÏúºÎ°ú Í±∏ÏùåÏùÑ Ï∂îÍ∞ÄÌï¥ Ï£ºÏÑ∏Ïöî.'; });
        }, { once: true });
      } else {
        window.addEventListener('devicemotion', onMotion);
        statusEl.textContent = 'Í±∏Ïùå Í∞êÏßÄ ÏºúÏßê (Î≤ÑÌäºÏúºÎ°úÎèÑ Ï∂îÍ∞Ä Í∞ÄÎä•)';
        statusEl.classList.add('sensor-ok');
      }
    } else {
      statusEl.textContent = 'Î≤ÑÌäºÏùÑ ÎàåÎü¨ Í±∏ÏùåÏùÑ Ï∂îÍ∞ÄÌï¥ Ï£ºÏÑ∏Ïöî.';
    }
  }

  function init() {
    attachListeners();
    loadAll();
    initAuth().then(function () {
      checkRouteRewards();
      renderSteps();
      renderWalk();
      renderAvatar();
      renderPet();
      renderRoutes();
      renderStorage();
      renderQuests();
      renderHeaderAuth();
      renderAttendance();
      renderEquipped();
      renderInventory();
      renderStory();
      renderLevel();
      renderRouteSelect();
      renderAchievements();
      renderGold();
      renderEnhanceSelect();
      var themeToggle = document.getElementById('themeToggle');
      if (themeToggle && document.body.getAttribute('data-theme') === 'morning') themeToggle.textContent = '‚òÄÔ∏è';
      initSensorAndStatus();
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();

  if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(function () {});
  </script>
</body>
</html>
