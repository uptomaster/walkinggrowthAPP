<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#00d4aa">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="WalkStory">
  <title>WalkStory Â· ê±¸ìŒìœ¼ë¡œ í‚¤ìš°ëŠ” ë‚˜ë§Œì˜ ë™ë¬¼ ì¹œêµ¬</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="./walkstory-logo.png">
  <link rel="apple-touch-icon" href="./walkstory-logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;600;700&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
  <script>
    // ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™”
    if (typeof window !== 'undefined' && window.APP_CONFIG && window.APP_CONFIG.kakao) {
      Kakao.init(window.APP_CONFIG.kakao.javascriptKey);
    }
  </script>
  <style>
    /* ë‚˜ì´íŠ¸ (ê¸°ë³¸) - ë¶€ë“œëŸ¬ìš´ ë‹¤í¬ ê·¸ë¦° í†¤ */
    :root, [data-theme="night"] {
      --bg: #0f1419;
      --bg-soft: #151c23;
      --card: #1a222c;
      --card-hover: #1f2935;
      --accent: #4ade80;
      --accent-dim: rgba(74, 222, 128, 0.16);
      --accent-glow: rgba(74, 222, 128, 0.28);
      --gold: #fcd34d;
      --gold-dim: rgba(252, 211, 77, 0.18);
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --goal: 10000;
      --radius: 1rem;
      --radius-lg: 1.25rem;
      --shadow: 0 4px 20px rgba(0,0,0,0.3);
      --shadow-glow: 0 0 28px var(--accent-glow);
      --rarity-common: #94a3b8;
      --rarity-rare: #60a5fa;
      --rarity-epic: #a78bfa;
      --rarity-legend: #fcd34d;
    }
    /* ëª¨ë‹ - ë”°ëœ»í•œ ì•„ì¹¨ í†¤ */
    [data-theme="morning"] {
      --bg: #f0f7f0;
      --bg-soft: #f7fbf7;
      --card: #ffffff;
      --card-hover: #ecf5ec;
      --accent: #16a34a;
      --accent-dim: rgba(22, 163, 74, 0.12);
      --accent-glow: rgba(22, 163, 74, 0.22);
      --gold: #ca8a04;
      --gold-dim: rgba(202, 138, 4, 0.15);
      --text: #14532d;
      --text-muted: #4d7c5c;
      --shadow: 0 2px 16px rgba(0,0,0,0.06);
      --shadow-glow: 0 0 20px var(--accent-glow);
      --rarity-common: #64748b;
      --rarity-rare: #2563eb;
      --rarity-epic: #7c3aed;
      --rarity-legend: #ca8a04;
    }
    [data-theme="morning"] body::before {
      background: radial-gradient(ellipse 85% 60% at 50% -10%, rgba(22,163,74,0.1), transparent 50%);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Outfit', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 0 5.5rem;
      padding-right: max(0, env(safe-area-inset-right, 0));
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 55vh;
      background: radial-gradient(ellipse 90% 70% at 50% -15%, var(--accent-dim), transparent 55%);
      pointer-events: none;
      z-index: 0;
    }

    .container { width: 100%; max-width: 420px; position: relative; z-index: 1; padding-left: 1rem; padding-right: max(1rem, env(safe-area-inset-right, 0)); box-sizing: border-box; }

    header { text-align: center; margin-bottom: 1rem; padding-top: 0.75rem; position: relative; }
    h1 { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.03em; color: var(--text); }
    .subtitle { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.35rem; font-weight: 400; }
    .header-level { display: inline-flex; align-items: center; gap: 0.35rem; margin-top: 0.5rem; padding: 0.35rem 0.75rem; background: var(--card); border-radius: 999px; border: 1px solid rgba(255,255,255,0.08); font-size: 0.8rem; font-weight: 600; color: var(--accent); }
    .header-level .lv-num { font-size: 1rem; }
    .level-bar-wrap { width: 120px; height: 6px; background: var(--bg-soft); border-radius: 999px; overflow: hidden; margin-left: 0.25rem; }
    .level-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #10b981); border-radius: 999px; transition: width 0.3s ease; }
    .header-right { position: absolute; top: 0.75rem; right: 0; display: flex; align-items: center; gap: 0.5rem; }
    .theme-toggle { width: 36px; height: 36px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); background: var(--card); color: var(--text-muted); font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    [data-theme="morning"] .theme-toggle { border-color: rgba(0,0,0,0.1); }
    .gold-display { font-size: 0.85rem; font-weight: 700; color: var(--gold); display: flex; align-items: center; gap: 0.25rem; }
    .header-auth-btn { font-size: 0.7rem; padding: 0.3rem 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: var(--card); color: var(--text-muted); cursor: pointer; font-family: inherit; font-weight: 500; }
    .header-auth-btn:hover { color: var(--accent); border-color: var(--accent); }
    .header-auth-btn.logged-in { border-color: var(--accent); color: var(--accent); }
    .header-logout-btn { font-size: 0.7rem; padding: 0.3rem 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: var(--card); color: var(--text-muted); cursor: pointer; font-family: inherit; font-weight: 500; }
    .header-logout-btn:hover { color: #ef4444; border-color: #ef4444; }
    .auth-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 1rem; }
    .auth-modal { background: var(--card); border-radius: var(--radius-lg); padding: 1.5rem; max-width: 320px; width: 100%; border: 1px solid rgba(255,255,255,0.08); box-shadow: var(--shadow); position: relative; }
    .auth-tabs { display: flex; gap: 0.25rem; margin-bottom: 1rem; }
    .auth-tab { flex: 1; padding: 0.5rem; border: none; border-radius: var(--radius); background: var(--bg-soft); color: var(--text-muted); font-size: 0.85rem; font-family: inherit; cursor: pointer; }
    .auth-tab.active { background: var(--accent-dim); color: var(--accent); font-weight: 600; }
    .auth-title { font-size: 1rem; margin-bottom: 1rem; color: var(--text); }
    .auth-panel label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-top: 0.75rem; margin-bottom: 0.25rem; }
    .auth-panel input { width: 100%; padding: 0.6rem; border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.15); background: var(--bg-soft); color: var(--text); font-size: 0.9rem; box-sizing: border-box; }
    .btn-auth-submit { width: 100%; margin-top: 1rem; padding: 0.65rem; border: none; border-radius: var(--radius); background: linear-gradient(145deg, var(--accent), #10b981); color: var(--bg); font-weight: 600; font-family: inherit; cursor: pointer; font-size: 0.9rem; }
    .auth-hint { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.75rem; }
    .auth-link-btn { font-size: 0.8rem; }
    .auth-divider { display: flex; align-items: center; margin: 1rem 0; text-align: center; }
    .auth-divider::before, .auth-divider::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.1); }
    .auth-divider span { padding: 0 0.75rem; color: var(--text-muted); font-size: 0.75rem; }
    .btn-social { width: 100%; padding: 0.65rem; border: none; border-radius: var(--radius); font-weight: 600; font-family: inherit; cursor: pointer; font-size: 0.9rem; margin-top: 0.5rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
    .btn-kakao { background: #FEE500; color: #000; }
    .btn-kakao:hover { background: #FDD835; }
    .btn-google { background: #fff; color: #000; border: 1px solid rgba(255,255,255,0.2); }
    .btn-google:hover { background: #f5f5f5; }
    .auth-close { position: absolute; top: 0.75rem; right: 0.75rem; width: 28px; height: 28px; border: none; border-radius: 50%; background: var(--bg-soft); color: var(--text-muted); cursor: pointer; font-size: 1rem; line-height: 1; }
    .auth-overlay.auth-gate { align-items: center; justify-content: center; }
    .auth-overlay.auth-gate .auth-close { display: none; }
    .pet-section { background: var(--card); border-radius: var(--radius-lg); padding: 1rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.08); }
    .pet-display { text-align: center; }
    .pet-preview { display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-bottom: 1rem; }
    .pet-emoji { font-size: 4rem; line-height: 1; }
    .pet-info { width: 100%; }
    .pet-name { font-size: 1.1rem; font-weight: 600; color: var(--text); margin-bottom: 0.5rem; }
    .pet-level { font-size: 0.9rem; color: var(--accent); font-weight: 600; margin-bottom: 0.5rem; }
    .pet-exp-bar { width: 100%; height: 8px; background: var(--bg-soft); border-radius: 999px; overflow: hidden; margin-bottom: 0.5rem; }
    .pet-exp-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #10b981); border-radius: 999px; transition: width 0.3s ease; }
    .pet-exp-text { font-size: 0.75rem; color: var(--text-muted); }
    .btn-select-pet { width: 100%; padding: 0.65rem; border: none; border-radius: var(--radius); background: linear-gradient(145deg, var(--accent), #10b981); color: var(--bg); font-weight: 600; font-family: inherit; cursor: pointer; font-size: 0.9rem; }
    .pet-select-modal { background: var(--card); border-radius: var(--radius-lg); padding: 1.5rem; max-width: 400px; width: 100%; border: 1px solid rgba(255,255,255,0.08); box-shadow: var(--shadow); }
    .pet-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-top: 1rem; }
    .pet-item { background: var(--bg-soft); border: 2px solid rgba(255,255,255,0.1); border-radius: var(--radius); padding: 1rem; cursor: pointer; transition: all 0.2s; text-align: center; }
    .pet-item:hover { border-color: var(--accent); background: var(--accent-dim); }
    .pet-item.selected { border-color: var(--accent); background: var(--accent-dim); }
    .pet-item-emoji { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .pet-item-name { font-size: 0.9rem; font-weight: 600; color: var(--text); margin-bottom: 0.25rem; }
    .pet-item-desc { font-size: 0.7rem; color: var(--text-muted); }
    #appMain { display: block; }
    #appMain.hidden { display: none !important; }
    .attendance-card { background: linear-gradient(145deg, var(--card), rgba(251,191,36,0.06)); border: 1px solid rgba(251,191,36,0.2); border-radius: var(--radius-lg); padding: 1rem; margin-bottom: 1rem; box-shadow: var(--shadow); }
    .attendance-desc { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.75rem; }
    .attendance-status { font-size: 0.9rem; color: var(--text); margin-bottom: 0.5rem; }
    .btn-attendance { width: 100%; padding: 0.65rem; border: none; border-radius: var(--radius); background: linear-gradient(145deg, var(--gold), #d97706); color: #1a1a1a; font-weight: 700; font-family: inherit; cursor: pointer; font-size: 0.9rem; }
    .title-badge { font-size: 0.7rem; color: var(--accent); margin-top: 0.35rem; font-weight: 600; }
    .walk-stat.walk-total { grid-column: 1 / -1; }

    /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
    .tab-nav {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.35rem;
      background: var(--card);
      border-radius: var(--radius);
      padding: 0.5rem;
      margin-bottom: 1.25rem;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: var(--shadow);
    }
    .tab-btn {
      min-width: 3rem;
      padding: 0.4rem 0.2rem;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.65rem;
      font-family: inherit;
      font-weight: 500;
      cursor: pointer;
      border-radius: 0.65rem;
      transition: all 0.25s ease;
    }
    .tab-btn:hover { color: var(--text); }
    .tab-btn.active { background: linear-gradient(135deg, var(--accent-dim), rgba(52,211,153,0.08)); color: var(--accent); font-weight: 600; box-shadow: 0 0 0 1px rgba(52,211,153,0.2); }
    .tab-btn .tab-emoji { display: block; font-size: 1.15rem; margin-bottom: 0.2rem; }

    .page { display: none; width: 100%; animation: fadeIn 0.25s ease; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ===== ì¹´ë“œ ê³µí†µ ===== */
    .step-card, .walk-card, .avatar-section, .story-section {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      margin-bottom: 1rem;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: var(--shadow);
      transition: box-shadow 0.2s ease;
    }
    .step-card:hover, .walk-card:hover, .avatar-section:hover { box-shadow: var(--shadow), 0 0 0 1px rgba(255,255,255,0.03); }
    .story-section { min-height: 200px; }

    /* ===== ê±¸ìŒ íƒ­ ===== */
    .step-value-wrap { display: flex; align-items: baseline; justify-content: center; gap: 0.3rem; margin-bottom: 0.3rem; }
    .step-value { font-size: 3.25rem; font-weight: 700; letter-spacing: -0.04em; background: linear-gradient(135deg, var(--accent), #10b981); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; line-height: 1; }
    .step-unit { font-size: 1.1rem; font-weight: 600; color: var(--text-muted); }
    .step-label { text-align: center; font-size: 0.9rem; color: var(--text-muted); font-weight: 400; }
    .lifetime-hint { text-align: center; font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem; }
    .progress-wrap { margin-top: 1.25rem; }
    .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.45rem; font-size: 0.8rem; color: var(--text-muted); }
    .progress-bar-bg { height: 10px; background: var(--bg-soft); border-radius: 999px; overflow: hidden; }
    .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #10b981); border-radius: 999px; width: 0%; transition: width 0.45s ease; box-shadow: 0 0 12px var(--accent-glow); }
    .manual-area { text-align: center; margin-top: 1.25rem; }
    .btn-add {
      width: 58px; height: 58px; border-radius: 50%; border: none; background: linear-gradient(145deg, var(--accent), #10b981); color: var(--bg);
      font-size: 1.6rem; font-weight: 700; cursor: pointer; box-shadow: 0 4px 20px var(--accent-glow);
      transition: transform 0.2s ease, box-shadow 0.2s ease; font-family: inherit; line-height: 1;
    }
    .btn-add:hover { transform: scale(1.06); box-shadow: 0 6px 28px var(--accent-glow); }
    .btn-add:active { transform: scale(0.97); }
    .manual-hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; }
    .status { font-size: 0.75rem; color: var(--text-muted); text-align: center; margin-top: 0.75rem; }
    .status.sensor-ok { color: var(--accent); }
    .actions { display: flex; justify-content: center; gap: 0.75rem; margin-top: 1rem; }
    .btn-reset {
      padding: 0.55rem 1.1rem; border-radius: 999px; border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04); color: var(--text-muted); font-size: 0.8rem; font-family: inherit; cursor: pointer; transition: all 0.2s;
    }
    .btn-reset:hover { color: var(--text); border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.06); }
    .goal-badge { display: none; text-align: center; margin-top: 0.75rem; padding: 0.45rem 1rem; background: var(--accent-dim); color: var(--accent); border-radius: 999px; font-size: 0.85rem; font-weight: 600; }
    .step-card.goal-reached .goal-badge { display: block; }
    .step-card.goal-reached .step-value { animation: pulse 1.5s ease infinite; }
    @keyframes pulse { 50% { opacity: 0.9; } }

    /* ===== ì•„ë°”íƒ€ íƒ­ ===== */
    /* ì œí˜í†  ìŠ¤íƒ€ì¼ 3D ìºë¦­í„° ì˜ì—­ (í”Œë ˆì´ìŠ¤í™€ë”) */
    .avatar-3d-placeholder {
      width: 100%; min-height: 220px; margin: 0 auto 1rem;
      background: linear-gradient(180deg, rgba(52,211,153,0.06) 0%, rgba(0,0,0,0.2) 100%);
      border: 2px dashed rgba(52,211,153,0.35);
      border-radius: var(--radius-lg);
      display: flex; align-items: center; justify-content: center;
      flex-direction: column;
      color: var(--text-muted);
      font-size: 0.85rem;
      text-align: center;
      padding: 1.5rem;
    }
    .avatar-3d-placeholder .ph-title { color: var(--accent); font-weight: 600; margin-bottom: 0.35rem; font-size: 0.95rem; }
    .avatar-3d-placeholder .ph-desc { font-size: 0.75rem; opacity: 0.9; }
    .avatar-preview-wrap {
      width: 150px; height: 200px; margin: 0 auto 1.25rem;
      background: linear-gradient(180deg, rgba(52,211,153,0.08) 0%, rgba(255,255,255,0.03) 100%); border-radius: var(--radius-lg);
      display: flex; align-items: flex-end; justify-content: center;
      position: relative;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
    }
    .avatar-preview {
      width: 80px; height: 120px;
      position: relative;
    }
    /* ì œí˜í†  ìŠ¤íƒ€ì¼ ì¹˜ë¹„: ë¨¸ë¦¬ í¬ê²Œ, ëª¸ ì‘ê²Œ */
    .avatar-body { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 42px; height: 48px; border-radius: 21px 21px 8px 8px; }
    .avatar-head { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 44px; height: 44px; border-radius: 50%; }
    .avatar-hair { position: absolute; bottom: 52px; left: 50%; transform: translateX(-50%); width: 52px; height: 22px; border-radius: 50% 50% 0 0; }
    .avatar-armor { position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); width: 46px; height: 42px; border-radius: 20px 20px 8px 8px; pointer-events: none; }
    .avatar-weapon { position: absolute; bottom: 28px; right: -26px; font-size: 1.4rem; }
    .avatar-hat { position: absolute; bottom: 72px; left: 50%; transform: translateX(-50%); font-size: 1.5rem; }
    .avatar-name { text-align: center; font-size: 1.05rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--accent); }
    .customize-row { display: flex; gap: 0.5rem; align-items: center; margin-top: 0.75rem; flex-wrap: wrap; }
    .customize-row label { font-size: 0.8rem; color: var(--text-muted); min-width: 3.5rem; font-weight: 500; }
    .customize-row select, .customize-row input[type="text"] {
      flex: 1; min-width: 0; padding: 0.5rem 0.75rem; border-radius: 0.6rem;
      border: 1px solid rgba(255,255,255,0.1); background: var(--bg-soft); color: var(--text);
      font-size: 0.85rem; font-family: inherit;
    }
    .color-swatch { width: 30px; height: 30px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.25); cursor: pointer; flex-shrink: 0; transition: transform 0.2s, box-shadow 0.2s; }
    .color-swatch:hover { transform: scale(1.08); }
    .color-swatch.active { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-dim), 0 0 12px var(--accent-glow); }

    /* ===== ì‚°ì±…ë¡œ íƒ­ ===== */
    .route-list { display: flex; flex-direction: column; gap: 0.65rem; }
    .route-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 1rem 1.25rem;
      border: 1px solid rgba(255,255,255,0.06);
      display: flex; align-items: center; gap: 1rem;
      transition: background 0.2s, border-color 0.2s;
    }
    .route-card:not(.locked):hover { background: var(--card-hover); border-color: rgba(52,211,153,0.15); }
    .route-card.locked { opacity: 0.6; }
    .route-icon { font-size: 2rem; width: 48px; text-align: center; flex-shrink: 0; }
    .route-info { flex: 1; min-width: 0; }
    .route-name { font-weight: 600; font-size: 0.95rem; margin-bottom: 0.2rem; }
    .route-steps { font-size: 0.8rem; color: var(--text-muted); }
    .route-reward { font-size: 0.8rem; color: var(--accent); margin-top: 0.25rem; }
    .route-status { font-size: 0.72rem; padding: 0.4rem 0.65rem; border-radius: 999px; flex-shrink: 0; font-weight: 500; }
    .route-status.locked { background: var(--bg-soft); color: var(--text-muted); }
    .route-status.claim { background: var(--accent-dim); color: var(--accent); }
    .route-status.done { background: rgba(52,211,153,0.2); color: var(--accent); }

    /* ===== ì¥ë¹„ íƒ­ ===== */
    .equipped-section { margin-bottom: 1.25rem; }
    .equipped-title { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
    .equipped-slots { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
    .equipped-slot {
      min-height: 4.2rem; background: var(--bg-soft); border-radius: var(--radius);
      border: 1px dashed rgba(255,255,255,0.12); display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 1.5rem; cursor: pointer; transition: all 0.2s; position: relative; padding: 0.5rem 0.35rem 0.4rem;
      gap: 0.2rem;
    }
    .equipped-slot:hover { border-color: rgba(52,211,153,0.3); background: var(--card-hover); }
    .equipped-slot.filled { border-style: solid; border-color: rgba(52,211,153,0.4); background: var(--accent-dim); }
    .equipped-slot .slot-label { font-size: 0.65rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
    .equipped-slot .slot-item-name { font-size: 0.7rem; color: var(--text); font-weight: 500; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; line-height: 1.2; }
    .equipped-slot .inv-tier { font-size: 0.6rem; font-weight: 600; color: var(--text-muted); }
    .equipped-slot.tier-standard .inv-tier { color: #94a3b8; }
    .equipped-slot.tier-pro .inv-tier { color: #60a5fa; }
    .equipped-slot.tier-prime .inv-tier { color: #a78bfa; }
    .equipped-slot.tier-signature .inv-tier { color: #fbbf24; }
    .inventory-title { font-size: 0.8rem; color: var(--text-muted); margin: 1rem 0 0.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
    .inventory-slot-section { margin-bottom: 1rem; }
    .inventory-slot-section h4 { font-size: 0.8rem; color: var(--accent); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.35rem; }
    .inventory-slot-list { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .inventory-slot-list .inv-item { width: calc(25% - 0.4rem); min-width: 72px; box-sizing: border-box; }
    .inventory-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
    .inv-item {
      aspect-ratio: 1; background: var(--card); border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.08);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 1.4rem; cursor: pointer; transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s; position: relative;
    }
    .inv-item:hover { transform: scale(1.05); border-color: rgba(52,211,153,0.25); box-shadow: 0 4px 16px rgba(0,0,0,0.2); }
    .inv-item .inv-name { font-size: 0.58rem; color: var(--text-muted); margin-top: 0.2rem; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .inv-item.equipped { border-color: var(--accent); background: var(--accent-dim); box-shadow: 0 0 0 1px rgba(52,211,153,0.3); }
    .inv-item-kit .inv-open { font-size: 0.55rem; color: var(--accent); margin-top: 0.1rem; font-weight: 600; }
    .storage-actions { display: flex; gap: 0.35rem; margin-top: 0.4rem; justify-content: center; flex-wrap: wrap; }
    .btn-storage-inv, .btn-storage-open { padding: 0.35rem 0.6rem; font-size: 0.7rem; border-radius: 0.5rem; border: none; cursor: pointer; font-family: inherit; font-weight: 600; }
    .btn-storage-inv { background: var(--bg-soft); color: var(--text); border: 1px solid rgba(255,255,255,0.15); }
    .btn-storage-open { background: linear-gradient(145deg, var(--accent), #10b981); color: var(--bg); }
    .inv-item .rarity-dot { position: absolute; top: 0.2rem; right: 0.2rem; width: 6px; height: 6px; border-radius: 50%; }
    .inv-item.rarity-common .rarity-dot { background: var(--rarity-common); }
    .inv-item.rarity-rare .rarity-dot { background: var(--rarity-rare); box-shadow: 0 0 6px var(--rarity-rare); }
    .inv-item.rarity-epic .rarity-dot { background: var(--rarity-epic); box-shadow: 0 0 8px var(--rarity-epic); }
    .inv-item.rarity-legend .rarity-dot { background: var(--rarity-legend); box-shadow: 0 0 10px var(--rarity-legend); }
    .inv-item.rarity-rare { border-color: rgba(96,165,250,0.4); }
    .inv-item.rarity-epic { border-color: rgba(167,139,250,0.5); box-shadow: 0 0 12px rgba(167,139,250,0.2); }
    .inv-item.rarity-legend { border-color: rgba(251,191,36,0.6); box-shadow: 0 0 16px rgba(251,191,36,0.25); }
    /* ë“±ê¸‰(í‹°ì–´)ë³„ ì¥ë¹„ ìŠ¤íƒ€ì¼ */
    .inv-item .inv-tier { font-size: 0.55rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; margin-top: 0.15rem; }
    .inv-item .inv-enhance { font-size: 0.85rem; font-weight: 800; color: var(--accent); margin-top: 0.1rem; }
    .inv-item.tier-standard { border-color: rgba(148,163,184,0.4); }
    .inv-item.tier-standard .inv-tier { color: #94a3b8; }
    .inv-item.tier-pro { border-color: rgba(96,165,250,0.5); box-shadow: 0 0 10px rgba(96,165,250,0.15); }
    .inv-item.tier-pro .inv-tier { color: #60a5fa; }
    .inv-item.tier-prime { border-color: rgba(167,139,250,0.6); box-shadow: 0 0 14px rgba(167,139,250,0.2); }
    .inv-item.tier-prime .inv-tier { color: #a78bfa; }
    .inv-item.tier-signature { border-color: rgba(251,191,36,0.7); box-shadow: 0 0 18px rgba(251,191,36,0.25); background: linear-gradient(145deg, var(--card), rgba(251,191,36,0.06)); }
    .inv-item.tier-signature .inv-tier { color: #fbbf24; }
    .equipped-slot.tier-standard.filled { border-color: rgba(148,163,184,0.5); }
    .equipped-slot.tier-pro.filled { border-color: rgba(96,165,250,0.5); box-shadow: 0 0 8px rgba(96,165,250,0.2); }
    .equipped-slot.tier-prime.filled { border-color: rgba(167,139,250,0.5); box-shadow: 0 0 10px rgba(167,139,250,0.25); }
    .equipped-slot.tier-signature.filled { border-color: rgba(251,191,36,0.6); box-shadow: 0 0 12px rgba(251,191,36,0.3); }

    /* ===== ìŠ¤í† ë¦¬ íƒ­ ===== */
    .story-title { font-size: 0.95rem; color: var(--accent); margin-bottom: 0.75rem; font-weight: 600; }
    .story-text { font-size: 0.9rem; line-height: 1.7; color: var(--text); font-weight: 400; white-space: pre-line; }
    .story-milestone { font-size: 0.78rem; color: var(--text-muted); margin-top: 1rem; }

    /* ë³´ìƒ íŒì—… */
    .toast {
      position: fixed; bottom: 5.5rem; left: 50%; transform: translateX(-50%) translateY(100px);
      background: var(--card); border: 1px solid var(--accent);
      color: var(--accent); padding: 0.8rem 1.35rem; border-radius: var(--radius);
      font-size: 0.9rem; font-weight: 600; z-index: 100; opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
      box-shadow: var(--shadow), 0 0 24px var(--accent-glow);
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* ì˜¤ëŠ˜ì˜ í€˜ìŠ¤íŠ¸ */
    .quest-card { background: var(--card); border-radius: var(--radius-lg); padding: 1rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.06); box-shadow: var(--shadow); }
    .quest-desc { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.75rem; }
    .quest-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .quest-item { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; padding: 0.6rem 0.75rem; background: var(--bg-soft); border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.06); }
    .quest-item.done { border-color: rgba(52,211,153,0.3); background: var(--accent-dim); }
    .quest-item .quest-info { flex: 1; min-width: 0; }
    .quest-item .quest-name { font-size: 0.85rem; font-weight: 600; color: var(--text); }
    .quest-item .quest-progress { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.2rem; }
    .quest-item .quest-reward { font-size: 0.8rem; font-weight: 700; color: var(--gold); white-space: nowrap; }
    .quest-item .btn-claim { padding: 0.35rem 0.65rem; font-size: 0.75rem; border-radius: 0.5rem; border: none; background: linear-gradient(145deg, var(--gold), #d97706); color: #1a1a1a; font-weight: 600; cursor: pointer; font-family: inherit; }
    .quest-item .quest-done-label { font-size: 0.75rem; color: var(--accent); font-weight: 600; }

    /* ===== ì‚°ì±… íƒ­ (ì½”ìŠ¤ + GPS) ===== */
    .walk-title { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--accent); }
    .course-set { margin-bottom: 1rem; }
    .course-label { display: block; font-size: 0.82rem; color: var(--text-muted); margin-bottom: 0.4rem; font-weight: 500; }
    .course-input { width: 100%; padding: 0.65rem 0.85rem; border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.1); background: var(--bg-soft); color: var(--text); font-size: 1rem; }
    .walk-actions { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    .btn-walk-start, .btn-walk-stop { flex: 1; padding: 0.8rem; border-radius: var(--radius); font-size: 0.95rem; font-weight: 600; font-family: inherit; cursor: pointer; border: none; transition: transform 0.15s, box-shadow 0.15s; }
    .btn-walk-start { background: linear-gradient(145deg, var(--accent), #10b981); color: var(--bg); box-shadow: 0 4px 16px var(--accent-glow); }
    .btn-walk-start:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 6px 20px var(--accent-glow); }
    .btn-walk-stop { background: rgba(248,113,113,0.25); color: #f87171; border: 1px solid rgba(248,113,113,0.4); }
    .btn-walk-stop:hover:not(:disabled) { transform: translateY(-1px); }
    .btn-walk-start:disabled, .btn-walk-stop:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .walk-live { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.75rem; }
    .walk-stat { background: var(--bg-soft); border-radius: 0.6rem; padding: 0.65rem; text-align: center; font-size: 0.85rem; color: var(--text-muted); border: 1px solid rgba(255,255,255,0.05); }
    .walk-stat-value { color: var(--accent); font-weight: 700; font-size: 1.15rem; }
    .walk-next { grid-column: 1 / -1; font-size: 0.8rem; color: var(--gold); text-align: center; font-weight: 500; }
    .walk-status { font-size: 0.8rem; color: var(--text-muted); text-align: center; }
    .walk-route-select { margin-bottom: 1rem; }
    .walk-route-select label { display: block; font-size: 0.82rem; color: var(--text-muted); margin-bottom: 0.4rem; font-weight: 500; }
    .walk-route-select select { width: 100%; padding: 0.65rem 0.85rem; border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.1); background: var(--bg-soft); color: var(--text); font-size: 0.95rem; }
    .btn-add-route { width: 100%; padding: 0.6rem; margin-top: 0.5rem; border-radius: var(--radius); border: 1px dashed rgba(52,211,153,0.5); background: transparent; color: var(--accent); font-size: 0.85rem; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; }
    .btn-add-route:hover { background: var(--accent-dim); }
    #walkMap { width: 100%; height: 220px; border-radius: var(--radius-lg); margin-top: 1rem; overflow: hidden; position: relative; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06), 0 4px 20px rgba(0,0,0,0.2); background: linear-gradient(180deg, var(--bg-soft) 0%, var(--card) 100%); }
    .our-map-wrap { width: 100%; height: 100%; position: relative; border-radius: inherit; }
    .our-map-wrap svg { width: 100%; height: 100%; display: block; }
    .our-map-path { fill: none; stroke: var(--accent); stroke-width: 4; stroke-linecap: round; stroke-linejoin: round; opacity: 0.9; filter: drop-shadow(0 0 6px var(--accent-glow)); transition: d 0.2s ease; }
    [data-theme="morning"] .our-map-path { stroke: var(--accent); filter: drop-shadow(0 0 4px rgba(22,163,74,0.35)); }
    .our-map-char { transition: transform 0.2s ease-out; }
    .our-map-char .char-body { fill: var(--accent); stroke: var(--bg); stroke-width: 2; }
    .our-map-char .char-head { fill: var(--accent); stroke: var(--bg); stroke-width: 1.5; }
    .our-map-char .char-shadow { fill: rgba(0,0,0,0.2); }
    .our-map-grid line { stroke: rgba(255,255,255,0.06); stroke-width: 0.4; stroke-dasharray: 3 4; }
    [data-theme="morning"] .our-map-grid line { stroke: rgba(0,0,0,0.08); stroke-dasharray: 3 4; }
    .our-map-label { position: absolute; bottom: 10px; left: 12px; font-size: 0.72rem; color: var(--text-muted); font-weight: 500; }
    .routes-map-box { border-radius: var(--radius-lg); overflow: hidden; background: linear-gradient(180deg, var(--bg-soft) 0%, var(--card) 100%); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06); }
    .route-create-card { margin-bottom: 1rem; padding: 1rem; background: var(--card); border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.06); }
    .route-create-card input { margin-bottom: 0.5rem; }
    .achievement-section { margin-bottom: 1.25rem; }
    .achievement-title { font-size: 0.9rem; font-weight: 600; color: var(--accent); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
    .achievement-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
    .achievement-item { background: var(--bg-soft); border-radius: var(--radius); padding: 0.75rem; border: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; gap: 0.6rem; }
    .achievement-item.unlocked { border-color: rgba(52,211,153,0.3); background: var(--accent-dim); }
    .achievement-item .ach-icon { font-size: 1.75rem; width: 40px; text-align: center; flex-shrink: 0; }
    .achievement-item.locked .ach-icon { filter: grayscale(1); opacity: 0.6; }
    .achievement-item .ach-name { font-size: 0.8rem; font-weight: 600; }
    .achievement-item .ach-desc { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.15rem; }

    /* ê°€ì± (ë³´ê¸‰ ë½‘ê¸°) */
    .gacha-card { background: var(--card); border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.06); text-align: center; }
    .gacha-gold { font-size: 1.5rem; font-weight: 700; color: var(--gold); margin-bottom: 0.5rem; }
    .gacha-buttons { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-top: 0.75rem; }
    .btn-gacha { padding: 0.75rem 1.25rem; border-radius: var(--radius); background: linear-gradient(145deg, var(--gold), #d97706); color: #1a1a1a; font-weight: 700; font-size: 0.9rem; border: none; cursor: pointer; font-family: inherit; }
    .btn-gacha:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-gacha-premium { padding: 0.75rem 1.25rem; border-radius: var(--radius); background: linear-gradient(145deg, #a78bfa, #7c3aed); color: #fff; font-weight: 700; font-size: 0.9rem; border: none; cursor: pointer; font-family: inherit; }
    .btn-gacha-premium:disabled { opacity: 0.5; cursor: not-allowed; }
    .gacha-cost { font-size: 0.78rem; color: var(--text-muted); margin-top: 0.35rem; }
    .share-card { background: var(--card); border-radius: var(--radius-lg); padding: 1.25rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.06); text-align: center; }
    .btn-share { width: 100%; padding: 0.8rem; border-radius: var(--radius); background: #fee500; color: #191919; font-weight: 700; font-size: 0.9rem; border: none; cursor: pointer; font-family: inherit; }
    .payment-card { background: var(--card); border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.06); }
    .payment-desc { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem; }
    .payment-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.65rem; }
    .payment-item-card { background: var(--bg-soft); border-radius: var(--radius); padding: 1rem; text-align: center; border: 1px solid rgba(255,255,255,0.06); display: flex; flex-direction: column; gap: 0.35rem; align-items: center; }
    .payment-item-card.highlight { border-color: rgba(251,191,36,0.4); background: linear-gradient(145deg, var(--bg-soft), rgba(251,191,36,0.06)); }
    .payment-amount { font-size: 1.1rem; font-weight: 700; color: var(--gold); }
    .payment-price { font-size: 0.7rem; color: var(--text-muted); }
    .btn-payment { padding: 0.45rem 0.75rem; font-size: 0.8rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.06); color: var(--text-muted); cursor: not-allowed; font-family: inherit; }

    /* ì¥ë¹„ ê°•í™” */
    .enhance-section { margin-bottom: 1rem; }
    .enhance-select { width: 100%; padding: 0.65rem; border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.1); background: var(--bg-soft); color: var(--text); margin-bottom: 0.5rem; font-size: 0.9rem; }
    .btn-enhance { width: 100%; padding: 0.75rem; border-radius: var(--radius); background: linear-gradient(145deg, var(--rarity-epic), #7c3aed); color: #fff; font-weight: 600; border: none; cursor: pointer; font-family: inherit; }
    .btn-enhance:disabled { opacity: 0.5; cursor: not-allowed; }
    .enhance-warn { font-size: 0.75rem; color: #f87171; margin-top: 0.5rem; }
    .enhance-table-wrap { margin: 1rem 0; overflow-x: auto; }
    .enhance-table { width: 100%; font-size: 0.8rem; border-collapse: collapse; }
    .enhance-table th, .enhance-table td { padding: 0.5rem 0.6rem; text-align: center; border: 1px solid rgba(255,255,255,0.08); }
    .enhance-table .enhance-col { font-size: 1rem; font-weight: 700; color: var(--accent); }
    .enhance-table th { background: var(--bg-soft); color: var(--text-muted); font-weight: 600; }
    .enhance-table tr:nth-child(even) { background: rgba(255,255,255,0.02); }
    .enhance-table .rate-ok { color: var(--accent); }
    .enhance-table .rate-mid { color: var(--gold); }
    .enhance-table .rate-low { color: #f87171; }
    .enhance-note { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem; line-height: 1.5; }
    .equip-bonus-summary { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.75rem; padding: 0.6rem; background: var(--bg-soft); border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.06); }
    .equip-bonus-summary strong { color: var(--accent); }

    /* 2D ìºë¦­í„° ì¸ê°„í˜• - ë¶€ë“œëŸ¬ìš´ ë¹„ìœ¨ê³¼ ê·¸ë¦¼ì */
    .avatar-human { width: 100px; height: 168px; margin: 0 auto; position: relative; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.2)); }
    .avatar-human .ah-head { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 38px; height: 38px; border-radius: 50%; box-shadow: inset -2px -1px 0 rgba(0,0,0,0.06), 0 2px 6px rgba(0,0,0,0.12); }
    .avatar-human .ah-face { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); width: 24px; height: 10px; display: flex; justify-content: space-between; align-items: center; }
    .avatar-human .ah-face .eye { width: 4px; height: 4px; border-radius: 50%; background: rgba(0,0,0,0.5); }
    .avatar-human .ah-neck { position: absolute; top: 36px; left: 50%; transform: translateX(-50%); width: 10px; height: 12px; border-radius: 0 0 4px 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .avatar-human .ah-torso { position: absolute; top: 48px; left: 50%; transform: translateX(-50%); width: 46px; height: 44px; border-radius: 12px 12px 8px 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.1); }
    .avatar-human .ah-arm-l, .avatar-human .ah-arm-r { position: absolute; top: 52px; width: 10px; height: 34px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    .avatar-human .ah-arm-l { left: 0; transform-origin: top right; }
    .avatar-human .ah-arm-r { right: 0; transform-origin: top left; }
    .avatar-human .ah-leg-l, .avatar-human .ah-leg-r { position: absolute; top: 90px; width: 14px; height: 44px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.12); }
    .avatar-human .ah-leg-l { left: 24px; }
    .avatar-human .ah-leg-r { right: 24px; }
    .avatar-human .ah-slot-head { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); font-size: 1.35rem; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2)); }
    .avatar-human .ah-slot-accessory { position: absolute; top: 6px; right: -12px; font-size: 1.1rem; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2)); }
    .avatar-preview-wrap { padding: 1.25rem; background: linear-gradient(180deg, var(--bg-soft) 0%, var(--card) 100%); border-radius: var(--radius-lg); margin-bottom: 1.25rem; border: 1px solid rgba(255,255,255,0.06); }
    .avatar-section .customize-row { margin-bottom: 1rem; }
    .avatar-section .customize-row label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.4rem; }
    .avatar-section .customize-section-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--accent); margin: 1.25rem 0 0.5rem; padding-bottom: 0.35rem; border-bottom: 1px solid rgba(255,255,255,0.06); }
    .avatar-section .customize-section-title:first-of-type { margin-top: 0; }

    /* ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 480px) {
      .container { padding-left: 0.75rem; padding-right: 0.75rem; }
      header { padding-top: 0.5rem; }
      h1 { font-size: 1.3rem; }
      .step-value { font-size: 2.75rem; }
      .btn-add { width: 64px; height: 64px; font-size: 1.8rem; }
      .tab-btn { min-width: 2.5rem; padding: 0.5rem 0.25rem; font-size: 0.7rem; }
      .tab-btn .tab-emoji { font-size: 1.25rem; }
      .step-card, .walk-card, .avatar-section, .story-section { padding: 1.25rem; }
      .auth-modal { padding: 1.25rem; max-width: 100%; }
      .btn-auth-submit, .btn-gacha, .btn-gacha-premium, .btn-share, .btn-attendance { min-height: 44px; padding: 0.75rem; }
      .btn-reset, .btn-claim { min-height: 36px; padding: 0.5rem 0.9rem; }
      .header-auth-btn { min-height: 36px; padding: 0.4rem 0.6rem; font-size: 0.75rem; }
      .theme-toggle { width: 40px; height: 40px; }
      input[type="text"], input[type="password"], input[type="number"], select { min-height: 44px; font-size: 16px; }
      .inv-item { min-height: 80px; }
      .equipped-slot { min-height: 5rem; }
    }
    @media (hover: none) and (pointer: coarse) {
      .btn-add:hover, .btn-reset:hover, .tab-btn:hover, .header-auth-btn:hover { transform: none; }
      .btn-add:active { transform: scale(0.95); }
      .btn-reset:active, .tab-btn:active { opacity: 0.7; }
    }
    html { -webkit-overflow-scrolling: touch; height: 100%; }
    body { -webkit-tap-highlight-color: transparent; height: 100%; overflow-y: auto; }
    button, a, input, select, .tab-btn, .inv-item, .equipped-slot { -webkit-tap-highlight-color: rgba(255,255,255,0.1); touch-action: manipulation; }
    input, textarea, select { font-size: 16px; }
    @supports (-webkit-touch-callout: none) {
      input, textarea, select { font-size: 16px; }
    }
    @media (max-width: 480px) {
      .auth-overlay { padding: 0.5rem; align-items: flex-start; padding-top: max(1rem, env(safe-area-inset-top)); }
      .auth-modal { margin-top: auto; margin-bottom: auto; max-height: calc(100vh - 2rem); overflow-y: auto; }
    }
  </style>
</head>
<body data-theme="night">
  <div class="container">
    <div id="appMain" class="hidden">
    <header>
      <button type="button" class="theme-toggle" id="themeToggle" title="ëª¨ë‹/ë‚˜ì´íŠ¸ ì „í™˜">ğŸŒ™</button>
      <h1>WalkStory</h1>
      <p class="subtitle">ê±¸ìŒìœ¼ë¡œ í‚¤ìš°ëŠ” ë‚˜ë§Œì˜ ë™ë¬¼ ì¹œêµ¬</p>
      <div class="header-level" id="headerLevel">
        <span>Lv.<span class="lv-num" id="levelNum">1</span></span>
        <div class="level-bar-wrap"><div class="level-bar-fill" id="levelBarFill" style="width:0%"></div></div>
      </div>
      <p class="title-badge" id="titleBadge">ì‚°ì±…ëŸ¬</p>
      <div class="header-right">
        <button type="button" class="header-auth-btn" id="btnHeaderAuth" aria-label="ë¡œê·¸ì¸">ğŸ” ë¡œê·¸ì¸</button>
        <button type="button" class="header-logout-btn" id="btnLogout" aria-label="ë¡œê·¸ì•„ì›ƒ" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
        <span class="gold-display">ğŸª™ <span id="headerGold">0</span> G</span>
      </div>
    </header>

    <nav class="tab-nav" role="tablist">
      <button type="button" class="tab-btn active" data-tab="walk" aria-selected="true"><span class="tab-emoji">ğŸš¶</span>ì‚°ì±…</button>
      <button type="button" class="tab-btn" data-tab="avatar"><span class="tab-emoji">ğŸ§‘</span>ì•„ë°”íƒ€</button>
      <button type="button" class="tab-btn" data-tab="storage"><span class="tab-emoji">ğŸ“¥</span>ë³´ê´€í•¨</button>
      <button type="button" class="tab-btn" data-tab="shop"><span class="tab-emoji">ğŸ›’</span>ìƒì </button>
      <button type="button" class="tab-btn" data-tab="equipment"><span class="tab-emoji">ğŸ’</span>ì¥ë¹„</button>
      <button type="button" class="tab-btn" data-tab="story"><span class="tab-emoji">ğŸ“–</span>ìŠ¤í† ë¦¬</button>
    </nav>

    <!-- ì‚°ì±… íƒ­ (ê±¸ìŒ + ì½”ìŠ¤ + ì§€ë„ + ì‚°ì±…ë¡œ í†µí•©) -->
    <section class="page active" id="page-walk" role="tabpanel">
      <div class="attendance-card" id="attendanceCard" style="display:none;">
        <h2 class="walk-title">ğŸ“… ì¶œì„ ì´ë²¤íŠ¸</h2>
        <p class="attendance-desc">ë§¤ì¼ ì¶œì„í•˜ê³  ë³´ìƒì„ ë°›ì•„ê°€ìš”. 7ì¼ ì—°ì† ì‹œ <strong>ìœ„í´ë¦¬ ë§ˆìŠ¤í„° ì„ ë¬¼ìƒì</strong> ì§€ê¸‰!</p>
        <div class="attendance-status" id="attendanceStatus"></div>
        <button type="button" class="btn-attendance" id="btnAttendance" style="display:none;">ì¶œì„ ì²´í¬</button>
      </div>
      <div class="quest-card">
        <h2 class="walk-title">ğŸ“‹ ì˜¤ëŠ˜ì˜ í€˜ìŠ¤íŠ¸</h2>
        <p class="quest-desc">ì™„ë£Œ í›„ ë³´ìƒì„ ìˆ˜ë ¹í•˜ë©´ ê³¨ë“œë¥¼ ë°›ì„ ìˆ˜ ìˆì–´ìš”.</p>
        <div id="questList" class="quest-list"></div>
      </div>
      <div class="step-card" id="stepCard">
        <div class="step-value-wrap">
          <span class="step-value" id="stepValue">0</span>
          <span class="step-unit">ê±¸ìŒ</span>
        </div>
        <p class="step-label">ì˜¤ëŠ˜ ê±¸ì€ ê±¸ìŒ</p>
        <p class="lifetime-hint">ëˆ„ì  <span id="lifetimeSteps">0</span>ê±¸ìŒìœ¼ë¡œ ì‚°ì±…ë¡œë¥¼ ì—´ì–´ê°€ìš”</p>
        <div class="progress-wrap">
          <div class="progress-header">
            <span>ì˜¤ëŠ˜ ëª©í‘œ</span>
            <span id="progressText">0 / 10,000</span>
          </div>
          <div class="progress-bar-bg">
            <div class="progress-bar-fill" id="progressFill"></div>
          </div>
        </div>
        <div class="goal-badge" id="goalBadge">ğŸ‰ ëª©í‘œ ë‹¬ì„±!</div>
        <div class="manual-area">
          <button type="button" class="btn-add" id="btnAdd" title="ê±¸ìŒ ì¶”ê°€">+</button>
          <p class="manual-hint" id="manualHint">ë²„íŠ¼ìœ¼ë¡œ ê±¸ìŒì„ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”</p>
        </div>
      </div>
      <p class="status" id="status">ì¤€ë¹„ ì¤‘...</p>
      <div class="actions">
        <button type="button" class="btn-reset" id="btnReset">ì˜¤ëŠ˜ ê±¸ìŒ ì´ˆê¸°í™”</button>
      </div>
      <div class="walk-card">
        <h2 class="walk-title">ë‚˜ë§Œì˜ ì‚°ì±… ì½”ìŠ¤</h2>
        <div class="walk-route-select">
          <label>ì§„í–‰í•  ì½”ìŠ¤ ì„ íƒ</label>
          <select id="selectActiveRoute">
            <option value="">-- ì½”ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
          </select>
          <button type="button" class="btn-add-route" id="btnAddRoute">+ ìƒˆ ì½”ìŠ¤ ë§Œë“¤ê¸°</button>
        </div>
        <div class="route-create-card" id="routeCreateCard" style="display:none;">
          <label class="course-label">ì½”ìŠ¤ ì´ë¦„</label>
          <input type="text" id="newRouteName" placeholder="ì˜ˆ: ë™ë„¤ í•œ ë°”í€´" class="course-input" maxlength="20" inputmode="text" />
          <label class="course-label">ëª©í‘œ ê±°ë¦¬ (km, ìµœì†Œ 0.5)</label>
          <input type="number" id="newRouteGoalKm" min="0.5" max="50" step="0.5" value="1" class="course-input" inputmode="decimal" />
          <button type="button" class="btn-walk-start" id="btnSaveRoute" style="margin-top:0.5rem;">ì €ì¥</button>
        </div>
        <div class="walk-actions">
          <button type="button" class="btn-walk-start" id="btnWalkStart">ì‚°ì±… ì‹œì‘</button>
          <button type="button" class="btn-walk-stop" id="btnWalkStop" disabled>ì‚°ì±… ì¢…ë£Œ</button>
        </div>
        <div class="walk-live" id="walkLive">
          <div class="walk-stat"><span class="walk-stat-value" id="walkDistance">0.00</span> km</div>
          <div class="walk-stat">XP <span class="walk-stat-value" id="walkXp">0</span></div>
          <div class="walk-stat walk-total">ì´ ì´ë™ ê±°ë¦¬ <span class="walk-stat-value" id="walkTotalKm">0.00</span> km</div>
          <div class="walk-next" id="walkNext">ì½”ìŠ¤ë¥¼ ì™„ì£¼í•˜ë©´ ë³´ê¸‰ í‚¤íŠ¸ê°€ ë³´ê´€í•¨ì— ë„ì°©í•´ìš”!</div>
        </div>
        <div id="walkMap" class="our-map-wrap"></div>
        <p class="walk-status" id="walkStatus">ì½”ìŠ¤ë¥¼ ì„ íƒí•˜ê³  ì‚°ì±… ì‹œì‘ì„ ëˆ„ë¥´ì„¸ìš”.</p>
      </div>
      <p class="inventory-title">ë‚´ ì‚°ì±… ì½”ìŠ¤</p>
      <div id="routesMap" class="our-map-wrap routes-map-box" style="height:180px;margin-bottom:1rem;"></div>
      <div class="route-list" id="routeList"></div>
    </section>

    <!-- ì•„ë°”íƒ€ íƒ­ -->
    <section class="page" id="page-avatar" role="tabpanel">
      <div class="avatar-section">
        <p class="avatar-name" id="avatarName">ì‚°ì±…ëŸ¬</p>
        <div class="avatar-3d-placeholder" id="avatar3dPlaceholder">
          <span class="ph-title">3D ìºë¦­í„° ì˜ì—­ (Unity WebGL ì—°ë™)</span>
          <span class="ph-desc">Unityë¡œ ë§Œë“  ìºë¦­í„°ë¥¼ ë„£ì„ ìˆ˜ ìˆì–´ìš”. WebGL ë¹Œë“œ í›„ ì´ ì˜ì—­ì— canvasë¥¼ ë„£ê³ , UNITY_ì—°ë™_ê°€ì´ë“œ.mdë¥¼ ì°¸ê³ í•´ ì—°ë™í•˜ì„¸ìš”.<br>ì•„ë˜ëŠ” 2D ë¯¸ë¦¬ë³´ê¸°ì…ë‹ˆë‹¤.</span>
        </div>
        <div class="avatar-preview-wrap">
          <div class="avatar-human" id="avatarHuman">
            <div class="ah-head" id="previewHead" style="background:var(--skin,#f5d0b0)"></div>
            <div class="ah-face"><span class="eye"></span><span class="eye"></span></div>
            <div class="ah-neck" style="background:var(--skin,#f5d0b0)"></div>
            <div class="ah-torso" id="previewBody" style="background:var(--top-color,#6b7280)"></div>
            <div class="ah-arm-l" id="previewArmL" style="background:var(--skin,#f5d0b0)"></div>
            <div class="ah-arm-r" id="previewArmR" style="background:var(--skin,#f5d0b0)"></div>
            <div class="ah-leg-l" id="previewLegL" style="background:var(--bottom-color,#4b5563)"></div>
            <div class="ah-leg-r" id="previewLegR" style="background:var(--bottom-color,#4b5563)"></div>
            <div class="ah-slot-head" id="previewHat"></div>
            <div class="ah-slot-accessory" id="previewWeapon"></div>
          </div>
        </div>
        <div class="pet-section" id="petSection">
          <p class="customize-section-title">ë‚˜ë§Œì˜ ë™ë¬¼ ì¹œêµ¬</p>
          <div class="pet-display" id="petDisplay">
            <div class="pet-preview" id="petPreview">
              <div class="pet-emoji" id="petEmoji" style="font-size: 4rem;">ğŸ¾</div>
              <div class="pet-info" id="petInfo">
                <div class="pet-name" id="petName">ë™ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                <div class="pet-level" id="petLevel">Lv.1</div>
                <div class="pet-exp-bar">
                  <div class="pet-exp-fill" id="petExpFill" style="width: 0%"></div>
                </div>
                <div class="pet-exp-text" id="petExpText">ê²½í—˜ì¹˜: 0 / 100</div>
              </div>
            </div>
            <button type="button" class="btn-select-pet" id="btnSelectPet">ë™ë¬¼ ì„ íƒí•˜ê¸°</button>
          </div>
        </div>
        <p class="customize-section-title">ê¸°ë³¸ ì •ë³´</p>
        <div class="customize-row">
          <label>ì´ë¦„</label>
          <input type="text" id="inputAvatarName" placeholder="ì´ë¦„ ì…ë ¥" maxlength="8" inputmode="text" autocomplete="name" />
        </div>
        <p class="customize-section-title">ì™¸í˜•</p>
        <div class="customize-row">
          <label>í”¼ë¶€ìƒ‰</label>
          <div style="display:flex;gap:0.35rem;flex-wrap:wrap;">
            <button type="button" class="color-swatch active" data-skin="#f5d0b0" style="background:#f5d0b0" aria-label="í”¼ë¶€ìƒ‰ 1"></button>
            <button type="button" class="color-swatch" data-skin="#e8b896" style="background:#e8b896" aria-label="í”¼ë¶€ìƒ‰ 2"></button>
            <button type="button" class="color-swatch" data-skin="#d4a574" style="background:#d4a574" aria-label="í”¼ë¶€ìƒ‰ 3"></button>
            <button type="button" class="color-swatch" data-skin="#c4956a" style="background:#c4956a" aria-label="í”¼ë¶€ìƒ‰ 4"></button>
          </div>
        </div>
        <p class="customize-section-title">ë¨¸ë¦¬</p>
        <div class="customize-row">
          <label>ìŠ¤íƒ€ì¼</label>
          <select id="selectHair">
            <option value="short">ì§§ì€ ë¨¸ë¦¬</option>
            <option value="long">ê¸´ ë¨¸ë¦¬</option>
            <option value="curly">ê³±ìŠ¬ë¨¸ë¦¬</option>
            <option value="spiky">ë»—ì¹œ ë¨¸ë¦¬</option>
          </select>
        </div>
        <div class="customize-row">
          <label>ë¨¸ë¦¬ ìƒ‰</label>
          <div style="display:flex;gap:0.35rem;flex-wrap:wrap;">
            <button type="button" class="color-swatch hair-color active" data-hair="#4a3728" style="background:#4a3728"></button>
            <button type="button" class="color-swatch hair-color" data-hair="#2c1810" style="background:#2c1810"></button>
            <button type="button" class="color-swatch hair-color" data-hair="#8b6914" style="background:#8b6914"></button>
            <button type="button" class="color-swatch hair-color" data-hair="#5c4033" style="background:#5c4033"></button>
          </div>
        </div>
      </div>
    </section>

    <!-- ë³´ê´€í•¨ íƒ­ -->
    <section class="page" id="page-storage" role="tabpanel">
      <div class="walk-card">
        <h2 class="walk-title">ğŸ“¥ ë³´ê´€í•¨</h2>
        <p class="story-text" style="font-size:0.85rem;color:var(--text-muted);margin-bottom:1rem;">ì‚°ì±… ì½”ìŠ¤ ì™„ì£¼ ì‹œ ë°›ì€ ë³´ê¸‰ í‚¤íŠ¸ê°€ ì—¬ê¸°ë¡œ ì˜µë‹ˆë‹¤. ì¸ë²¤ìœ¼ë¡œ ê°€ì ¸ê°€ê±°ë‚˜ ë°”ë¡œ ì—´ ìˆ˜ ìˆì–´ìš”.</p>
        <div class="inventory-slot-list" id="storageList"></div>
      </div>
    </section>

    <!-- ìƒì  íƒ­ (ë³´ê¸‰ + ê³µìœ  + ê²°ì œ) -->
    <section class="page" id="page-shop" role="tabpanel">
      <div class="gacha-card">
        <h2 class="walk-title">ğŸ“¦ ë³´ê¸‰ ë½‘ê¸°</h2>
        <p class="gacha-gold">ğŸª™ <span id="gachaGold">0</span> G</p>
        <div class="gacha-buttons">
          <button type="button" class="btn-gacha" id="btnGacha">1íšŒ ë½‘ê¸° (30 G)</button>
          <button type="button" class="btn-gacha-premium" id="btnGachaPremium">ê°•í™” ë½‘ê¸° (60 G)</button>
        </div>
        <p class="gacha-cost">ê°•í™” ë½‘ê¸°ëŠ” ì¢‹ì€ ë“±ê¸‰Â·í¬ê·€ë„ í™•ë¥  ìƒìŠ¹</p>
      </div>
      <div class="share-card">
        <h2 class="walk-title">ğŸ”— ë§í¬ ê³µìœ  ë³´ìƒ</h2>
        <p class="story-text" style="font-size:0.85rem;margin-bottom:0.75rem;">ì¹´ì¹´ì˜¤í†¡ ë“±ìœ¼ë¡œ ê³µìœ í•˜ë©´ <strong>+40 G</strong> (ì¼ 1íšŒ)</p>
        <button type="button" class="btn-share" id="btnShare">ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ê³µìœ í•˜ê³  40 G ë°›ê¸°</button>
      </div>
      <div class="payment-card">
        <h2 class="walk-title">ğŸ’³ ê³¨ë“œ êµ¬ë§¤</h2>
        <p class="payment-desc">ìŠ¤í† ì–´ ì—°ë™ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
        <div class="payment-grid">
          <div class="payment-item-card">
            <span class="payment-amount">100 G</span>
            <span class="payment-price">ì†Œì•¡</span>
            <button type="button" class="btn-payment" disabled>ì¤€ë¹„ ì¤‘</button>
          </div>
          <div class="payment-item-card">
            <span class="payment-amount">500 G</span>
            <span class="payment-price">ì¸ê¸°</span>
            <button type="button" class="btn-payment" disabled>ì¤€ë¹„ ì¤‘</button>
          </div>
          <div class="payment-item-card highlight">
            <span class="payment-amount">1,200 G</span>
            <span class="payment-price">20% ë³´ë„ˆìŠ¤</span>
            <button type="button" class="btn-payment" disabled>ì¤€ë¹„ ì¤‘</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ì¥ë¹„ íƒ­ (ì°©ìš©/ë³´ìœ  + ê°•í™”) -->
    <section class="page" id="page-equipment" role="tabpanel">
      <div class="equipped-section">
        <p class="equipped-title">ì°©ìš© ì¤‘ (íƒ­í•˜ì—¬ ë³€ê²½)</p>
        <div class="equipped-slots" id="equippedSlots"></div>
        <div class="equip-bonus-summary" id="equipBonusSummary"></div>
      </div>
      <p class="inventory-title">ì¥ë¹„ ì¹¸ë³„ ë³´ìœ  ëª©ë¡ (íƒ­í•˜ë©´ ì°©ìš©)</p>
      <div id="inventoryBySlot"></div>
      <div class="walk-card" style="margin-top:1.25rem;">
        <h2 class="walk-title">â¬†ï¸ ì¥ë¹„ ê°•í™”</h2>
        <div class="enhance-table-wrap">
          <table class="enhance-table" aria-label="ê°•í™” ì„±ê³µë¥ ">
            <thead>
              <tr><th>ê°•í™”</th><th>ì„±ê³µ í™•ë¥ </th><th>ì‹œë„/ì‹¤íŒ¨ ì‹œ</th></tr>
            </thead>
            <tbody id="enhanceTableBody"></tbody>
          </table>
        </div>
        <p class="course-label">ê°•í™”í•  ì¥ë¹„ ì„ íƒ</p>
        <select class="enhance-select" id="enhanceSelect">
          <option value="">-- ì¥ë¹„ ì„ íƒ --</option>
        </select>
        <button type="button" class="btn-enhance" id="btnEnhance">ê°•í™” ì‹œë„</button>
        <p class="enhance-note">1~3ê°• ì‹¤íŒ¨ ì‹œ ì¥ë¹„ íŒŒê´´. 4~7ê°•ì€ ì‹œë„í•  ë•Œ ê³¨ë“œë¥¼ ë¨¼ì € ì°¨ê°í•˜ê³ , ì‹¤íŒ¨í•´ë„ ì¥ë¹„ëŠ” ìœ ì§€ë¼ìš”.</p>
      </div>
    </section>

    <!-- ìŠ¤í† ë¦¬ íƒ­ -->
    <section class="page" id="page-story" role="tabpanel">
      <div class="story-section">
        <p class="story-title">ë‚˜ì˜ ì‚°ì±… ì¼ì§€</p>
        <div class="story-text" id="storyText"></div>
        <p class="story-milestone" id="storyMilestone"></p>
        <div class="achievement-section">
          <p class="achievement-title">ğŸ† ì—…ì </p>
          <div class="achievement-grid" id="achievementGrid"></div>
        </div>
      </div>
    </section>
    </div>

    <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… (ë¹„ë¡œê·¸ì¸ ì‹œ ì²« í™”ë©´, ë¡œê·¸ì¸ í›„ ë©”ì¸ë§Œ í‘œì‹œ) -->
    <div class="auth-overlay auth-gate" id="authOverlay" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <div class="auth-modal">
        <div class="auth-tabs">
          <button type="button" class="auth-tab active" data-auth-tab="login">ë¡œê·¸ì¸</button>
          <button type="button" class="auth-tab" data-auth-tab="signup">íšŒì›ê°€ì…</button>
        </div>
        <h2 class="auth-title" id="authTitle">ë¡œê·¸ì¸</h2>
        <div id="authLoginPanel" class="auth-panel">
          <label>ë‹‰ë„¤ì„</label>
          <input type="text" id="authLoginNick" placeholder="ë‹‰ë„¤ì„" maxlength="12" inputmode="text" autocomplete="username" />
          <label>ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="authLoginPw" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />
          <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.75rem;">
            <button type="button" class="auth-link-btn" id="btnFindId" style="background: none; border: none; color: var(--accent); cursor: pointer; padding: 0;">ì•„ì´ë”” ì°¾ê¸°</button>
            <button type="button" class="auth-link-btn" id="btnFindPw" style="background: none; border: none; color: var(--accent); cursor: pointer; padding: 0;">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</button>
          </div>
          <button type="button" class="btn-auth-submit" id="btnAuthLogin">ë¡œê·¸ì¸</button>
          <div class="auth-divider">
            <span>ë˜ëŠ”</span>
          </div>
          <button type="button" class="btn-social btn-kakao" id="btnKakaoLogin">
            <span>ì¹´ì¹´ì˜¤ë¡œ ì‹œì‘í•˜ê¸°</span>
          </button>
          <button type="button" class="btn-social btn-google" id="btnGoogleLogin">
            <span>êµ¬ê¸€ë¡œ ì‹œì‘í•˜ê¸°</span>
          </button>
        </div>
        <div id="authSignupPanel" class="auth-panel" style="display:none;">
          <label>ë‹‰ë„¤ì„</label>
          <input type="text" id="authSignupNick" placeholder="2~12ì" maxlength="12" inputmode="text" autocomplete="username" />
          <label>ì´ë©”ì¼ <span style="color: #ef4444;">*</span></label>
          <input type="email" id="authSignupEmail" placeholder="example@email.com" required inputmode="email" autocomplete="email" />
          <label>ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="authSignupPw" placeholder="6ì ì´ìƒ" autocomplete="new-password" />
          <label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
          <input type="password" id="authSignupPw2" placeholder="ë‹¤ì‹œ ì…ë ¥" autocomplete="new-password" />
          <button type="button" class="btn-auth-submit" id="btnAuthSignup">ê°€ì…í•˜ê¸°</button>
          <div class="auth-divider">
            <span>ë˜ëŠ”</span>
          </div>
          <button type="button" class="btn-social btn-kakao" id="btnKakaoSignup">
            <span>ì¹´ì¹´ì˜¤ë¡œ ì‹œì‘í•˜ê¸°</span>
          </button>
          <button type="button" class="btn-social btn-google" id="btnGoogleSignup">
            <span>êµ¬ê¸€ë¡œ ì‹œì‘í•˜ê¸°</span>
          </button>
        </div>
        <div id="authFindIdPanel" class="auth-panel" style="display:none;">
          <label>ì´ë©”ì¼</label>
          <input type="email" id="authFindIdEmail" placeholder="ê°€ì… ì‹œ ì…ë ¥í•œ ì´ë©”ì¼" inputmode="email" autocomplete="email" />
          <button type="button" class="btn-auth-submit" id="btnFindIdSubmit">ì•„ì´ë”” ì°¾ê¸°</button>
          <div id="findIdResult" style="margin-top: 1rem; padding: 0.75rem; background: var(--bg-soft); border-radius: var(--radius); display: none;"></div>
          <button type="button" class="auth-link-btn" id="btnBackToLogin" style="width: 100%; margin-top: 0.5rem; background: none; border: none; color: var(--accent); cursor: pointer; padding: 0.5rem;">â† ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
        <div id="authFindPwPanel" class="auth-panel" style="display:none;">
          <label>ì´ë©”ì¼</label>
          <input type="email" id="authFindPwEmail" placeholder="ê°€ì… ì‹œ ì…ë ¥í•œ ì´ë©”ì¼" inputmode="email" autocomplete="email" />
          <button type="button" class="btn-auth-submit" id="btnFindPwSubmit">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë§í¬ ë°œì†¡</button>
          <div id="findPwResult" style="margin-top: 1rem; padding: 0.75rem; background: var(--bg-soft); border-radius: var(--radius); display: none;"></div>
          <div id="authResetPwPanel" style="display:none; margin-top: 1rem;">
            <label>ì¬ì„¤ì • í† í°</label>
            <input type="text" id="authResetToken" placeholder="ì´ë©”ì¼ë¡œ ë°›ì€ í† í° ì…ë ¥" />
            <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="authResetPw" placeholder="6ì ì´ìƒ" autocomplete="new-password" />
            <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input type="password" id="authResetPw2" placeholder="ë‹¤ì‹œ ì…ë ¥" autocomplete="new-password" />
            <button type="button" class="btn-auth-submit" id="btnResetPwSubmit">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</button>
          </div>
          <button type="button" class="auth-link-btn" id="btnBackToLogin2" style="width: 100%; margin-top: 0.5rem; background: none; border: none; color: var(--accent); cursor: pointer; padding: 0.5rem;">â† ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
        <p class="auth-hint">â€» ë¹„ë°€ë²ˆí˜¸ëŠ” ì„œë²„ì—ì„œ ì•”í˜¸í™”ë˜ì–´ ì €ì¥ë˜ë©°, ê²Œì„ ë°ì´í„°ëŠ” DBì— ë™ê¸°í™”ë©ë‹ˆë‹¤.</p>
        <button type="button" class="auth-close" id="authClose" aria-label="ë‹«ê¸°">âœ•</button>
      </div>
    </div>
    
    <!-- ë™ë¬¼ ì„ íƒ ëª¨ë‹¬ -->
    <div class="auth-overlay" id="petSelectOverlay" style="display:none;" role="dialog" aria-modal="true">
      <div class="pet-select-modal">
        <h2 class="auth-title">ë™ë¬¼ ì¹œêµ¬ ì„ íƒí•˜ê¸°</h2>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem;">ê±¸ìŒì„ ê±¸ì–´ í•¨ê»˜ ì„±ì¥í•  ë™ë¬¼ ì¹œêµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!</p>
        <div class="pet-grid" id="petGrid"></div>
        <button type="button" class="btn-auth-submit" id="btnConfirmPet" style="margin-top: 1rem;">ì„ íƒí•˜ê¸°</button>
        <button type="button" class="auth-close" id="petSelectClose" aria-label="ë‹«ê¸°">âœ•</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="alert"></div>

  <script>
(function () {
  const GOAL = 10000;
  var API_BASE = (typeof location !== 'undefined' && location.protocol === 'file:') ? 'http://localhost:3000' : '';
  const TOKEN_KEY = 'walk_token';
  function getAuthToken() { try { return localStorage.getItem(TOKEN_KEY); } catch (e) { return null; } }
  function setAuthToken(t) { try { if (t) localStorage.setItem(TOKEN_KEY, t); else localStorage.removeItem(TOKEN_KEY); } catch (e) {} }
  function clearAuthToken() { setAuthToken(null); }
  const STORAGE_KEYS = {
    pet: 'walk_pet',
    steps: 'pedometer_steps',
    date: 'pedometer_date',
    lifetime: 'walk_lifetime_steps',
    avatar: 'walk_avatar',
    inventory: 'walk_inventory',
    equipped: 'walk_equipped',
    claimed: 'walk_claimed_routes',
    courseGoal: 'walk_course_goal_km',
    totalXp: 'walk_total_xp',
    supplyDate: 'walk_supply_date',
    supplyCount: 'walk_supply_count',
    userRoutes: 'walk_user_routes',
    gold: 'walk_gold',
    theme: 'walk_theme',
    totalWalkKm: 'walk_total_km',
    currentTitle: 'walk_current_title',
    storage: 'walk_storage',
    questProgress: 'walk_quest_progress',
    questDate: 'walk_quest_date',
    sharedDate: 'walk_shared_date',
    user: 'walk_user',
    loggedIn: 'walk_logged_in',
    attendanceDate: 'walk_attendance_date',
    attendanceStreak: 'walk_attendance_streak'
  };
  var ATTENDANCE_DAILY_GOLD = [10, 15, 20, 25, 30, 40];
  var ATTENDANCE_7DAY_BOX_NAME = 'ìœ„í´ë¦¬ ë§ˆìŠ¤í„° ì„ ë¬¼ìƒì';
  var ATTENDANCE_7DAY_GOLD = 100;
  const XP_PER_KM = 100;
  const GACHA_COST = 30;
  const GACHA_PREMIUM_COST = 60;
  const STARTING_GOLD = 500;
  const ENHANCE_MAX = 7;
  var ENHANCE_RATES = [95, 90, 85, 75, 60, 45, 30];
  var ENHANCE_ATTEMPT_GOLD = [0, 0, 0, 20, 35, 50, 50];
  var DAILY_QUESTS = [
    { id: 'q_steps', name: 'ê±¸ìŒ ê±¸ê¸°', desc: 'ì˜¤ëŠ˜ 3,000ê±¸ìŒ', goal: 3000, reward: 25, getProgress: function() { return steps; } },
    { id: 'q_walk', name: 'ì‚°ì±… ì™„ì£¼', desc: 'ì½”ìŠ¤ 1íšŒ ì™„ì£¼', goal: 1, reward: 60, getProgress: function() { return userRoutes.filter(function(r){ return r.completedAt && new Date(r.completedAt).toISOString().slice(0,10) === todayStr(); }).length; } },
    { id: 'q_gacha', name: 'ë³´ê¸‰ ë½‘ê¸°', desc: 'ë³´ê¸‰ 1íšŒ ë½‘ê¸°', goal: 1, reward: 15, getProgress: function() { return questGachaCount; } },
    { id: 'q_share', name: 'ë§í¬ ê³µìœ ', desc: 'ì¹´ì¹´ì˜¤í†¡ ë“±ìœ¼ë¡œ ê³µìœ ', goal: 1, reward: 40, getProgress: function() { return sharedToday ? 1 : 0; } }
  ];
  var questGachaCount = 0;
  var questClaimed = {};
  var sharedToday = false;
  var TITLES = [
    { id: 'walker', name: 'ì‚°ì±…ëŸ¬', minKm: 0 },
    { id: 'short', name: 'ë‹¨ê±°ë¦¬ ì„ ìˆ˜', minKm: 1 },
    { id: 'long', name: 'ì¥ê±°ë¦¬ ì„ ìˆ˜', minKm: 10 },
    { id: 'marathon', name: 'ë§ˆë¼í† ë„ˆ', minKm: 42.195 },
    { id: 'master', name: 'ë§ˆìŠ¤í„° ëŸ¬ë„ˆ', minKm: 100 }
  ];
  function getTitleForKm(km) {
    var t = TITLES[0];
    for (var i = TITLES.length - 1; i >= 0; i--) {
      if (km >= TITLES[i].minKm) { t = TITLES[i]; break; }
    }
    return t;
  }
  function xpToLevel(xp) {
    if (xp <= 0) return { level: 1, current: 0, need: 100 };
    var level = 1 + Math.floor(Math.sqrt(xp / 50));
    var prevXp = 50 * (level - 1) * (level - 1);
    var nextXp = 50 * level * level;
    return { level: level, current: xp - prevXp, need: nextXp - prevXp };
  }
  var ACHIEVEMENTS = [
    { id: 'first_walk', name: 'ì²« ê±¸ìŒ', desc: 'ì²« ì‚°ì±… ì‹œì‘', icon: 'ğŸ‘£', check: function() { return totalXp >= 10; } },
    { id: 'km1', name: '1km ë‹¬ì„±', desc: 'ì´ 1km ì‚°ì±…', icon: 'ğŸ›¤ï¸', check: function() { return totalXp >= 100; } },
    { id: 'km5', name: '5km ë‹¬ì„±', desc: 'ì´ 5km ì‚°ì±…', icon: 'ğŸƒ', check: function() { return totalXp >= 500; } },
    { id: 'course1', name: 'ì½”ìŠ¤ ì™„ì£¼', desc: 'ì²« ì½”ìŠ¤ ì™„ì£¼', icon: 'ğŸ', check: function() { return (userRoutes.filter(function(r){ return r.completedAt; }).length) >= 1; } },
    { id: 'steps10k', name: 'ë§Œë³´ ë‹¬ì¸', desc: 'í•˜ë£¨ 10,000ê±¸ìŒ', icon: 'ğŸ¯', check: function() { return steps >= 10000 || lifetimeSteps >= 10000; } },
    { id: 'rare', name: 'ë ˆì–´ ìˆ˜ì§‘ê°€', desc: 'ë ˆì–´ ì´ìƒ ì¥ë¹„ íšë“', icon: 'âœ¨', check: function() { return inventory.some(function(i){ return i.rarity === 'rare' || i.rarity === 'epic' || i.rarity === 'legend'; }); } },
    { id: 'legend', name: 'ë ˆì „ë“œ', desc: 'ë ˆì „ë“œ ì¥ë¹„ íšë“', icon: 'ğŸŒŸ', check: function() { return inventory.some(function(i){ return i.rarity === 'legend'; }); } },
    { id: 'level5', name: 'ë ˆë²¨ 5', desc: 'Lv.5 ë‹¬ì„±', icon: 'â¬†ï¸', check: function() { return xpToLevel(totalXp).level >= 5; } }
  ];
  var RARITY_WEIGHTS = [60, 25, 12, 3];
  var RARITY_NAMES = ['common', 'rare', 'epic', 'legend'];
  var TIER_LABELS = { standard: 'ìŠ¤íƒ ë‹¤ë“œ', pro: 'í”„ë¡œ', prime: 'í”„ë¼ì„', signature: 'ì‹œê·¸ë‹ˆì²˜' };
  var SUPPLY_POOL = [
    { id: 'shoe_1', name: 'ë ˆë³¼ë£¨ì…˜', type: 'shoes', emoji: 'ğŸ‘Ÿ', tier: 'standard' },
    { id: 'shoe_2', name: 'ë‹¤ìš´ì‹œí”„í„°', type: 'shoes', emoji: 'ğŸ‘Ÿ', tier: 'standard' },
    { id: 'shoe_3', name: 'ìœˆí”Œë¡œ', type: 'shoes', emoji: 'ğŸ‘Ÿ', tier: 'standard' },
    { id: 'shoe_4', name: 'ê°¤ëŸ­ì‹œ ëŸ¬ë‹í™”', type: 'shoes', emoji: 'ğŸ‘Ÿ', tier: 'standard' },
    { id: 'shoe_5', name: 'í˜ê°€ìˆ˜ìŠ¤', type: 'shoes', emoji: 'ğŸ‘Ÿ', tier: 'pro' },
    { id: 'shoe_6', name: 'ë¦¬ì•¡íŠ¸', type: 'shoes', emoji: 'ğŸ‘Ÿ', tier: 'pro' },
    { id: 'shoe_7', name: 'ë…¸ë°”ë¸”ë¼ìŠ¤íŠ¸', type: 'shoes', emoji: 'ğŸ‘Ÿ', tier: 'pro' },
    { id: 'shoe_8', name: 'í´ë¼ìš°ë“œ', type: 'shoes', emoji: 'ğŸ‘Ÿ', tier: 'pro' },
    { id: 'shoe_9', name: 'í”„ë¼ì„', type: 'shoes', emoji: 'ğŸ‘Ÿ', tier: 'prime' },
    { id: 'shoe_10', name: 'ìš¸íŠ¸ë¼ë¶€ìŠ¤íŠ¸', type: 'shoes', emoji: 'ğŸ‘Ÿ', tier: 'prime' },
    { id: 'shoe_11', name: 'í˜¸ì¹´ í´ë¦¬í”„í†¤', type: 'shoes', emoji: 'ğŸ‘Ÿ', tier: 'prime' },
    { id: 'shoe_12', name: 'ì ¤ ì¹´ì•¼ë…¸', type: 'shoes', emoji: 'ğŸ‘Ÿ', tier: 'prime' },
    { id: 'shoe_13', name: 'ì—”ëŒí•€ ìŠ¤í”¼ë“œ', type: 'shoes', emoji: 'ğŸ‘Ÿ', tier: 'prime' },
    { id: 'shoe_14', name: 'ì•ŒíŒŒí”Œë¼ì´', type: 'shoes', emoji: 'ğŸ‘Ÿ', tier: 'signature' },
    { id: 'shoe_15', name: 'ë² ì´í¼í”Œë¼ì´', type: 'shoes', emoji: 'ğŸ‘Ÿ', tier: 'signature' },
    { id: 'shoe_16', name: 'ì•„ë””ì œë¡œ ì•„ë””ì˜¤ìŠ¤ í”„ë¡œ', type: 'shoes', emoji: 'ğŸ‘Ÿ', tier: 'signature' },
    { id: 'shoe_17', name: 'ë©”íƒ€ìŠ¤í”¼ë“œ ìŠ¤ì¹´ì´', type: 'shoes', emoji: 'ğŸ‘Ÿ', tier: 'signature' },
    { id: 'watch_1', name: 'ìƒ¤ì˜¤ë¯¸ ë°´ë“œ', type: 'accessory', emoji: 'âŒš', tier: 'standard' },
    { id: 'watch_2', name: 'ê°¤ëŸ­ì‹œ í•', type: 'accessory', emoji: 'âŒš', tier: 'standard' },
    { id: 'watch_3', name: 'ë¯¸ë°´ë“œ', type: 'accessory', emoji: 'âŒš', tier: 'standard' },
    { id: 'watch_4', name: 'í•ë¹— ì°¨ì§€', type: 'accessory', emoji: 'âŒš', tier: 'pro' },
    { id: 'watch_5', name: 'ê°¤ëŸ­ì‹œ ì›Œì¹˜', type: 'accessory', emoji: 'âŒš', tier: 'pro' },
    { id: 'watch_6', name: 'ì• í”Œì›Œì¹˜ SE', type: 'accessory', emoji: 'âŒš', tier: 'pro' },
    { id: 'watch_7', name: 'ê°€ë¯¼ í¬ëŸ¬ë„ˆ', type: 'accessory', emoji: 'âŒš', tier: 'prime' },
    { id: 'watch_8', name: 'ê°€ë¯¼ ë² ë‰´', type: 'accessory', emoji: 'âŒš', tier: 'prime' },
    { id: 'watch_9', name: 'ì• í”Œì›Œì¹˜ ìš¸íŠ¸ë¼', type: 'accessory', emoji: 'âŒš', tier: 'prime' },
    { id: 'watch_10', name: 'ê°€ë¯¼ í”¼ë‹‰ìŠ¤', type: 'accessory', emoji: 'âŒš', tier: 'signature' },
    { id: 'watch_11', name: 'ì½”ë¡œìŠ¤ ë²„í…ìŠ¤', type: 'accessory', emoji: 'âŒš', tier: 'signature' },
    { id: 'watch_12', name: 'ìˆœí†  ë²„í‹°ì»¬', type: 'accessory', emoji: 'âŒš', tier: 'signature' },
    { id: 'ear_1', name: 'QCY', type: 'accessory', emoji: 'ğŸ§', tier: 'standard' },
    { id: 'ear_2', name: 'ìƒ¤ì˜¤ë¯¸ ë²„ì¦ˆ', type: 'accessory', emoji: 'ğŸ§', tier: 'standard' },
    { id: 'ear_3', name: 'ìœ ì„  ìŠ¤í¬ì¸  ì´ì–´í°', type: 'accessory', emoji: 'ğŸ§', tier: 'standard' },
    { id: 'ear_4', name: 'ì—ì–´íŒŸ', type: 'accessory', emoji: 'ğŸ§', tier: 'pro' },
    { id: 'ear_5', name: 'ê°¤ëŸ­ì‹œ ë²„ì¦ˆ', type: 'accessory', emoji: 'ğŸ§', tier: 'pro' },
    { id: 'ear_6', name: 'ì œì´ë²„ë“œ', type: 'accessory', emoji: 'ğŸ§', tier: 'pro' },
    { id: 'ear_7', name: 'ë³´ìŠ¤ ìŠ¤í¬ì¸ ', type: 'accessory', emoji: 'ğŸ§', tier: 'prime' },
    { id: 'ear_8', name: 'ìƒ¥ì¦ˆ ì˜¤í”ˆëŸ°', type: 'accessory', emoji: 'ğŸ§', tier: 'prime' },
    { id: 'ear_9', name: 'ì  í•˜ì´ì € ìŠ¤í¬ì¸ ', type: 'accessory', emoji: 'ğŸ§', tier: 'prime' },
    { id: 'ear_10', name: 'ìƒ¥ì¦ˆ ì˜¤í”ˆëŸ° í”„ë¡œ', type: 'accessory', emoji: 'ğŸ§', tier: 'signature' },
    { id: 'ear_11', name: 'ë³´ìŠ¤ ìš¸íŠ¸ë¼', type: 'accessory', emoji: 'ğŸ§', tier: 'signature' },
    { id: 'ear_12', name: 'ì†Œë‹ˆ XM', type: 'accessory', emoji: 'ğŸ§', tier: 'signature' },
    { id: 'bag_1', name: 'ë‚˜ì´í‚¤ ìŠ¬ë§ë°±', type: 'accessory', emoji: 'ğŸ’', tier: 'standard' },
    { id: 'bag_2', name: 'ë°ì¹´íŠ¸ë¡  ë°±', type: 'accessory', emoji: 'ğŸ’', tier: 'standard' },
    { id: 'bag_3', name: 'ë¯¸ë‹ˆ ì›¨ì´ìŠ¤íŠ¸ë°±', type: 'accessory', emoji: 'ğŸ’', tier: 'standard' },
    { id: 'bag_4', name: 'ë‚˜ì´í‚¤ ëŸ¬ë‹ ë² ìŠ¤íŠ¸', type: 'accessory', emoji: 'ğŸ’', tier: 'pro' },
    { id: 'bag_5', name: 'ì‚´ë¡œëª¬ ì•¡í‹°ë¸Œ', type: 'accessory', emoji: 'ğŸ’', tier: 'pro' },
    { id: 'bag_6', name: 'ì–¸ë”ì•„ë¨¸ ëŸ¬ë‹ë°±', type: 'accessory', emoji: 'ğŸ’', tier: 'pro' },
    { id: 'bag_7', name: 'ì˜¤ìŠ¤í”„ë¦¬ íƒ¤ëŸ°', type: 'accessory', emoji: 'ğŸ’', tier: 'prime' },
    { id: 'bag_8', name: 'ì‚´ë¡œëª¬ ADV ìŠ¤í‚¨', type: 'accessory', emoji: 'ğŸ’', tier: 'prime' },
    { id: 'bag_9', name: 'ë…¸ìŠ¤í˜ì´ìŠ¤ ëŸ¬ë‹íŒ©', type: 'accessory', emoji: 'ğŸ’', tier: 'prime' },
    { id: 'bag_10', name: 'ì•„í¬í…Œë¦­ìŠ¤ ë°±íŒ©', type: 'accessory', emoji: 'ğŸ’', tier: 'signature' },
    { id: 'bag_11', name: 'ì‚´ë¡œëª¬ S/LAB', type: 'accessory', emoji: 'ğŸ’', tier: 'signature' },
    { id: 'bag_12', name: 'íŒŒíƒ€ê³ ë‹ˆì•„ í…Œí¬íŒ©', type: 'accessory', emoji: 'ğŸ’', tier: 'signature' },
    { id: 'top_1', name: 'ë“œë¼ì´í• í‹°', type: 'top', emoji: 'ğŸ‘•', tier: 'standard' },
    { id: 'top_2', name: 'ì¿¨ë¡  í‹°', type: 'top', emoji: 'ğŸ‘•', tier: 'standard' },
    { id: 'top_3', name: 'ì—ì–´ë¦¬ì¦˜', type: 'top', emoji: 'ğŸ‘•', tier: 'standard' },
    { id: 'top_4', name: 'ì–¸ë”ì•„ë¨¸ í…Œí¬í•', type: 'top', emoji: 'ğŸ‘•', tier: 'pro' },
    { id: 'top_5', name: 'ë‚˜ì´í‚¤ ëŸ¬ë‹ íƒ‘', type: 'top', emoji: 'ğŸ‘•', tier: 'pro' },
    { id: 'top_6', name: 'ì•„ë””ë‹¤ìŠ¤ ì—ì–´ë¡œë ˆë””', type: 'top', emoji: 'ğŸ‘•', tier: 'pro' },
    { id: 'top_7', name: 'ë‚˜ì´í‚¤ ë“œë¼ì´í• ADV', type: 'top', emoji: 'ğŸ‘•', tier: 'prime' },
    { id: 'top_8', name: 'ë£°ë£¨ë ˆëª¬ ëŸ¬ë‹íƒ‘', type: 'top', emoji: 'ğŸ‘•', tier: 'prime' },
    { id: 'top_9', name: 'íŒŒíƒ€ê³ ë‹ˆì•„ ëŸ¬ë‹íƒ‘', type: 'top', emoji: 'ğŸ‘•', tier: 'prime' },
    { id: 'top_10', name: 'ì•„í¬í…Œë¦­ìŠ¤ í”„ë¡œí†¤', type: 'top', emoji: 'ğŸ‘•', tier: 'signature' },
    { id: 'top_11', name: 'ì•„í¬í…Œë¦­ìŠ¤ ì½”ì–´ë¡œí”„íŠ¸', type: 'top', emoji: 'ğŸ‘•', tier: 'signature' },
    { id: 'top_12', name: 'ë…¸ìŠ¤í˜ì´ìŠ¤ ì„œë°‹', type: 'top', emoji: 'ğŸ‘•', tier: 'signature' },
    { id: 'bottom_1', name: 'ëŸ¬ë‹ ì‡¼ì¸ ', type: 'bottom', emoji: 'ğŸ‘–', tier: 'standard' },
    { id: 'bottom_2', name: 'ì¿¨ë¡  íŒ¬ì¸ ', type: 'bottom', emoji: 'ğŸ‘–', tier: 'standard' },
    { id: 'bottom_3', name: 'íŠ¸ë ˆì´ë‹ íŒ¬ì¸ ', type: 'bottom', emoji: 'ğŸ‘–', tier: 'standard' },
    { id: 'bottom_4', name: 'ë‚˜ì´í‚¤ í”Œë ‰ìŠ¤', type: 'bottom', emoji: 'ğŸ‘–', tier: 'pro' },
    { id: 'bottom_5', name: 'ì–¸ë”ì•„ë¨¸ ëŸ¬ë‹ ì‡¼ì¸ ', type: 'bottom', emoji: 'ğŸ‘–', tier: 'pro' },
    { id: 'bottom_6', name: 'ì•„ë””ë‹¤ìŠ¤ ëŸ¬ë‹ íƒ€ì´ì¸ ', type: 'bottom', emoji: 'ğŸ‘–', tier: 'pro' },
    { id: 'bottom_7', name: 'ë£°ë£¨ ì„œì§€', type: 'bottom', emoji: 'ğŸ‘–', tier: 'prime' },
    { id: 'bottom_8', name: 'ë‚˜ì´í‚¤ ADV íŒ¬ì¸ ', type: 'bottom', emoji: 'ğŸ‘–', tier: 'prime' },
    { id: 'bottom_9', name: '2XU ì»´í”„ë ˆì…˜', type: 'bottom', emoji: 'ğŸ‘–', tier: 'prime' },
    { id: 'bottom_10', name: 'ì•„í¬í…Œë¦­ìŠ¤ ê°ë§ˆ', type: 'bottom', emoji: 'ğŸ‘–', tier: 'signature' },
    { id: 'bottom_11', name: 'ì•„í¬í…Œë¦­ìŠ¤ ëŸ¬ë‹ íƒ€ì´ì¸ ', type: 'bottom', emoji: 'ğŸ‘–', tier: 'signature' },
    { id: 'bottom_12', name: 'CEP í”„ë¡œë¼ì¸', type: 'bottom', emoji: 'ğŸ‘–', tier: 'signature' },
    { id: 'guard_1', name: 'ì¼ë°˜ ë¬´ë¦ ë³´í˜¸ëŒ€', type: 'guard', emoji: 'ğŸ›¡', tier: 'standard' },
    { id: 'guard_2', name: 'ê¸°ë³¸ ì••ë°• ìŠ¬ë¦¬ë¸Œ', type: 'guard', emoji: 'ğŸ›¡', tier: 'standard' },
    { id: 'guard_3', name: 'ë§¥ë°ì´ë¹„ë“œ', type: 'guard', emoji: 'ğŸ›¡', tier: 'pro' },
    { id: 'guard_4', name: 'ë‚˜ì´í‚¤ í”„ë¡œ', type: 'guard', emoji: 'ğŸ›¡', tier: 'pro' },
    { id: 'guard_5', name: '2XU', type: 'guard', emoji: 'ğŸ›¡', tier: 'prime' },
    { id: 'guard_6', name: 'ìŠ¤í‚¨ìŠ¤', type: 'guard', emoji: 'ğŸ›¡', tier: 'prime' },
    { id: 'guard_7', name: 'CEP', type: 'guard', emoji: 'ğŸ›¡', tier: 'signature' },
    { id: 'guard_8', name: 'BV SPORT', type: 'guard', emoji: 'ğŸ›¡', tier: 'signature' },
    { id: 'glove_1', name: 'ê¸°ë³¸ ëŸ¬ë‹ ì¥ê°‘', type: 'accessory', emoji: 'ğŸ§¤', tier: 'standard' },
    { id: 'glove_2', name: 'í„°ì¹˜ ì¥ê°‘', type: 'accessory', emoji: 'ğŸ§¤', tier: 'standard' },
    { id: 'glove_3', name: 'ë‚˜ì´í‚¤ ëŸ¬ë‹ê¸€ëŸ¬ë¸Œ', type: 'accessory', emoji: 'ğŸ§¤', tier: 'pro' },
    { id: 'glove_4', name: 'ì–¸ë”ì•„ë¨¸ ì¥ê°‘', type: 'accessory', emoji: 'ğŸ§¤', tier: 'pro' },
    { id: 'glove_5', name: 'ë¸”ë™ë‹¤ì´ì•„ëª¬ë“œ', type: 'accessory', emoji: 'ğŸ§¤', tier: 'prime' },
    { id: 'glove_6', name: 'ë…¸ìŠ¤í˜ì´ìŠ¤ ëŸ¬ë‹ê¸€ëŸ¬ë¸Œ', type: 'accessory', emoji: 'ğŸ§¤', tier: 'prime' },
    { id: 'glove_7', name: 'í—¤ìŠ¤íŠ¸ë¼', type: 'accessory', emoji: 'ğŸ§¤', tier: 'signature' },
    { id: 'glove_8', name: 'ì•„í¬í…Œë¦­ìŠ¤ ê¸€ëŸ¬ë¸Œ', type: 'accessory', emoji: 'ğŸ§¤', tier: 'signature' },
    { id: 'outer_1', name: 'ë°”ëŒë§‰ì´', type: 'top', emoji: 'ğŸ§¥', tier: 'standard' },
    { id: 'outer_2', name: 'ê²½ëŸ‰ ìì¼“', type: 'top', emoji: 'ğŸ§¥', tier: 'standard' },
    { id: 'outer_3', name: 'ë‚˜ì´í‚¤ ëŸ¬ë‹ ìì¼“', type: 'top', emoji: 'ğŸ§¥', tier: 'pro' },
    { id: 'outer_4', name: 'ì•„ë””ë‹¤ìŠ¤ ìœˆë“œìì¼“', type: 'top', emoji: 'ğŸ§¥', tier: 'pro' },
    { id: 'outer_5', name: 'íŒŒíƒ€ê³ ë‹ˆì•„ í›„ë””ë‹ˆ', type: 'top', emoji: 'ğŸ§¥', tier: 'prime' },
    { id: 'outer_6', name: 'ë…¸ìŠ¤í˜ì´ìŠ¤ í”Œë¼ì´íŠ¸', type: 'top', emoji: 'ğŸ§¥', tier: 'prime' },
    { id: 'outer_7', name: 'ì•„í¬í…Œë¦­ìŠ¤ ì•ŒíŒŒ', type: 'top', emoji: 'ğŸ§¥', tier: 'signature' },
    { id: 'outer_8', name: 'ì•„í¬í…Œë¦­ìŠ¤ ë² íƒ€', type: 'top', emoji: 'ğŸ§¥', tier: 'signature' },
    { id: 'outer_9', name: 'ë…¸ìŠ¤í˜ì´ìŠ¤ ì„œë°‹ ì‹œë¦¬ì¦ˆ', type: 'top', emoji: 'ğŸ§¥', tier: 'signature' }
  ];

  const ROUTES = [
    { id: 'r1', name: 'ë™ë„¤ ê³¨ëª©', steps: 500, icon: 'ğŸ˜ï¸', reward: { id: 'shoe_1', name: 'ë ˆë³¼ë£¨ì…˜', type: 'shoes', emoji: 'ğŸ‘Ÿ', tier: 'standard' } },
    { id: 'r2', name: 'ì‘ì€ ê³µì›', steps: 1000, icon: 'ğŸŒ³', reward: { id: 'top_1', name: 'ë“œë¼ì´í• í‹°', type: 'top', emoji: 'ğŸ‘•', tier: 'standard' } },
    { id: 'r3', name: 'ì‹œë‚´ ì‚°ì±…ë¡œ', steps: 2000, icon: 'ğŸ›¤ï¸', reward: { id: 'shoe_5', name: 'í˜ê°€ìˆ˜ìŠ¤', type: 'shoes', emoji: 'ğŸ‘Ÿ', tier: 'pro' } },
    { id: 'r4', name: 'ê°•ë‘‘ ê¸¸', steps: 3500, icon: 'ğŸŒŠ', reward: { id: 'top_4', name: 'ì–¸ë”ì•„ë¨¸ í…Œí¬í•', type: 'top', emoji: 'ğŸ‘•', tier: 'pro' } },
    { id: 'r5', name: 'ìˆ² ì…êµ¬', steps: 5000, icon: 'ğŸŒ²', reward: { id: 'watch_4', name: 'í•ë¹— ì°¨ì§€', type: 'accessory', emoji: 'âŒš', tier: 'pro' } },
    { id: 'r6', name: 'í˜¸ìˆ˜ ë‘˜ë ˆê¸¸', steps: 7500, icon: 'ğŸï¸', reward: { id: 'ear_4', name: 'ì—ì–´íŒŸ', type: 'accessory', emoji: 'ğŸ§', tier: 'pro' } },
    { id: 'r7', name: 'ë“±ì‚°ë¡œ ì •ìƒ', steps: 10000, icon: 'â›°ï¸', reward: { id: 'shoe_14', name: 'ì•ŒíŒŒí”Œë¼ì´', type: 'shoes', emoji: 'ğŸ‘Ÿ', tier: 'signature' } }
  ];

  const SLOT_ORDER = ['shoes', 'watch', 'earphones', 'bag', 'top', 'bottom', 'guard', 'glove', 'outer'];
  const SLOT_LABELS = { shoes: 'ğŸ‘Ÿ ì‹ ë°œ', watch: 'âŒš ì‹œê³„/ë””ë°”ì´ìŠ¤', earphones: 'ğŸ§ ì´ì–´í°', bag: 'ğŸ’ ê°€ë°©/ëŸ¬ë‹ë² ìŠ¤íŠ¸', top: 'ğŸ‘• ìƒì˜', bottom: 'ğŸ‘– í•˜ì˜', guard: 'ğŸ›¡ ë³´í˜¸ëŒ€/ì»´í”„ë ˆì…˜', glove: 'ğŸ§¤ ì¥ê°‘', outer: 'ğŸ§¥ ì•„ìš°í„°' };
  var TIER_WEIGHTS = { standard: 50, pro: 30, prime: 15, signature: 5 };
  /* ê±¸ìŒ ë³´ë„ˆìŠ¤ ì œê±°: ëª©í‘œ ê±¸ìŒ/ê±°ë¦¬ ì •í™•ë„ ìœ ì§€ë¥¼ ìœ„í•´ step ë³´ë„ˆìŠ¤ ì—†ìŒ */
  var SLOT_BONUS_TYPE = { shoes: 'distance', watch: 'gold', earphones: 'gold', bag: 'xp', top: 'xp', bottom: 'xp', guard: 'xp', glove: 'xp', outer: 'xp' };
  var TIER_PERCENT = { standard: 1, pro: 2, prime: 3, signature: 5 };
  var SLOT_BONUS_LABEL = { xp: 'XP ë³´ë„ˆìŠ¤', distance: 'ì´ë™ ê±°ë¦¬', gold: 'ê³¨ë“œ ë³´ë„ˆìŠ¤' };
  function itemSlot(item) {
    if (!item || !item.id) return 'top';
    var id = item.id.replace(/_\d+$/, '');
    if (id.indexOf('shoe') === 0) return 'shoes';
    if (id.indexOf('watch') === 0) return 'watch';
    if (id.indexOf('ear') === 0) return 'earphones';
    if (id.indexOf('bag') === 0) return 'bag';
    if (id.indexOf('outer') === 0) return 'outer';
    if (id.indexOf('top') === 0) return 'top';
    if (id.indexOf('bottom') === 0) return 'bottom';
    if (id.indexOf('guard') === 0) return 'guard';
    if (id.indexOf('glove') === 0) return 'glove';
    var t = item.type;
    if (t === 'shoes') return 'shoes';
    if (t === 'bottom') return 'bottom';
    if (t === 'guard') return 'guard';
    if (t === 'accessory') return 'watch';
    return 'top';
  }
  function getItemIcon(item) {
    if (!item || item.type === 'supply_kit') return 'ğŸ“¦';
    var slot = itemSlot(item);
    var icons = { shoes: ['ğŸ‘Ÿ','ğŸ¥¾','ğŸƒ','âš¡','ğŸ”¥','ğŸ’¨','âœ¨','ğŸŒŸ','â­','ğŸ’«','ğŸ¯','ğŸ','ğŸ‘Ÿ','ğŸ¥¾','ğŸƒ','âš¡','ğŸ”¥'], watch: ['âŒš','âŒš','âŒš','âŒš','âŒš','âŒš','âŒš','âŒš','âŒš','âŒš','âŒš','âŒš'], earphones: ['ğŸ§','ğŸ§','ğŸ§','ğŸ§','ğŸ§','ğŸ§','ğŸ§','ğŸ§','ğŸ§','ğŸ§','ğŸ§','ğŸ§'], bag: ['ğŸ’','ğŸ’','ğŸ’','ğŸ’','ğŸ’','ğŸ’','ğŸ’','ğŸ’','ğŸ’','ğŸ’','ğŸ’','ğŸ’'], top: ['ğŸ‘•','ğŸ‘•','ğŸ‘•','ğŸ‘•','ğŸ‘•','ğŸ‘•','ğŸ‘•','ğŸ‘•','ğŸ‘•','ğŸ‘•','ğŸ‘•','ğŸ‘•'], bottom: ['ğŸ‘–','ğŸ©³','ğŸ‘–','ğŸ©³','ğŸ‘–','ğŸ©³','ğŸ‘–','ğŸ©³','ğŸ‘–','ğŸ©³','ğŸ‘–','ğŸ©³'], guard: ['ğŸ›¡','ğŸ›¡','ğŸ›¡','ğŸ›¡','ğŸ›¡','ğŸ›¡','ğŸ›¡','ğŸ›¡'], glove: ['ğŸ§¤','ğŸ§¤','ğŸ§¤','ğŸ§¤','ğŸ§¤','ğŸ§¤','ğŸ§¤','ğŸ§¤'], outer: ['ğŸ§¥','ğŸ§¥','ğŸ§¥','ğŸ§¥','ğŸ§¥','ğŸ§¥','ğŸ§¥','ğŸ§¥','ğŸ§¥'] };
    var arr = icons[slot] || ['ğŸ“¦'];
    var baseId = (item.id || '').replace(/_\d+$/, '');
    var h = 0; for (var i = 0; i < baseId.length; i++) h = (h * 31 + baseId.charCodeAt(i)) | 0;
    return arr[Math.abs(h) % arr.length];
  }
  function getEquipmentBonus() {
    var b = { xp: 0, distance: 0, gold: 0, step: 0 };
    SLOT_ORDER.forEach(function(slot) {
      var itemId = equipped[slot];
      var item = itemId ? inventory.find(function(i){ return i.id === itemId; }) : null;
      if (!item) return;
      var pct = TIER_PERCENT[item.tier] || 1;
      var typ = SLOT_BONUS_TYPE[slot];
      if (typ && b[typ] !== undefined) b[typ] += pct;
    });
    return b;
  }
  function pickItemByTierWeight(premium) {
    var w = premium ? { standard: 35, pro: 30, prime: 22, signature: 13 } : TIER_WEIGHTS;
    var r = Math.random() * 100;
    var tier = 'standard';
    if (r < w.standard) tier = 'standard';
    else if (r < w.standard + w.pro) tier = 'pro';
    else if (r < w.standard + w.pro + w.prime) tier = 'prime';
    else tier = 'signature';
    var pool = SUPPLY_POOL.filter(function(i){ return (i.tier || 'standard') === tier; });
    if (pool.length === 0) pool = SUPPLY_POOL;
    return pool[Math.floor(Math.random() * pool.length)];
  }
  function rollRarityPremium() {
    var r = Math.random() * 100;
    if (r < 40) return 'common';
    if (r < 72) return 'rare';
    if (r < 92) return 'epic';
    return 'legend';
  }

  let steps = 0, lastDate = '', lifetimeSteps = 0;
  // ë™ë¬¼ ë°ì´í„°
  const PET_TYPES = [
    { id: 'dog', name: 'ê°•ì•„ì§€', emoji: 'ğŸ•', description: 'ì¶©ì‹¤í•˜ê³  í™œë°œí•œ ì¹œêµ¬', color: '#fbbf24' },
    { id: 'cat', name: 'ê³ ì–‘ì´', emoji: 'ğŸ±', description: 'ìš°ì•„í•˜ê³  ë…ë¦½ì ì¸ ì¹œêµ¬', color: '#f97316' },
    { id: 'lion', name: 'ì‚¬ì', emoji: 'ğŸ¦', description: 'ìš©ë§¹í•˜ê³  ë‹¹ë‹¹í•œ ì¹œêµ¬', color: '#eab308' },
    { id: 'rabbit', name: 'í† ë¼', emoji: 'ğŸ°', description: 'ê·€ì—½ê³  ë¯¼ì²©í•œ ì¹œêµ¬', color: '#fda4af' },
    { id: 'bear', name: 'ê³°', emoji: 'ğŸ»', description: 'í˜ì°¨ê³  ë“ ë“ í•œ ì¹œêµ¬', color: '#92400e' },
    { id: 'panda', name: 'íŒë‹¤', emoji: 'ğŸ¼', description: 'í‰í™”ë¡­ê³  ì‚¬ë‘ìŠ¤ëŸ¬ìš´ ì¹œêµ¬', color: '#ffffff' },
    { id: 'fox', name: 'ì—¬ìš°', emoji: 'ğŸ¦Š', description: 'ì˜ë¦¬í•˜ê³  êµí™œí•œ ì¹œêµ¬', color: '#f97316' },
    { id: 'tiger', name: 'í˜¸ë‘ì´', emoji: 'ğŸ¯', description: 'ê°•ì¸í•˜ê³  ìš©ë§¹í•œ ì¹œêµ¬', color: '#fbbf24' }
  ];
  
  let pet = { type: null, level: 1, exp: 0, name: '' }; // ì„ íƒí•œ ë™ë¬¼ ì •ë³´
  
  let avatar = { name: 'ì‚°ì±…ëŸ¬', skin: '#f5d0b0', hair: 'short', hairColor: '#4a3728' };
  let inventory = [];
  var storage = [];
  let equipped = { shoes: null, watch: null, earphones: null, bag: null, top: null, bottom: null, guard: null, glove: null, outer: null };
  let claimedRoutes = [];
  var userRoutes = [];
  var activeRouteId = null;
  var activeRouteGoalKm = 0;
  var walkState = 'idle';
  var courseGoalKm = 1;
  var totalXp = 0;
  var pathCoords = [];
  var sessionDistanceKm = 0;
  var sessionXp = 0;
  var watchId = null;
  var lastPositionTime = 0;
  var MIN_SEGMENT_KM = 0.005;
  var MAX_SPEED_KMH = 12;
  var supplyDateToday = '';
  var supplyCountToday = 0;
  var walkMapEl = null;
  var walkMapPathEl = null;
  var walkMapCharEl = null;
  var DEFAULT_BOUNDS = { minLat: 37.4, maxLat: 37.6, minLon: 126.9, maxLon: 127.2 };
  function ourMapBounds(coords) {
    if (!coords || coords.length === 0) return null;
    var minLat = coords[0].lat, maxLat = coords[0].lat, minLon = coords[0].lon, maxLon = coords[0].lon;
    coords.forEach(function(c) {
      if (c.lat < minLat) minLat = c.lat;
      if (c.lat > maxLat) maxLat = c.lat;
      if (c.lon < minLon) minLon = c.lon;
      if (c.lon > maxLon) maxLon = c.lon;
    });
    var padLat = Math.max(0.002, (maxLat - minLat) * 0.15);
    var padLon = Math.max(0.003, (maxLon - minLon) * 0.15);
    return { minLat: minLat - padLat, maxLat: maxLat + padLat, minLon: minLon - padLon, maxLon: maxLon + padLon };
  }
  function ourMapLatLonToXY(lat, lon, bounds, w, h) {
    var x = ((lon - bounds.minLon) / (bounds.maxLon - bounds.minLon)) * w;
    var y = (1 - (lat - bounds.minLat) / (bounds.maxLat - bounds.minLat)) * h;
    return { x: x, y: y };
  }
  var gold = STARTING_GOLD;
  var totalWalkDistanceKm = 0;
  var currentTitleId = 'walker';
  var userProfile = null;
  var isLoggedIn = false;
  var lastAttendanceDate = '';
  var attendanceStreak = 0;

  function todayStr() {
    const d = new Date();
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
  }

  function loadAll() {
    try {
      const saved = localStorage.getItem(STORAGE_KEYS.steps);
      const savedDate = localStorage.getItem(STORAGE_KEYS.date);
      const today = todayStr();
      if (saved != null && savedDate === today) {
        steps = parseInt(saved, 10) || 0;
      } else {
        if (saved != null && savedDate) lifetimeSteps += parseInt(localStorage.getItem(STORAGE_KEYS.steps) || '0', 10);
        steps = 0;
        localStorage.setItem(STORAGE_KEYS.date, today);
      }
      lifetimeSteps = parseInt(localStorage.getItem(STORAGE_KEYS.lifetime) || '0', 10) + steps;
    } catch (e) {}
    try {
      const a = localStorage.getItem(STORAGE_KEYS.avatar);
      if (a) avatar = { ...avatar, ...JSON.parse(a) };
    } catch (e) {}
    try {
      const inv = localStorage.getItem(STORAGE_KEYS.inventory);
      if (inv) inventory = JSON.parse(inv);
    } catch (e) {}
    try {
      const eq = localStorage.getItem(STORAGE_KEYS.equipped);
      if (eq) {
        var parsed = JSON.parse(eq);
        SLOT_ORDER.forEach(function(s) { if (parsed[s] != null) equipped[s] = parsed[s]; });
        if (parsed.accessory != null && equipped.watch == null) equipped.watch = parsed.accessory;
        if (parsed.armor != null && equipped.top == null) equipped.top = parsed.armor;
        if (parsed.weapon != null && equipped.watch == null) equipped.watch = parsed.weapon;
      }
    } catch (e) {}
    try {
      var sd = localStorage.getItem(STORAGE_KEYS.supplyDate);
      var sc = localStorage.getItem(STORAGE_KEYS.supplyCount);
      var today = todayStr();
      if (sd === today && sc != null) {
        supplyDateToday = sd;
        supplyCountToday = parseInt(sc, 10) || 0;
      } else {
        supplyDateToday = today;
        supplyCountToday = 0;
      }
    } catch (e) {}
    try {
      const cr = localStorage.getItem(STORAGE_KEYS.claimed);
      if (cr) claimedRoutes = JSON.parse(cr);
    } catch (e) {}
    try {
      var cg = localStorage.getItem(STORAGE_KEYS.courseGoal);
      if (cg) courseGoalKm = parseFloat(cg) || 1;
      var tx = localStorage.getItem(STORAGE_KEYS.totalXp);
      if (tx) totalXp = parseInt(tx, 10) || 0;
    } catch (e) {}
    try {
      var ur = localStorage.getItem(STORAGE_KEYS.userRoutes);
      if (ur) userRoutes = JSON.parse(ur);
    } catch (e) {}
    try {
      var g = localStorage.getItem(STORAGE_KEYS.gold);
      if (g != null) { gold = parseInt(g, 10); if (gold === 0) gold = 500; }
      else gold = STARTING_GOLD;
    } catch (e) {}
    try {
      var tw = localStorage.getItem(STORAGE_KEYS.totalWalkKm);
      if (tw != null) totalWalkDistanceKm = parseFloat(tw);
    } catch (e) {}
    try {
      var ct = localStorage.getItem(STORAGE_KEYS.currentTitle);
      if (ct) currentTitleId = ct;
    } catch (e) {}
    try {
      var st = localStorage.getItem(STORAGE_KEYS.storage);
      if (st) storage = JSON.parse(st);
    } catch (e) {}
    try {
      var qd = localStorage.getItem(STORAGE_KEYS.questDate);
      var today = todayStr();
      if (qd === today) {
        var qc = localStorage.getItem(STORAGE_KEYS.questProgress);
        if (qc) questGachaCount = parseInt(qc, 10) || 0;
        var qcl = localStorage.getItem('walk_quest_claimed');
        if (qcl) questClaimed = JSON.parse(qcl);
      } else {
        questGachaCount = 0;
        questClaimed = {};
      }
    } catch (e) {}
    try {
      var sd = localStorage.getItem(STORAGE_KEYS.sharedDate);
      sharedToday = sd === todayStr();
    } catch (e) {}
    try {
      var ad = localStorage.getItem(STORAGE_KEYS.attendanceDate);
      var as = localStorage.getItem(STORAGE_KEYS.attendanceStreak);
      if (ad) lastAttendanceDate = ad;
      if (as != null) attendanceStreak = parseInt(as, 10) || 0;
    } catch (e) {}
    try {
      var p = localStorage.getItem(STORAGE_KEYS.pet);
      if (p) pet = { ...pet, ...JSON.parse(p) };
    } catch (e) {}
    var th = localStorage.getItem(STORAGE_KEYS.theme);
    if (th === 'morning' || th === 'night') document.body.setAttribute('data-theme', th);
    lastDate = todayStr();
  }

  function saveAll() {
    try {
      localStorage.setItem(STORAGE_KEYS.steps, String(steps));
      localStorage.setItem(STORAGE_KEYS.date, todayStr());
      localStorage.setItem(STORAGE_KEYS.lifetime, String(lifetimeSteps));
      localStorage.setItem(STORAGE_KEYS.avatar, JSON.stringify(avatar));
      localStorage.setItem(STORAGE_KEYS.inventory, JSON.stringify(inventory));
      localStorage.setItem(STORAGE_KEYS.equipped, JSON.stringify(equipped));
      localStorage.setItem(STORAGE_KEYS.storage, JSON.stringify(storage));
      localStorage.setItem(STORAGE_KEYS.claimed, JSON.stringify(claimedRoutes));
      localStorage.setItem(STORAGE_KEYS.courseGoal, String(courseGoalKm));
      localStorage.setItem(STORAGE_KEYS.totalXp, String(totalXp));
      if (supplyDateToday) localStorage.setItem(STORAGE_KEYS.supplyDate, supplyDateToday);
      localStorage.setItem(STORAGE_KEYS.supplyCount, String(supplyCountToday));
      localStorage.setItem(STORAGE_KEYS.userRoutes, JSON.stringify(userRoutes));
      localStorage.setItem(STORAGE_KEYS.gold, String(gold));
      localStorage.setItem(STORAGE_KEYS.totalWalkKm, String(totalWalkDistanceKm));
      localStorage.setItem(STORAGE_KEYS.currentTitle, currentTitleId);
      localStorage.setItem(STORAGE_KEYS.questDate, todayStr());
      localStorage.setItem(STORAGE_KEYS.questProgress, String(questGachaCount));
      localStorage.setItem('walk_quest_claimed', JSON.stringify(questClaimed));
      if (sharedToday) localStorage.setItem(STORAGE_KEYS.sharedDate, todayStr());
      localStorage.setItem(STORAGE_KEYS.attendanceDate, lastAttendanceDate);
      localStorage.setItem(STORAGE_KEYS.attendanceStreak, String(attendanceStreak));
      localStorage.setItem(STORAGE_KEYS.pet, JSON.stringify(pet));
    } catch (e) {}
    if (isLoggedIn && getAuthToken()) syncGameStateToServer();
  }
  function getGameStatePayload() {
    return {
      steps: steps,
      date: todayStr(),
      lifetimeSteps: lifetimeSteps,
      avatar: avatar,
      pet: pet,
      inventory: inventory,
      equipped: equipped,
      storage: storage,
      claimedRoutes: claimedRoutes,
      courseGoalKm: courseGoalKm,
      totalXp: totalXp,
      supplyDateToday: supplyDateToday,
      supplyCountToday: supplyCountToday,
      userRoutes: userRoutes,
      gold: gold,
      totalWalkDistanceKm: totalWalkDistanceKm,
      currentTitleId: currentTitleId,
      questDate: todayStr(),
      questProgress: questGachaCount,
      questClaimed: questClaimed,
      sharedDate: sharedToday ? todayStr() : '',
      lastAttendanceDate: lastAttendanceDate,
      attendanceStreak: attendanceStreak
    };
  }
  function applyGameState(obj) {
    if (!obj || typeof obj !== 'object') return;
    if (obj.steps != null) steps = obj.steps;
    if (obj.date != null) lastDate = obj.date;
    if (obj.lifetimeSteps != null) lifetimeSteps = obj.lifetimeSteps;
    if (obj.avatar && typeof obj.avatar === 'object') avatar = { ...avatar, ...obj.avatar };
    if (obj.pet && typeof obj.pet === 'object') pet = { ...pet, ...obj.pet };
    if (Array.isArray(obj.inventory)) inventory = obj.inventory;
    if (obj.equipped && typeof obj.equipped === 'object') { Object.keys(obj.equipped).forEach(function (k) { if (obj.equipped[k] != null) equipped[k] = obj.equipped[k]; }); }
    if (Array.isArray(obj.storage)) storage = obj.storage;
    if (Array.isArray(obj.claimedRoutes)) claimedRoutes = obj.claimedRoutes;
    if (obj.courseGoalKm != null) courseGoalKm = obj.courseGoalKm;
    if (obj.totalXp != null) totalXp = obj.totalXp;
    if (obj.supplyDateToday != null) supplyDateToday = obj.supplyDateToday;
    if (obj.supplyCountToday != null) supplyCountToday = obj.supplyCountToday;
    if (Array.isArray(obj.userRoutes)) userRoutes = obj.userRoutes;
    if (obj.gold != null) gold = obj.gold;
    if (obj.totalWalkDistanceKm != null) totalWalkDistanceKm = obj.totalWalkDistanceKm;
    if (obj.currentTitleId != null) currentTitleId = obj.currentTitleId;
    if (obj.questProgress != null) questGachaCount = obj.questProgress;
    if (obj.questClaimed && typeof obj.questClaimed === 'object') questClaimed = obj.questClaimed;
    if (obj.sharedDate != null) sharedToday = obj.sharedDate === todayStr();
    if (obj.lastAttendanceDate != null) lastAttendanceDate = obj.lastAttendanceDate;
    if (obj.attendanceStreak != null) attendanceStreak = obj.attendanceStreak;
    if (obj.pet && typeof obj.pet === 'object') {
      pet = { ...pet, ...obj.pet };
      renderPet();
    }
  }
  function syncGameStateToServer() {
    var token = getAuthToken();
    if (!token) return;
    var payload = getGameStatePayload();
    fetch(API_BASE + '/api/user/data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
      body: JSON.stringify(payload)
    }).catch(function () {});
  }
  function initAuth() {
    var token = getAuthToken();
    if (!token) return Promise.resolve();
    return fetch(API_BASE + '/api/user/me', { headers: { 'Authorization': 'Bearer ' + token } })
      .then(function (r) {
        if (!r.ok) { clearAuthToken(); return null; }
        return r.json();
      })
      .then(function (me) {
        if (!me) return null;
        userProfile = { id: me.id, nickname: me.nickname };
        isLoggedIn = true;
        return fetch(API_BASE + '/api/user/data', { headers: { 'Authorization': 'Bearer ' + token } });
      })
      .then(function (r) {
        if (!r) return null;
        return r.json();
      })
      .then(function (body) {
        if (body && body.data) {
          try {
            var data = typeof body.data === 'string' ? JSON.parse(body.data) : body.data;
            applyGameState(data);
            renderPet();
          } catch (e) {}
        }
      })
      .catch(function () { clearAuthToken(); });
  }

  function addStep() {
    steps++;
    lifetimeSteps++;
    // ë™ë¬¼ ê²½í—˜ì¹˜ íšë“ (10ê±¸ìŒë‹¹ 1 ê²½í—˜ì¹˜)
    if (steps % 10 === 0 && pet.type) {
      addPetExp(1);
    }
    saveAll();
    renderSteps();
    checkRouteRewards();
    var pw = document.getElementById('page-walk');
    var ps = document.getElementById('page-story');
    if (pw && pw.classList.contains('active')) { renderRoutes(); renderQuests(); }
    if (ps && ps.classList.contains('active')) renderStory();
  }

  function checkRouteRewards() {
    ROUTES.forEach(function (r) {
      if (claimedRoutes.indexOf(r.id) !== -1) return;
      if (lifetimeSteps < r.steps) return;
      claimedRoutes.push(r.id);
      inventory.push({ id: r.reward.id + '_' + Date.now(), name: r.reward.name, type: r.reward.type, emoji: r.reward.emoji, rarity: 'common', enhance: 0, tier: r.reward.tier || 'standard' });
      saveAll();
      showToast('ğŸ ' + r.name + 'ì—ì„œ ' + r.reward.name + ' íšë“!');
      renderRoutes();
      renderInventory();
      renderStory();
    });
  }

  function showToast(msg) {
    var el = document.getElementById('toast');
    if (!el) return;
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(function () { el.classList.remove('show'); }, 2500);
  }

  function haversineKm(lat1, lon1, lat2, lon2) {
    var R = 6371;
    var dLat = (lat2 - lat1) * Math.PI / 180;
    var dLon = (lon2 - lon1) * Math.PI / 180;
    var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function getDailyKitChance() {
    var n = supplyCountToday + 1;
    if (n <= 3) return 1;
    if (n === 4) return 0.5;
    if (n === 5) return 0.25;
    return 0.1;
  }

  function checkRouteComplete() {
    if (!activeRouteId || sessionDistanceKm < activeRouteGoalKm) return;
    var route = userRoutes.find(function(r) { return r.id === activeRouteId; });
    if (!route || route.completedAt) return;
    var today = todayStr();
    if (today !== supplyDateToday) {
      supplyDateToday = today;
      supplyCountToday = 0;
    }
    var chance = getDailyKitChance();
    if (Math.random() > chance) {
      route.completedAt = Date.now();
      route.path = pathCoords.slice();
      activeRouteId = null;
      activeRouteGoalKm = 0;
      saveAll();
      renderWalk();
      renderRouteSelect();
      showToast('ğŸ ì½”ìŠ¤ ì™„ì£¼! (ë³´ê¸‰ í‚¤íŠ¸ëŠ” ì¼ì¼ í•œë„ì— ë”°ë¼ ì§€ê¸‰ë¼ìš”)');
      return;
    }
    supplyCountToday += 1;
    route.completedAt = Date.now();
    route.path = pathCoords.slice();
    activeRouteId = null;
    activeRouteGoalKm = 0;
    storage.push({ id: 'kit_' + Date.now(), type: 'supply_kit', name: 'íŠ¸ë ˆì´ë‹ ë³´ê¸‰ í‚¤íŠ¸', receivedAt: Date.now() });
    saveAll();
    showToast('ğŸ“¦ ë³´ê¸‰ í‚¤íŠ¸ê°€ ë³´ê´€í•¨ì— ë„ì°©í–ˆì–´ìš”');
    renderWalk();
    renderRouteSelect();
    renderStorage();
    renderQuests();
  }

  function rollRarity() {
    var r = Math.random() * 100;
    if (r < 60) return 'common';
    if (r < 85) return 'rare';
    if (r < 97) return 'epic';
    return 'legend';
  }

  function openSupplyKit() {
    var idx = inventory.findIndex(function (i) { return i.type === 'supply_kit'; });
    if (idx === -1) { showToast('íŠ¸ë ˆì´ë‹ ë³´ê¸‰ í‚¤íŠ¸ê°€ ì—†ì–´ìš”'); return; }
    inventory.splice(idx, 1);
    openOneSupplyKit();
  }
  function openOneSupplyKit() {
    var item = pickItemByTierWeight();
    var rarity = rollRarity();
    var newItem = { id: item.id + '_' + Date.now(), name: item.name, type: item.type, emoji: item.emoji, rarity: rarity, enhance: 0, tier: item.tier || 'standard' };
    inventory.push(newItem);
    saveAll();
    var rarityLabel = { common: 'ì»¤ë¨¼', rare: 'ë ˆì–´', epic: 'ì—í”½', legend: 'ë ˆì „ë“œ' }[rarity];
    var tierLabel = TIER_LABELS[item.tier] || 'ìŠ¤íƒ ë‹¤ë“œ';
    showToast(getItemIcon(newItem) + ' ' + item.name + ' (' + tierLabel + ' Â· ' + rarityLabel + ') íšë“!');
    renderEquipped();
    renderInventory();
    renderAvatar();
  }
  function moveKitToInventory() {
    if (storage.length === 0) { showToast('ë³´ê´€í•¨ì— í‚¤íŠ¸ê°€ ì—†ì–´ìš”'); return; }
    var one = storage.pop();
    inventory.push({ id: 'supply_kit_' + Date.now(), name: 'íŠ¸ë ˆì´ë‹ ë³´ê¸‰ í‚¤íŠ¸', type: 'supply_kit', emoji: 'ğŸ“¦' });
    saveAll();
    renderStorage();
    renderInventory();
    showToast('ë³´ê¸‰ í‚¤íŠ¸ë¥¼ ì¸ë²¤í† ë¦¬ë¡œ ê°€ì ¸ì™”ì–´ìš”');
  }
  function openKitFromStorage() {
    if (storage.length === 0) { showToast('ë³´ê´€í•¨ì— í‚¤íŠ¸ê°€ ì—†ì–´ìš”'); return; }
    storage.pop();
    saveAll();
    openOneSupplyKit();
    renderStorage();
  }
  function renderStorage() {
    var wrap = document.getElementById('storageList');
    if (!wrap) return;
    wrap.innerHTML = '';
    if (storage.length === 0) {
      wrap.innerHTML = '<p class="story-text" style="color:var(--text-muted);">ë³´ê´€í•¨ì´ ë¹„ì–´ ìˆì–´ìš”.<br>ì‚°ì±… ì½”ìŠ¤ë¥¼ ì™„ì£¼í•˜ë©´ ë³´ê¸‰ í‚¤íŠ¸ê°€ ì—¬ê¸°ë¡œ ë„ì°©í•´ìš”.</p>';
      return;
    }
    storage.forEach(function(k, i) {
      var card = document.createElement('div');
      card.className = 'inv-item inv-item-kit';
      card.innerHTML = '<span>ğŸ“¦</span><span class="inv-name">íŠ¸ë ˆì´ë‹ ë³´ê¸‰ í‚¤íŠ¸</span><div class="storage-actions"><button type="button" class="btn-storage-inv">ì¸ë²¤ìœ¼ë¡œ</button><button type="button" class="btn-storage-open">ì—´ê¸°</button></div>';
      card.querySelector('.btn-storage-inv').onclick = function() { moveKitToInventory(); };
      card.querySelector('.btn-storage-open').onclick = function() { openKitFromStorage(); };
      wrap.appendChild(card);
    });
  }

  function onPosition(pos) {
    if (walkState !== 'walking') return;
    var lat = pos.coords.latitude;
    var lon = pos.coords.longitude;
    var nowMs = pos.timestamp != null ? pos.timestamp : Date.now();
    if (pathCoords.length > 0) {
      var last = pathCoords[pathCoords.length - 1];
      var seg = haversineKm(last.lat, last.lon, lat, lon);
      if (seg < MIN_SEGMENT_KM) return;
      var timeDeltaH = (nowMs - lastPositionTime) / 3600000;
      if (timeDeltaH > 0) {
        var speedKmh = seg / timeDeltaH;
        if (speedKmh > MAX_SPEED_KMH) return;
      }
      var bonus = getEquipmentBonus();
      var distMult = 1 + (bonus.distance / 100);
      var xpMult = 1 + (bonus.xp / 100);
      sessionDistanceKm += seg * distMult;
      sessionXp = Math.floor(sessionDistanceKm * XP_PER_KM);
      totalXp += Math.floor(seg * XP_PER_KM * xpMult);
      totalWalkDistanceKm += seg * distMult;
      checkRouteComplete();
      saveAll();
      pathCoords.push({ lat: lat, lon: lon });
      lastPositionTime = nowMs;
    } else {
      pathCoords.push({ lat: lat, lon: lon });
      lastPositionTime = nowMs;
    }
    renderWalk();
  }

  function startWalk() {
    var sel = document.getElementById('selectActiveRoute');
    var val = sel ? sel.value : '';
    if (val) {
      var r = userRoutes.find(function(x) { return x.id === val; });
      if (r && !r.completedAt) {
        activeRouteId = r.id;
        activeRouteGoalKm = r.goalKm;
      }
    }
    if (!activeRouteId) {
      showToast('ì§„í–‰í•  ì½”ìŠ¤ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
      return;
    }
    if (!navigator.geolocation) { showToast('ì´ ê¸°ê¸°ëŠ” GPSë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„ìš”'); return; }
    walkState = 'walking';
    pathCoords = [];
    sessionDistanceKm = 0;
    sessionXp = 0;
    var statusEl = document.getElementById('walkStatus');
    if (statusEl) statusEl.textContent = 'ìœ„ì¹˜ í™•ì¸ ì¤‘...';
    var opts = { enableHighAccuracy: true, maximumAge: 0, timeout: 20000 };
    navigator.geolocation.getCurrentPosition(
      function (pos) {
        pathCoords.push({ lat: pos.coords.latitude, lon: pos.coords.longitude });
        lastPositionTime = pos.timestamp != null ? pos.timestamp : Date.now();
        watchId = navigator.geolocation.watchPosition(onPosition, function () {}, opts);
        if (statusEl) statusEl.textContent = 'ì‚°ì±… ì¤‘! ê±¸ìœ¼ë©´ ê±°ë¦¬ê°€ ëˆ„ì ë¼ìš”.';
        var startBtn = document.getElementById('btnWalkStart');
        var stopBtn = document.getElementById('btnWalkStop');
        if (startBtn) startBtn.disabled = true;
        if (stopBtn) stopBtn.disabled = false;
        renderWalk();
      },
      function (err) {
        if (err.code === 1) {
          if (statusEl) statusEl.textContent = 'ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.';
          showToast('ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•´ìš”');
          walkState = 'idle';
        } else if (err.code === 3) {
          if (statusEl) statusEl.textContent = 'ìœ„ì¹˜ í™•ì¸ ì¤‘ì´ì—ìš”. ì•¼ì™¸ì—ì„œ ì‹œë„í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ëˆŒëŸ¬ ì£¼ì„¸ìš”.';
          showToast('ì‹œê°„ ì´ˆê³¼. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
          walkState = 'idle';
        } else {
          if (statusEl) statusEl.textContent = 'ìœ„ì¹˜ë¥¼ ì¼œê³  ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
          showToast('ìœ„ì¹˜ë¥¼ ì¼œ ì£¼ì„¸ìš”.');
          walkState = 'idle';
        }
      },
      opts
    );
  }

  function stopWalk() {
    walkState = 'idle';
    if (watchId != null && navigator.geolocation) navigator.geolocation.clearWatch(watchId);
    watchId = null;
    var startBtn = document.getElementById('btnWalkStart');
    var stopBtn = document.getElementById('btnWalkStop');
    if (startBtn) startBtn.disabled = false;
    if (stopBtn) stopBtn.disabled = true;
    var statusEl = document.getElementById('walkStatus');
    if (statusEl) statusEl.textContent = 'ì´ë²ˆ ì‚°ì±… ' + sessionDistanceKm.toFixed(2) + ' km, XP +' + sessionXp + ' (ì´ XP ' + totalXp + ')';
    saveAll();
    renderWalk();
  }

  function renderWalk() {
    var distEl = document.getElementById('walkDistance');
    var xpEl = document.getElementById('walkXp');
    var nextEl = document.getElementById('walkNext');
    if (distEl) distEl.textContent = sessionDistanceKm.toFixed(2);
    if (xpEl) xpEl.textContent = totalXp + (sessionXp > 0 ? ' (+' + sessionXp + ')' : '');
    if (nextEl) {
      if (activeRouteId && activeRouteGoalKm > 0) {
        var remain = activeRouteGoalKm - sessionDistanceKm;
        nextEl.textContent = remain <= 0 ? 'ì½”ìŠ¤ ì™„ì£¼!' : 'ì™„ì£¼ê¹Œì§€ ' + remain.toFixed(2) + ' km';
      } else {
        nextEl.textContent = 'ì½”ìŠ¤ë¥¼ ì™„ì£¼í•˜ë©´ ë³´ê¸‰ í‚¤íŠ¸ê°€ ë³´ê´€í•¨ì— ë„ì°©í•´ìš”!';
      }
    }
    var totalKmEl = document.getElementById('walkTotalKm');
    if (totalKmEl) totalKmEl.textContent = totalWalkDistanceKm.toFixed(3);
    var titleObj = getTitleForKm(totalWalkDistanceKm);
    currentTitleId = titleObj.id;
    var titleBadge = document.getElementById('titleBadge');
    if (titleBadge) titleBadge.textContent = titleObj.name;
    renderLevel();
    renderGold();
    updateWalkMap();
  }
  function renderLevel() {
    var info = xpToLevel(totalXp);
    var numEl = document.getElementById('levelNum');
    var barEl = document.getElementById('levelBarFill');
    if (numEl) numEl.textContent = info.level;
    if (barEl) barEl.style.width = (info.need ? (info.current / info.need * 100) : 0) + '%';
  }
  function renderGold() {
    var h = document.getElementById('headerGold');
    var g = document.getElementById('gachaGold');
    var btnGacha = document.getElementById('btnGacha');
    var btnGachaPremium = document.getElementById('btnGachaPremium');
    if (h) h.textContent = gold;
    if (g) g.textContent = gold;
    if (btnGacha) btnGacha.disabled = gold < GACHA_COST;
    if (btnGachaPremium) btnGachaPremium.disabled = gold < GACHA_PREMIUM_COST;
  }
  function renderRouteSelect() {
    var sel = document.getElementById('selectActiveRoute');
    if (!sel) return;
    sel.innerHTML = '<option value="">-- ì½”ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>';
    userRoutes.forEach(function(r) {
      var opt = document.createElement('option');
      opt.value = r.id;
      opt.textContent = r.name + ' (' + r.goalKm + ' km)' + (r.completedAt ? ' âœ“ ì™„ì£¼' : '');
      opt.disabled = !!r.completedAt;
      sel.appendChild(opt);
    });
  }
  function addNewRoute() {
    var name = document.getElementById('newRouteName');
    var goal = document.getElementById('newRouteGoalKm');
    if (!name || !goal) return;
    var n = (name.value || '').trim();
    var g = parseFloat(goal.value) || 1;
    if (n.length < 1) { showToast('ì½”ìŠ¤ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    if (g < 0.5) g = 0.5;
    userRoutes.push({ id: 'r_' + Date.now(), name: n, goalKm: g, path: [], completedAt: null });
    saveAll();
    name.value = '';
    goal.value = '1';
    document.getElementById('routeCreateCard').style.display = 'none';
    renderRouteSelect();
    showToast('ì½”ìŠ¤ê°€ ì¶”ê°€ë˜ì—ˆì–´ìš”.');
  }
  function initWalkMap() {
    if (walkMapPathEl) return;
    var el = document.getElementById('walkMap');
    if (!el) return;
    el.innerHTML = '';
    var w = 400, h = 220;
    var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('viewBox', '0 0 ' + w + ' ' + h);
    svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
    var grid = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    grid.setAttribute('class', 'our-map-grid');
    for (var i = 0; i <= 10; i++) {
      var v = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      v.setAttribute('x1', (i * w / 10));
      v.setAttribute('y1', 0);
      v.setAttribute('x2', (i * w / 10));
      v.setAttribute('y2', h);
      grid.appendChild(v);
      var hor = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      hor.setAttribute('x1', 0);
      hor.setAttribute('y1', (i * h / 10));
      hor.setAttribute('x2', w);
      hor.setAttribute('y2', (i * h / 10));
      grid.appendChild(hor);
    }
    svg.appendChild(grid);
    var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('class', 'our-map-path');
    path.setAttribute('d', '');
    svg.appendChild(path);
    var charG = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    charG.setAttribute('class', 'our-map-char');
    var shadow = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
    shadow.setAttribute('class', 'char-shadow');
    shadow.setAttribute('cx', 0);
    shadow.setAttribute('cy', 10);
    shadow.setAttribute('rx', 12);
    shadow.setAttribute('ry', 4);
    charG.appendChild(shadow);
    var charHead = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    charHead.setAttribute('class', 'char-head');
    charHead.setAttribute('r', 7);
    charHead.setAttribute('cx', 0);
    charHead.setAttribute('cy', -8);
    charG.appendChild(charHead);
    var charBody = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    charBody.setAttribute('class', 'char-body');
    charBody.setAttribute('r', 10);
    charBody.setAttribute('cx', 0);
    charBody.setAttribute('cy', 6);
    charG.appendChild(charBody);
    svg.appendChild(charG);
    el.appendChild(svg);
    var label = document.createElement('span');
    label.className = 'our-map-label';
    label.textContent = 'ì‹¤ì‹œê°„ ì´ë™ ê²½ë¡œ';
    el.appendChild(label);
    walkMapEl = el;
    walkMapPathEl = path;
    walkMapCharEl = charG;
  }
  function updateWalkMap() {
    if (!walkMapPathEl || !walkMapCharEl) return;
    var coords = pathCoords.length ? pathCoords : (activeRouteId ? (userRoutes.find(function(r){ return r.id === activeRouteId; }) || {}).path : []);
    var w = 400, h = 220;
    if (coords.length === 0) {
      walkMapPathEl.setAttribute('d', '');
      walkMapCharEl.setAttribute('transform', 'translate(-1000,-1000)');
      return;
    }
    var bounds = ourMapBounds(coords);
    var pts = coords.map(function(c) { return ourMapLatLonToXY(c.lat, c.lon, bounds, w, h); });
    var d = 'M ' + pts[0].x + ' ' + pts[0].y;
    for (var i = 1; i < pts.length; i++) d += ' L ' + pts[i].x + ' ' + pts[i].y;
    walkMapPathEl.setAttribute('d', d);
    var last = pts[pts.length - 1];
    walkMapCharEl.setAttribute('transform', 'translate(' + last.x + ',' + last.y + ')');
  }

  function renderSteps() {
    var today = todayStr();
    if (today !== lastDate) {
      steps = 0;
      lastDate = today;
      saveAll();
    }
    var stepVal = document.getElementById('stepValue');
    var lifeVal = document.getElementById('lifetimeSteps');
    var progressFill = document.getElementById('progressFill');
    var progressText = document.getElementById('progressText');
    var card = document.getElementById('stepCard');
    if (stepVal) stepVal.textContent = steps.toLocaleString();
    if (lifeVal) lifeVal.textContent = lifetimeSteps.toLocaleString();
    var pct = Math.min(100, (steps / GOAL) * 100);
    if (progressFill) progressFill.style.width = pct + '%';
    if (progressText) progressText.textContent = steps.toLocaleString() + ' / ' + GOAL.toLocaleString();
    if (card) {
      if (steps >= GOAL) card.classList.add('goal-reached');
      else card.classList.remove('goal-reached');
    }
  }

  function switchTab(tabId) {
    document.querySelectorAll('.tab-btn').forEach(function (b) {
      b.classList.toggle('active', b.getAttribute('data-tab') === tabId);
      b.setAttribute('aria-selected', b.getAttribute('data-tab') === tabId ? 'true' : 'false');
    });
    document.querySelectorAll('.page').forEach(function (p) {
      p.classList.toggle('active', p.id === 'page-' + tabId);
    });
    if (tabId === 'walk') {
      renderSteps();
      renderWalk();
      renderRouteSelect();
      renderRoutes();
      renderQuests();
      renderAttendance();
      initWalkMap();
      setTimeout(function () { initWalkMap(); updateWalkMap(); }, 150);
    }
    if (tabId === 'avatar') { renderAvatar(); renderPet(); }
    if (tabId === 'storage') renderStorage();
    if (tabId === 'shop') { renderGold(); }
    if (tabId === 'equipment') { renderEquipped(); renderInventory(); renderEnhanceSelect(); }
    if (tabId === 'story') { renderStory(); renderAchievements(); }
  }
  function doGachaPull(premium) {
    var cost = premium ? GACHA_PREMIUM_COST : GACHA_COST;
    if (gold < cost) { showToast('Gê°€ ë¶€ì¡±í•´ìš”. (í•„ìš”: ' + cost + ' G)'); return; }
    gold -= cost;
    var item = pickItemByTierWeight(!!premium);
    var rarity = premium ? rollRarityPremium() : rollRarity();
    var newItem = { id: item.id + '_' + Date.now(), name: item.name, type: item.type, emoji: item.emoji, rarity: rarity, enhance: 0, tier: item.tier || 'standard' };
    inventory.push(newItem);
    questGachaCount += 1;
    saveAll();
    renderGold();
    renderInventory();
    renderQuests();
    var rarityLabel = { common: 'ì»¤ë¨¼', rare: 'ë ˆì–´', epic: 'ì—í”½', legend: 'ë ˆì „ë“œ' }[rarity];
    var tierLabel = TIER_LABELS[item.tier] || 'ìŠ¤íƒ ë‹¤ë“œ';
    showToast(getItemIcon(newItem) + ' ' + item.name + ' (' + tierLabel + ' Â· ' + rarityLabel + ') ë½‘ê¸° ì„±ê³µ!');
  }
  function renderEnhanceTable() {
    var tbody = document.getElementById('enhanceTableBody');
    if (!tbody) return;
    tbody.innerHTML = '';
    for (var i = 0; i <= ENHANCE_MAX; i++) {
      var tr = document.createElement('tr');
      var next = i + 1;
      var rate = i < ENHANCE_MAX ? ENHANCE_RATES[i] : 0;
      var failText = i < 4 ? 'ì¥ë¹„ íŒŒê´´' : (i < ENHANCE_MAX ? 'ì‹œë„ ì‹œ ' + ENHANCE_ATTEMPT_GOLD[i] + ' G' : 'ìµœëŒ€ ê°•í™”');
      var col1 = i < ENHANCE_MAX ? ('+' + i + ' â†’ +' + next) : ('+' + i + ' (ìµœëŒ€)');
      var rateClass = rate >= 75 ? 'rate-ok' : (rate >= 45 ? 'rate-mid' : 'rate-low');
      tr.innerHTML = '<td class="enhance-col">' + col1 + '</td><td class="' + rateClass + '">' + (i < ENHANCE_MAX ? rate + '%' : '-') + '</td><td>' + failText + '</td>';
      tbody.appendChild(tr);
    }
  }
  function renderEnhanceSelect() {
    renderEnhanceTable();
    var sel = document.getElementById('enhanceSelect');
    if (!sel) return;
    sel.innerHTML = '<option value="">-- ì¥ë¹„ ì„ íƒ --</option>';
    inventory.forEach(function(item) {
      if (item.type === 'supply_kit') return;
      var enh = item.enhance != null ? item.enhance : 0;
      var opt = document.createElement('option');
      opt.value = item.id;
      opt.textContent = (item.emoji || '') + ' ' + item.name + ' +' + enh + (enh >= ENHANCE_MAX ? ' (ìµœëŒ€)' : '');
      sel.appendChild(opt);
    });
  }
  function tryEnhance() {
    var sel = document.getElementById('enhanceSelect');
    if (!sel || !sel.value) { showToast('ê°•í™”í•  ì¥ë¹„ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }
    var item = inventory.find(function(i){ return i.id === sel.value; });
    if (!item) { showToast('ì¥ë¹„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”.'); return; }
    var enh = item.enhance != null ? item.enhance : 0;
    if (enh >= ENHANCE_MAX) { showToast('ì´ë¯¸ ìµœëŒ€ ê°•í™”(+7)ì…ë‹ˆë‹¤.'); return; }
    var attemptGold = ENHANCE_ATTEMPT_GOLD[enh];
    if (attemptGold > 0) {
      if (gold < attemptGold) { showToast('ê°•í™” ì‹œë„ì— ' + attemptGold + ' Gê°€ í•„ìš”í•´ìš”.'); return; }
      gold -= attemptGold;
      saveAll();
      renderGold();
    }
    var successRate = ENHANCE_RATES[enh];
    if (Math.random() * 100 >= successRate) {
      if (enh < 4) {
        var idx = inventory.indexOf(item);
        inventory.splice(idx, 1);
        saveAll();
        renderEnhanceSelect();
        renderInventory();
        renderEquipped();
        renderAvatar();
        showToast('ê°•í™” ì‹¤íŒ¨... ' + item.name + 'ì´(ê°€) íŒŒê´´ë˜ì—ˆì–´ìš”.');
      } else {
        renderEnhanceSelect();
        showToast('ê°•í™” ì‹¤íŒ¨. (ì¥ë¹„ ìœ ì§€, ì‹œë„ ë¹„ìš© ' + attemptGold + ' G ì†Œëª¨)');
      }
      return;
    }
    item.enhance = enh + 1;
    saveAll();
    renderEnhanceSelect();
    renderInventory();
    showToast(item.name + ' +' + (enh + 1) + ' ê°•í™” ì„±ê³µ!');
  }
  function renderAchievements() {
    var grid = document.getElementById('achievementGrid');
    if (!grid) return;
    grid.innerHTML = '';
    ACHIEVEMENTS.forEach(function(a) {
      var unlocked = a.check();
      var div = document.createElement('div');
      div.className = 'achievement-item' + (unlocked ? ' unlocked' : ' locked');
      div.innerHTML = '<span class="ach-icon">' + a.icon + '</span><div><span class="ach-name">' + a.name + '</span><div class="ach-desc">' + a.desc + '</div></div>';
      grid.appendChild(div);
    });
  }

  function renderQuests() {
    var list = document.getElementById('questList');
    if (!list) return;
    list.innerHTML = '';
    DAILY_QUESTS.forEach(function(q) {
      var progress = q.getProgress();
      var done = progress >= q.goal;
      var claimed = questClaimed[q.id];
      var item = document.createElement('div');
      item.className = 'quest-item' + (claimed ? ' done' : '');
      var progressText = q.goal === 1 ? (progress + ' / ' + q.goal) : (progress.toLocaleString() + ' / ' + q.goal.toLocaleString());
      if (claimed) {
        item.innerHTML = '<div class="quest-info"><span class="quest-name">' + q.name + '</span><div class="quest-progress">' + q.desc + '</div></div><span class="quest-done-label">âœ“ ì™„ë£Œ</span>';
      } else if (done) {
        item.innerHTML = '<div class="quest-info"><span class="quest-name">' + q.name + '</span><div class="quest-progress">' + progressText + '</div></div><span class="quest-reward">+' + q.reward + ' G</span><button type="button" class="btn-claim" data-quest="' + q.id + '">ë³´ìƒ ìˆ˜ë ¹</button>';
      } else {
        item.innerHTML = '<div class="quest-info"><span class="quest-name">' + q.name + '</span><div class="quest-progress">' + progressText + '</div></div><span class="quest-reward">+' + q.reward + ' G</span>';
      }
      list.appendChild(item);
    });
    list.querySelectorAll('.btn-claim').forEach(function(btn) {
      btn.addEventListener('click', function() { claimQuest(this.getAttribute('data-quest')); });
    });
  }
  function claimQuest(questId) {
    var q = DAILY_QUESTS.find(function(x){ return x.id === questId; });
    if (!q || questClaimed[questId]) return;
    if (q.getProgress() < q.goal) { showToast('ì•„ì§ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ì§€ ëª»í–ˆì–´ìš”'); return; }
    questClaimed[questId] = true;
    gold += q.reward;
    saveAll();
    renderQuests();
    renderGold();
    showToast('+' + q.reward + ' G íšë“!');
  }
  function doShare() {
    var url = location.href;
    var text = 'WalkStory - ê±¸ìŒìœ¼ë¡œ í‚¤ìš°ëŠ” ë‚˜ë§Œì˜ ë™ë¬¼ ì¹œêµ¬';
    if (navigator.share) {
      navigator.share({ title: 'WalkStory', text: text, url: url }).then(function() {
        onShareSuccess();
      }).catch(function() { onShareSuccess(); });
    } else {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(function() { onShareSuccess(); }).catch(function() { onShareSuccess(); });
      } else { onShareSuccess(); }
    }
  }
  function onShareSuccess() {
    if (sharedToday) { showToast('ì˜¤ëŠ˜ì€ ì´ë¯¸ ê³µìœ  ë³´ìƒì„ ë°›ì•˜ì–´ìš”'); return; }
    sharedToday = true;
    gold += 40;
    saveAll();
    renderGold();
    renderQuests();
    showToast('ê³µìœ  ê°ì‚¬í•´ìš”! +40 G');
  }
  function renderHeaderAuth() {
    var btn = document.getElementById('btnHeaderAuth');
    var logoutBtn = document.getElementById('btnLogout');
    if (!btn) return;
    if (isLoggedIn && userProfile && userProfile.nickname) {
      btn.textContent = userProfile.nickname;
      btn.classList.add('logged-in');
      btn.setAttribute('aria-label', 'í”„ë¡œí•„');
      if (logoutBtn) {
        logoutBtn.style.display = 'block';
      }
    } else {
      btn.textContent = 'ğŸ” ë¡œê·¸ì¸';
      btn.classList.remove('logged-in');
      btn.setAttribute('aria-label', 'ë¡œê·¸ì¸');
      if (logoutBtn) {
        logoutBtn.style.display = 'none';
      }
    }
    renderAuthGate();
  }
  function renderAuthGate() {
    var appMain = document.getElementById('appMain');
    var authOverlay = document.getElementById('authOverlay');
    if (!appMain || !authOverlay) return;
    if (isLoggedIn) {
      appMain.classList.remove('hidden');
      authOverlay.style.display = 'none';
      authOverlay.classList.remove('auth-gate');
    } else {
      appMain.classList.add('hidden');
      authOverlay.style.display = 'flex';
      authOverlay.classList.add('auth-gate');
    }
  }
  function openAuthModal() {
    var overlay = document.getElementById('authOverlay');
    if (overlay) { overlay.style.display = 'flex'; overlay.classList.remove('auth-gate'); }
    document.getElementById('authLoginPanel').style.display = 'block';
    document.getElementById('authSignupPanel').style.display = 'none';
    document.querySelectorAll('.auth-tab').forEach(function(t){ t.classList.remove('active'); if (t.getAttribute('data-auth-tab') === 'login') t.classList.add('active'); });
    document.getElementById('authTitle').textContent = 'ë¡œê·¸ì¸';
  }
  function closeAuthModal() {
    var overlay = document.getElementById('authOverlay');
    if (overlay && isLoggedIn) overlay.style.display = 'none';
    if (overlay && !isLoggedIn) { overlay.style.display = 'flex'; overlay.classList.add('auth-gate'); }
  }
  function doLogin() {
    var nick = (document.getElementById('authLoginNick') || {}).value.trim();
    var pw = (document.getElementById('authLoginPw') || {}).value;
    if (!nick || !pw) { showToast('ë‹‰ë„¤ì„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    var url = API_BASE + '/api/auth/login';
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nickname: nick, password: pw })
    }).then(function (r) {
      if (!r.ok) {
        return r.text().then(function (text) {
          try { return { ok: false, body: JSON.parse(text) }; }
          catch { return { ok: false, body: { error: 'HTTP ' + r.status + ': ' + text.substring(0, 50) } }; }
        });
      }
      return r.json().then(function (j) { return { ok: true, body: j }; });
    })
      .then(function (x) {
        if (!x.ok) { showToast(x.body.error || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆì–´ìš”.'); return; }
        setAuthToken(x.body.token);
        userProfile = x.body.user;
        isLoggedIn = true;
        return fetch(API_BASE + '/api/user/data', { headers: { 'Authorization': 'Bearer ' + x.body.token } });
      })
      .then(function (r) {
        if (!r) return;
        return r.json();
      })
      .then(function (body) {
        if (body && body.data) {
          try {
            var data = typeof body.data === 'string' ? JSON.parse(body.data) : body.data;
            applyGameState(data);
          } catch (e) {}
        }
        saveAll();
        closeAuthModal();
        renderHeaderAuth();
        renderAuthGate();
        renderPet();
        renderAttendance();
        var card = document.getElementById('attendanceCard');
        if (card) card.style.display = 'block';
        if (userProfile && userProfile.nickname) {
          showToast(userProfile.nickname + 'ë‹˜ í™˜ì˜í•´ìš”!');
        } else {
          showToast('ë¡œê·¸ì¸ ì„±ê³µ!');
        }
      })
      .catch(function (err) {
        console.error('Login error:', err, 'URL:', url, 'API_BASE:', API_BASE);
        showToast('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ì–´ìš”. (API: ' + url + ')');
      });
  }
  function doSignup() {
    var nick = (document.getElementById('authSignupNick') || {}).value.trim();
    var email = (document.getElementById('authSignupEmail') || {}).value.trim();
    var pw = (document.getElementById('authSignupPw') || {}).value;
    var pw2 = (document.getElementById('authSignupPw2') || {}).value;
    if (!nick || nick.length < 2) { showToast('ë‹‰ë„¤ì„ì€ 2ì ì´ìƒì´ì—ìš”.'); return; }
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showToast('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    if (!pw || pw.length < 6) { showToast('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì—ìš”.'); return; }
    if (pw !== pw2) { showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•Šì•„ìš”.'); return; }
    var url = API_BASE + '/api/auth/signup';
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nickname: nick, password: pw, email: email })
    }).then(function (r) {
      if (!r.ok) {
        return r.text().then(function (text) {
          try { return { ok: false, body: JSON.parse(text) }; }
          catch { return { ok: false, body: { error: 'HTTP ' + r.status + ': ' + text.substring(0, 50) } }; }
        });
      }
      return r.json().then(function (j) { return { ok: true, body: j }; });
    })
      .then(function (x) {
        if (!x.ok) { showToast(x.body.error || 'ê°€ì…ì— ì‹¤íŒ¨í–ˆì–´ìš”.'); return; }
        setAuthToken(x.body.token);
        userProfile = x.body.user;
        isLoggedIn = true;
        saveAll();
        closeAuthModal();
        renderHeaderAuth();
        renderAttendance();
        var card = document.getElementById('attendanceCard');
        if (card) card.style.display = 'block';
        if (userProfile && userProfile.nickname) {
          showToast('ê°€ì… ì™„ë£Œ! ' + userProfile.nickname + 'ë‹˜ í™˜ì˜í•´ìš”.');
        } else {
          showToast('ê°€ì… ì™„ë£Œ!');
        }
      })
      .catch(function (err) {
        console.error('Signup error:', err, 'URL:', url);
        showToast('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ì–´ìš”. (API: ' + url + ')');
      });
  }
  function doFindId() {
    var email = (document.getElementById('authFindIdEmail') || {}).value.trim();
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      showToast('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return;
    }
    var url = API_BASE + '/api/auth/find-id';
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: email })
    }).then(function (r) {
      if (!r.ok) {
        return r.text().then(function (text) {
          try { return { ok: false, body: JSON.parse(text) }; }
          catch { return { ok: false, body: { error: 'HTTP ' + r.status + ': ' + text.substring(0, 50) } }; }
        });
      }
      return r.json().then(function (j) { return { ok: true, body: j }; });
    }).then(function (x) {
      var resultDiv = document.getElementById('findIdResult');
      if (!x.ok) {
        if (resultDiv) {
          resultDiv.style.display = 'block';
          resultDiv.innerHTML = '<div style="color: #ef4444;">' + (x.body.error || 'ì•„ì´ë”” ì°¾ê¸°ì— ì‹¤íŒ¨í–ˆì–´ìš”.') + '</div>';
        } else {
          showToast(x.body.error || 'ì•„ì´ë”” ì°¾ê¸°ì— ì‹¤íŒ¨í–ˆì–´ìš”.');
        }
        return;
      }
      if (resultDiv) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div style="color: var(--accent);">ë‹‰ë„¤ì„: <strong>' + x.body.fullNickname + '</strong></div>';
      }
    }).catch(function (err) {
      console.error('Find ID error:', err);
      showToast('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ì–´ìš”.');
    });
  }
  function doFindPw() {
    var email = (document.getElementById('authFindPwEmail') || {}).value.trim();
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      showToast('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return;
    }
    var url = API_BASE + '/api/auth/reset-password-request';
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: email })
    }).then(function (r) {
      if (!r.ok) {
        return r.text().then(function (text) {
          try { return { ok: false, body: JSON.parse(text) }; }
          catch { return { ok: false, body: { error: 'HTTP ' + r.status + ': ' + text.substring(0, 50) } }; }
        });
      }
      return r.json().then(function (j) { return { ok: true, body: j }; });
    }).then(function (x) {
      var resultDiv = document.getElementById('findPwResult');
      var resetPanel = document.getElementById('authResetPwPanel');
      if (!x.ok) {
        if (resultDiv) {
          resultDiv.style.display = 'block';
          resultDiv.innerHTML = '<div style="color: #ef4444;">' + (x.body.error || 'ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ìš”ì²­ì— ì‹¤íŒ¨í–ˆì–´ìš”.') + '</div>';
        } else {
          showToast(x.body.error || 'ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ìš”ì²­ì— ì‹¤íŒ¨í–ˆì–´ìš”.');
        }
        return;
      }
      if (resultDiv) {
        resultDiv.style.display = 'block';
        var msg = x.body.message || 'ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë§í¬ë¥¼ ë°œì†¡í–ˆì–´ìš”.';
        if (x.body.resetToken) {
          msg += '<br><small style="color: var(--text-muted); margin-top: 0.5rem; display: block;">ê°œë°œ ëª¨ë“œ: í† í° = ' + x.body.resetToken + '</small>';
        }
        resultDiv.innerHTML = '<div style="color: var(--accent);">' + msg + '</div>';
      }
      if (resetPanel && x.body.resetToken) {
        resetPanel.style.display = 'block';
        document.getElementById('authResetToken').value = x.body.resetToken;
      }
    }).catch(function (err) {
      console.error('Find PW error:', err);
      showToast('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ì–´ìš”.');
    });
  }
  function doResetPw() {
    var token = (document.getElementById('authResetToken') || {}).value.trim();
    var pw = (document.getElementById('authResetPw') || {}).value;
    var pw2 = (document.getElementById('authResetPw2') || {}).value;
    if (!token) { showToast('í† í°ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    if (!pw || pw.length < 6) { showToast('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì—ìš”.'); return; }
    if (pw !== pw2) { showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•Šì•„ìš”.'); return; }
    var url = API_BASE + '/api/auth/reset-password';
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token: token, newPassword: pw })
    }).then(function (r) {
      if (!r.ok) {
        return r.text().then(function (text) {
          try { return { ok: false, body: JSON.parse(text) }; }
          catch { return { ok: false, body: { error: 'HTTP ' + r.status + ': ' + text.substring(0, 50) } }; }
        });
      }
      return r.json().then(function (j) { return { ok: true, body: j }; });
    }).then(function (x) {
      if (!x.ok) {
        showToast(x.body.error || 'ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •ì— ì‹¤íŒ¨í–ˆì–´ìš”.');
        return;
      }
      showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ì¬ì„¤ì •ë˜ì—ˆì–´ìš”. ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');
      switchAuthTab('login');
    }).catch(function (err) {
      console.error('Reset PW error:', err);
      showToast('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ì–´ìš”.');
    });
  }
  function doSocialLogin(provider) {
    // ì¹´ì¹´ì˜¤/êµ¬ê¸€ OAuthëŠ” í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì²˜ë¦¬í•˜ê³ , ë°±ì—”ë“œì— ì‚¬ìš©ì ì •ë³´ ì „ì†¡
    if (provider === 'kakao') {
      // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ (Kakao SDK í•„ìš”)
      if (typeof Kakao === 'undefined') {
        showToast('ì¹´ì¹´ì˜¤ SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ì–´ìš”. ì¹´ì¹´ì˜¤ ê°œë°œì ì•± ì„¤ì •ì´ í•„ìš”í•´ìš”.');
        return;
      }
      Kakao.Auth.login({
        // ë‹‰ë„¤ì„ë§Œ ìš”ì²­ (ì´ë©”ì¼ì€ ê¶Œí•œ ì—†ìŒ ìƒíƒœì´ë¯€ë¡œ ì œì™¸)
        scope: 'profile_nickname',
        success: function(authObj) {
          Kakao.API.request({
            url: '/v2/user/me',
            success: function(res) {
              console.log('Kakao API response:', res);
              console.log('Kakao account:', res.kakao_account);
              console.log('Properties:', res.properties);
              try {
                var socialId = res.id ? res.id.toString() : null;
                if (!socialId) {
                  showToast('ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ìš”.');
                  return;
                }
                
                // ë‹‰ë„¤ì„ ì¶”ì¶œ (ì•ˆì „í•˜ê²Œ - ì—¬ëŸ¬ ê²½ë¡œ í™•ì¸)
                var nickname = 'ì¹´ì¹´ì˜¤ì‚¬ìš©ì' + Math.floor(Math.random() * 1000); // ê¸°ë³¸ê°’ì— ëœë¤ ìˆ«ì ì¶”ê°€
                if (res.kakao_account) {
                  if (res.kakao_account.profile && res.kakao_account.profile.nickname) {
                    nickname = res.kakao_account.profile.nickname;
                  } else if (res.kakao_account.profile_nickname) {
                    nickname = res.kakao_account.profile_nickname;
                  }
                }
                if (res.properties) {
                  if (res.properties.nickname) {
                    nickname = res.properties.nickname;
                  }
                }
                
                // ì´ë©”ì¼ì€ ê¶Œí•œ ì—†ìŒì´ë¯€ë¡œ nullë¡œ ì„¤ì •
                var email = null;
                
                console.log('Extracted nickname:', nickname, 'socialId:', socialId);
                sendSocialLogin(provider, socialId, nickname, email);
              } catch (err) {
                console.error('Kakao API response processing error:', err);
                showToast('ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ì •ë³´ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´ìš”.');
              }
            },
            fail: function(err) {
              console.error('Kakao API error:', err);
              showToast('ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ìš”: ' + (err.error_description || err.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
          });
        },
        fail: function(err) {
          console.error('Kakao Auth error:', err);
          showToast('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆì–´ìš”: ' + (err.error_description || err.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      });
    } else if (provider === 'google') {
      // êµ¬ê¸€ ë¡œê·¸ì¸ (Google Sign-In API í•„ìš”)
      if (typeof gapi === 'undefined') {
        showToast('êµ¬ê¸€ SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ì–´ìš”. Google OAuth ì„¤ì •ì´ í•„ìš”í•´ìš”.');
        return;
      }
      var googleClientId = (typeof window !== 'undefined' && window.APP_CONFIG && window.APP_CONFIG.google) 
        ? window.APP_CONFIG.google.clientId 
        : 'YOUR_GOOGLE_CLIENT_ID';
      if (googleClientId === 'YOUR_GOOGLE_CLIENT_ID') {
        showToast('êµ¬ê¸€ í´ë¼ì´ì–¸íŠ¸ IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ì–´ìš”.');
        return;
      }
      gapi.load('auth2', function() {
        gapi.auth2.init({
          client_id: googleClientId
        }).then(function() {
          var authInstance = gapi.auth2.getAuthInstance();
          authInstance.signIn().then(function(googleUser) {
            var profile = googleUser.getBasicProfile();
            var socialId = profile.getId();
            var nickname = profile.getName() || 'êµ¬ê¸€ì‚¬ìš©ì';
            var email = profile.getEmail() || null;
            sendSocialLogin(provider, socialId, nickname, email);
          }).catch(function(err) {
            console.error('Google Sign-In error:', err);
            showToast('êµ¬ê¸€ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆì–´ìš”.');
          });
        });
      });
    }
  }
  function sendSocialLogin(provider, socialId, nickname, email) {
    console.log('sendSocialLogin called:', { provider, socialId: socialId?.substring(0, 10) + '...', nickname: nickname?.substring(0, 20), email: email ? 'provided' : 'null' });
    var url = API_BASE + '/api/auth/social';
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ provider: provider, socialId: socialId, nickname: nickname, email: email })
    }).then(function (r) {
      console.log('Social login response status:', r.status);
      if (!r.ok) {
        return r.text().then(function (text) {
          console.error('Social login error response:', text);
          try { 
            var parsed = JSON.parse(text);
            console.error('Parsed error:', parsed);
            return { ok: false, body: parsed, status: r.status }; 
          }
          catch { 
            console.error('Failed to parse error response:', text);
            return { ok: false, body: { error: 'HTTP ' + r.status + ': ' + text.substring(0, 100) }, status: r.status }; 
          }
        });
      }
      return r.json().then(function (j) { 
        console.log('Social login success:', { userId: j.user?.id, nickname: j.user?.nickname });
        return { ok: true, body: j }; 
      });
    }).catch(function(err) {
      console.error('sendSocialLogin fetch error:', err);
      return { ok: false, body: { error: 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + err.message } };
    }).then(function (x) {
      if (!x || !x.ok) {
        var errorMsg = x && x.body && x.body.error ? x.body.error : 'ì†Œì…œ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆì–´ìš”.';
        if (x && x.body && x.body.details) {
          console.error('Server error details:', x.body.details);
        }
        if (x && x.body && x.body.code) {
          console.error('Server error code:', x.body.code);
        }
        showToast(errorMsg);
        return null;
      }
      if (!x.body || !x.body.user || !x.body.token) {
        showToast('ì„œë²„ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”.');
        return null;
      }
      setAuthToken(x.body.token);
      userProfile = x.body.user;
      isLoggedIn = true;
      
      // userProfileì´ ì œëŒ€ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
      if (!userProfile || !userProfile.nickname) {
        console.error('userProfile is invalid:', userProfile);
        showToast('ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´ìš”.');
        return null;
      }
      
      return fetch(API_BASE + '/api/user/data', { headers: { 'Authorization': 'Bearer ' + x.body.token } });
    }).then(function (r) {
      if (!r) {
        // ë¡œê·¸ì¸ì€ ì„±ê³µí–ˆì§€ë§Œ ë°ì´í„° ë¡œë“œëŠ” ìŠ¤í‚µ
        if (userProfile && userProfile.nickname) {
          saveAll();
          closeAuthModal();
          renderHeaderAuth();
          renderAuthGate();
          renderPet();
          renderAttendance();
          var card = document.getElementById('attendanceCard');
          if (card) card.style.display = 'block';
          showToast(userProfile.nickname + 'ë‹˜ í™˜ì˜í•´ìš”!');
        }
        return null;
      }
      if (!r.ok) {
        // ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨í•´ë„ ë¡œê·¸ì¸ì€ ì„±ê³µ
        console.warn('Failed to load user data:', r.status);
        if (userProfile && userProfile.nickname) {
          saveAll();
          closeAuthModal();
          renderHeaderAuth();
          renderAuthGate();
          renderPet();
          renderAttendance();
          var card = document.getElementById('attendanceCard');
          if (card) card.style.display = 'block';
          showToast(userProfile.nickname + 'ë‹˜ í™˜ì˜í•´ìš”! (ë°ì´í„°ëŠ” ìƒˆë¡œ ì‹œì‘í•©ë‹ˆë‹¤)');
        }
        return null;
      }
      return r.json();
    }).then(function (body) {
      if (!body) return;
      if (body && body.data) {
        try {
          var data = typeof body.data === 'string' ? JSON.parse(body.data) : body.data;
          applyGameState(data);
        } catch (e) {
          console.error('Failed to apply game state:', e);
        }
      }
      saveAll();
      closeAuthModal();
      renderHeaderAuth();
      renderAuthGate();
      renderPet();
      renderAttendance();
      var card = document.getElementById('attendanceCard');
      if (card) card.style.display = 'block';
      if (userProfile && userProfile.nickname) {
        showToast(userProfile.nickname + 'ë‹˜ í™˜ì˜í•´ìš”!');
      } else {
        showToast('ë¡œê·¸ì¸ ì„±ê³µ!');
      }
    }).catch(function (err) {
      console.error('Social login error:', err);
      // ë¡œê·¸ì¸ì€ ì„±ê³µí–ˆì§€ë§Œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨
      if (userProfile && userProfile.nickname) {
        saveAll();
        closeAuthModal();
        renderHeaderAuth();
        renderAuthGate();
        renderPet();
        renderAttendance();
        var card = document.getElementById('attendanceCard');
        if (card) card.style.display = 'block';
        showToast(userProfile.nickname + 'ë‹˜ í™˜ì˜í•´ìš”! (ë°ì´í„° ë¡œë“œ ì¤‘ ì¼ë¶€ ì˜¤ë¥˜ ë°œìƒ)');
      } else {
        showToast('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´ìš”: ' + (err.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    });
  }
  function switchAuthTab(tab) {
    document.getElementById('authLoginPanel').style.display = tab === 'login' ? 'block' : 'none';
    document.getElementById('authSignupPanel').style.display = tab === 'signup' ? 'block' : 'none';
    document.getElementById('authFindIdPanel').style.display = tab === 'findId' ? 'block' : 'none';
    document.getElementById('authFindPwPanel').style.display = tab === 'findPw' ? 'block' : 'none';
    document.querySelectorAll('.auth-tab').forEach(function(t){ 
      t.classList.remove('active'); 
      if (t.getAttribute('data-auth-tab') === tab) t.classList.add('active'); 
    });
    document.getElementById('authTitle').textContent = 
      tab === 'login' ? 'ë¡œê·¸ì¸' : 
      tab === 'signup' ? 'íšŒì›ê°€ì…' : 
      tab === 'findId' ? 'ì•„ì´ë”” ì°¾ê¸°' : 
      tab === 'findPw' ? 'ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°' : 'ë¡œê·¸ì¸';
  }
  function doLogout() {
    // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì¸ ê²½ìš° ì¹´ì¹´ì˜¤ ë¡œê·¸ì•„ì›ƒë„ ì²˜ë¦¬
    if (typeof Kakao !== 'undefined' && Kakao.Auth.getAccessToken()) {
      Kakao.Auth.logout(function() {
        console.log('ì¹´ì¹´ì˜¤ ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
      });
    }
    clearAuthToken();
    userProfile = null;
    isLoggedIn = false;
    saveAll();
    renderHeaderAuth();
    renderAuthGate();
    renderAttendance();
    var card = document.getElementById('attendanceCard');
    if (card) card.style.display = 'none';
    showToast('ë¡œê·¸ì•„ì›ƒë˜ì—ˆì–´ìš”.');
  }
  function renderAttendance() {
    var card = document.getElementById('attendanceCard');
    var statusEl = document.getElementById('attendanceStatus');
    var btn = document.getElementById('btnAttendance');
    if (!card || !statusEl) return;
    if (!isLoggedIn) {
      card.style.display = 'none';
      return;
    }
    card.style.display = 'block';
    var today = todayStr();
    var already = lastAttendanceDate === today;
    if (already) {
      statusEl.textContent = 'ì˜¤ëŠ˜ ì¶œì„ ì™„ë£Œ! ì—°ì† ' + attendanceStreak + 'ì¼';
      if (btn) btn.style.display = 'none';
    } else {
      var nextDay = attendanceStreak + 1;
      if (nextDay <= 7) {
        statusEl.textContent = 'ì˜¤ëŠ˜ ì¶œì„í•˜ë©´ ' + (nextDay === 7 ? ATTENDANCE_7DAY_BOX_NAME : nextDay + 'ì¼ì°¨ ë³´ìƒ') + ' ë°›ê¸°';
        if (btn) { btn.style.display = 'block'; btn.textContent = nextDay === 7 ? 'ì¶œì„í•˜ê³  ì„ ë¬¼ìƒì ë°›ê¸°' : 'ì¶œì„ ì²´í¬'; }
      } else {
        statusEl.textContent = 'ì—°ì† ' + attendanceStreak + 'ì¼ ë‹¬ì„±! ë‚´ì¼ ë‹¤ì‹œ 1ì¼ì°¨ë¶€í„° ì‹œì‘í•´ìš”.';
        if (btn) btn.style.display = 'none';
      }
    }
  }
  function doAttendance() {
    if (!isLoggedIn) { showToast('ë¡œê·¸ì¸ í›„ ì¶œì„í•  ìˆ˜ ìˆì–´ìš”.'); return; }
    var today = todayStr();
    if (lastAttendanceDate === today) { showToast('ì˜¤ëŠ˜ì€ ì´ë¯¸ ì¶œì„í–ˆì–´ìš”.'); return; }
    var yesterday = (function(){
      var d = new Date(); d.setDate(d.getDate() - 1);
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    })();
    if (lastAttendanceDate !== yesterday && lastAttendanceDate !== '') attendanceStreak = 0;
    attendanceStreak++;
    lastAttendanceDate = today;
    if (attendanceStreak <= 6) {
      var reward = ATTENDANCE_DAILY_GOLD[attendanceStreak - 1] || 10;
      gold += reward;
      saveAll();
      renderGold();
      renderAttendance();
      showToast('ì¶œì„ ' + attendanceStreak + 'ì¼ì°¨! +' + reward + ' G');
    } else {
      attendanceStreak = 7;
      saveAll();
      openWeekMasterBox();
    }
  }
  function openWeekMasterBox() {
    if (Math.random() < 0.5) {
      gold += ATTENDANCE_7DAY_GOLD;
      saveAll();
      renderGold();
      renderAttendance();
      showToast(ATTENDANCE_7DAY_BOX_NAME + 'ì—ì„œ ' + ATTENDANCE_7DAY_GOLD + ' G íšë“!');
    } else {
      var item = pickItemByTierWeight(true);
      var rarity = rollRarityPremium();
      var newItem = { id: item.id + '_' + Date.now(), name: item.name, type: item.type, emoji: item.emoji, rarity: rarity, enhance: 0, tier: item.tier || 'standard' };
      inventory.push(newItem);
      saveAll();
      renderInventory();
      renderAttendance();
      var tierLabel = TIER_LABELS[newItem.tier] || newItem.tier;
      var rarityLabel = (RARITY_NAMES.indexOf(rarity) >= 0 ? rarity : 'common');
      showToast(getItemIcon(newItem) + ' ' + newItem.name + ' (' + tierLabel + ' Â· ' + rarityLabel + ') íšë“!');
    }
    attendanceStreak = 0;
    saveAll();
    renderAttendance();
    showToast('ê³µìœ  ê°ì‚¬í•´ìš”! +40 G');
  }

  function renderPet() {
    var petEmoji = document.getElementById('petEmoji');
    var petName = document.getElementById('petName');
    var petLevel = document.getElementById('petLevel');
    var petExpFill = document.getElementById('petExpFill');
    var petExpText = document.getElementById('petExpText');
    
    if (!pet.type) {
      if (petEmoji) petEmoji.textContent = 'ğŸ¾';
      if (petName) petName.textContent = 'ë™ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
      if (petLevel) petLevel.textContent = '';
      if (petExpFill) petExpFill.style.width = '0%';
      if (petExpText) petExpText.textContent = '';
      return;
    }
    
    var petType = PET_TYPES.find(function(p) { return p.id === pet.type; });
    if (!petType) return;
    
    var expForNextLevel = pet.level * 100; // ë ˆë²¨ë‹¹ 100 ê²½í—˜ì¹˜ í•„ìš”
    var expPercent = (pet.exp / expForNextLevel) * 100;
    
    if (petEmoji) petEmoji.textContent = petType.emoji;
    if (petName) petName.textContent = pet.name || petType.name;
    if (petLevel) petLevel.textContent = 'Lv.' + pet.level;
    if (petExpFill) petExpFill.style.width = Math.min(expPercent, 100) + '%';
    if (petExpText) petExpText.textContent = 'ê²½í—˜ì¹˜: ' + pet.exp + ' / ' + expForNextLevel;
  }
  
  function addPetExp(amount) {
    if (!pet.type) return;
    pet.exp += amount;
    var expForNextLevel = pet.level * 100;
    while (pet.exp >= expForNextLevel) {
      pet.exp -= expForNextLevel;
      pet.level++;
      showToast('ğŸ‰ ' + (PET_TYPES.find(function(p) { return p.id === pet.type; }) || {}).name + 'ì´(ê°€) ë ˆë²¨ì—…í–ˆì–´ìš”! Lv.' + pet.level);
      expForNextLevel = pet.level * 100;
    }
    saveAll();
    renderPet();
  }
  
  function renderAvatar() {
    var nameEl = document.getElementById('avatarName');
    var inputEl = document.getElementById('inputAvatarName');
    if (nameEl) nameEl.textContent = avatar.name || 'ì‚°ì±…ëŸ¬';
    if (inputEl) inputEl.value = avatar.name || '';
    var skin = avatar.skin || '#f5d0b0';
    var human = document.getElementById('avatarHuman');
    if (human) {
      human.style.setProperty('--skin', skin);
      var topItem = equipped.top ? inventory.find(function(i){ return i.id === equipped.top; }) : null;
      var bottomItem = equipped.bottom ? inventory.find(function(i){ return i.id === equipped.bottom; }) : null;
      human.style.setProperty('--top-color', topItem ? '#4a6fa5' : '#6b7280');
      human.style.setProperty('--bottom-color', bottomItem ? '#374151' : '#4b5563');
    }
    var headEl = document.getElementById('previewHead');
    var bodyEl = document.getElementById('previewBody');
    var armL = document.getElementById('previewArmL');
    var armR = document.getElementById('previewArmR');
    var legL = document.getElementById('previewLegL');
    var legR = document.getElementById('previewLegR');
    if (headEl) headEl.style.background = skin;
    if (bodyEl) bodyEl.style.background = (equipped.top ? inventory.find(function(i){ return i.id === equipped.top; }) : null) ? '#4a6fa5' : '#6b7280';
    if (armL) armL.style.background = skin;
    if (armR) armR.style.background = skin;
    if (legL) legL.style.background = (equipped.bottom ? inventory.find(function(i){ return i.id === equipped.bottom; }) : null) ? '#374151' : '#4b5563';
    if (legR) legR.style.background = (equipped.bottom ? inventory.find(function(i){ return i.id === equipped.bottom; }) : null) ? '#374151' : '#4b5563';
    var hatEl = document.getElementById('previewHat');
    var weaponEl = document.getElementById('previewWeapon');
    if (hatEl) { hatEl.textContent = ''; hatEl.style.display = 'none'; }
    var accSlot = equipped.watch || equipped.earphones || equipped.bag || equipped.glove;
    var accItem = accSlot ? inventory.find(function(i){ return i.id === accSlot; }) : null;
    if (weaponEl) { weaponEl.textContent = accItem ? getItemIcon(accItem) : ''; weaponEl.style.display = accItem ? 'block' : 'none'; }
    var selectHair = document.getElementById('selectHair');
    if (selectHair) selectHair.value = avatar.hair || 'short';
  }

  var routesMapPathEl = null;
  function initRoutesMap() {
    var el = document.getElementById('routesMap');
    if (!el) return;
    if (routesMapPathEl) return;
    el.innerHTML = '';
    var w = 400, h = 180;
    var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('viewBox', '0 0 ' + w + ' ' + h);
    svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
    var grid = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    grid.setAttribute('class', 'our-map-grid');
    for (var i = 0; i <= 8; i++) {
      var v = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      v.setAttribute('x1', (i * w / 8));
      v.setAttribute('y1', 0);
      v.setAttribute('x2', (i * w / 8));
      v.setAttribute('y2', h);
      grid.appendChild(v);
      var hor = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      hor.setAttribute('x1', 0);
      hor.setAttribute('y1', (i * h / 8));
      hor.setAttribute('x2', w);
      hor.setAttribute('y2', (i * h / 8));
      grid.appendChild(hor);
    }
    svg.appendChild(grid);
    var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('class', 'our-map-path');
    path.setAttribute('d', '');
    svg.appendChild(path);
    el.appendChild(svg);
    var label = document.createElement('span');
    label.className = 'our-map-label';
    label.textContent = 'ì™„ì£¼í•œ ê²½ë¡œ';
    el.appendChild(label);
    routesMapPathEl = path;
  }
  function updateRoutesMap(routeId) {
    if (!routesMapPathEl) return;
    var r = routeId ? userRoutes.find(function(x){ return x.id === routeId; }) : null;
    var coords = (r && r.path && r.path.length) ? r.path : [];
    var w = 400, h = 180;
    if (coords.length === 0) {
      routesMapPathEl.setAttribute('d', '');
      return;
    }
    var bounds = ourMapBounds(coords);
    var pts = coords.map(function(c) { return ourMapLatLonToXY(c.lat, c.lon, bounds, w, h); });
    var d = 'M ' + pts[0].x + ' ' + pts[0].y;
    for (var i = 1; i < pts.length; i++) d += ' L ' + pts[i].x + ' ' + pts[i].y;
    routesMapPathEl.setAttribute('d', d);
  }
  function renderRoutes() {
    initRoutesMap();
    var list = document.getElementById('routeList');
    if (!list) return;
    list.innerHTML = '';
    if (userRoutes.length === 0) {
      list.innerHTML = '<p class="story-text" style="color:var(--text-muted);font-size:0.9rem;">ì•„ì§ ë§Œë“  ì½”ìŠ¤ê°€ ì—†ì–´ìš”.<br>ì‚°ì±… íƒ­ì—ì„œ ìƒˆ ì½”ìŠ¤ë¥¼ ë§Œë“¤ì–´ ë³´ì„¸ìš”!</p>';
      return;
    }
    userRoutes.forEach(function (r) {
      var card = document.createElement('div');
      card.className = 'route-card' + (r.completedAt ? '' : '');
      card.setAttribute('data-route-id', r.id);
      var status = r.completedAt ? 'done' : 'claim';
      var statusText = r.completedAt ? 'ì™„ì£¼' : r.goalKm + ' km';
      card.innerHTML =
        '<div class="route-icon">' + (r.completedAt ? 'âœ…' : 'ğŸ—ºï¸') + '</div>' +
        '<div class="route-info">' +
          '<div class="route-name">' + r.name + '</div>' +
          '<div class="route-steps">ëª©í‘œ ' + r.goalKm + ' km' + (r.path && r.path.length ? ' Â· ê²½ë¡œ ê¸°ë¡ë¨' : '') + '</div>' +
        '</div>' +
        '<span class="route-status ' + status + '">' + statusText + '</span>';
      card.onclick = function () { updateRoutesMap(r.id); };
      list.appendChild(card);
    });
  }

  function renderEquipped() {
    var wrap = document.getElementById('equippedSlots');
    if (!wrap) return;
    wrap.innerHTML = '';
    SLOT_ORDER.forEach(function (slot) {
      var itemId = equipped[slot];
      var item = itemId ? inventory.find(function (i) { return i.id === itemId; }) : null;
      var slotEl = document.createElement('div');
      slotEl.className = 'equipped-slot' + (item ? ' filled tier-' + (item.tier || 'standard') : '');
      slotEl.setAttribute('data-slot', slot);
      var tierLabel = item ? (TIER_LABELS[item.tier] || 'ìŠ¤íƒ ë‹¤ë“œ') : '';
      var icon = item ? getItemIcon(item) : 'ï¼‹';
      var nameLine = item ? '<span class="slot-item-name" title="' + (item.name || '') + '">' + (item.name || '') + '</span>' : '';
      slotEl.innerHTML = '<span class="slot-label">' + SLOT_LABELS[slot] + '</span>' + icon + nameLine + (item ? '<span class="inv-tier">' + tierLabel + (item.enhance > 0 ? ' +' + item.enhance : '') + '</span>' : '');
      slotEl.onclick = function () { openEquipModal(slot); };
      wrap.appendChild(slotEl);
    });
    var sumEl = document.getElementById('equipBonusSummary');
    if (sumEl) {
      var b = getEquipmentBonus();
      var parts = [];
      if (b.xp > 0) parts.push('XP +' + b.xp + '%');
      if (b.distance > 0) parts.push('ì´ë™ ê±°ë¦¬ +' + b.distance + '%');
      if (b.gold > 0) parts.push('ê³¨ë“œ +' + b.gold + '%');
      sumEl.innerHTML = parts.length ? '<strong>ì¥ë¹„ ë³´ë„ˆìŠ¤</strong>: ' + parts.join(', ') : '<strong>ì¥ë¹„ ë³´ë„ˆìŠ¤</strong>: ì°©ìš© ì¥ë¹„ì— ë”°ë¼ XPÂ·ê±°ë¦¬Â·ê³¨ë“œ ë³´ë„ˆìŠ¤ ì ìš© (ê±¸ìŒ ìˆ˜ëŠ” ì •í™•í•œ ê¸°ë¡ ìœ ì§€ë¥¼ ìœ„í•´ ë³´ë„ˆìŠ¤ ì—†ìŒ)';
    }
  }

  function openEquipModal(slot) {
    var list = inventory.filter(function (i) { return itemSlot(i) === slot; });
    if (list.length === 0) { showToast('í•´ë‹¹ ìŠ¬ë¡¯ì— ì°©ìš©í•  ì¥ë¹„ê°€ ì—†ì–´ìš”'); return; }
    var current = equipped[slot];
    var idx = list.findIndex(function (i) { return i.id === current; });
    idx = (idx + 1) % list.length;
    equipped[slot] = list[idx].id;
    saveAll();
    renderEquipped();
    renderInventory();
    renderAvatar();
    showToast(list[idx].name + ' ì°©ìš©');
  }

  function renderInventory() {
    var wrap = document.getElementById('inventoryBySlot');
    if (!wrap) return;
    wrap.innerHTML = '';
    var kits = inventory.filter(function(i){ return i.type === 'supply_kit'; });
    if (kits.length > 0) {
      var kitSec = document.createElement('div');
      kitSec.className = 'inventory-slot-section';
      kitSec.innerHTML = '<h4>ğŸ“¦ ë³´ê¸‰ í‚¤íŠ¸</h4>';
      var kitList = document.createElement('div');
      kitList.className = 'inventory-slot-list';
      kits.forEach(function() {
        var div = document.createElement('div');
        div.className = 'inv-item inv-item-kit';
        div.innerHTML = '<span>ğŸ“¦</span><span class="inv-name">íŠ¸ë ˆì´ë‹ ë³´ê¸‰ í‚¤íŠ¸</span><span class="inv-open">ì—´ê¸°</span>';
        div.onclick = function () { openSupplyKit(); };
        kitList.appendChild(div);
      });
      kitSec.appendChild(kitList);
      wrap.appendChild(kitSec);
    }
    SLOT_ORDER.forEach(function (slot) {
      var list = inventory.filter(function (i) { return i.type !== 'supply_kit' && itemSlot(i) === slot; });
      if (list.length === 0) return;
      var sec = document.createElement('div');
      sec.className = 'inventory-slot-section';
      sec.innerHTML = '<h4>' + SLOT_LABELS[slot] + '</h4>';
      var listEl = document.createElement('div');
      listEl.className = 'inventory-slot-list';
      list.forEach(function (item) {
        var isEquipped = equipped[slot] === item.id;
        var rarity = item.rarity || 'common';
        var tier = item.tier || 'standard';
        var tierLabel = TIER_LABELS[tier] || 'ìŠ¤íƒ ë‹¤ë“œ';
        var div = document.createElement('div');
        div.className = 'inv-item rarity-' + rarity + ' tier-' + tier + (isEquipped ? ' equipped' : '');
        var enh = (item.enhance != null && item.enhance > 0) ? item.enhance : 0;
        var enhHtml = enh > 0 ? '<span class="inv-enhance">+' + enh + '</span>' : '';
        div.innerHTML = '<span class="rarity-dot"></span><span>' + getItemIcon(item) + '</span><span class="inv-name">' + (item.name || item.id) + '</span>' + enhHtml + '<span class="inv-tier">' + tierLabel + '</span>';
        div.onclick = function () {
          equipped[slot] = equipped[slot] === item.id ? null : item.id;
          saveAll();
          renderEquipped();
          renderInventory();
          renderAvatar();
        };
        listEl.appendChild(div);
      });
      sec.appendChild(listEl);
      wrap.appendChild(sec);
    });
  }

  function getStoryContent() {
    var completedCourses = userRoutes.filter(function(r){ return r.completedAt; });
    var lines = [];
    if (lifetimeSteps < 500 && totalXp < 10) {
      lines.push('ì•„ì§ ì‚°ì±…ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ì–´ìš”.');
      lines.push('ì‚°ì±… íƒ­ì—ì„œ ì½”ìŠ¤ë¥¼ ë§Œë“¤ê³  ê±¸ì–´ ë³´ì„¸ìš”.');
    } else {
      lines.push('ë‹¹ì‹ ì€ ê±¸ìŒì„ ê±¸ìœ¼ë©° ì„¸ìƒì„ íƒí—˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.');
      if (completedCourses.length > 0) {
        var lastCourse = completedCourses[completedCourses.length - 1];
        lines.push('ìµœê·¼ì— ' + lastCourse.name + ' ì½”ìŠ¤ë¥¼ ì™„ì£¼í–ˆì–´ìš”.');
      }
      if (totalXp > 0) lines.push('íŠ¸ë ˆì´ë‹ ë³´ê¸‰ í‚¤íŠ¸ë¡œ ì¥ë¹„ë¥¼ ëª¨ìœ¼ë©° ì„±ì¥í•˜ê³  ìˆì–´ìš”. (ì´ XP ' + totalXp + ')');
      if (lifetimeSteps >= 10000) lines.push('ë“±ì‚°ë¡œ ì •ìƒê¹Œì§€ ì˜¤ë¥¸ ë‹¹ì‹ ì€ ì´ì œ ì§„ì •í•œ ì‚°ì±…ì˜ ë‹¬ì¸ì…ë‹ˆë‹¤.');
      else if (lifetimeSteps >= 5000) lines.push('ìˆ²ê³¼ í˜¸ìˆ˜ë¥¼ ì§€ë‚˜ ë” ë†’ì€ ê³³ì„ ë°”ë¼ë³´ê³  ìˆì–´ìš”.');
      else if (lifetimeSteps >= 2000) lines.push('ì‹œë‚´ë¥¼ ë²—ì–´ë‚˜ ê°•ê³¼ ê³µì›ì„ íƒí—˜í•˜ê³  ìˆì–´ìš”.');
    }
    var coursesDone = userRoutes.filter(function(r){ return r.completedAt; }).length;
    return { text: lines.join('\n\n'), milestone: 'ëˆ„ì  ' + lifetimeSteps.toLocaleString() + 'ê±¸ìŒ Â· Lv.' + xpToLevel(totalXp).level + ' Â· ì™„ì£¼ ì½”ìŠ¤ ' + coursesDone + 'ê°œ' };
  }

  function renderStory() {
    var s = getStoryContent();
    var st = document.getElementById('storyText');
    var sm = document.getElementById('storyMilestone');
    if (st) st.textContent = s.text;
    if (sm) sm.textContent = s.milestone;
  }
  
  function openPetSelectModal() {
    var overlay = document.getElementById('petSelectOverlay');
    var grid = document.getElementById('petGrid');
    if (!overlay || !grid) return;
    
    grid.innerHTML = '';
    var selectedPetId = pet.type;
    
    PET_TYPES.forEach(function(petType) {
      var item = document.createElement('div');
      item.className = 'pet-item' + (selectedPetId === petType.id ? ' selected' : '');
      item.setAttribute('data-pet-id', petType.id);
      item.innerHTML = '<div class="pet-item-emoji">' + petType.emoji + '</div><div class="pet-item-name">' + petType.name + '</div><div class="pet-item-desc">' + petType.description + '</div>';
      item.onclick = function() {
        document.querySelectorAll('.pet-item').forEach(function(el) { el.classList.remove('selected'); });
        item.classList.add('selected');
        selectedPetId = petType.id;
      };
      grid.appendChild(item);
    });
    
    overlay.style.display = 'flex';
  }
  
  function closePetSelectModal() {
    var overlay = document.getElementById('petSelectOverlay');
    if (overlay) overlay.style.display = 'none';
  }
  
  function confirmPetSelection() {
    var selectedItem = document.querySelector('.pet-item.selected');
    if (!selectedItem) {
      showToast('ë™ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    
    var petTypeId = selectedItem.getAttribute('data-pet-id');
    if (!petTypeId) return;
    
    var petType = PET_TYPES.find(function(p) { return p.id === petTypeId; });
    if (!petType) return;
    
    pet.type = petTypeId;
    pet.name = petType.name;
    if (!pet.level) pet.level = 1;
    if (pet.exp == null) pet.exp = 0;
    
    saveAll();
    renderPet();
    closePetSelectModal();
    showToast(petType.name + 'ì„(ë¥¼) ì„ íƒí–ˆì–´ìš”! í•¨ê»˜ ê±¸ì–´ ì„±ì¥í•´ë´ìš”! ğŸ¾');
  }

  function attachListeners() {
    document.querySelectorAll('.tab-btn').forEach(function (btn) {
      btn.addEventListener('click', function () { switchTab(btn.getAttribute('data-tab')); });
    });
    var btnAdd = document.getElementById('btnAdd');
    var btnReset = document.getElementById('btnReset');
    if (btnAdd) btnAdd.addEventListener('click', addStep);
    if (btnReset) btnReset.addEventListener('click', function () {
      if (confirm('ì˜¤ëŠ˜ì˜ ê±¸ìŒ ìˆ˜ë§Œ 0ìœ¼ë¡œ ì´ˆê¸°í™”í• ê¹Œìš”? (ëˆ„ì  ê±¸ìŒê³¼ ì¥ë¹„ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)')) {
        steps = 0;
        saveAll();
        renderSteps();
      }
    });
    var inputName = document.getElementById('inputAvatarName');
    if (inputName) {
      inputName.addEventListener('input', function () {
        avatar.name = this.value.trim() || 'ì‚°ì±…ëŸ¬';
        var an = document.getElementById('avatarName');
        if (an) an.textContent = avatar.name;
        saveAll();
      });
      inputName.addEventListener('blur', saveAll);
    }
    document.querySelectorAll('.color-swatch[data-skin]').forEach(function (sw) {
      sw.addEventListener('click', function () {
        document.querySelectorAll('.color-swatch[data-skin]').forEach(function (s) { s.classList.remove('active'); });
        sw.classList.add('active');
        avatar.skin = sw.getAttribute('data-skin');
        var b = document.getElementById('previewBody'), h = document.getElementById('previewHead');
        if (b) b.style.background = avatar.skin;
        if (h) h.style.background = avatar.skin;
        saveAll();
      });
    });
    document.querySelectorAll('.color-swatch.hair-color').forEach(function (sw) {
      sw.addEventListener('click', function () {
        document.querySelectorAll('.color-swatch.hair-color').forEach(function (s) { s.classList.remove('active'); });
        sw.classList.add('active');
        avatar.hairColor = sw.getAttribute('data-hair');
        var hair = document.getElementById('previewHair');
        if (hair) hair.style.background = avatar.hairColor;
        saveAll();
      });
    });
    var selectHair = document.getElementById('selectHair');
    if (selectHair) selectHair.addEventListener('change', function () {
      avatar.hair = this.value;
      renderAvatar();
      saveAll();
    });
    var btnWalkStart = document.getElementById('btnWalkStart');
    var btnWalkStop = document.getElementById('btnWalkStop');
    if (btnWalkStart) btnWalkStart.addEventListener('click', startWalk);
    if (btnWalkStop) btnWalkStop.addEventListener('click', stopWalk);
    var courseInput = document.getElementById('courseGoalKm');
    var routeCreateCard = document.getElementById('routeCreateCard');
    var btnAddRoute = document.getElementById('btnAddRoute');
    var btnSaveRoute = document.getElementById('btnSaveRoute');
    if (btnAddRoute) btnAddRoute.addEventListener('click', function () { routeCreateCard.style.display = routeCreateCard.style.display === 'none' ? 'block' : 'none'; });
    if (btnSaveRoute) btnSaveRoute.addEventListener('click', addNewRoute);
    var themeToggle = document.getElementById('themeToggle');
    if (themeToggle) themeToggle.addEventListener('click', function () {
      var next = document.body.getAttribute('data-theme') === 'night' ? 'morning' : 'night';
      document.body.setAttribute('data-theme', next);
      localStorage.setItem(STORAGE_KEYS.theme, next);
      themeToggle.textContent = next === 'night' ? 'ğŸŒ™' : 'â˜€ï¸';
    });
    if (document.body.getAttribute('data-theme') === 'morning') themeToggle.textContent = 'â˜€ï¸';
    var btnGacha = document.getElementById('btnGacha');
    if (btnGacha) btnGacha.addEventListener('click', function() { doGachaPull(false); });
    var btnGachaPremium = document.getElementById('btnGachaPremium');
    if (btnGachaPremium) btnGachaPremium.addEventListener('click', function() { doGachaPull(true); });
    var btnShare = document.getElementById('btnShare');
    if (btnShare) btnShare.addEventListener('click', doShare);
    var btnEnhance = document.getElementById('btnEnhance');
    if (btnEnhance) btnEnhance.addEventListener('click', tryEnhance);
    var btnHeaderAuth = document.getElementById('btnHeaderAuth');
    if (btnHeaderAuth) btnHeaderAuth.addEventListener('click', function() {
      if (isLoggedIn) {
        // ë¡œê·¸ì¸ ìƒíƒœì¼ ë•ŒëŠ” í”„ë¡œí•„ í‘œì‹œ (ë˜ëŠ” ì•„ë¬´ ë™ì‘ ì•ˆ í•¨)
        // ë¡œê·¸ì•„ì›ƒì€ ë³„ë„ ë²„íŠ¼ìœ¼ë¡œ ì²˜ë¦¬
      } else {
        openAuthModal();
      }
    });
    var btnLogout = document.getElementById('btnLogout');
    if (btnLogout) btnLogout.addEventListener('click', function() {
      if (confirm('ë¡œê·¸ì•„ì›ƒí• ê¹Œìš”?')) {
        doLogout();
      }
    });
    document.querySelectorAll('.auth-tab').forEach(function(t) {
      t.addEventListener('click', function() {
        var tab = this.getAttribute('data-auth-tab');
        switchAuthTab(tab);
      });
    });
    var authClose = document.getElementById('authClose');
    if (authClose) authClose.addEventListener('click', closeAuthModal);
    var authOverlay = document.getElementById('authOverlay');
    if (authOverlay) authOverlay.addEventListener('click', function(e) { if (e.target === authOverlay && !authOverlay.classList.contains('auth-gate')) closeAuthModal(); });
    var btnAuthLogin = document.getElementById('btnAuthLogin');
    if (btnAuthLogin) btnAuthLogin.addEventListener('click', doLogin);
    var btnAuthSignup = document.getElementById('btnAuthSignup');
    if (btnAuthSignup) btnAuthSignup.addEventListener('click', doSignup);
    var btnFindId = document.getElementById('btnFindId');
    if (btnFindId) btnFindId.addEventListener('click', function() { switchAuthTab('findId'); });
    var btnFindPw = document.getElementById('btnFindPw');
    if (btnFindPw) btnFindPw.addEventListener('click', function() { switchAuthTab('findPw'); });
    var btnFindIdSubmit = document.getElementById('btnFindIdSubmit');
    if (btnFindIdSubmit) btnFindIdSubmit.addEventListener('click', doFindId);
    var btnFindPwSubmit = document.getElementById('btnFindPwSubmit');
    if (btnFindPwSubmit) btnFindPwSubmit.addEventListener('click', doFindPw);
    var btnResetPwSubmit = document.getElementById('btnResetPwSubmit');
    if (btnResetPwSubmit) btnResetPwSubmit.addEventListener('click', doResetPw);
    var btnBackToLogin = document.getElementById('btnBackToLogin');
    if (btnBackToLogin) btnBackToLogin.addEventListener('click', function() { switchAuthTab('login'); });
    var btnBackToLogin2 = document.getElementById('btnBackToLogin2');
    if (btnBackToLogin2) btnBackToLogin2.addEventListener('click', function() { switchAuthTab('login'); });
    var btnKakaoLogin = document.getElementById('btnKakaoLogin');
    if (btnKakaoLogin) btnKakaoLogin.addEventListener('click', function() { doSocialLogin('kakao'); });
    var btnKakaoSignup = document.getElementById('btnKakaoSignup');
    if (btnKakaoSignup) btnKakaoSignup.addEventListener('click', function() { doSocialLogin('kakao'); });
    var btnGoogleLogin = document.getElementById('btnGoogleLogin');
    if (btnGoogleLogin) btnGoogleLogin.addEventListener('click', function() { doSocialLogin('google'); });
    var btnGoogleSignup = document.getElementById('btnGoogleSignup');
    if (btnGoogleSignup) btnGoogleSignup.addEventListener('click', function() { doSocialLogin('google'); });
    var btnSelectPet = document.getElementById('btnSelectPet');
    if (btnSelectPet) btnSelectPet.addEventListener('click', openPetSelectModal);
    var btnConfirmPet = document.getElementById('btnConfirmPet');
    if (btnConfirmPet) btnConfirmPet.addEventListener('click', confirmPetSelection);
    var petSelectClose = document.getElementById('petSelectClose');
    if (petSelectClose) petSelectClose.addEventListener('click', closePetSelectModal);
    var petSelectOverlay = document.getElementById('petSelectOverlay');
    if (petSelectOverlay) petSelectOverlay.addEventListener('click', function(e) {
      if (e.target === petSelectOverlay) closePetSelectModal();
    });
    var btnAttendance = document.getElementById('btnAttendance');
    if (btnAttendance) btnAttendance.addEventListener('click', doAttendance);
  }

  var lastAcc = 0, lastPeakTime = 0;
  function onMotion(e) {
    var acc = e.accelerationIncludingGravity;
    if (acc.x == null || acc.y == null || acc.z == null) return;
    var magnitude = Math.sqrt(acc.x * acc.x + acc.y * acc.y + acc.z * acc.z);
    var now = Date.now();
    if (magnitude > 12 && (now - lastPeakTime) > 400 && lastAcc > 0 && lastAcc < magnitude) {
      lastPeakTime = now;
      addStep();
    }
    lastAcc = magnitude;
  }
  function initSensorAndStatus() {
    var statusEl = document.getElementById('status');
    if (!statusEl) return;
    if (typeof DeviceMotionEvent !== 'undefined') {
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        statusEl.textContent = 'iOS: í™”ë©´ì„ í•œ ë²ˆ íƒ­í•˜ë©´ ì„¼ì„œë¥¼ ì¼¤ ìˆ˜ ìˆì–´ìš”. ë²„íŠ¼ìœ¼ë¡œë„ ê±¸ìŒì„ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”.';
        document.body.addEventListener('click', function req() {
          DeviceMotionEvent.requestPermission()
            .then(function (p) {
              if (p === 'granted') {
                window.addEventListener('devicemotion', onMotion);
                statusEl.textContent = 'ê±¸ìŒ ê°ì§€ ì¼œì§';
                statusEl.classList.add('sensor-ok');
              }
            }, function () { statusEl.textContent = 'ì„¼ì„œ ì‚¬ìš© ë¶ˆê°€. ë²„íŠ¼ìœ¼ë¡œ ê±¸ìŒì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.'; });
        }, { once: true });
      } else {
        window.addEventListener('devicemotion', onMotion);
        statusEl.textContent = 'ê±¸ìŒ ê°ì§€ ì¼œì§ (ë²„íŠ¼ìœ¼ë¡œë„ ì¶”ê°€ ê°€ëŠ¥)';
        statusEl.classList.add('sensor-ok');
      }
    } else {
      statusEl.textContent = 'ë²„íŠ¼ì„ ëˆŒëŸ¬ ê±¸ìŒì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.';
    }
  }

  function init() {
    attachListeners();
    loadAll();
    initAuth().then(function () {
      checkRouteRewards();
      renderSteps();
      renderWalk();
      renderAvatar();
      renderPet();
      renderRoutes();
      renderStorage();
      renderQuests();
      renderHeaderAuth();
      renderAttendance();
      renderEquipped();
      renderInventory();
      renderStory();
      renderLevel();
      renderRouteSelect();
      renderAchievements();
      renderGold();
      renderEnhanceSelect();
      var themeToggle = document.getElementById('themeToggle');
      if (themeToggle && document.body.getAttribute('data-theme') === 'morning') themeToggle.textContent = 'â˜€ï¸';
      initSensorAndStatus();
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();

  if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(function () {});
  </script>
</body>
</html>
