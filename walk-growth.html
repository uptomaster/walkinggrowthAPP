<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#00d4aa">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="WalkStory">
  <title>WalkStory · 걸음으로 키우는 나만의 동물 친구</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="./walkstory-logo.png">
  <link rel="apple-touch-icon" href="./walkstory-logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;600;700&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
  <script>
    // Capacitor 감지 (모바일 앱 환경 확인)
    // 더 강력한 감지 로직: 여러 방법으로 확인
    window.isCapacitorApp = typeof window !== 'undefined' && (
      window.Capacitor !== undefined ||
      window.capacitor !== undefined ||
      (window.location && (
        window.location.protocol === 'capacitor:' ||
        window.location.protocol === 'http:' && window.location.hostname === 'localhost' && navigator.userAgent.includes('Android')
      )) ||
      (navigator.userAgent && (
        navigator.userAgent.includes('Capacitor') ||
        (navigator.userAgent.includes('Android') && window.location && window.location.hostname === 'localhost')
      ))
    );
    
    // 디버깅용 로그
    if (typeof window !== 'undefined') {
      console.log('Capacitor detection:', {
        Capacitor: window.Capacitor !== undefined,
        capacitor: window.capacitor !== undefined,
        protocol: window.location ? window.location.protocol : 'N/A',
        hostname: window.location ? window.location.hostname : 'N/A',
        userAgent: navigator.userAgent,
        isCapacitorApp: window.isCapacitorApp
      });
    }
    
    // 카카오 SDK 초기화
    if (typeof window !== 'undefined' && window.APP_CONFIG && window.APP_CONFIG.kakao) {
      Kakao.init(window.APP_CONFIG.kakao.javascriptKey);
    }
  </script>
  <style>
    /* 나이트 (기본) - 부드러운 다크 그린 톤 */
    :root, [data-theme="night"] {
      --bg: #0f1419;
      --bg-soft: #151c23;
      --card: #1a222c;
      --card-hover: #1f2935;
      --accent: #4ade80;
      --accent-dim: rgba(74, 222, 128, 0.16);
      --accent-glow: rgba(74, 222, 128, 0.28);
      --gold: #fcd34d;
      --gold-dim: rgba(252, 211, 77, 0.18);
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --goal: 10000;
      --radius: 1rem;
      --radius-lg: 1.25rem;
      --shadow: 0 4px 20px rgba(0,0,0,0.3);
      --shadow-glow: 0 0 28px var(--accent-glow);
      --rarity-common: #94a3b8;
      --rarity-rare: #60a5fa;
      --rarity-epic: #a78bfa;
      --rarity-legend: #fcd34d;
    }
    /* 모닝 - 따뜻한 아침 톤 */
    [data-theme="morning"] {
      --bg: #f0f7f0;
      --bg-soft: #f7fbf7;
      --card: #ffffff;
      --card-hover: #ecf5ec;
      --accent: #16a34a;
      --accent-dim: rgba(22, 163, 74, 0.12);
      --accent-glow: rgba(22, 163, 74, 0.22);
      --gold: #ca8a04;
      --gold-dim: rgba(202, 138, 4, 0.15);
      --text: #14532d;
      --text-muted: #4d7c5c;
      --shadow: 0 2px 16px rgba(0,0,0,0.06);
      --shadow-glow: 0 0 20px var(--accent-glow);
      --rarity-common: #64748b;
      --rarity-rare: #2563eb;
      --rarity-epic: #7c3aed;
      --rarity-legend: #ca8a04;
    }
    [data-theme="morning"] body::before {
      background: radial-gradient(ellipse 85% 60% at 50% -10%, rgba(22,163,74,0.1), transparent 50%);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Outfit', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 0 5.5rem;
      padding-right: max(0, env(safe-area-inset-right, 0));
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 55vh;
      background: radial-gradient(ellipse 90% 70% at 50% -15%, var(--accent-dim), transparent 55%);
      pointer-events: none;
      z-index: 0;
    }

    .container { width: 100%; max-width: 420px; position: relative; z-index: 1; padding-left: 1rem; padding-right: max(1rem, env(safe-area-inset-right, 0)); box-sizing: border-box; }

    header { text-align: center; margin-bottom: 1rem; padding-top: 0.75rem; position: relative; }
    h1 { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.03em; color: var(--text); }
    .subtitle { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.35rem; font-weight: 400; }
    .header-level { display: inline-flex; align-items: center; gap: 0.35rem; margin-top: 0.5rem; padding: 0.35rem 0.75rem; background: var(--card); border-radius: 999px; border: 1px solid rgba(255,255,255,0.08); font-size: 0.8rem; font-weight: 600; color: var(--accent); }
    .header-level .lv-num { font-size: 1rem; }
    .level-bar-wrap { width: 120px; height: 6px; background: var(--bg-soft); border-radius: 999px; overflow: hidden; margin-left: 0.25rem; }
    .level-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #10b981); border-radius: 999px; transition: width 0.3s ease; }
    .header-right { position: absolute; top: 0.75rem; right: 0; display: flex; align-items: center; gap: 0.5rem; }
    .theme-toggle { width: 36px; height: 36px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); background: var(--card); color: var(--text-muted); font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    [data-theme="morning"] .theme-toggle { border-color: rgba(0,0,0,0.1); }
    .gold-display { font-size: 0.85rem; font-weight: 700; color: var(--gold); display: flex; align-items: center; gap: 0.25rem; }
    .header-auth-btn { font-size: 0.7rem; padding: 0.3rem 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: var(--card); color: var(--text-muted); cursor: pointer; font-family: inherit; font-weight: 500; }
    .header-auth-btn:hover { color: var(--accent); border-color: var(--accent); }
    .header-auth-btn.logged-in { border-color: var(--accent); color: var(--accent); }
    .header-logout-btn { font-size: 0.7rem; padding: 0.3rem 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: var(--card); color: var(--text-muted); cursor: pointer; font-family: inherit; font-weight: 500; }
    .header-logout-btn:hover { color: #ef4444; border-color: #ef4444; }
    .auth-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 1rem; transition: opacity 0.3s ease, visibility 0.3s ease; }
    .auth-overlay.fade-out { opacity: 0; visibility: hidden; }
    .auth-modal { background: var(--card); border-radius: var(--radius-lg); padding: 1.5rem; max-width: 320px; width: 100%; border: 1px solid rgba(255,255,255,0.08); box-shadow: var(--shadow); position: relative; transition: transform 0.3s ease, opacity 0.3s ease; }
    .auth-overlay.fade-out .auth-modal { transform: scale(0.95); opacity: 0; }
    .auth-loading { display: none; text-align: center; padding: 2rem; }
    .auth-loading.active { display: block; }
    .auth-loading-spinner { width: 40px; height: 40px; border: 3px solid var(--accent-dim); border-top-color: var(--accent); border-radius: 50%; margin: 0 auto 1rem; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .tutorial-modal { display: flex; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 400; align-items: center; justify-content: center; padding: 1rem; }
    .welcome-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 300; align-items: center; justify-content: center; padding: 1rem; animation: fadeIn 0.25s ease; }
    .welcome-modal.show { display: flex; }
    .welcome-content { background: var(--card); border-radius: var(--radius-lg); padding: 2rem; max-width: 320px; width: 100%; text-align: center; border: 1px solid rgba(255,255,255,0.08); box-shadow: var(--shadow); }
    .welcome-icon { font-size: 4rem; margin-bottom: 1rem; }
    .welcome-title { font-size: 1.25rem; font-weight: 600; color: var(--accent); margin-bottom: 0.5rem; }
    .welcome-message { color: var(--text-muted); margin-bottom: 1.5rem; }
    .btn-welcome-close { background: var(--accent); color: var(--bg); border: none; border-radius: var(--radius); padding: 0.75rem 2rem; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .btn-welcome-close:active { transform: scale(0.95); }
    /* 도감 플로팅 버튼 */
    .codex-fab {
      position: fixed;
      right: 1.2rem;
      bottom: 5.2rem;
      width: 52px;
      height: 52px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--accent), #22c55e);
      color: var(--bg);
      font-size: 1.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.35);
      cursor: pointer;
      z-index: 250;
    }
    .codex-fab:hover { transform: translateY(-1px); box-shadow: 0 14px 30px rgba(0,0,0,0.4); }
    .codex-fab:active { transform: translateY(1px) scale(0.97); box-shadow: 0 6px 15px rgba(0,0,0,0.3); }
    /* 도감 모달 */
    .codex-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 350;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .codex-overlay.show { display: flex; }
    .codex-modal {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 1.25rem 1.25rem 1rem;
      max-width: 380px;
      width: 100%;
      box-shadow: var(--shadow);
      position: relative;
      max-height: calc(100vh - 3rem);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .codex-close {
      position: absolute;
      top: 0.6rem;
      right: 0.7rem;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: none;
      background: var(--bg-soft);
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.9rem;
    }
    .codex-title {
      font-size: 1.05rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.25rem;
    }
    .codex-tabs {
      display: flex;
      gap: 0.35rem;
      margin-bottom: 0.25rem;
    }
    .codex-tab {
      flex: 1;
      padding: 0.45rem 0.6rem;
      border-radius: 999px;
      border: none;
      background: var(--bg-soft);
      color: var(--text-muted);
      font-size: 0.8rem;
      cursor: pointer;
    }
    .codex-tab.active {
      background: var(--accent-dim);
      color: var(--accent);
      font-weight: 600;
    }
    .codex-body {
      flex: 1;
      overflow-y: auto;
      margin-top: 0.25rem;
    }
    .codex-section-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }
    .codex-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 0.6rem;
    }
    .codex-card {
      background: var(--bg-soft);
      border-radius: var(--radius);
      padding: 0.6rem 0.45rem 0.5rem;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.05);
      font-size: 0.75rem;
    }
    .codex-card.owned {
      border-color: var(--accent-dim);
      box-shadow: 0 0 0 1px rgba(148,163,184,0.25);
    }
    .codex-card .codex-emoji {
      font-size: 1.8rem;
      margin-bottom: 0.25rem;
    }
    .codex-card .codex-name {
      font-weight: 600;
      margin-bottom: 0.15rem;
    }
    .codex-card .codex-meta {
      font-size: 0.7rem;
      color: var(--text-muted);
    }
    .auth-tabs { display: flex; gap: 0.25rem; margin-bottom: 1rem; }
    .auth-tab { flex: 1; padding: 0.5rem; border: none; border-radius: var(--radius); background: var(--bg-soft); color: var(--text-muted); font-size: 0.85rem; font-family: inherit; cursor: pointer; }
    .auth-tab.active { background: var(--accent-dim); color: var(--accent); font-weight: 600; }
    .auth-title { font-size: 1rem; margin-bottom: 1rem; color: var(--text); }
    .auth-panel label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-top: 0.75rem; margin-bottom: 0.25rem; }
    .auth-panel input { width: 100%; padding: 0.6rem; border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.15); background: var(--bg-soft); color: var(--text); font-size: 0.9rem; box-sizing: border-box; }
    .btn-auth-submit { width: 100%; margin-top: 1rem; padding: 0.65rem; border: none; border-radius: var(--radius); background: linear-gradient(145deg, var(--accent), #10b981); color: var(--bg); font-weight: 600; font-family: inherit; cursor: pointer; font-size: 0.9rem; }
    .auth-hint { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.75rem; }
    .auth-link-btn { font-size: 0.8rem; }
    .auth-divider { display: flex; align-items: center; margin: 1rem 0; text-align: center; }
    .auth-divider::before, .auth-divider::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.1); }
    .auth-divider span { padding: 0 0.75rem; color: var(--text-muted); font-size: 0.75rem; }
    .btn-social { width: 100%; padding: 0.65rem; border: none; border-radius: var(--radius); font-weight: 600; font-family: inherit; cursor: pointer; font-size: 0.9rem; margin-top: 0.5rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
    .btn-kakao { background: #FEE500; color: #000; }
    .btn-kakao:hover { background: #FDD835; }
    .btn-google { background: #fff; color: #000; border: 1px solid rgba(255,255,255,0.2); }
    .btn-google:hover { background: #f5f5f5; }
    .auth-close { position: absolute; top: 0.75rem; right: 0.75rem; width: 28px; height: 28px; border: none; border-radius: 50%; background: var(--bg-soft); color: var(--text-muted); cursor: pointer; font-size: 1rem; line-height: 1; }
    .auth-overlay.auth-gate { align-items: center; justify-content: center; }
    .auth-overlay.auth-gate .auth-close { display: none; }
    .pet-section { background: var(--card); border-radius: var(--radius-lg); padding: 1rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.08); }
    .pet-display { text-align: center; }
    .pet-preview { display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-bottom: 1rem; }
    .pet-emoji { font-size: 4rem; line-height: 1; }
    .pet-info { width: 100%; }
    .pet-name { font-size: 1.1rem; font-weight: 600; color: var(--text); margin-bottom: 0.5rem; }
    .pet-level { font-size: 0.9rem; color: var(--accent); font-weight: 600; margin-bottom: 0.5rem; }
    .pet-exp-bar { width: 100%; height: 8px; background: var(--bg-soft); border-radius: 999px; overflow: hidden; margin-bottom: 0.5rem; }
    .pet-exp-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #10b981); border-radius: 999px; transition: width 0.3s ease; }
    .pet-exp-text { font-size: 0.75rem; color: var(--text-muted); }
    .btn-select-pet { width: 100%; padding: 0.65rem; border: none; border-radius: var(--radius); background: linear-gradient(145deg, var(--accent), #10b981); color: var(--bg); font-weight: 600; font-family: inherit; cursor: pointer; font-size: 0.9rem; }
    .pet-select-modal { background: var(--card); border-radius: var(--radius-lg); padding: 1.5rem; max-width: 400px; width: 100%; border: 1px solid rgba(255,255,255,0.08); box-shadow: var(--shadow); }
    .pet-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-top: 1rem; }
    .pet-item { background: var(--bg-soft); border: 2px solid rgba(255,255,255,0.1); border-radius: var(--radius); padding: 1rem; cursor: pointer; transition: all 0.2s; text-align: center; }
    .pet-item:hover { border-color: var(--accent); background: var(--accent-dim); }
    .pet-item.selected { border-color: var(--accent); background: var(--accent-dim); }
    .pet-item-emoji { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .pet-item-name { font-size: 0.9rem; font-weight: 600; color: var(--text); margin-bottom: 0.25rem; }
    .pet-item-desc { font-size: 0.7rem; color: var(--text-muted); }
    #appMain { display: block; }
    #appMain.hidden { display: none !important; }
    .attendance-card { background: linear-gradient(145deg, var(--card), rgba(251,191,36,0.06)); border: 1px solid rgba(251,191,36,0.2); border-radius: var(--radius-lg); padding: 1rem; margin-bottom: 1rem; box-shadow: var(--shadow); }
    .attendance-desc { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.75rem; }
    .attendance-status { font-size: 0.9rem; color: var(--text); margin-bottom: 0.5rem; }
    .btn-attendance { width: 100%; padding: 0.65rem; border: none; border-radius: var(--radius); background: linear-gradient(145deg, var(--gold), #d97706); color: #1a1a1a; font-weight: 700; font-family: inherit; cursor: pointer; font-size: 0.9rem; }
    .title-badge { font-size: 0.7rem; color: var(--accent); margin-top: 0.35rem; font-weight: 600; }
    .walk-stat.walk-total { grid-column: 1 / -1; }

    /* 탭 네비게이션 */
    .tab-nav {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.35rem;
      background: var(--card);
      border-radius: var(--radius);
      padding: 0.5rem;
      margin-bottom: 1.25rem;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: var(--shadow);
    }
    .tab-btn {
      min-width: 3rem;
      padding: 0.4rem 0.2rem;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.65rem;
      font-family: inherit;
      font-weight: 500;
      cursor: pointer;
      border-radius: 0.65rem;
      transition: all 0.25s ease;
    }
    .tab-btn:hover { color: var(--text); }
    .tab-btn.active { background: linear-gradient(135deg, var(--accent-dim), rgba(52,211,153,0.08)); color: var(--accent); font-weight: 600; box-shadow: 0 0 0 1px rgba(52,211,153,0.2); }
    .tab-btn .tab-emoji { display: block; font-size: 1.15rem; margin-bottom: 0.2rem; }

    .page { display: none; width: 100%; animation: fadeIn 0.25s ease; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideDown { from { transform: translateX(-50%) translateY(-20px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }
    @keyframes slideUp { from { transform: translateX(-50%) translateY(0); opacity: 1; } to { transform: translateX(-50%) translateY(-20px); opacity: 0; } }
    .wild-animal-notification { animation: slideDown 0.3s ease; }

    /* ===== 카드 공통 ===== */
    .step-card, .walk-card, .avatar-section, .story-section {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      margin-bottom: 1rem;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: var(--shadow);
      transition: box-shadow 0.2s ease;
    }
    .step-card:hover, .walk-card:hover, .avatar-section:hover { box-shadow: var(--shadow), 0 0 0 1px rgba(255,255,255,0.03); }
    .story-section { min-height: 200px; }

    /* ===== 걸음 탭 ===== */
    .step-value-wrap { display: flex; align-items: baseline; justify-content: center; gap: 0.3rem; margin-bottom: 0.3rem; }
    .step-value { font-size: 3.25rem; font-weight: 700; letter-spacing: -0.04em; background: linear-gradient(135deg, var(--accent), #10b981); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; line-height: 1; }
    .step-unit { font-size: 1.1rem; font-weight: 600; color: var(--text-muted); }
    .step-label { text-align: center; font-size: 0.9rem; color: var(--text-muted); font-weight: 400; }
    .lifetime-hint { text-align: center; font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem; }
    .progress-wrap { margin-top: 1.25rem; }
    .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.45rem; font-size: 0.8rem; color: var(--text-muted); }
    .progress-bar-bg { height: 10px; background: var(--bg-soft); border-radius: 999px; overflow: hidden; }
    .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #10b981); border-radius: 999px; width: 0%; transition: width 0.45s ease; box-shadow: 0 0 12px var(--accent-glow); }
    .manual-area { text-align: center; margin-top: 1.25rem; }
    .btn-add {
      width: 58px; height: 58px; border-radius: 50%; border: none; background: linear-gradient(145deg, var(--accent), #10b981); color: var(--bg);
      font-size: 1.6rem; font-weight: 700; cursor: pointer; box-shadow: 0 4px 20px var(--accent-glow);
      transition: transform 0.2s ease, box-shadow 0.2s ease; font-family: inherit; line-height: 1;
    }
    .btn-add:hover { transform: scale(1.06); box-shadow: 0 6px 28px var(--accent-glow); }
    .btn-add:active { transform: scale(0.97); }
    .manual-hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; }
    .status { font-size: 0.75rem; color: var(--text-muted); text-align: center; margin-top: 0.75rem; }
    .status.sensor-ok { color: var(--accent); }
    .actions { display: flex; justify-content: center; gap: 0.75rem; margin-top: 1rem; }
    .btn-reset {
      padding: 0.55rem 1.1rem; border-radius: 999px; border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04); color: var(--text-muted); font-size: 0.8rem; font-family: inherit; cursor: pointer; transition: all 0.2s;
    }
    .btn-reset:hover { color: var(--text); border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.06); }
    .goal-badge { display: none; text-align: center; margin-top: 0.75rem; padding: 0.45rem 1rem; background: var(--accent-dim); color: var(--accent); border-radius: 999px; font-size: 0.85rem; font-weight: 600; }
    .step-card.goal-reached .goal-badge { display: block; }
    .step-card.goal-reached .step-value { animation: pulse 1.5s ease infinite; }
    @keyframes pulse { 50% { opacity: 0.9; } }

    /* ===== 아바타 탭 ===== */
    /* 제페토 스타일 3D 캐릭터 영역 (플레이스홀더) */
    .avatar-3d-placeholder {
      width: 100%; min-height: 220px; margin: 0 auto 1rem;
      background: linear-gradient(180deg, rgba(52,211,153,0.06) 0%, rgba(0,0,0,0.2) 100%);
      border: 2px dashed rgba(52,211,153,0.35);
      border-radius: var(--radius-lg);
      display: flex; align-items: center; justify-content: center;
      flex-direction: column;
      color: var(--text-muted);
      font-size: 0.85rem;
      text-align: center;
      padding: 1.5rem;
    }
    .avatar-3d-placeholder .ph-title { color: var(--accent); font-weight: 600; margin-bottom: 0.35rem; font-size: 0.95rem; }
    .avatar-3d-placeholder .ph-desc { font-size: 0.75rem; opacity: 0.9; }
    .avatar-preview-wrap {
      width: 150px; height: 200px; margin: 0 auto 1.25rem;
      background: linear-gradient(180deg, rgba(52,211,153,0.08) 0%, rgba(255,255,255,0.03) 100%); border-radius: var(--radius-lg);
      display: flex; align-items: flex-end; justify-content: center;
      position: relative;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
    }
    .avatar-preview {
      width: 80px; height: 120px;
      position: relative;
    }
    /* 제페토 스타일 치비: 머리 크게, 몸 작게 */
    .avatar-body { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 42px; height: 48px; border-radius: 21px 21px 8px 8px; }
    .avatar-head { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 44px; height: 44px; border-radius: 50%; }
    .avatar-hair { position: absolute; bottom: 52px; left: 50%; transform: translateX(-50%); width: 52px; height: 22px; border-radius: 50% 50% 0 0; }
    .avatar-armor { position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); width: 46px; height: 42px; border-radius: 20px 20px 8px 8px; pointer-events: none; }
    .avatar-weapon { position: absolute; bottom: 28px; right: -26px; font-size: 1.4rem; }
    .avatar-hat { position: absolute; bottom: 72px; left: 50%; transform: translateX(-50%); font-size: 1.5rem; }
    .avatar-name { text-align: center; font-size: 1.05rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--accent); }
    .customize-row { display: flex; gap: 0.5rem; align-items: center; margin-top: 0.75rem; flex-wrap: wrap; }
    .customize-row label { font-size: 0.8rem; color: var(--text-muted); min-width: 3.5rem; font-weight: 500; }
    .customize-row select, .customize-row input[type="text"] {
      flex: 1; min-width: 0; padding: 0.5rem 0.75rem; border-radius: 0.6rem;
      border: 1px solid rgba(255,255,255,0.1); background: var(--bg-soft); color: var(--text);
      font-size: 0.85rem; font-family: inherit;
    }
    .color-swatch { width: 30px; height: 30px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.25); cursor: pointer; flex-shrink: 0; transition: transform 0.2s, box-shadow 0.2s; }
    .color-swatch:hover { transform: scale(1.08); }
    .color-swatch.active { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-dim), 0 0 12px var(--accent-glow); }

    /* ===== 산책로 탭 ===== */
    .route-list { display: flex; flex-direction: column; gap: 0.65rem; }
    .route-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 1rem 1.25rem;
      border: 1px solid rgba(255,255,255,0.06);
      display: flex; align-items: center; gap: 1rem;
      transition: background 0.2s, border-color 0.2s;
    }
    .route-card:not(.locked):hover { background: var(--card-hover); border-color: rgba(52,211,153,0.15); }
    .route-card.locked { opacity: 0.6; }
    .route-icon { font-size: 2rem; width: 48px; text-align: center; flex-shrink: 0; }
    .route-info { flex: 1; min-width: 0; }
    .route-name { font-weight: 600; font-size: 0.95rem; margin-bottom: 0.2rem; }
    .route-steps { font-size: 0.8rem; color: var(--text-muted); }
    .route-reward { font-size: 0.8rem; color: var(--accent); margin-top: 0.25rem; }
    .route-status { font-size: 0.72rem; padding: 0.4rem 0.65rem; border-radius: 999px; flex-shrink: 0; font-weight: 500; }
    .route-status.locked { background: var(--bg-soft); color: var(--text-muted); }
    .route-status.claim { background: var(--accent-dim); color: var(--accent); }
    .route-status.done { background: rgba(52,211,153,0.2); color: var(--accent); }

    /* ===== 장비 탭 ===== */
    .equipped-section { margin-bottom: 1.25rem; }
    .equipped-title { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
    .equipped-slots { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
    .equipped-slot {
      min-height: 4.2rem; background: var(--bg-soft); border-radius: var(--radius);
      border: 1px dashed rgba(255,255,255,0.12); display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 1.5rem; cursor: pointer; transition: all 0.2s; position: relative; padding: 0.5rem 0.35rem 0.4rem;
      gap: 0.2rem;
    }
    .equipped-slot:hover { border-color: rgba(52,211,153,0.3); background: var(--card-hover); }
    .equipped-slot.filled { border-style: solid; border-color: rgba(52,211,153,0.4); background: var(--accent-dim); }
    .equipped-slot .slot-label { font-size: 0.65rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
    .equipped-slot .slot-item-name { font-size: 0.7rem; color: var(--text); font-weight: 500; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; line-height: 1.2; }
    .equipped-slot .inv-tier { font-size: 0.6rem; font-weight: 600; color: var(--text-muted); }
    .equipped-slot.tier-standard .inv-tier { color: #94a3b8; }
    .equipped-slot.tier-pro .inv-tier { color: #60a5fa; }
    .equipped-slot.tier-prime .inv-tier { color: #a78bfa; }
    .equipped-slot.tier-signature .inv-tier { color: #fbbf24; }
    .inventory-title { font-size: 0.8rem; color: var(--text-muted); margin: 1rem 0 0.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
    .inventory-slot-section { margin-bottom: 1rem; }
    .inventory-slot-section h4 { font-size: 0.8rem; color: var(--accent); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.35rem; }
    .inventory-slot-list { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .inventory-slot-list .inv-item { width: calc(25% - 0.4rem); min-width: 72px; box-sizing: border-box; }
    .inventory-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
    .inv-item {
      aspect-ratio: 1; background: var(--card); border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.08);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 1.4rem; cursor: pointer; transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s; position: relative;
    }
    .inv-item:hover { transform: scale(1.05); border-color: rgba(52,211,153,0.25); box-shadow: 0 4px 16px rgba(0,0,0,0.2); }
    .inv-item .inv-name { font-size: 0.58rem; color: var(--text-muted); margin-top: 0.2rem; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .inv-item.equipped { border-color: var(--accent); background: var(--accent-dim); box-shadow: 0 0 0 1px rgba(52,211,153,0.3); }
    .inv-item-kit .inv-open { font-size: 0.55rem; color: var(--accent); margin-top: 0.1rem; font-weight: 600; }
    .storage-actions { display: flex; gap: 0.35rem; margin-top: 0.4rem; justify-content: center; flex-wrap: wrap; }
    .btn-storage-inv, .btn-storage-open { padding: 0.35rem 0.6rem; font-size: 0.7rem; border-radius: 0.5rem; border: none; cursor: pointer; font-family: inherit; font-weight: 600; }
    .btn-storage-inv { background: var(--bg-soft); color: var(--text); border: 1px solid rgba(255,255,255,0.15); }
    .btn-storage-open { background: linear-gradient(145deg, var(--accent), #10b981); color: var(--bg); }
    .inv-item .rarity-dot { position: absolute; top: 0.2rem; right: 0.2rem; width: 6px; height: 6px; border-radius: 50%; }
    .inv-item.rarity-common .rarity-dot { background: var(--rarity-common); }
    .inv-item.rarity-rare .rarity-dot { background: var(--rarity-rare); box-shadow: 0 0 6px var(--rarity-rare); }
    .inv-item.rarity-epic .rarity-dot { background: var(--rarity-epic); box-shadow: 0 0 8px var(--rarity-epic); }
    .inv-item.rarity-legend .rarity-dot { background: var(--rarity-legend); box-shadow: 0 0 10px var(--rarity-legend); }
    .inv-item.rarity-rare { border-color: rgba(96,165,250,0.4); }
    .inv-item.rarity-epic { border-color: rgba(167,139,250,0.5); box-shadow: 0 0 12px rgba(167,139,250,0.2); }
    .inv-item.rarity-legend { border-color: rgba(251,191,36,0.6); box-shadow: 0 0 16px rgba(251,191,36,0.25); }
    /* 등급(티어)별 장비 스타일 */
    .inv-item .inv-tier { font-size: 0.55rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; margin-top: 0.15rem; }
    .inv-item .inv-enhance { font-size: 0.85rem; font-weight: 800; color: var(--accent); margin-top: 0.1rem; }
    .inv-item.tier-standard { border-color: rgba(148,163,184,0.4); }
    .inv-item.tier-standard .inv-tier { color: #94a3b8; }
    .inv-item.tier-pro { border-color: rgba(96,165,250,0.5); box-shadow: 0 0 10px rgba(96,165,250,0.15); }
    .inv-item.tier-pro .inv-tier { color: #60a5fa; }
    .inv-item.tier-prime { border-color: rgba(167,139,250,0.6); box-shadow: 0 0 14px rgba(167,139,250,0.2); }
    .inv-item.tier-prime .inv-tier { color: #a78bfa; }
    .inv-item.tier-signature { border-color: rgba(251,191,36,0.7); box-shadow: 0 0 18px rgba(251,191,36,0.25); background: linear-gradient(145deg, var(--card), rgba(251,191,36,0.06)); }
    .inv-item.tier-signature .inv-tier { color: #fbbf24; }
    .equipped-slot.tier-standard.filled { border-color: rgba(148,163,184,0.5); }
    .equipped-slot.tier-pro.filled { border-color: rgba(96,165,250,0.5); box-shadow: 0 0 8px rgba(96,165,250,0.2); }
    .equipped-slot.tier-prime.filled { border-color: rgba(167,139,250,0.5); box-shadow: 0 0 10px rgba(167,139,250,0.25); }
    .equipped-slot.tier-signature.filled { border-color: rgba(251,191,36,0.6); box-shadow: 0 0 12px rgba(251,191,36,0.3); }

    /* ===== 스토리 탭 ===== */
    .story-title { font-size: 0.95rem; color: var(--accent); margin-bottom: 0.75rem; font-weight: 600; }
    .story-text { font-size: 0.9rem; line-height: 1.7; color: var(--text); font-weight: 400; white-space: pre-line; }
    .story-milestone { font-size: 0.78rem; color: var(--text-muted); margin-top: 1rem; }

    /* 보상 팝업 */
    .toast {
      position: fixed; bottom: 5.5rem; left: 50%; transform: translateX(-50%) translateY(100px);
      background: var(--card); border: 1px solid var(--accent);
      color: var(--accent); padding: 0.8rem 1.35rem; border-radius: var(--radius);
      font-size: 0.9rem; font-weight: 600; z-index: 100; opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
      box-shadow: var(--shadow), 0 0 24px var(--accent-glow);
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* 오늘의 퀘스트 */
    .quest-card { background: var(--card); border-radius: var(--radius-lg); padding: 1rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.06); box-shadow: var(--shadow); }
    .quest-desc { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.75rem; }
    .quest-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .quest-item { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; padding: 0.6rem 0.75rem; background: var(--bg-soft); border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.06); }
    .quest-item.done { border-color: rgba(52,211,153,0.3); background: var(--accent-dim); }
    .quest-item .quest-info { flex: 1; min-width: 0; }
    .quest-item .quest-name { font-size: 0.85rem; font-weight: 600; color: var(--text); }
    .quest-item .quest-progress { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.2rem; }
    .quest-item .quest-reward { font-size: 0.8rem; font-weight: 700; color: var(--gold); white-space: nowrap; }
    .quest-item .btn-claim { padding: 0.35rem 0.65rem; font-size: 0.75rem; border-radius: 0.5rem; border: none; background: linear-gradient(145deg, var(--gold), #d97706); color: #1a1a1a; font-weight: 600; cursor: pointer; font-family: inherit; }
    .quest-item .quest-done-label { font-size: 0.75rem; color: var(--accent); font-weight: 600; }

    /* ===== 산책 탭 (코스 + GPS) ===== */
    .walk-title { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--accent); }
    .course-set { margin-bottom: 1rem; }
    .course-label { display: block; font-size: 0.82rem; color: var(--text-muted); margin-bottom: 0.4rem; font-weight: 500; }
    .course-input { width: 100%; padding: 0.65rem 0.85rem; border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.1); background: var(--bg-soft); color: var(--text); font-size: 1rem; }
    .walk-actions { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    .btn-walk-start, .btn-walk-stop { flex: 1; padding: 0.8rem; border-radius: var(--radius); font-size: 0.95rem; font-weight: 600; font-family: inherit; cursor: pointer; border: none; transition: transform 0.15s, box-shadow 0.15s; }
    .btn-walk-start { background: linear-gradient(145deg, var(--accent), #10b981); color: var(--bg); box-shadow: 0 4px 16px var(--accent-glow); }
    .btn-walk-start:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 6px 20px var(--accent-glow); }
    .btn-walk-stop { background: rgba(248,113,113,0.25); color: #f87171; border: 1px solid rgba(248,113,113,0.4); }
    .btn-walk-stop:hover:not(:disabled) { transform: translateY(-1px); }
    .btn-walk-start:disabled, .btn-walk-stop:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .walk-live { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.75rem; }
    .walk-stat { background: var(--bg-soft); border-radius: 0.6rem; padding: 0.65rem; text-align: center; font-size: 0.85rem; color: var(--text-muted); border: 1px solid rgba(255,255,255,0.05); }
    .walk-stat-value { color: var(--accent); font-weight: 700; font-size: 1.15rem; }
    .walk-next { grid-column: 1 / -1; font-size: 0.8rem; color: var(--gold); text-align: center; font-weight: 500; }
    .walk-status { font-size: 0.8rem; color: var(--text-muted); text-align: center; }
    .walk-route-select { margin-bottom: 1rem; }
    .walk-route-select label { display: block; font-size: 0.82rem; color: var(--text-muted); margin-bottom: 0.4rem; font-weight: 500; }
    .walk-route-select select { width: 100%; padding: 0.65rem 0.85rem; border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.1); background: var(--bg-soft); color: var(--text); font-size: 0.95rem; }
    .btn-add-route { width: 100%; padding: 0.6rem; margin-top: 0.5rem; border-radius: var(--radius); border: 1px dashed rgba(52,211,153,0.5); background: transparent; color: var(--accent); font-size: 0.85rem; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; }
    .btn-add-route:hover { background: var(--accent-dim); }
    #walkMap { width: 100%; height: 220px; border-radius: var(--radius-lg); margin-top: 1rem; overflow: hidden; position: relative; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06), 0 4px 20px rgba(0,0,0,0.2); background: linear-gradient(180deg, var(--bg-soft) 0%, var(--card) 100%); }
    .our-map-wrap { width: 100%; height: 100%; position: relative; border-radius: inherit; }
    .our-map-wrap svg { width: 100%; height: 100%; display: block; }
    .our-map-path { fill: none; stroke: var(--accent); stroke-width: 4; stroke-linecap: round; stroke-linejoin: round; opacity: 0.9; filter: drop-shadow(0 0 6px var(--accent-glow)); transition: d 0.2s ease; }
    [data-theme="morning"] .our-map-path { stroke: var(--accent); filter: drop-shadow(0 0 4px rgba(22,163,74,0.35)); }
    /* 전체 코스 맵에서는 이전 경로를 더 눈에 띄게 골드 톤으로 표시 */
    .routes-map-box .our-map-path { stroke: var(--gold); stroke-width: 4; filter: drop-shadow(0 0 6px var(--gold-dim)); }
    .our-map-char { transition: transform 0.2s ease-out; }
    .our-map-char .char-body { fill: var(--accent); stroke: var(--bg); stroke-width: 2; }
    .our-map-char .char-head { fill: var(--accent); stroke: var(--bg); stroke-width: 1.5; }
    .our-map-char .char-shadow { fill: rgba(0,0,0,0.2); }
    .our-map-grid line { stroke: rgba(255,255,255,0.06); stroke-width: 0.4; stroke-dasharray: 3 4; }
    [data-theme="morning"] .our-map-grid line { stroke: rgba(0,0,0,0.08); stroke-dasharray: 3 4; }
    .our-map-label { position: absolute; bottom: 10px; left: 12px; font-size: 0.72rem; color: var(--text-muted); font-weight: 500; }
    .routes-map-box { border-radius: var(--radius-lg); overflow: hidden; background: linear-gradient(180deg, var(--bg-soft) 0%, var(--card) 100%); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06); }
    .route-create-card { margin-bottom: 1rem; padding: 1rem; background: var(--card); border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.06); }
    .route-create-card input { margin-bottom: 0.5rem; }
    .achievement-section { margin-bottom: 1.25rem; }
    .achievement-title { font-size: 0.9rem; font-weight: 600; color: var(--accent); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
    .achievement-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
    .achievement-item { background: var(--bg-soft); border-radius: var(--radius); padding: 0.75rem; border: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; gap: 0.6rem; }
    .achievement-item.unlocked { border-color: rgba(52,211,153,0.3); background: var(--accent-dim); }
    .achievement-item .ach-icon { font-size: 1.75rem; width: 40px; text-align: center; flex-shrink: 0; }
    .achievement-item.locked .ach-icon { filter: grayscale(1); opacity: 0.6; }
    .achievement-item .ach-name { font-size: 0.8rem; font-weight: 600; }
    .achievement-item .ach-desc { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.15rem; }

    /* 가챠(보급 뽑기) */
    .gacha-card { background: var(--card); border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.06); text-align: center; }
    .gacha-gold { font-size: 1.5rem; font-weight: 700; color: var(--gold); margin-bottom: 0.5rem; }
    .gacha-buttons { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-top: 0.75rem; }
    .btn-gacha { padding: 0.75rem 1.25rem; border-radius: var(--radius); background: linear-gradient(145deg, var(--gold), #d97706); color: #1a1a1a; font-weight: 700; font-size: 0.9rem; border: none; cursor: pointer; font-family: inherit; }
    .btn-gacha:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-gacha-premium { padding: 0.75rem 1.25rem; border-radius: var(--radius); background: linear-gradient(145deg, #a78bfa, #7c3aed); color: #fff; font-weight: 700; font-size: 0.9rem; border: none; cursor: pointer; font-family: inherit; }
    .btn-gacha-premium:disabled { opacity: 0.5; cursor: not-allowed; }
    .gacha-cost { font-size: 0.78rem; color: var(--text-muted); margin-top: 0.35rem; }
    .share-card { background: var(--card); border-radius: var(--radius-lg); padding: 1.25rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.06); text-align: center; }
    .btn-share { width: 100%; padding: 0.8rem; border-radius: var(--radius); background: #fee500; color: #191919; font-weight: 700; font-size: 0.9rem; border: none; cursor: pointer; font-family: inherit; }
    .payment-card { background: var(--card); border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.06); }
    .payment-desc { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem; }
    .payment-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.65rem; }
    .payment-item-card { background: var(--bg-soft); border-radius: var(--radius); padding: 1rem; text-align: center; border: 1px solid rgba(255,255,255,0.06); display: flex; flex-direction: column; gap: 0.35rem; align-items: center; }
    .payment-item-card.highlight { border-color: rgba(251,191,36,0.4); background: linear-gradient(145deg, var(--bg-soft), rgba(251,191,36,0.06)); }
    .payment-amount { font-size: 1.1rem; font-weight: 700; color: var(--gold); }
    .payment-price { font-size: 0.7rem; color: var(--text-muted); }
    .btn-payment { padding: 0.45rem 0.75rem; font-size: 0.8rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.06); color: var(--text-muted); cursor: not-allowed; font-family: inherit; }

    /* 장비 강화 */
    .enhance-section { margin-bottom: 1rem; }
    .enhance-select { width: 100%; padding: 0.65rem; border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.1); background: var(--bg-soft); color: var(--text); margin-bottom: 0.5rem; font-size: 0.9rem; }
    .btn-enhance { width: 100%; padding: 0.75rem; border-radius: var(--radius); background: linear-gradient(145deg, var(--rarity-epic), #7c3aed); color: #fff; font-weight: 600; border: none; cursor: pointer; font-family: inherit; }
    .btn-enhance:disabled { opacity: 0.5; cursor: not-allowed; }
    .enhance-warn { font-size: 0.75rem; color: #f87171; margin-top: 0.5rem; }
    .enhance-table-wrap { margin: 1rem 0; overflow-x: auto; }
    .enhance-table { width: 100%; font-size: 0.8rem; border-collapse: collapse; }
    .enhance-table th, .enhance-table td { padding: 0.5rem 0.6rem; text-align: center; border: 1px solid rgba(255,255,255,0.08); }
    .enhance-table .enhance-col { font-size: 1rem; font-weight: 700; color: var(--accent); }
    .enhance-table th { background: var(--bg-soft); color: var(--text-muted); font-weight: 600; }
    .enhance-table tr:nth-child(even) { background: rgba(255,255,255,0.02); }
    .enhance-table .rate-ok { color: var(--accent); }
    .enhance-table .rate-mid { color: var(--gold); }
    .enhance-table .rate-low { color: #f87171; }
    .enhance-note { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem; line-height: 1.5; }
    .equip-bonus-summary { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.75rem; padding: 0.6rem; background: var(--bg-soft); border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.06); }
    .equip-bonus-summary strong { color: var(--accent); }

    /* 2D 캐릭터 인간형 - 부드러운 비율과 그림자 */
    .avatar-human { width: 100px; height: 168px; margin: 0 auto; position: relative; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.2)); }
    .avatar-human .ah-head { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 38px; height: 38px; border-radius: 50%; box-shadow: inset -2px -1px 0 rgba(0,0,0,0.06), 0 2px 6px rgba(0,0,0,0.12); }
    .avatar-human .ah-face { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); width: 24px; height: 10px; display: flex; justify-content: space-between; align-items: center; }
    .avatar-human .ah-face .eye { width: 4px; height: 4px; border-radius: 50%; background: rgba(0,0,0,0.5); }
    .avatar-human .ah-neck { position: absolute; top: 36px; left: 50%; transform: translateX(-50%); width: 10px; height: 12px; border-radius: 0 0 4px 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .avatar-human .ah-torso { position: absolute; top: 48px; left: 50%; transform: translateX(-50%); width: 46px; height: 44px; border-radius: 12px 12px 8px 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.1); }
    .avatar-human .ah-arm-l, .avatar-human .ah-arm-r { position: absolute; top: 52px; width: 10px; height: 34px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    .avatar-human .ah-arm-l { left: 0; transform-origin: top right; }
    .avatar-human .ah-arm-r { right: 0; transform-origin: top left; }
    .avatar-human .ah-leg-l, .avatar-human .ah-leg-r { position: absolute; top: 90px; width: 14px; height: 44px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.12); }
    .avatar-human .ah-leg-l { left: 24px; }
    .avatar-human .ah-leg-r { right: 24px; }
    .avatar-human .ah-slot-head { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); font-size: 1.35rem; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2)); }
    .avatar-human .ah-slot-accessory { position: absolute; top: 6px; right: -12px; font-size: 1.1rem; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2)); }
    .avatar-preview-wrap { padding: 1.25rem; background: linear-gradient(180deg, var(--bg-soft) 0%, var(--card) 100%); border-radius: var(--radius-lg); margin-bottom: 1.25rem; border: 1px solid rgba(255,255,255,0.06); }
    .avatar-section .customize-row { margin-bottom: 1rem; }
    .avatar-section .customize-row label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.4rem; }
    .avatar-section .customize-section-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--accent); margin: 1.25rem 0 0.5rem; padding-bottom: 0.35rem; border-bottom: 1px solid rgba(255,255,255,0.06); }
    .avatar-section .customize-section-title:first-of-type { margin-top: 0; }

    /* 모바일 최적화 */
    @media (max-width: 480px) {
      .container { padding-left: 0.75rem; padding-right: 0.75rem; }
      header { padding-top: 0.5rem; }
      h1 { font-size: 1.3rem; }
      .step-value { font-size: 2.75rem; }
      .btn-add { width: 64px; height: 64px; font-size: 1.8rem; }
      .tab-btn { min-width: 2.5rem; padding: 0.5rem 0.25rem; font-size: 0.7rem; }
      .tab-btn .tab-emoji { font-size: 1.25rem; }
      .step-card, .walk-card, .avatar-section, .story-section { padding: 1.25rem; }
      .auth-modal { padding: 1.25rem; max-width: 100%; }
      .btn-auth-submit, .btn-gacha, .btn-gacha-premium, .btn-share, .btn-attendance { min-height: 44px; padding: 0.75rem; }
      .btn-reset, .btn-claim { min-height: 36px; padding: 0.5rem 0.9rem; }
      .header-auth-btn { min-height: 36px; padding: 0.4rem 0.6rem; font-size: 0.75rem; }
      .theme-toggle { width: 40px; height: 40px; }
      input[type="text"], input[type="password"], input[type="number"], select { min-height: 44px; font-size: 16px; }
      .inv-item { min-height: 80px; }
      .equipped-slot { min-height: 5rem; }
    }
    @media (hover: none) and (pointer: coarse) {
      .btn-add:hover, .btn-reset:hover, .tab-btn:hover, .header-auth-btn:hover { transform: none; }
      .btn-add:active { transform: scale(0.95); }
      .btn-reset:active, .tab-btn:active { opacity: 0.7; }
    }
    html { -webkit-overflow-scrolling: touch; height: 100%; }
    body { -webkit-tap-highlight-color: transparent; height: 100%; overflow-y: auto; }
    button, a, input, select, .tab-btn, .inv-item, .equipped-slot { -webkit-tap-highlight-color: rgba(255,255,255,0.1); touch-action: manipulation; }
    input, textarea, select { font-size: 16px; }
    @supports (-webkit-touch-callout: none) {
      input, textarea, select { font-size: 16px; }
    }
    @media (max-width: 480px) {
      .auth-overlay { padding: 0.5rem; align-items: flex-start; padding-top: max(1rem, env(safe-area-inset-top)); }
      .auth-modal { margin-top: auto; margin-bottom: auto; max-height: calc(100vh - 2rem); overflow-y: auto; }
    }
  </style>
</head>
<body data-theme="night">
  <div class="container">
    <div id="appMain" class="hidden">
    <header>
      <button type="button" class="theme-toggle" id="themeToggle" title="모닝/나이트 전환">🌙</button>
      <h1>WalkStory</h1>
      <p class="subtitle">걸음으로 키우는 나만의 동물 친구</p>
      <div class="header-level" id="headerLevel">
        <span>Lv.<span class="lv-num" id="levelNum">1</span></span>
        <div class="level-bar-wrap"><div class="level-bar-fill" id="levelBarFill" style="width:0%"></div></div>
      </div>
      <p class="title-badge" id="titleBadge">산책러</p>
      <div class="header-right">
        <button type="button" class="header-auth-btn" id="btnHeaderAuth" aria-label="로그인">🔐 로그인</button>
        <button type="button" class="header-logout-btn" id="btnLogout" aria-label="로그아웃" style="display:none;">로그아웃</button>
        <span class="gold-display">🪙 <span id="headerGold">0</span> G</span>
      </div>
    </header>

    <nav class="tab-nav" role="tablist">
      <button type="button" class="tab-btn active" data-tab="walk" aria-selected="true"><span class="tab-emoji">🚶</span>산책</button>
      <button type="button" class="tab-btn" data-tab="avatar"><span class="tab-emoji">🧑</span>아바타</button>
      <button type="button" class="tab-btn" data-tab="storage"><span class="tab-emoji">📥</span>보관함</button>
      <button type="button" class="tab-btn" data-tab="shop"><span class="tab-emoji">🛒</span>상점</button>
      <button type="button" class="tab-btn" data-tab="equipment"><span class="tab-emoji">🎒</span>장비</button>
      <button type="button" class="tab-btn" data-tab="story"><span class="tab-emoji">📖</span>스토리</button>
    </nav>

    <!-- 산책 탭 (걸음 + 코스 + 지도 + 산책로 통합) -->
    <section class="page active" id="page-walk" role="tabpanel">
      <div class="attendance-card" id="attendanceCard" style="display:none;">
        <h2 class="walk-title">📅 출석 이벤트</h2>
        <p class="attendance-desc">매일 출석하고 보상을 받아가요. 7일 연속 시 <strong>위클리 마스터 선물상자</strong> 지급!</p>
        <div class="attendance-status" id="attendanceStatus"></div>
        <button type="button" class="btn-attendance" id="btnAttendance" style="display:none;">출석 체크</button>
      </div>
      <div class="quest-card">
        <h2 class="walk-title">📋 오늘의 퀘스트</h2>
        <p class="quest-desc">완료 후 보상을 수령하면 골드를 받을 수 있어요.</p>
        <div id="questList" class="quest-list"></div>
      </div>
      <div class="step-card" id="stepCard">
        <div class="step-value-wrap">
          <span class="step-value" id="stepValue">0</span>
          <span class="step-unit">걸음</span>
        </div>
        <p class="step-label">오늘 걸은 걸음</p>
        <p class="lifetime-hint">누적 <span id="lifetimeSteps">0</span>걸음으로 산책로를 열어가요</p>
        <div class="progress-wrap">
          <div class="progress-header">
            <span>오늘 목표</span>
            <span id="progressText">0 / 10,000</span>
          </div>
          <div class="progress-bar-bg">
            <div class="progress-bar-fill" id="progressFill"></div>
          </div>
        </div>
        <div class="goal-badge" id="goalBadge">🎉 목표 달성!</div>
        <div class="manual-area">
          <button type="button" class="btn-add" id="btnAdd" title="걸음 추가">+</button>
          <p class="manual-hint" id="manualHint">버튼으로 걸음을 추가할 수 있어요</p>
        </div>
      </div>
      <p class="status" id="status">준비 중...</p>
      <div class="actions">
        <button type="button" class="btn-reset" id="btnReset">오늘 걸음 초기화</button>
      </div>
      <div class="walk-card">
        <h2 class="walk-title">나만의 산책 코스</h2>
        <div class="walk-route-select">
          <label>진행할 코스 선택</label>
          <select id="selectActiveRoute">
            <option value="">-- 코스를 선택하세요 --</option>
          </select>
          <button type="button" class="btn-add-route" id="btnAddRoute">+ 새 코스 만들기</button>
        </div>
        <div class="route-create-card" id="routeCreateCard" style="display:none;">
          <label class="course-label">코스 이름</label>
          <input type="text" id="newRouteName" placeholder="예: 동네 한 바퀴" class="course-input" maxlength="20" inputmode="text" />
          <label class="course-label">목표 거리 (km, 최소 0.5)</label>
          <input type="number" id="newRouteGoalKm" min="0.5" max="50" step="0.5" value="1" class="course-input" inputmode="decimal" />
          <button type="button" class="btn-walk-start" id="btnSaveRoute" style="margin-top:0.5rem;">저장</button>
        </div>
        <div class="walk-actions">
          <button type="button" class="btn-walk-start" id="btnWalkStart">산책 시작</button>
          <button type="button" class="btn-walk-stop" id="btnWalkStop" disabled>산책 종료</button>
        </div>
      <div class="walk-live" id="walkLive">
          <div class="walk-stat"><span class="walk-stat-value" id="walkDistance">0.00</span> km</div>
          <div class="walk-stat">속도 <span class="walk-stat-value" id="walkSpeed">0.0</span> km/h</div>
          <div class="walk-stat">XP <span class="walk-stat-value" id="walkXp">0</span></div>
          <div class="walk-stat walk-total">총 이동 거리 <span class="walk-stat-value" id="walkTotalKm">0.00</span> km</div>
          <div class="walk-next" id="walkNext">코스를 완주하면 보급 키트가 보관함에 도착해요!</div>
          <div class="walk-next" id="walkRace" style="margin-top:0.25rem;"></div>
        </div>
        <div id="walkMap" class="our-map-wrap"></div>
        <p class="walk-status" id="walkStatus">코스를 선택하고 산책 시작을 누르세요.</p>
      </div>
      <p class="inventory-title">내 산책 코스</p>
      <div id="routesMap" class="our-map-wrap routes-map-box" style="height:180px;margin-bottom:1rem;"></div>
      <div class="route-list" id="routeList"></div>
    </section>

    <!-- 아바타 탭 -->
    <section class="page" id="page-avatar" role="tabpanel">
      <div class="avatar-section">
        <p class="avatar-name" id="avatarName">산책러</p>
        <div class="avatar-3d-placeholder" id="avatar3dPlaceholder">
          <span class="ph-title">3D 캐릭터 영역 (Unity WebGL 연동)</span>
          <span class="ph-desc">Unity로 만든 캐릭터를 넣을 수 있어요. WebGL 빌드 후 이 영역에 canvas를 넣고, UNITY_연동_가이드.md를 참고해 연동하세요.<br>아래는 2D 미리보기입니다.</span>
        </div>
        <div class="avatar-preview-wrap">
          <div class="avatar-human" id="avatarHuman">
            <div class="ah-head" id="previewHead" style="background:var(--skin,#f5d0b0)"></div>
            <div class="ah-face"><span class="eye"></span><span class="eye"></span></div>
            <div class="ah-neck" style="background:var(--skin,#f5d0b0)"></div>
            <div class="ah-torso" id="previewBody" style="background:var(--top-color,#6b7280)"></div>
            <div class="ah-arm-l" id="previewArmL" style="background:var(--skin,#f5d0b0)"></div>
            <div class="ah-arm-r" id="previewArmR" style="background:var(--skin,#f5d0b0)"></div>
            <div class="ah-leg-l" id="previewLegL" style="background:var(--bottom-color,#4b5563)"></div>
            <div class="ah-leg-r" id="previewLegR" style="background:var(--bottom-color,#4b5563)"></div>
            <div class="ah-slot-head" id="previewHat"></div>
            <div class="ah-slot-accessory" id="previewWeapon"></div>
          </div>
        </div>
        <div class="pet-section" id="petSection">
          <p class="customize-section-title">나만의 동물 친구</p>
          <div class="pet-display" id="petDisplay">
            <div class="pet-preview" id="petPreview">
              <div class="pet-emoji" id="petEmoji" style="font-size: 4rem;">🐾</div>
              <div class="pet-info" id="petInfo">
                <div class="pet-name" id="petName">동물을 선택해주세요</div>
                <div class="pet-level" id="petLevel">Lv.1</div>
                <div class="pet-exp-bar">
                  <div class="pet-exp-fill" id="petExpFill" style="width: 0%"></div>
                </div>
                <div class="pet-exp-text" id="petExpText">경험치: 0 / 100</div>
              </div>
            </div>
            <button type="button" class="btn-select-pet" id="btnSelectPet">동물 선택하기</button>
          </div>
        </div>
        <p class="customize-section-title">기본 정보</p>
        <div class="customize-row">
          <label>이름</label>
          <input type="text" id="inputAvatarName" placeholder="이름 입력" maxlength="8" inputmode="text" autocomplete="name" />
        </div>
        <p class="customize-section-title">외형</p>
        <div class="customize-row">
          <label>피부색</label>
          <div style="display:flex;gap:0.35rem;flex-wrap:wrap;">
            <button type="button" class="color-swatch active" data-skin="#f5d0b0" style="background:#f5d0b0" aria-label="피부색 1"></button>
            <button type="button" class="color-swatch" data-skin="#e8b896" style="background:#e8b896" aria-label="피부색 2"></button>
            <button type="button" class="color-swatch" data-skin="#d4a574" style="background:#d4a574" aria-label="피부색 3"></button>
            <button type="button" class="color-swatch" data-skin="#c4956a" style="background:#c4956a" aria-label="피부색 4"></button>
          </div>
        </div>
        <p class="customize-section-title">머리</p>
        <div class="customize-row">
          <label>스타일</label>
          <select id="selectHair">
            <option value="short">짧은 머리</option>
            <option value="long">긴 머리</option>
            <option value="curly">곱슬머리</option>
            <option value="spiky">뻗친 머리</option>
          </select>
        </div>
        <div class="customize-row">
          <label>머리 색</label>
          <div style="display:flex;gap:0.35rem;flex-wrap:wrap;">
            <button type="button" class="color-swatch hair-color active" data-hair="#4a3728" style="background:#4a3728"></button>
            <button type="button" class="color-swatch hair-color" data-hair="#2c1810" style="background:#2c1810"></button>
            <button type="button" class="color-swatch hair-color" data-hair="#8b6914" style="background:#8b6914"></button>
            <button type="button" class="color-swatch hair-color" data-hair="#5c4033" style="background:#5c4033"></button>
          </div>
        </div>
      </div>
    </section>

    <!-- 보관함 탭 -->
    <section class="page" id="page-storage" role="tabpanel">
      <div class="walk-card">
        <h2 class="walk-title">📥 보관함</h2>
        <p class="story-text" style="font-size:0.85rem;color:var(--text-muted);margin-bottom:1rem;">산책 코스 완주 시 받은 보급 키트가 여기로 옵니다. 인벤으로 가져가거나 바로 열 수 있어요.</p>
        <div class="inventory-slot-list" id="storageList"></div>
      </div>
    </section>

    <!-- 상점 탭 (보급 + 공유 + 결제) -->
    <section class="page" id="page-shop" role="tabpanel">
      <div class="gacha-card">
        <h2 class="walk-title">📦 보급 뽑기</h2>
        <p class="gacha-gold">🪙 <span id="gachaGold">0</span> G</p>
        <div class="gacha-buttons">
          <button type="button" class="btn-gacha" id="btnGacha">1회 뽑기 (30 G)</button>
          <button type="button" class="btn-gacha-premium" id="btnGachaPremium">강화 뽑기 (60 G)</button>
        </div>
        <p class="gacha-cost">강화 뽑기는 좋은 등급·희귀도 확률 상승</p>
      </div>
      <div class="share-card">
        <h2 class="walk-title">🔗 링크 공유 보상</h2>
        <p class="story-text" style="font-size:0.85rem;margin-bottom:0.75rem;">카카오톡 등으로 공유하면 <strong>+40 G</strong> (일 1회)</p>
        <button type="button" class="btn-share" id="btnShare">카카오톡으로 공유하고 40 G 받기</button>
      </div>
      <div class="payment-card">
        <h2 class="walk-title">💳 골드 구매</h2>
        <p class="payment-desc">스토어 연동 후 사용 가능합니다.</p>
        <div class="payment-grid">
          <div class="payment-item-card">
            <span class="payment-amount">100 G</span>
            <span class="payment-price">소액</span>
            <button type="button" class="btn-payment" disabled>준비 중</button>
          </div>
          <div class="payment-item-card">
            <span class="payment-amount">500 G</span>
            <span class="payment-price">인기</span>
            <button type="button" class="btn-payment" disabled>준비 중</button>
          </div>
          <div class="payment-item-card highlight">
            <span class="payment-amount">1,200 G</span>
            <span class="payment-price">20% 보너스</span>
            <button type="button" class="btn-payment" disabled>준비 중</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 장비 탭 (착용/보유 + 강화) -->
    <section class="page" id="page-equipment" role="tabpanel">
      <div class="equipped-section">
        <p class="equipped-title">착용 중 (탭하여 변경)</p>
        <div class="equipped-slots" id="equippedSlots"></div>
        <div class="equip-bonus-summary" id="equipBonusSummary"></div>
      </div>
      <p class="inventory-title">장비 칸별 보유 목록 (탭하면 착용)</p>
      <div id="inventoryBySlot"></div>
      <div class="walk-card" style="margin-top:1.25rem;">
        <h2 class="walk-title">⬆️ 장비 강화</h2>
        <div class="enhance-table-wrap">
          <table class="enhance-table" aria-label="강화 성공률">
            <thead>
              <tr><th>강화</th><th>성공 확률</th><th>시도/실패 시</th></tr>
            </thead>
            <tbody id="enhanceTableBody"></tbody>
          </table>
        </div>
        <p class="course-label">강화할 장비 선택</p>
        <select class="enhance-select" id="enhanceSelect">
          <option value="">-- 장비 선택 --</option>
        </select>
        <button type="button" class="btn-enhance" id="btnEnhance">강화 시도</button>
        <p class="enhance-note">1~3강 실패 시 장비 파괴. 4~7강은 시도할 때 골드를 먼저 차감하고, 실패해도 장비는 유지돼요.</p>
      </div>
    </section>

    <!-- 스토리 탭 -->
    <section class="page" id="page-story" role="tabpanel">
      <div class="story-section">
        <p class="story-title">나의 산책 일지</p>
        <div class="story-text" id="storyText"></div>
        <p class="story-milestone" id="storyMilestone"></p>
        <div class="achievement-section">
          <p class="achievement-title">🏆 업적</p>
          <div class="achievement-grid" id="achievementGrid"></div>
        </div>
        <div class="animal-collection-section" style="margin-top: 2rem;">
          <p class="achievement-title">🦋 동물 컬렉션</p>
          <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;">산책 중 발견한 동물들을 모아보세요!</p>
          <div class="animal-collection-grid" id="animalCollectionGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem;"></div>
        </div>
      </div>
    </section>
    </div>

    <!-- 도감 플로팅 버튼 -->
    <button type="button" class="codex-fab" id="btnCodex" aria-label="도감 열기">📚</button>

    <!-- 도감 모달 -->
    <div class="codex-overlay" id="codexOverlay" role="dialog" aria-modal="true" aria-labelledby="codexTitle">
      <div class="codex-modal">
        <button type="button" class="codex-close" id="codexClose">×</button>
        <div class="codex-title" id="codexTitle">도감</div>
        <div class="codex-tabs">
          <button type="button" class="codex-tab active" data-codex-tab="equip" id="codexTabEquip">장비 도감</button>
          <button type="button" class="codex-tab" data-codex-tab="animal" id="codexTabAnimal">동물 도감</button>
        </div>
        <div class="codex-body">
          <div id="codexEquipPanel">
            <p class="codex-section-title">보급/강화로 얻을 수 있는 장비들</p>
            <div class="codex-grid" id="codexEquipGrid"></div>
          </div>
          <div id="codexAnimalPanel" style="display:none;">
            <p class="codex-section-title">야생에서 만날 수 있는 동물들</p>
            <div class="codex-grid" id="codexAnimalGrid"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 로그인/회원가입 (비로그인 시 첫 화면, 로그인 후 메인만 표시) -->
    <!-- 튜토리얼 모달 -->
    <div class="tutorial-modal" id="tutorialModal" style="display: none;">
      <div class="tutorial-content" style="background: var(--card); border-radius: var(--radius-lg); padding: 2rem; max-width: 400px; width: 90%; position: relative; animation: slideUp 0.4s ease;">
        <button type="button" class="tutorial-close" id="tutorialClose" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">×</button>
        <div class="tutorial-slide" id="tutorialSlide">
          <div class="tutorial-icon" id="tutorialIcon" style="font-size: 4rem; text-align: center; margin-bottom: 1rem;">👋</div>
          <div class="tutorial-title" id="tutorialTitle" style="font-size: 1.25rem; font-weight: 600; text-align: center; margin-bottom: 0.5rem;">WalkStory에 오신 것을 환영합니다!</div>
          <div class="tutorial-text" id="tutorialText" style="color: var(--text-muted); text-align: center; margin-bottom: 1.5rem; line-height: 1.6;"></div>
          <div class="tutorial-progress" id="tutorialProgress" style="text-align: center; margin-bottom: 1rem; font-size: 0.85rem; color: var(--text-muted);"></div>
          <div class="tutorial-buttons" style="display: flex; gap: 0.5rem;">
            <button type="button" class="btn-tutorial-prev" id="btnTutorialPrev" style="flex: 1; background: var(--bg-soft); color: var(--text); border: none; border-radius: var(--radius); padding: 0.75rem; font-weight: 600; cursor: pointer; display: none;">이전</button>
            <button type="button" class="btn-tutorial-next" id="btnTutorialNext" style="flex: 1; background: var(--accent); color: var(--bg); border: none; border-radius: var(--radius); padding: 0.75rem; font-weight: 600; cursor: pointer;">다음</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 환영 모달 -->
    <div class="welcome-modal" id="welcomeModal">
      <div class="welcome-content">
        <div class="welcome-icon">🎉</div>
        <div class="welcome-title" id="welcomeTitle">환영합니다!</div>
        <div class="welcome-message" id="welcomeMessage">로그인 성공</div>
        <button type="button" class="btn-welcome-close" id="btnWelcomeClose">시작하기</button>
      </div>
    </div>

    <!-- 로딩 오버레이 -->
    <div class="auth-loading" id="authLoading">
      <div class="auth-loading-spinner"></div>
      <div style="color: var(--text-muted); font-size: 0.9rem;">로그인 중...</div>
    </div>

    <div class="auth-overlay auth-gate" id="authOverlay" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <div class="auth-modal">
        <div class="auth-tabs">
          <button type="button" class="auth-tab active" data-auth-tab="login">로그인</button>
          <button type="button" class="auth-tab" data-auth-tab="signup">회원가입</button>
        </div>
        <h2 class="auth-title" id="authTitle">로그인</h2>
        <div id="authLoginPanel" class="auth-panel">
          <label>닉네임</label>
          <input type="text" id="authLoginNick" placeholder="닉네임" maxlength="12" inputmode="text" autocomplete="username" />
          <label>비밀번호</label>
          <input type="password" id="authLoginPw" placeholder="비밀번호" autocomplete="current-password" />
          <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.75rem;">
            <button type="button" class="auth-link-btn" id="btnFindId" style="background: none; border: none; color: var(--accent); cursor: pointer; padding: 0;">아이디 찾기</button>
            <button type="button" class="auth-link-btn" id="btnFindPw" style="background: none; border: none; color: var(--accent); cursor: pointer; padding: 0;">비밀번호 찾기</button>
          </div>
          <button type="button" class="btn-auth-submit" id="btnAuthLogin">로그인</button>
          <div class="auth-divider">
            <span>또는</span>
          </div>
          <button type="button" class="btn-social btn-kakao" id="btnKakaoLogin">
            <span>카카오로 시작하기</span>
          </button>
          <button type="button" class="btn-social btn-google" id="btnGoogleLogin">
            <span>구글로 시작하기</span>
          </button>
        </div>
        <div id="authSignupPanel" class="auth-panel" style="display:none;">
          <label>닉네임</label>
          <input type="text" id="authSignupNick" placeholder="2~12자" maxlength="12" inputmode="text" autocomplete="username" />
          <label>이메일 <span style="color: #ef4444;">*</span></label>
          <input type="email" id="authSignupEmail" placeholder="example@email.com" required inputmode="email" autocomplete="email" />
          <label>비밀번호</label>
          <input type="password" id="authSignupPw" placeholder="6자 이상" autocomplete="new-password" />
          <label>비밀번호 확인</label>
          <input type="password" id="authSignupPw2" placeholder="다시 입력" autocomplete="new-password" />
          <button type="button" class="btn-auth-submit" id="btnAuthSignup">가입하기</button>
          <div class="auth-divider">
            <span>또는</span>
          </div>
          <button type="button" class="btn-social btn-kakao" id="btnKakaoSignup">
            <span>카카오로 시작하기</span>
          </button>
          <button type="button" class="btn-social btn-google" id="btnGoogleSignup">
            <span>구글로 시작하기</span>
          </button>
        </div>
        <div id="authFindIdPanel" class="auth-panel" style="display:none;">
          <label>이메일</label>
          <input type="email" id="authFindIdEmail" placeholder="가입 시 입력한 이메일" inputmode="email" autocomplete="email" />
          <button type="button" class="btn-auth-submit" id="btnFindIdSubmit">아이디 찾기</button>
          <div id="findIdResult" style="margin-top: 1rem; padding: 0.75rem; background: var(--bg-soft); border-radius: var(--radius); display: none;"></div>
          <button type="button" class="auth-link-btn" id="btnBackToLogin" style="width: 100%; margin-top: 0.5rem; background: none; border: none; color: var(--accent); cursor: pointer; padding: 0.5rem;">← 로그인으로 돌아가기</button>
        </div>
        <div id="authFindPwPanel" class="auth-panel" style="display:none;">
          <label>이메일</label>
          <input type="email" id="authFindPwEmail" placeholder="가입 시 입력한 이메일" inputmode="email" autocomplete="email" />
          <button type="button" class="btn-auth-submit" id="btnFindPwSubmit">비밀번호 재설정 링크 발송</button>
          <div id="findPwResult" style="margin-top: 1rem; padding: 0.75rem; background: var(--bg-soft); border-radius: var(--radius); display: none;"></div>
          <div id="authResetPwPanel" style="display:none; margin-top: 1rem;">
            <label>재설정 토큰</label>
            <input type="text" id="authResetToken" placeholder="이메일로 받은 토큰 입력" />
            <label>새 비밀번호</label>
            <input type="password" id="authResetPw" placeholder="6자 이상" autocomplete="new-password" />
            <label>새 비밀번호 확인</label>
            <input type="password" id="authResetPw2" placeholder="다시 입력" autocomplete="new-password" />
            <button type="button" class="btn-auth-submit" id="btnResetPwSubmit">비밀번호 재설정</button>
          </div>
          <button type="button" class="auth-link-btn" id="btnBackToLogin2" style="width: 100%; margin-top: 0.5rem; background: none; border: none; color: var(--accent); cursor: pointer; padding: 0.5rem;">← 로그인으로 돌아가기</button>
        </div>
        
        <button type="button" class="auth-close" id="authClose" aria-label="닫기">✕</button>
      </div>
    </div>
    
    <!-- 동물 선택 모달 -->
    <div class="auth-overlay" id="petSelectOverlay" style="display:none;" role="dialog" aria-modal="true">
      <div class="pet-select-modal">
        <h2 class="auth-title">동물 친구 선택하기</h2>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem;">걸음을 걸어 함께 성장할 동물 친구를 선택해주세요!</p>
        <div class="pet-grid" id="petGrid"></div>
        <button type="button" class="btn-auth-submit" id="btnConfirmPet" style="margin-top: 1rem;">선택하기</button>
        <button type="button" class="auth-close" id="petSelectClose" aria-label="닫기">✕</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="alert"></div>

  <script>
(function () {
  const GOAL = 10000;
  // API_BASE 설정: 모바일 앱 감지 우선순위로 처리
  var API_BASE = '';
  var isCapacitorApp = typeof window !== 'undefined' && window.isCapacitorApp;
  
  // 모바일 앱 감지: 여러 방법으로 확인
  var isMobileApp = isCapacitorApp || 
    (typeof location !== 'undefined' && location.protocol === 'capacitor:') ||
    (typeof location !== 'undefined' && location.hostname === 'localhost' && navigator.userAgent && navigator.userAgent.includes('Android') && !navigator.userAgent.includes('Chrome/')) ||
    (navigator.userAgent && navigator.userAgent.includes('Capacitor'));
  
  if (isMobileApp) {
    // 모바일 앱에서는 항상 Vercel URL 사용
    API_BASE = 'https://walkinggrowth-app.vercel.app';
    console.log('모바일 앱 감지됨 - Vercel URL 사용');
  } else if (typeof location !== 'undefined') {
    if (location.protocol === 'file:') {
      API_BASE = 'http://localhost:3000';
    } else if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
      // localhost 접속 시: 추가로 모바일 앱인지 확인
      // Android WebView는 Chrome이 아닌 경우가 많음
      var isAndroidApp = navigator.userAgent && 
        navigator.userAgent.includes('Android') && 
        !navigator.userAgent.includes('Chrome/') &&
        !navigator.userAgent.includes('Version/');
      
      if (isAndroidApp || isCapacitorApp) {
        // 모바일 앱에서는 Vercel URL 사용
        API_BASE = 'https://walkinggrowth-app.vercel.app';
        console.log('localhost 접속이지만 모바일 앱으로 감지됨 - Vercel URL 사용');
      } else {
        // 웹 브라우저에서 localhost 접속 시에만 로컬 서버 사용
        API_BASE = 'http://localhost:3000';
      }
    } else {
      // 웹 브라우저에서는 현재 도메인 사용
      API_BASE = location.origin;
    }
  } else {
    // location이 없는 경우 - 모바일 앱일 가능성이 높음
    API_BASE = 'https://walkinggrowth-app.vercel.app';
  }
  
  console.log('API_BASE 설정 완료:', {
    API_BASE: API_BASE,
    location: typeof location !== 'undefined' ? location.href : 'N/A',
    protocol: typeof location !== 'undefined' ? location.protocol : 'N/A',
    hostname: typeof location !== 'undefined' ? location.hostname : 'N/A',
    isCapacitorApp: isCapacitorApp,
    isMobileApp: isMobileApp,
    Capacitor: typeof window !== 'undefined' && window.Capacitor !== undefined,
    userAgent: navigator.userAgent
  });
  const TOKEN_KEY = 'walk_token';
  function getAuthToken() { try { return localStorage.getItem(TOKEN_KEY); } catch (e) { return null; } }
  function setAuthToken(t) { try { if (t) localStorage.setItem(TOKEN_KEY, t); else localStorage.removeItem(TOKEN_KEY); } catch (e) {} }
  function clearAuthToken() { setAuthToken(null); }
  const STORAGE_KEYS = {
    pet: 'walk_pet',
    steps: 'pedometer_steps',
    date: 'pedometer_date',
    lifetime: 'walk_lifetime_steps',
    avatar: 'walk_avatar',
    inventory: 'walk_inventory',
    equipped: 'walk_equipped',
    claimed: 'walk_claimed_routes',
    courseGoal: 'walk_course_goal_km',
    totalXp: 'walk_total_xp',
    supplyDate: 'walk_supply_date',
    supplyCount: 'walk_supply_count',
    userRoutes: 'walk_user_routes',
    gold: 'walk_gold',
    theme: 'walk_theme',
    totalWalkKm: 'walk_total_km',
    currentTitle: 'walk_current_title',
    storage: 'walk_storage',
    questProgress: 'walk_quest_progress',
    questDate: 'walk_quest_date',
    sharedDate: 'walk_shared_date',
    user: 'walk_user',
    loggedIn: 'walk_logged_in',
    attendanceDate: 'walk_attendance_date',
    attendanceStreak: 'walk_attendance_streak',
    tutorialCompleted: 'walk_tutorial_completed',
    wildAnimals: 'walk_wild_animals',
    capturedAnimals: 'walk_captured_animals'
  };
  var ATTENDANCE_DAILY_GOLD = [10, 15, 20, 25, 30, 40];
  var ATTENDANCE_7DAY_BOX_NAME = '위클리 마스터 선물상자';
  var ATTENDANCE_7DAY_GOLD = 100;
  const XP_PER_KM = 100;
  const GACHA_COST = 30;
  const GACHA_PREMIUM_COST = 60;
  const STARTING_GOLD = 500;
  const ENHANCE_MAX = 7;
  var ENHANCE_RATES = [95, 90, 85, 75, 60, 45, 30];
  var ENHANCE_ATTEMPT_GOLD = [0, 0, 0, 20, 35, 50, 50];
  var DAILY_QUESTS = [
    { id: 'q_steps', name: '걸음 걸기', desc: '오늘 3,000걸음', goal: 3000, reward: 25, getProgress: function() { return steps; } },
    { id: 'q_walk', name: '산책 완주', desc: '코스 1회 완주', goal: 1, reward: 60, getProgress: function() { return userRoutes.filter(function(r){ return r.completedAt && new Date(r.completedAt).toISOString().slice(0,10) === todayStr(); }).length; } },
    { id: 'q_gacha', name: '보급 뽑기', desc: '보급 1회 뽑기', goal: 1, reward: 15, getProgress: function() { return questGachaCount; } },
    { id: 'q_share', name: '링크 공유', desc: '카카오톡 등으로 공유', goal: 1, reward: 40, getProgress: function() { return sharedToday ? 1 : 0; } }
  ];
  var questGachaCount = 0;
  var questClaimed = {};
  var sharedToday = false;
  var TITLES = [
    { id: 'walker', name: '산책러', minKm: 0 },
    { id: 'short', name: '단거리 선수', minKm: 1 },
    { id: 'long', name: '장거리 선수', minKm: 10 },
    { id: 'marathon', name: '마라토너', minKm: 42.195 },
    { id: 'master', name: '마스터 러너', minKm: 100 }
  ];
  function getTitleForKm(km) {
    var t = TITLES[0];
    for (var i = TITLES.length - 1; i >= 0; i--) {
      if (km >= TITLES[i].minKm) { t = TITLES[i]; break; }
    }
    return t;
  }
  function xpToLevel(xp) {
    if (xp <= 0) return { level: 1, current: 0, need: 100 };
    var level = 1 + Math.floor(Math.sqrt(xp / 50));
    var prevXp = 50 * (level - 1) * (level - 1);
    var nextXp = 50 * level * level;
    return { level: level, current: xp - prevXp, need: nextXp - prevXp };
  }
  // 야생 동물 데이터
  var WILD_ANIMALS = [
    // 커먼 (60%)
    { id: 'rabbit', name: '토끼', emoji: '🐰', rarity: 'common', spawnChance: 0.3, description: '귀여운 토끼예요!' },
    { id: 'squirrel', name: '다람쥐', emoji: '🐿️', rarity: 'common', spawnChance: 0.3, description: '재빠른 다람쥐예요!' },
    { id: 'bird', name: '새', emoji: '🐦', rarity: 'common', spawnChance: 0.25, description: '자유로운 새예요!' },
    { id: 'duck', name: '오리', emoji: '🦆', rarity: 'common', spawnChance: 0.15, description: '물가의 오리예요!' },
    // 레어 (25%)
    { id: 'deer', name: '사슴', emoji: '🦌', rarity: 'rare', spawnChance: 0.15, description: '우아한 사슴이에요!' },
    { id: 'fox', name: '여우', emoji: '🦊', rarity: 'rare', spawnChance: 0.12, description: '영리한 여우예요!' },
    { id: 'hedgehog', name: '고슴도치', emoji: '🦔', rarity: 'rare', spawnChance: 0.1, description: '뾰족한 고슴도치예요!' },
    { id: 'owl', name: '부엉이', emoji: '🦉', rarity: 'rare', spawnChance: 0.08, description: '지혜로운 부엉이예요!' },
    // 에픽 (12%)
    { id: 'wolf', name: '늑대', emoji: '🐺', rarity: 'epic', spawnChance: 0.05, description: '강인한 늑대예요!' },
    { id: 'bear', name: '곰', emoji: '🐻', rarity: 'epic', spawnChance: 0.04, description: '힘센 곰이에요!' },
    { id: 'eagle', name: '독수리', emoji: '🦅', rarity: 'epic', spawnChance: 0.03, description: '위엄 있는 독수리예요!' },
    // 레전드 (3%)
    { id: 'phoenix', name: '불사조', emoji: '🔥', rarity: 'legend', spawnChance: 0.01, description: '전설의 불사조예요!' },
    { id: 'dragon', name: '용', emoji: '🐉', rarity: 'legend', spawnChance: 0.008, description: '신화 속 용이에요!' },
    { id: 'unicorn', name: '유니콘', emoji: '🦄', rarity: 'legend', spawnChance: 0.007, description: '마법의 유니콘이에요!' },
    { id: 'pegasus', name: '페가수스', emoji: '🦋', rarity: 'legend', spawnChance: 0.005, description: '하늘을 나는 페가수스예요!' }
  ];
  
  var ACHIEVEMENTS = [
    { id: 'first_walk', name: '첫 걸음', desc: '첫 산책 시작', icon: '👣', check: function() { return totalXp >= 10; } },
    { id: 'km1', name: '1km 달성', desc: '총 1km 산책', icon: '🛤️', check: function() { return totalXp >= 100; } },
    { id: 'km5', name: '5km 달성', desc: '총 5km 산책', icon: '🏃', check: function() { return totalXp >= 500; } },
    { id: 'course1', name: '코스 완주', desc: '첫 코스 완주', icon: '🏁', check: function() { return (userRoutes.filter(function(r){ return r.completedAt; }).length) >= 1; } },
    { id: 'steps10k', name: '만보 달인', desc: '하루 10,000걸음', icon: '🎯', check: function() { return steps >= 10000 || lifetimeSteps >= 10000; } },
    { id: 'rare', name: '레어 수집가', desc: '레어 이상 장비 획득', icon: '✨', check: function() { return inventory.some(function(i){ return i.rarity === 'rare' || i.rarity === 'epic' || i.rarity === 'legend'; }); } },
    { id: 'legend', name: '레전드', desc: '레전드 장비 획득', icon: '🌟', check: function() { return inventory.some(function(i){ return i.rarity === 'legend'; }); } },
    { id: 'level5', name: '레벨 5', desc: 'Lv.5 달성', icon: '⬆️', check: function() { return xpToLevel(totalXp).level >= 5; } }
  ];
  var RARITY_WEIGHTS = [60, 25, 12, 3];
  var RARITY_NAMES = ['common', 'rare', 'epic', 'legend'];
  var TIER_LABELS = { standard: '스탠다드', pro: '프로', prime: '프라임', signature: '시그니처' };
  var SUPPLY_POOL = [
    { id: 'shoe_1', name: '레볼루션', type: 'shoes', emoji: '👟', tier: 'standard' },
    { id: 'shoe_2', name: '다운시프터', type: 'shoes', emoji: '👟', tier: 'standard' },
    { id: 'shoe_3', name: '윈플로', type: 'shoes', emoji: '👟', tier: 'standard' },
    { id: 'shoe_4', name: '갤럭시 러닝화', type: 'shoes', emoji: '👟', tier: 'standard' },
    { id: 'shoe_5', name: '페가수스', type: 'shoes', emoji: '👟', tier: 'pro' },
    { id: 'shoe_6', name: '리액트', type: 'shoes', emoji: '👟', tier: 'pro' },
    { id: 'shoe_7', name: '노바블라스트', type: 'shoes', emoji: '👟', tier: 'pro' },
    { id: 'shoe_8', name: '클라우드', type: 'shoes', emoji: '👟', tier: 'pro' },
    { id: 'shoe_9', name: '프라임', type: 'shoes', emoji: '👟', tier: 'prime' },
    { id: 'shoe_10', name: '울트라부스트', type: 'shoes', emoji: '👟', tier: 'prime' },
    { id: 'shoe_11', name: '호카 클리프톤', type: 'shoes', emoji: '👟', tier: 'prime' },
    { id: 'shoe_12', name: '젤 카야노', type: 'shoes', emoji: '👟', tier: 'prime' },
    { id: 'shoe_13', name: '엔돌핀 스피드', type: 'shoes', emoji: '👟', tier: 'prime' },
    { id: 'shoe_14', name: '알파플라이', type: 'shoes', emoji: '👟', tier: 'signature' },
    { id: 'shoe_15', name: '베이퍼플라이', type: 'shoes', emoji: '👟', tier: 'signature' },
    { id: 'shoe_16', name: '아디제로 아디오스 프로', type: 'shoes', emoji: '👟', tier: 'signature' },
    { id: 'shoe_17', name: '메타스피드 스카이', type: 'shoes', emoji: '👟', tier: 'signature' },
    { id: 'watch_1', name: '샤오미 밴드', type: 'accessory', emoji: '⌚', tier: 'standard' },
    { id: 'watch_2', name: '갤럭시 핏', type: 'accessory', emoji: '⌚', tier: 'standard' },
    { id: 'watch_3', name: '미밴드', type: 'accessory', emoji: '⌚', tier: 'standard' },
    { id: 'watch_4', name: '핏빗 차지', type: 'accessory', emoji: '⌚', tier: 'pro' },
    { id: 'watch_5', name: '갤럭시 워치', type: 'accessory', emoji: '⌚', tier: 'pro' },
    { id: 'watch_6', name: '애플워치 SE', type: 'accessory', emoji: '⌚', tier: 'pro' },
    { id: 'watch_7', name: '가민 포러너', type: 'accessory', emoji: '⌚', tier: 'prime' },
    { id: 'watch_8', name: '가민 베뉴', type: 'accessory', emoji: '⌚', tier: 'prime' },
    { id: 'watch_9', name: '애플워치 울트라', type: 'accessory', emoji: '⌚', tier: 'prime' },
    { id: 'watch_10', name: '가민 피닉스', type: 'accessory', emoji: '⌚', tier: 'signature' },
    { id: 'watch_11', name: '코로스 버텍스', type: 'accessory', emoji: '⌚', tier: 'signature' },
    { id: 'watch_12', name: '순토 버티컬', type: 'accessory', emoji: '⌚', tier: 'signature' },
    { id: 'ear_1', name: 'QCY', type: 'accessory', emoji: '🎧', tier: 'standard' },
    { id: 'ear_2', name: '샤오미 버즈', type: 'accessory', emoji: '🎧', tier: 'standard' },
    { id: 'ear_3', name: '유선 스포츠 이어폰', type: 'accessory', emoji: '🎧', tier: 'standard' },
    { id: 'ear_4', name: '에어팟', type: 'accessory', emoji: '🎧', tier: 'pro' },
    { id: 'ear_5', name: '갤럭시 버즈', type: 'accessory', emoji: '🎧', tier: 'pro' },
    { id: 'ear_6', name: '제이버드', type: 'accessory', emoji: '🎧', tier: 'pro' },
    { id: 'ear_7', name: '보스 스포츠', type: 'accessory', emoji: '🎧', tier: 'prime' },
    { id: 'ear_8', name: '샥즈 오픈런', type: 'accessory', emoji: '🎧', tier: 'prime' },
    { id: 'ear_9', name: '젠하이저 스포츠', type: 'accessory', emoji: '🎧', tier: 'prime' },
    { id: 'ear_10', name: '샥즈 오픈런 프로', type: 'accessory', emoji: '🎧', tier: 'signature' },
    { id: 'ear_11', name: '보스 울트라', type: 'accessory', emoji: '🎧', tier: 'signature' },
    { id: 'ear_12', name: '소니 XM', type: 'accessory', emoji: '🎧', tier: 'signature' },
    { id: 'bag_1', name: '나이키 슬링백', type: 'accessory', emoji: '🎒', tier: 'standard' },
    { id: 'bag_2', name: '데카트론 백', type: 'accessory', emoji: '🎒', tier: 'standard' },
    { id: 'bag_3', name: '미니 웨이스트백', type: 'accessory', emoji: '🎒', tier: 'standard' },
    { id: 'bag_4', name: '나이키 러닝 베스트', type: 'accessory', emoji: '🎒', tier: 'pro' },
    { id: 'bag_5', name: '살로몬 액티브', type: 'accessory', emoji: '🎒', tier: 'pro' },
    { id: 'bag_6', name: '언더아머 러닝백', type: 'accessory', emoji: '🎒', tier: 'pro' },
    { id: 'bag_7', name: '오스프리 탤런', type: 'accessory', emoji: '🎒', tier: 'prime' },
    { id: 'bag_8', name: '살로몬 ADV 스킨', type: 'accessory', emoji: '🎒', tier: 'prime' },
    { id: 'bag_9', name: '노스페이스 러닝팩', type: 'accessory', emoji: '🎒', tier: 'prime' },
    { id: 'bag_10', name: '아크테릭스 백팩', type: 'accessory', emoji: '🎒', tier: 'signature' },
    { id: 'bag_11', name: '살로몬 S/LAB', type: 'accessory', emoji: '🎒', tier: 'signature' },
    { id: 'bag_12', name: '파타고니아 테크팩', type: 'accessory', emoji: '🎒', tier: 'signature' },
    { id: 'top_1', name: '드라이핏 티', type: 'top', emoji: '👕', tier: 'standard' },
    { id: 'top_2', name: '쿨론 티', type: 'top', emoji: '👕', tier: 'standard' },
    { id: 'top_3', name: '에어리즘', type: 'top', emoji: '👕', tier: 'standard' },
    { id: 'top_4', name: '언더아머 테크핏', type: 'top', emoji: '👕', tier: 'pro' },
    { id: 'top_5', name: '나이키 러닝 탑', type: 'top', emoji: '👕', tier: 'pro' },
    { id: 'top_6', name: '아디다스 에어로레디', type: 'top', emoji: '👕', tier: 'pro' },
    { id: 'top_7', name: '나이키 드라이핏 ADV', type: 'top', emoji: '👕', tier: 'prime' },
    { id: 'top_8', name: '룰루레몬 러닝탑', type: 'top', emoji: '👕', tier: 'prime' },
    { id: 'top_9', name: '파타고니아 러닝탑', type: 'top', emoji: '👕', tier: 'prime' },
    { id: 'top_10', name: '아크테릭스 프로톤', type: 'top', emoji: '👕', tier: 'signature' },
    { id: 'top_11', name: '아크테릭스 코어로프트', type: 'top', emoji: '👕', tier: 'signature' },
    { id: 'top_12', name: '노스페이스 서밋', type: 'top', emoji: '👕', tier: 'signature' },
    { id: 'bottom_1', name: '러닝 쇼츠', type: 'bottom', emoji: '👖', tier: 'standard' },
    { id: 'bottom_2', name: '쿨론 팬츠', type: 'bottom', emoji: '👖', tier: 'standard' },
    { id: 'bottom_3', name: '트레이닝 팬츠', type: 'bottom', emoji: '👖', tier: 'standard' },
    { id: 'bottom_4', name: '나이키 플렉스', type: 'bottom', emoji: '👖', tier: 'pro' },
    { id: 'bottom_5', name: '언더아머 러닝 쇼츠', type: 'bottom', emoji: '👖', tier: 'pro' },
    { id: 'bottom_6', name: '아디다스 러닝 타이츠', type: 'bottom', emoji: '👖', tier: 'pro' },
    { id: 'bottom_7', name: '룰루 서지', type: 'bottom', emoji: '👖', tier: 'prime' },
    { id: 'bottom_8', name: '나이키 ADV 팬츠', type: 'bottom', emoji: '👖', tier: 'prime' },
    { id: 'bottom_9', name: '2XU 컴프레션', type: 'bottom', emoji: '👖', tier: 'prime' },
    { id: 'bottom_10', name: '아크테릭스 감마', type: 'bottom', emoji: '👖', tier: 'signature' },
    { id: 'bottom_11', name: '아크테릭스 러닝 타이츠', type: 'bottom', emoji: '👖', tier: 'signature' },
    { id: 'bottom_12', name: 'CEP 프로라인', type: 'bottom', emoji: '👖', tier: 'signature' },
    { id: 'guard_1', name: '일반 무릎 보호대', type: 'guard', emoji: '🛡', tier: 'standard' },
    { id: 'guard_2', name: '기본 압박 슬리브', type: 'guard', emoji: '🛡', tier: 'standard' },
    { id: 'guard_3', name: '맥데이비드', type: 'guard', emoji: '🛡', tier: 'pro' },
    { id: 'guard_4', name: '나이키 프로', type: 'guard', emoji: '🛡', tier: 'pro' },
    { id: 'guard_5', name: '2XU', type: 'guard', emoji: '🛡', tier: 'prime' },
    { id: 'guard_6', name: '스킨스', type: 'guard', emoji: '🛡', tier: 'prime' },
    { id: 'guard_7', name: 'CEP', type: 'guard', emoji: '🛡', tier: 'signature' },
    { id: 'guard_8', name: 'BV SPORT', type: 'guard', emoji: '🛡', tier: 'signature' },
    { id: 'glove_1', name: '기본 러닝 장갑', type: 'accessory', emoji: '🧤', tier: 'standard' },
    { id: 'glove_2', name: '터치 장갑', type: 'accessory', emoji: '🧤', tier: 'standard' },
    { id: 'glove_3', name: '나이키 러닝글러브', type: 'accessory', emoji: '🧤', tier: 'pro' },
    { id: 'glove_4', name: '언더아머 장갑', type: 'accessory', emoji: '🧤', tier: 'pro' },
    { id: 'glove_5', name: '블랙다이아몬드', type: 'accessory', emoji: '🧤', tier: 'prime' },
    { id: 'glove_6', name: '노스페이스 러닝글러브', type: 'accessory', emoji: '🧤', tier: 'prime' },
    { id: 'glove_7', name: '헤스트라', type: 'accessory', emoji: '🧤', tier: 'signature' },
    { id: 'glove_8', name: '아크테릭스 글러브', type: 'accessory', emoji: '🧤', tier: 'signature' },
    { id: 'outer_1', name: '바람막이', type: 'top', emoji: '🧥', tier: 'standard' },
    { id: 'outer_2', name: '경량 자켓', type: 'top', emoji: '🧥', tier: 'standard' },
    { id: 'outer_3', name: '나이키 러닝 자켓', type: 'top', emoji: '🧥', tier: 'pro' },
    { id: 'outer_4', name: '아디다스 윈드자켓', type: 'top', emoji: '🧥', tier: 'pro' },
    { id: 'outer_5', name: '파타고니아 후디니', type: 'top', emoji: '🧥', tier: 'prime' },
    { id: 'outer_6', name: '노스페이스 플라이트', type: 'top', emoji: '🧥', tier: 'prime' },
    { id: 'outer_7', name: '아크테릭스 알파', type: 'top', emoji: '🧥', tier: 'signature' },
    { id: 'outer_8', name: '아크테릭스 베타', type: 'top', emoji: '🧥', tier: 'signature' },
    { id: 'outer_9', name: '노스페이스 서밋 시리즈', type: 'top', emoji: '🧥', tier: 'signature' }
  ];

  const ROUTES = [
    { id: 'r1', name: '동네 골목', steps: 500, icon: '🏘️', reward: { id: 'shoe_1', name: '레볼루션', type: 'shoes', emoji: '👟', tier: 'standard' } },
    { id: 'r2', name: '작은 공원', steps: 1000, icon: '🌳', reward: { id: 'top_1', name: '드라이핏 티', type: 'top', emoji: '👕', tier: 'standard' } },
    { id: 'r3', name: '시내 산책로', steps: 2000, icon: '🛤️', reward: { id: 'shoe_5', name: '페가수스', type: 'shoes', emoji: '👟', tier: 'pro' } },
    { id: 'r4', name: '강둑 길', steps: 3500, icon: '🌊', reward: { id: 'top_4', name: '언더아머 테크핏', type: 'top', emoji: '👕', tier: 'pro' } },
    { id: 'r5', name: '숲 입구', steps: 5000, icon: '🌲', reward: { id: 'watch_4', name: '핏빗 차지', type: 'accessory', emoji: '⌚', tier: 'pro' } },
    { id: 'r6', name: '호수 둘레길', steps: 7500, icon: '🏞️', reward: { id: 'ear_4', name: '에어팟', type: 'accessory', emoji: '🎧', tier: 'pro' } },
    { id: 'r7', name: '등산로 정상', steps: 10000, icon: '⛰️', reward: { id: 'shoe_14', name: '알파플라이', type: 'shoes', emoji: '👟', tier: 'signature' } }
  ];

  const SLOT_ORDER = ['shoes', 'watch', 'earphones', 'bag', 'top', 'bottom', 'guard', 'glove', 'outer'];
  const SLOT_LABELS = { shoes: '👟 신발', watch: '⌚ 시계/디바이스', earphones: '🎧 이어폰', bag: '🎒 가방/러닝베스트', top: '👕 상의', bottom: '👖 하의', guard: '🛡 보호대/컴프레션', glove: '🧤 장갑', outer: '🧥 아우터' };
  var TIER_WEIGHTS = { standard: 50, pro: 30, prime: 15, signature: 5 };
  /* 걸음 보너스 제거: 목표 걸음/거리 정확도 유지를 위해 step 보너스 없음 */
  var SLOT_BONUS_TYPE = { shoes: 'distance', watch: 'gold', earphones: 'gold', bag: 'xp', top: 'xp', bottom: 'xp', guard: 'xp', glove: 'xp', outer: 'xp' };
  var TIER_PERCENT = { standard: 1, pro: 2, prime: 3, signature: 5 };
  var SLOT_BONUS_LABEL = { xp: 'XP 보너스', distance: '이동 거리', gold: '골드 보너스' };
  function itemSlot(item) {
    if (!item || !item.id) return 'top';
    var id = item.id.replace(/_\d+$/, '');
    if (id.indexOf('shoe') === 0) return 'shoes';
    if (id.indexOf('watch') === 0) return 'watch';
    if (id.indexOf('ear') === 0) return 'earphones';
    if (id.indexOf('bag') === 0) return 'bag';
    if (id.indexOf('outer') === 0) return 'outer';
    if (id.indexOf('top') === 0) return 'top';
    if (id.indexOf('bottom') === 0) return 'bottom';
    if (id.indexOf('guard') === 0) return 'guard';
    if (id.indexOf('glove') === 0) return 'glove';
    var t = item.type;
    if (t === 'shoes') return 'shoes';
    if (t === 'bottom') return 'bottom';
    if (t === 'guard') return 'guard';
    if (t === 'accessory') return 'watch';
    return 'top';
  }
  function getItemIcon(item) {
    if (!item || item.type === 'supply_kit') return '📦';
    var slot = itemSlot(item);
    var icons = { shoes: ['👟','🥾','🏃','⚡','🔥','💨','✨','🌟','⭐','💫','🎯','🏁','👟','🥾','🏃','⚡','🔥'], watch: ['⌚','⌚','⌚','⌚','⌚','⌚','⌚','⌚','⌚','⌚','⌚','⌚'], earphones: ['🎧','🎧','🎧','🎧','🎧','🎧','🎧','🎧','🎧','🎧','🎧','🎧'], bag: ['🎒','🎒','🎒','🎒','🎒','🎒','🎒','🎒','🎒','🎒','🎒','🎒'], top: ['👕','👕','👕','👕','👕','👕','👕','👕','👕','👕','👕','👕'], bottom: ['👖','🩳','👖','🩳','👖','🩳','👖','🩳','👖','🩳','👖','🩳'], guard: ['🛡','🛡','🛡','🛡','🛡','🛡','🛡','🛡'], glove: ['🧤','🧤','🧤','🧤','🧤','🧤','🧤','🧤'], outer: ['🧥','🧥','🧥','🧥','🧥','🧥','🧥','🧥','🧥'] };
    var arr = icons[slot] || ['📦'];
    var baseId = (item.id || '').replace(/_\d+$/, '');
    var h = 0; for (var i = 0; i < baseId.length; i++) h = (h * 31 + baseId.charCodeAt(i)) | 0;
    return arr[Math.abs(h) % arr.length];
  }
  function getEquipmentBonus() {
    var b = { xp: 0, distance: 0, gold: 0, step: 0 };
    SLOT_ORDER.forEach(function(slot) {
      var itemId = equipped[slot];
      var item = itemId ? inventory.find(function(i){ return i.id === itemId; }) : null;
      if (!item) return;
      var pct = TIER_PERCENT[item.tier] || 1;
      var typ = SLOT_BONUS_TYPE[slot];
      if (typ && b[typ] !== undefined) b[typ] += pct;
    });
    return b;
  }
  function pickItemByTierWeight(premium) {
    var w = premium ? { standard: 35, pro: 30, prime: 22, signature: 13 } : TIER_WEIGHTS;
    var r = Math.random() * 100;
    var tier = 'standard';
    if (r < w.standard) tier = 'standard';
    else if (r < w.standard + w.pro) tier = 'pro';
    else if (r < w.standard + w.pro + w.prime) tier = 'prime';
    else tier = 'signature';
    var pool = SUPPLY_POOL.filter(function(i){ return (i.tier || 'standard') === tier; });
    if (pool.length === 0) pool = SUPPLY_POOL;
    return pool[Math.floor(Math.random() * pool.length)];
  }
  function rollRarityPremium() {
    var r = Math.random() * 100;
    if (r < 40) return 'common';
    if (r < 72) return 'rare';
    if (r < 92) return 'epic';
    return 'legend';
  }

  let steps = 0, lastDate = '', lifetimeSteps = 0;
  // 동물 데이터
  const PET_TYPES = [
    { id: 'dog', name: '강아지', emoji: '🐕', description: '충실하고 활발한 친구', color: '#fbbf24' },
    { id: 'cat', name: '고양이', emoji: '🐱', description: '우아하고 독립적인 친구', color: '#f97316' },
    { id: 'lion', name: '사자', emoji: '🦁', description: '용맹하고 당당한 친구', color: '#eab308' },
    { id: 'rabbit', name: '토끼', emoji: '🐰', description: '귀엽고 민첩한 친구', color: '#fda4af' },
    { id: 'bear', name: '곰', emoji: '🐻', description: '힘차고 든든한 친구', color: '#92400e' },
    { id: 'panda', name: '판다', emoji: '🐼', description: '평화롭고 사랑스러운 친구', color: '#ffffff' },
    { id: 'fox', name: '여우', emoji: '🦊', description: '영리하고 교활한 친구', color: '#f97316' },
    { id: 'tiger', name: '호랑이', emoji: '🐯', description: '강인하고 용맹한 친구', color: '#fbbf24' }
  ];
  
  let pet = { type: null, level: 1, exp: 0, name: '' }; // 선택한 동물 정보
  
  let avatar = { name: '산책러', skin: '#f5d0b0', hair: 'short', hairColor: '#4a3728' };
  let inventory = [];
  var storage = [];
  let equipped = { shoes: null, watch: null, earphones: null, bag: null, top: null, bottom: null, guard: null, glove: null, outer: null };
  let claimedRoutes = [];
  var userRoutes = [];
  var activeRouteId = null;
  var activeRouteGoalKm = 0;
  var walkState = 'idle';
  var courseGoalKm = 1;
  var totalXp = 0;
  var pathCoords = [];
  var sessionDistanceKm = 0;
  var sessionXp = 0;
  var watchId = null;
  var lastPositionTime = 0;
  var sessionStartTimeMs = 0;
  var lastSpeedKmh = 0; // 마지막 구간 속도 (km/h)
  var MIN_SEGMENT_KM = 0.005;
  var MAX_SPEED_KMH = 12;
  var tutorialCompleted = false;
  var wildAnimals = []; // 현재 주변에 스폰된 야생 동물들
  var capturedAnimals = []; // 포획한 동물 컬렉션
  var nearbyAnimalsCheckInterval = null;
  var supplyDateToday = '';
  var supplyCountToday = 0;
  var walkMapEl = null;
  var walkMapPathEl = null;
  var walkMapCharEl = null;
  var DEFAULT_BOUNDS = { minLat: 37.4, maxLat: 37.6, minLon: 126.9, maxLon: 127.2 };
  function ourMapBounds(coords) {
    if (!coords || coords.length === 0) return null;
    var minLat = coords[0].lat, maxLat = coords[0].lat, minLon = coords[0].lon, maxLon = coords[0].lon;
    coords.forEach(function(c) {
      if (c.lat < minLat) minLat = c.lat;
      if (c.lat > maxLat) maxLat = c.lat;
      if (c.lon < minLon) minLon = c.lon;
      if (c.lon > maxLon) maxLon = c.lon;
    });
    var padLat = Math.max(0.002, (maxLat - minLat) * 0.15);
    var padLon = Math.max(0.003, (maxLon - minLon) * 0.15);
    return { minLat: minLat - padLat, maxLat: maxLat + padLat, minLon: minLon - padLon, maxLon: maxLon + padLon };
  }
  function ourMapLatLonToXY(lat, lon, bounds, w, h) {
    var x = ((lon - bounds.minLon) / (bounds.maxLon - bounds.minLon)) * w;
    var y = (1 - (lat - bounds.minLat) / (bounds.maxLat - bounds.minLat)) * h;
    return { x: x, y: y };
  }
  var gold = STARTING_GOLD;
  var totalWalkDistanceKm = 0;
  var currentTitleId = 'walker';
  var userProfile = null;
  var isLoggedIn = false;
  var lastAttendanceDate = '';
  var attendanceStreak = 0;

  function todayStr() {
    const d = new Date();
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
  }

  function loadAll() {
    try {
      const saved = localStorage.getItem(STORAGE_KEYS.steps);
      const savedDate = localStorage.getItem(STORAGE_KEYS.date);
      const today = todayStr();
      if (saved != null && savedDate === today) {
        steps = parseInt(saved, 10) || 0;
      } else {
        if (saved != null && savedDate) lifetimeSteps += parseInt(localStorage.getItem(STORAGE_KEYS.steps) || '0', 10);
        steps = 0;
        localStorage.setItem(STORAGE_KEYS.date, today);
      }
      lifetimeSteps = parseInt(localStorage.getItem(STORAGE_KEYS.lifetime) || '0', 10) + steps;
    } catch (e) {}
    try {
      const a = localStorage.getItem(STORAGE_KEYS.avatar);
      if (a) avatar = { ...avatar, ...JSON.parse(a) };
    } catch (e) {}
    try {
      const inv = localStorage.getItem(STORAGE_KEYS.inventory);
      if (inv) inventory = JSON.parse(inv);
    } catch (e) {}
    try {
      const eq = localStorage.getItem(STORAGE_KEYS.equipped);
      if (eq) {
        var parsed = JSON.parse(eq);
        SLOT_ORDER.forEach(function(s) { if (parsed[s] != null) equipped[s] = parsed[s]; });
        if (parsed.accessory != null && equipped.watch == null) equipped.watch = parsed.accessory;
        if (parsed.armor != null && equipped.top == null) equipped.top = parsed.armor;
        if (parsed.weapon != null && equipped.watch == null) equipped.watch = parsed.weapon;
      }
    } catch (e) {}
    try {
      var sd = localStorage.getItem(STORAGE_KEYS.supplyDate);
      var sc = localStorage.getItem(STORAGE_KEYS.supplyCount);
      var today = todayStr();
      if (sd === today && sc != null) {
        supplyDateToday = sd;
        supplyCountToday = parseInt(sc, 10) || 0;
      } else {
        supplyDateToday = today;
        supplyCountToday = 0;
      }
    } catch (e) {}
    try {
      const cr = localStorage.getItem(STORAGE_KEYS.claimed);
      if (cr) claimedRoutes = JSON.parse(cr);
    } catch (e) {}
    try {
      var cg = localStorage.getItem(STORAGE_KEYS.courseGoal);
      if (cg) courseGoalKm = parseFloat(cg) || 1;
      var tx = localStorage.getItem(STORAGE_KEYS.totalXp);
      if (tx) totalXp = parseInt(tx, 10) || 0;
    } catch (e) {}
    try {
      var ur = localStorage.getItem(STORAGE_KEYS.userRoutes);
      if (ur) userRoutes = JSON.parse(ur);
    } catch (e) {}
    try {
      var g = localStorage.getItem(STORAGE_KEYS.gold);
      if (g != null) { gold = parseInt(g, 10); if (gold === 0) gold = 500; }
      else gold = STARTING_GOLD;
    } catch (e) {}
    try {
      var tw = localStorage.getItem(STORAGE_KEYS.totalWalkKm);
      if (tw != null) totalWalkDistanceKm = parseFloat(tw);
    } catch (e) {}
    try {
      var tc = localStorage.getItem(STORAGE_KEYS.tutorialCompleted);
      if (tc === 'true') tutorialCompleted = true;
    } catch (e) {}
    try {
      var wa = localStorage.getItem(STORAGE_KEYS.wildAnimals);
      if (wa) wildAnimals = JSON.parse(wa);
    } catch (e) {}
    try {
      var ca = localStorage.getItem(STORAGE_KEYS.capturedAnimals);
      if (ca) capturedAnimals = JSON.parse(ca);
    } catch (e) {}
    try {
      var ct = localStorage.getItem(STORAGE_KEYS.currentTitle);
      if (ct) currentTitleId = ct;
    } catch (e) {}
    try {
      var st = localStorage.getItem(STORAGE_KEYS.storage);
      if (st) storage = JSON.parse(st);
    } catch (e) {}
    try {
      var qd = localStorage.getItem(STORAGE_KEYS.questDate);
      var today = todayStr();
      if (qd === today) {
        var qc = localStorage.getItem(STORAGE_KEYS.questProgress);
        if (qc) questGachaCount = parseInt(qc, 10) || 0;
        var qcl = localStorage.getItem('walk_quest_claimed');
        if (qcl) questClaimed = JSON.parse(qcl);
      } else {
        questGachaCount = 0;
        questClaimed = {};
      }
    } catch (e) {}
    try {
      var sd = localStorage.getItem(STORAGE_KEYS.sharedDate);
      sharedToday = sd === todayStr();
    } catch (e) {}
    try {
      var ad = localStorage.getItem(STORAGE_KEYS.attendanceDate);
      var as = localStorage.getItem(STORAGE_KEYS.attendanceStreak);
      if (ad) lastAttendanceDate = ad;
      if (as != null) attendanceStreak = parseInt(as, 10) || 0;
    } catch (e) {}
    try {
      var p = localStorage.getItem(STORAGE_KEYS.pet);
      if (p) pet = { ...pet, ...JSON.parse(p) };
    } catch (e) {}
    var th = localStorage.getItem(STORAGE_KEYS.theme);
    if (th === 'morning' || th === 'night') document.body.setAttribute('data-theme', th);
    lastDate = todayStr();
  }

  function saveAll() {
    try {
      localStorage.setItem(STORAGE_KEYS.steps, String(steps));
      localStorage.setItem(STORAGE_KEYS.date, todayStr());
      localStorage.setItem(STORAGE_KEYS.lifetime, String(lifetimeSteps));
      localStorage.setItem(STORAGE_KEYS.tutorialCompleted, tutorialCompleted ? 'true' : 'false');
      localStorage.setItem(STORAGE_KEYS.wildAnimals, JSON.stringify(wildAnimals));
      localStorage.setItem(STORAGE_KEYS.capturedAnimals, JSON.stringify(capturedAnimals));
      localStorage.setItem(STORAGE_KEYS.avatar, JSON.stringify(avatar));
      localStorage.setItem(STORAGE_KEYS.inventory, JSON.stringify(inventory));
      localStorage.setItem(STORAGE_KEYS.equipped, JSON.stringify(equipped));
      localStorage.setItem(STORAGE_KEYS.storage, JSON.stringify(storage));
      localStorage.setItem(STORAGE_KEYS.claimed, JSON.stringify(claimedRoutes));
      localStorage.setItem(STORAGE_KEYS.courseGoal, String(courseGoalKm));
      localStorage.setItem(STORAGE_KEYS.totalXp, String(totalXp));
      if (supplyDateToday) localStorage.setItem(STORAGE_KEYS.supplyDate, supplyDateToday);
      localStorage.setItem(STORAGE_KEYS.supplyCount, String(supplyCountToday));
      localStorage.setItem(STORAGE_KEYS.userRoutes, JSON.stringify(userRoutes));
      localStorage.setItem(STORAGE_KEYS.gold, String(gold));
      localStorage.setItem(STORAGE_KEYS.totalWalkKm, String(totalWalkDistanceKm));
      localStorage.setItem(STORAGE_KEYS.currentTitle, currentTitleId);
      localStorage.setItem(STORAGE_KEYS.tutorialCompleted, tutorialCompleted ? 'true' : 'false');
      localStorage.setItem(STORAGE_KEYS.wildAnimals, JSON.stringify(wildAnimals));
      localStorage.setItem(STORAGE_KEYS.capturedAnimals, JSON.stringify(capturedAnimals));
      localStorage.setItem(STORAGE_KEYS.questDate, todayStr());
      localStorage.setItem(STORAGE_KEYS.questProgress, String(questGachaCount));
      localStorage.setItem('walk_quest_claimed', JSON.stringify(questClaimed));
      if (sharedToday) localStorage.setItem(STORAGE_KEYS.sharedDate, todayStr());
      localStorage.setItem(STORAGE_KEYS.attendanceDate, lastAttendanceDate);
      localStorage.setItem(STORAGE_KEYS.attendanceStreak, String(attendanceStreak));
      localStorage.setItem(STORAGE_KEYS.pet, JSON.stringify(pet));
    } catch (e) {}
    if (isLoggedIn && getAuthToken()) syncGameStateToServer();
  }
  function getGameStatePayload() {
    return {
      steps: steps,
      date: todayStr(),
      lifetimeSteps: lifetimeSteps,
      avatar: avatar,
      pet: pet,
      inventory: inventory,
      equipped: equipped,
      storage: storage,
      claimedRoutes: claimedRoutes,
      courseGoalKm: courseGoalKm,
      totalXp: totalXp,
      supplyDateToday: supplyDateToday,
      supplyCountToday: supplyCountToday,
      userRoutes: userRoutes,
      gold: gold,
      totalWalkDistanceKm: totalWalkDistanceKm,
      currentTitleId: currentTitleId,
      questDate: todayStr(),
      questProgress: questGachaCount,
      questClaimed: questClaimed,
      sharedDate: sharedToday ? todayStr() : '',
      lastAttendanceDate: lastAttendanceDate,
      attendanceStreak: attendanceStreak,
      // 도감을 위한 추가 정보 (향후 확장용)
      userRoutes: userRoutes
    };
  }
  function applyGameState(obj) {
    if (!obj || typeof obj !== 'object') return;
    if (obj.steps != null) steps = obj.steps;
    if (obj.date != null) lastDate = obj.date;
    if (obj.lifetimeSteps != null) lifetimeSteps = obj.lifetimeSteps;
    if (obj.avatar && typeof obj.avatar === 'object') avatar = { ...avatar, ...obj.avatar };
    if (obj.pet && typeof obj.pet === 'object') pet = { ...pet, ...obj.pet };
    if (Array.isArray(obj.inventory)) inventory = obj.inventory;
    if (obj.equipped && typeof obj.equipped === 'object') { Object.keys(obj.equipped).forEach(function (k) { if (obj.equipped[k] != null) equipped[k] = obj.equipped[k]; }); }
    if (Array.isArray(obj.storage)) storage = obj.storage;
    if (Array.isArray(obj.claimedRoutes)) claimedRoutes = obj.claimedRoutes;
    if (obj.courseGoalKm != null) courseGoalKm = obj.courseGoalKm;
    if (obj.totalXp != null) totalXp = obj.totalXp;
    if (obj.supplyDateToday != null) supplyDateToday = obj.supplyDateToday;
    if (obj.supplyCountToday != null) supplyCountToday = obj.supplyCountToday;
    if (Array.isArray(obj.userRoutes)) userRoutes = obj.userRoutes;
    if (obj.gold != null) gold = obj.gold;
    if (obj.totalWalkDistanceKm != null) totalWalkDistanceKm = obj.totalWalkDistanceKm;
    if (obj.currentTitleId != null) currentTitleId = obj.currentTitleId;
    if (obj.questProgress != null) questGachaCount = obj.questProgress;
    if (obj.questClaimed && typeof obj.questClaimed === 'object') questClaimed = obj.questClaimed;
    if (obj.sharedDate != null) sharedToday = obj.sharedDate === todayStr();
    if (obj.lastAttendanceDate != null) lastAttendanceDate = obj.lastAttendanceDate;
    if (obj.attendanceStreak != null) attendanceStreak = obj.attendanceStreak;
    if (obj.pet && typeof obj.pet === 'object') {
      pet = { ...pet, ...obj.pet };
      renderPet();
    }
  }
  function syncGameStateToServer() {
    var token = getAuthToken();
    if (!token) return;
    var payload = getGameStatePayload();
    fetch(API_BASE + '/api/user/data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
      body: JSON.stringify(payload)
    }).catch(function () {});
  }
  function initAuth() {
    var token = getAuthToken();
    if (!token) return Promise.resolve();
    return fetch(API_BASE + '/api/user/me', { headers: { 'Authorization': 'Bearer ' + token } })
      .then(function (r) {
        if (!r.ok) { clearAuthToken(); return null; }
        return r.json();
      })
      .then(function (me) {
        if (!me) return null;
        userProfile = { id: me.id, nickname: me.nickname };
        isLoggedIn = true;
        return fetch(API_BASE + '/api/user/data', { headers: { 'Authorization': 'Bearer ' + token } });
      })
      .then(function (r) {
        if (!r) return null;
        return r.json();
      })
      .then(function (body) {
        if (body && body.data) {
          try {
            var data = typeof body.data === 'string' ? JSON.parse(body.data) : body.data;
            applyGameState(data);
            renderPet();
          } catch (e) {}
        }
      })
      .catch(function () { clearAuthToken(); });
  }

  function addStep() {
    steps++;
    lifetimeSteps++;
    // 동물 경험치 획득 (10걸음당 1 경험치)
    if (steps % 10 === 0 && pet.type) {
      addPetExp(1);
    }
    saveAll();
    renderSteps();
    checkRouteRewards();
    var pw = document.getElementById('page-walk');
    var ps = document.getElementById('page-story');
    if (pw && pw.classList.contains('active')) { renderRoutes(); renderQuests(); }
    if (ps && ps.classList.contains('active')) renderStory();
  }

  function checkRouteRewards() {
    ROUTES.forEach(function (r) {
      if (claimedRoutes.indexOf(r.id) !== -1) return;
      if (lifetimeSteps < r.steps) return;
      claimedRoutes.push(r.id);
      inventory.push({ id: r.reward.id + '_' + Date.now(), name: r.reward.name, type: r.reward.type, emoji: r.reward.emoji, rarity: 'common', enhance: 0, tier: r.reward.tier || 'standard' });
      saveAll();
      showToast('🎁 ' + r.name + '에서 ' + r.reward.name + ' 획득!');
      renderRoutes();
      renderInventory();
      renderStory();
    });
  }

  function showToast(msg) {
    var el = document.getElementById('toast');
    if (!el) return;
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(function () { el.classList.remove('show'); }, 2500);
  }

  function haversineKm(lat1, lon1, lat2, lon2) {
    var R = 6371;
    var dLat = (lat2 - lat1) * Math.PI / 180;
    var dLon = (lon2 - lon1) * Math.PI / 180;
    var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function formatDuration(ms) {
    if (!ms || ms <= 0) return '';
    var totalSec = Math.round(ms / 1000);
    var m = Math.floor(totalSec / 60);
    var s = totalSec % 60;
    return m + '분 ' + (s < 10 ? '0' : '') + s + '초';
  }

  function formatPace(minPerKm) {
    if (!minPerKm || !isFinite(minPerKm) || minPerKm <= 0) return '0:00';
    var totalSec = Math.round(minPerKm * 60);
    var m = Math.floor(totalSec / 60);
    var s = totalSec % 60;
    return m + ':' + (s < 10 ? '0' : '') + s;
  }

  function getDailyKitChance() {
    var n = supplyCountToday + 1;
    if (n <= 3) return 1;
    if (n === 4) return 0.5;
    if (n === 5) return 0.25;
    return 0.1;
  }

  function checkRouteComplete() {
    if (!activeRouteId || sessionDistanceKm < activeRouteGoalKm) return;
    var route = userRoutes.find(function(r) { return r.id === activeRouteId; });
    if (!route || route.completedAt) return;
    var today = todayStr();
    if (today !== supplyDateToday) {
      supplyDateToday = today;
      supplyCountToday = 0;
    }
    var chance = getDailyKitChance();
    var finishTime = Date.now();
    var durationMs = sessionStartTimeMs ? (finishTime - sessionStartTimeMs) : 0;
    if (durationMs > 0) {
      route.lastTimeMs = durationMs;
      if (!route.bestTimeMs || durationMs < route.bestTimeMs) {
        route.bestTimeMs = durationMs;
      }
    }

    if (Math.random() > chance) {
      route.completedAt = finishTime;
      route.path = pathCoords.slice();
      activeRouteId = null;
      activeRouteGoalKm = 0;
      saveAll();
      renderWalk();
      renderRouteSelect();
      showToast('🏁 코스 완주! (보급 키트는 일일 한도에 따라 지급돼요)');
      return;
    }
    supplyCountToday += 1;
    route.completedAt = finishTime;
    route.path = pathCoords.slice();
    activeRouteId = null;
    activeRouteGoalKm = 0;
    storage.push({ id: 'kit_' + Date.now(), type: 'supply_kit', name: '트레이닝 보급 키트', receivedAt: Date.now() });
    saveAll();
    showToast('📦 보급 키트가 보관함에 도착했어요');
    renderWalk();
    renderRouteSelect();
    renderStorage();
    renderQuests();
  }

  function rollRarity() {
    var r = Math.random() * 100;
    if (r < 60) return 'common';
    if (r < 85) return 'rare';
    if (r < 97) return 'epic';
    return 'legend';
  }

  function openSupplyKit() {
    var idx = inventory.findIndex(function (i) { return i.type === 'supply_kit'; });
    if (idx === -1) { showToast('트레이닝 보급 키트가 없어요'); return; }
    inventory.splice(idx, 1);
    openOneSupplyKit();
  }
  function openOneSupplyKit() {
    var item = pickItemByTierWeight();
    var rarity = rollRarity();
    var newItem = { id: item.id + '_' + Date.now(), name: item.name, type: item.type, emoji: item.emoji, rarity: rarity, enhance: 0, tier: item.tier || 'standard' };
    inventory.push(newItem);
    saveAll();
    var rarityLabel = { common: '커먼', rare: '레어', epic: '에픽', legend: '레전드' }[rarity];
    var tierLabel = TIER_LABELS[item.tier] || '스탠다드';
    showToast(getItemIcon(newItem) + ' ' + item.name + ' (' + tierLabel + ' · ' + rarityLabel + ') 획득!');
    renderEquipped();
    renderInventory();
    renderAvatar();
  }
  function moveKitToInventory() {
    if (storage.length === 0) { showToast('보관함에 키트가 없어요'); return; }
    var one = storage.pop();
    inventory.push({ id: 'supply_kit_' + Date.now(), name: '트레이닝 보급 키트', type: 'supply_kit', emoji: '📦' });
    saveAll();
    renderStorage();
    renderInventory();
    showToast('보급 키트를 인벤토리로 가져왔어요');
  }
  function openKitFromStorage() {
    if (storage.length === 0) { showToast('보관함에 키트가 없어요'); return; }
    storage.pop();
    saveAll();
    openOneSupplyKit();
    renderStorage();
  }
  function renderStorage() {
    var wrap = document.getElementById('storageList');
    if (!wrap) return;
    wrap.innerHTML = '';
    if (storage.length === 0) {
      wrap.innerHTML = '<p class="story-text" style="color:var(--text-muted);">보관함이 비어 있어요.<br>산책 코스를 완주하면 보급 키트가 여기로 도착해요.</p>';
      return;
    }
    storage.forEach(function(k, i) {
      var card = document.createElement('div');
      card.className = 'inv-item inv-item-kit';
      card.innerHTML = '<span>📦</span><span class="inv-name">트레이닝 보급 키트</span><div class="storage-actions"><button type="button" class="btn-storage-inv">인벤으로</button><button type="button" class="btn-storage-open">열기</button></div>';
      card.querySelector('.btn-storage-inv').onclick = function() { moveKitToInventory(); };
      card.querySelector('.btn-storage-open').onclick = function() { openKitFromStorage(); };
      wrap.appendChild(card);
    });
  }

  function onPosition(pos) {
    if (walkState !== 'walking') return;
    var lat = pos.coords.latitude;
    var lon = pos.coords.longitude;
    var nowMs = pos.timestamp != null ? pos.timestamp : Date.now();
    if (pathCoords.length > 0) {
      var last = pathCoords[pathCoords.length - 1];
      var seg = haversineKm(last.lat, last.lon, lat, lon);
      if (seg < MIN_SEGMENT_KM) return;
      var timeDeltaH = (nowMs - lastPositionTime) / 3600000;
      if (timeDeltaH > 0) {
        var speedKmh = seg / timeDeltaH;
        if (speedKmh > MAX_SPEED_KMH) return;
        lastSpeedKmh = speedKmh;
      }
      var bonus = getEquipmentBonus();
      var distMult = 1 + (bonus.distance / 100);
      var xpMult = 1 + (bonus.xp / 100);
      sessionDistanceKm += seg * distMult;
      sessionXp = Math.floor(sessionDistanceKm * XP_PER_KM);
      totalXp += Math.floor(seg * XP_PER_KM * xpMult);
      totalWalkDistanceKm += seg * distMult;
      checkRouteComplete();
      saveAll();
      pathCoords.push({ lat: lat, lon: lon });
      lastPositionTime = nowMs;
    } else {
      pathCoords.push({ lat: lat, lon: lon });
      lastPositionTime = nowMs;
      sessionStartTimeMs = nowMs;
    }
    // 야생 동물 스폰 체크 (50m마다)
    checkWildAnimalSpawn(lat, lon);
    renderWalk();
  }
  
  function checkWildAnimalSpawn(lat, lon) {
    // 기존 동물과 너무 가까우면 스킵
    var tooClose = wildAnimals.some(function(animal) {
      return haversineKm(animal.lat, animal.lon, lat, lon) < 0.05; // 50m 이내
    });
    if (tooClose) return;
    
    // 랜덤 스폰 (5% 확률)
    if (Math.random() > 0.05) return;
    
    // 희귀도에 따라 동물 선택
    var rarityRoll = Math.random() * 100;
    var targetRarity = 'common';
    if (rarityRoll < 3) targetRarity = 'legend';
    else if (rarityRoll < 15) targetRarity = 'epic';
    else if (rarityRoll < 40) targetRarity = 'rare';
    
    var availableAnimals = WILD_ANIMALS.filter(function(a) { return a.rarity === targetRarity; });
    if (availableAnimals.length === 0) return;
    
    var animal = availableAnimals[Math.floor(Math.random() * availableAnimals.length)];
    var spawnAnimal = {
      id: 'wild_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      animalId: animal.id,
      name: animal.name,
      emoji: animal.emoji,
      rarity: animal.rarity,
      description: animal.description,
      lat: lat,
      lon: lon,
      spawnTime: Date.now(),
      expiresAt: Date.now() + (5 * 60 * 1000) // 5분 후 사라짐
    };
    
    wildAnimals.push(spawnAnimal);
    saveAll();
    showWildAnimalNearby(spawnAnimal);
  }
  
  function showWildAnimalNearby(animal) {
    var rarityLabel = { common: '커먼', rare: '레어', epic: '에픽', legend: '레전드' }[animal.rarity];
    var rarityColor = { 
      common: 'var(--rarity-common)', 
      rare: 'var(--rarity-rare)', 
      epic: 'var(--rarity-epic)', 
      legend: 'var(--rarity-legend)' 
    }[animal.rarity];
    
    showToast(animal.emoji + ' ' + animal.name + ' (' + rarityLabel + ') 주변에 나타났어요!', 5000);
    
    // 동물 포획 알림 표시
    var notification = document.createElement('div');
    notification.className = 'wild-animal-notification';
    notification.style.cssText = 'position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: var(--card); border: 2px solid ' + rarityColor + '; border-radius: var(--radius-lg); padding: 1rem; z-index: 250; box-shadow: var(--shadow-glow); animation: slideDown 0.3s ease; max-width: 90%;';
    notification.innerHTML = '<div style="text-align: center;"><div style="font-size: 3rem; margin-bottom: 0.5rem;">' + animal.emoji + '</div><div style="font-weight: 600; color: ' + rarityColor + '; margin-bottom: 0.25rem;">' + animal.name + '</div><div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.75rem;">' + rarityLabel + ' · ' + animal.description + '</div><button type="button" class="btn-capture-animal" data-animal-id="' + animal.id + '" style="background: ' + rarityColor + '; color: var(--bg); border: none; border-radius: var(--radius); padding: 0.75rem 1.5rem; font-weight: 600; cursor: pointer; width: 100%;">포획하기</button></div>';
    
    document.body.appendChild(notification);
    
    var captureBtn = notification.querySelector('.btn-capture-animal');
    captureBtn.addEventListener('click', function() {
      captureWildAnimal(animal.id);
      document.body.removeChild(notification);
    });
    
    // 5초 후 자동 제거
    setTimeout(function() {
      if (notification.parentNode) {
        notification.style.animation = 'slideUp 0.3s ease';
        setTimeout(function() {
          if (notification.parentNode) document.body.removeChild(notification);
        }, 300);
      }
    }, 5000);
  }
  
  function captureWildAnimal(animalId) {
    var animal = wildAnimals.find(function(a) { return a.id === animalId; });
    if (!animal) {
      showToast('동물을 찾을 수 없어요.');
      return;
    }
    
    // 포획 확률 (희귀도에 따라)
    var captureRate = { common: 0.9, rare: 0.7, epic: 0.5, legend: 0.3 }[animal.rarity];
    if (Math.random() > captureRate) {
      showToast('포획에 실패했어요. 동물이 도망갔어요!');
      wildAnimals = wildAnimals.filter(function(a) { return a.id !== animalId; });
      saveAll();
      return;
    }
    
    // 포획 성공
    var captured = {
      id: 'captured_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      animalId: animal.animalId,
      name: animal.name,
      emoji: animal.emoji,
      rarity: animal.rarity,
      description: animal.description,
      capturedAt: Date.now()
    };
    
    capturedAnimals.push(captured);
    wildAnimals = wildAnimals.filter(function(a) { return a.id !== animalId; });
    
    var rarityLabel = { common: '커먼', rare: '레어', epic: '에픽', legend: '레전드' }[animal.rarity];
    showToast('🎉 ' + animal.emoji + ' ' + animal.name + ' (' + rarityLabel + ') 포획 성공!');
    
    // 골드 보상
    var goldReward = { common: 10, rare: 30, epic: 100, legend: 500 }[animal.rarity];
    gold += goldReward;
    showToast('💰 +' + goldReward + 'G 획득!');
    
    saveAll();
    renderAnimalCollection();
  }

  function startWalk() {
    var sel = document.getElementById('selectActiveRoute');
    var val = sel ? sel.value : '';
    if (val) {
      var r = userRoutes.find(function(x) { return x.id === val; });
      if (r && !r.completedAt) {
        activeRouteId = r.id;
        activeRouteGoalKm = r.goalKm;
      }
    }
    if (!activeRouteId) {
      showToast('진행할 코스를 선택해 주세요.');
      return;
    }
    if (!navigator.geolocation) { showToast('이 기기는 GPS를 지원하지 않아요'); return; }
    walkState = 'walking';
    pathCoords = [];
    sessionDistanceKm = 0;
    sessionXp = 0;
    sessionStartTimeMs = 0;
    lastSpeedKmh = 0;
    var statusEl = document.getElementById('walkStatus');
    if (statusEl) statusEl.textContent = '위치 확인 중...';
    var opts = { enableHighAccuracy: true, maximumAge: 0, timeout: 20000 };
    navigator.geolocation.getCurrentPosition(
      function (pos) {
        pathCoords.push({ lat: pos.coords.latitude, lon: pos.coords.longitude });
        lastPositionTime = pos.timestamp != null ? pos.timestamp : Date.now();
        watchId = navigator.geolocation.watchPosition(onPosition, function () {}, opts);
        if (statusEl) statusEl.textContent = '산책 중! 걸으면 거리가 누적돼요.';
        var startBtn = document.getElementById('btnWalkStart');
        var stopBtn = document.getElementById('btnWalkStop');
        if (startBtn) startBtn.disabled = true;
        if (stopBtn) stopBtn.disabled = false;
        renderWalk();
      },
      function (err) {
        if (err.code === 1) {
          if (statusEl) statusEl.textContent = '위치 권한을 허용해 주세요.';
          showToast('위치 권한이 필요해요');
          walkState = 'idle';
        } else if (err.code === 3) {
          if (statusEl) statusEl.textContent = '위치 확인 중이에요. 야외에서 시도하거나 잠시 후 다시 눌러 주세요.';
          showToast('시간 초과. 다시 시도해 주세요.');
          walkState = 'idle';
        } else {
          if (statusEl) statusEl.textContent = '위치를 켜고 다시 시도해 주세요.';
          showToast('위치를 켜 주세요.');
          walkState = 'idle';
        }
      },
      opts
    );
  }

  function stopWalk() {
    walkState = 'idle';
    if (watchId != null && navigator.geolocation) navigator.geolocation.clearWatch(watchId);
    watchId = null;
    var startBtn = document.getElementById('btnWalkStart');
    var stopBtn = document.getElementById('btnWalkStop');
    if (startBtn) startBtn.disabled = false;
    if (stopBtn) stopBtn.disabled = true;
    var statusEl = document.getElementById('walkStatus');
    if (statusEl) statusEl.textContent = '이번 산책 ' + sessionDistanceKm.toFixed(2) + ' km, XP +' + sessionXp + ' (총 XP ' + totalXp + ')';
    saveAll();
    renderWalk();
  }

  function renderWalk() {
    var distEl = document.getElementById('walkDistance');
    var xpEl = document.getElementById('walkXp');
    var nextEl = document.getElementById('walkNext');
    var speedEl = document.getElementById('walkSpeed');
    var raceEl = document.getElementById('walkRace');
    if (distEl) distEl.textContent = sessionDistanceKm.toFixed(2);
    if (xpEl) xpEl.textContent = totalXp + (sessionXp > 0 ? ' (+' + sessionXp + ')' : '');
    if (speedEl) speedEl.textContent = lastSpeedKmh.toFixed(1);
    if (nextEl) {
      if (activeRouteId && activeRouteGoalKm > 0) {
        var remain = activeRouteGoalKm - sessionDistanceKm;
        nextEl.textContent = remain <= 0 ? '코스 완주!' : '완주까지 ' + remain.toFixed(2) + ' km';
      } else {
        nextEl.textContent = '코스를 완주하면 보급 키트가 보관함에 도착해요!';
      }
    }
    if (raceEl) {
      raceEl.textContent = '';
      if (activeRouteId && sessionStartTimeMs && sessionDistanceKm > 0) {
        var route = userRoutes.find(function(r){ return r.id === activeRouteId; });
        if (route && route.bestTimeMs && route.goalKm) {
          var now = Date.now();
          var elapsedMs = now - sessionStartTimeMs;
          var currentPaceMinPerKm = (elapsedMs / 60000) / Math.max(sessionDistanceKm, 0.001);
          var bestPaceMinPerKm = (route.bestTimeMs / 60000) / route.goalKm;
          var diffMinPerKm = currentPaceMinPerKm - bestPaceMinPerKm;
          var label = '';
          if (Math.abs(diffMinPerKm) < 0.05) {
            label = '이전 기록과 거의 비슷한 페이스예요.';
          } else if (diffMinPerKm < 0) {
            label = '이전 나보다 더 빠르게 걷는 중이에요! (-' + formatPace(Math.abs(diffMinPerKm)) + '/km)';
          } else {
            label = '이전 기록보다 조금 느려요. (+' + formatPace(diffMinPerKm) + '/km)';
          }
          raceEl.textContent = label;
        }
      }
    }
    var totalKmEl = document.getElementById('walkTotalKm');
    if (totalKmEl) totalKmEl.textContent = totalWalkDistanceKm.toFixed(3);
    var titleObj = getTitleForKm(totalWalkDistanceKm);
    currentTitleId = titleObj.id;
    var titleBadge = document.getElementById('titleBadge');
    if (titleBadge) titleBadge.textContent = titleObj.name;
    renderLevel();
    renderGold();
    updateWalkMap();
  }
  function renderLevel() {
    var info = xpToLevel(totalXp);
    var numEl = document.getElementById('levelNum');
    var barEl = document.getElementById('levelBarFill');
    if (numEl) numEl.textContent = info.level;
    if (barEl) barEl.style.width = (info.need ? (info.current / info.need * 100) : 0) + '%';
  }
  function renderGold() {
    var h = document.getElementById('headerGold');
    var g = document.getElementById('gachaGold');
    var btnGacha = document.getElementById('btnGacha');
    var btnGachaPremium = document.getElementById('btnGachaPremium');
    if (h) h.textContent = gold;
    if (g) g.textContent = gold;
    if (btnGacha) btnGacha.disabled = gold < GACHA_COST;
    if (btnGachaPremium) btnGachaPremium.disabled = gold < GACHA_PREMIUM_COST;
  }
  function renderRouteSelect() {
    var sel = document.getElementById('selectActiveRoute');
    if (!sel) return;
    sel.innerHTML = '<option value="">-- 코스를 선택하세요 --</option>';
    userRoutes.forEach(function(r) {
      var opt = document.createElement('option');
      opt.value = r.id;
      opt.textContent = r.name + ' (' + r.goalKm + ' km)' + (r.completedAt ? ' ✓ 완주' : '');
      opt.disabled = !!r.completedAt;
      sel.appendChild(opt);
    });
  }
  function addNewRoute() {
    var name = document.getElementById('newRouteName');
    var goal = document.getElementById('newRouteGoalKm');
    if (!name || !goal) return;
    var n = (name.value || '').trim();
    var g = parseFloat(goal.value) || 1;
    if (n.length < 1) { showToast('코스 이름을 입력해 주세요.'); return; }
    if (g < 0.5) g = 0.5;
    userRoutes.push({ id: 'r_' + Date.now(), name: n, goalKm: g, path: [], completedAt: null, bestTimeMs: null, lastTimeMs: null });
    saveAll();
    name.value = '';
    goal.value = '1';
    document.getElementById('routeCreateCard').style.display = 'none';
    renderRouteSelect();
    showToast('코스가 추가되었어요.');
  }
  function initWalkMap() {
    if (walkMapPathEl) return;
    var el = document.getElementById('walkMap');
    if (!el) return;
    el.innerHTML = '';
    var w = 400, h = 220;
    var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('viewBox', '0 0 ' + w + ' ' + h);
    svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
    var grid = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    grid.setAttribute('class', 'our-map-grid');
    for (var i = 0; i <= 10; i++) {
      var v = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      v.setAttribute('x1', (i * w / 10));
      v.setAttribute('y1', 0);
      v.setAttribute('x2', (i * w / 10));
      v.setAttribute('y2', h);
      grid.appendChild(v);
      var hor = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      hor.setAttribute('x1', 0);
      hor.setAttribute('y1', (i * h / 10));
      hor.setAttribute('x2', w);
      hor.setAttribute('y2', (i * h / 10));
      grid.appendChild(hor);
    }
    svg.appendChild(grid);
    var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('class', 'our-map-path');
    path.setAttribute('d', '');
    svg.appendChild(path);
    var charG = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    charG.setAttribute('class', 'our-map-char');
    var shadow = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
    shadow.setAttribute('class', 'char-shadow');
    shadow.setAttribute('cx', 0);
    shadow.setAttribute('cy', 10);
    shadow.setAttribute('rx', 12);
    shadow.setAttribute('ry', 4);
    charG.appendChild(shadow);
    var charHead = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    charHead.setAttribute('class', 'char-head');
    charHead.setAttribute('r', 7);
    charHead.setAttribute('cx', 0);
    charHead.setAttribute('cy', -8);
    charG.appendChild(charHead);
    var charBody = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    charBody.setAttribute('class', 'char-body');
    charBody.setAttribute('r', 10);
    charBody.setAttribute('cx', 0);
    charBody.setAttribute('cy', 6);
    charG.appendChild(charBody);
    svg.appendChild(charG);
    el.appendChild(svg);
    var label = document.createElement('span');
    label.className = 'our-map-label';
    label.textContent = '실시간 이동 경로';
    el.appendChild(label);
    walkMapEl = el;
    walkMapPathEl = path;
    walkMapCharEl = charG;
  }
  function updateWalkMap() {
    if (!walkMapPathEl || !walkMapCharEl) return;
    var coords = pathCoords.length ? pathCoords : (activeRouteId ? (userRoutes.find(function(r){ return r.id === activeRouteId; }) || {}).path : []);
    var w = 400, h = 220;
    if (coords.length === 0) {
      walkMapPathEl.setAttribute('d', '');
      walkMapCharEl.setAttribute('transform', 'translate(-1000,-1000)');
      return;
    }
    var bounds = ourMapBounds(coords);
    var pts = coords.map(function(c) { return ourMapLatLonToXY(c.lat, c.lon, bounds, w, h); });
    var d = 'M ' + pts[0].x + ' ' + pts[0].y;
    for (var i = 1; i < pts.length; i++) d += ' L ' + pts[i].x + ' ' + pts[i].y;
    walkMapPathEl.setAttribute('d', d);
    var last = pts[pts.length - 1];
    walkMapCharEl.setAttribute('transform', 'translate(' + last.x + ',' + last.y + ')');
  }

  function renderSteps() {
    var today = todayStr();
    if (today !== lastDate) {
      steps = 0;
      lastDate = today;
      saveAll();
    }
    var stepVal = document.getElementById('stepValue');
    var lifeVal = document.getElementById('lifetimeSteps');
    var progressFill = document.getElementById('progressFill');
    var progressText = document.getElementById('progressText');
    var card = document.getElementById('stepCard');
    if (stepVal) stepVal.textContent = steps.toLocaleString();
    if (lifeVal) lifeVal.textContent = lifetimeSteps.toLocaleString();
    var pct = Math.min(100, (steps / GOAL) * 100);
    if (progressFill) progressFill.style.width = pct + '%';
    if (progressText) progressText.textContent = steps.toLocaleString() + ' / ' + GOAL.toLocaleString();
    if (card) {
      if (steps >= GOAL) card.classList.add('goal-reached');
      else card.classList.remove('goal-reached');
    }
  }

  function switchTab(tabId) {
    document.querySelectorAll('.tab-btn').forEach(function (b) {
      b.classList.toggle('active', b.getAttribute('data-tab') === tabId);
      b.setAttribute('aria-selected', b.getAttribute('data-tab') === tabId ? 'true' : 'false');
    });
    document.querySelectorAll('.page').forEach(function (p) {
      p.classList.toggle('active', p.id === 'page-' + tabId);
    });
    if (tabId === 'walk') {
      renderSteps();
      renderWalk();
      renderRouteSelect();
      renderRoutes();
      renderQuests();
      renderAttendance();
      initWalkMap();
      setTimeout(function () { initWalkMap(); updateWalkMap(); }, 150);
    }
    if (tabId === 'avatar') { renderAvatar(); renderPet(); }
    if (tabId === 'storage') renderStorage();
    if (tabId === 'shop') { renderGold(); }
    if (tabId === 'equipment') { renderEquipped(); renderInventory(); renderEnhanceSelect(); }
    if (tabId === 'story') { renderStory(); renderAchievements(); renderAnimalCollection(); }
  }
  function doGachaPull(premium) {
    var cost = premium ? GACHA_PREMIUM_COST : GACHA_COST;
    if (gold < cost) { showToast('G가 부족해요. (필요: ' + cost + ' G)'); return; }
    gold -= cost;
    var item = pickItemByTierWeight(!!premium);
    var rarity = premium ? rollRarityPremium() : rollRarity();
    var newItem = { id: item.id + '_' + Date.now(), name: item.name, type: item.type, emoji: item.emoji, rarity: rarity, enhance: 0, tier: item.tier || 'standard' };
    inventory.push(newItem);
    questGachaCount += 1;
    saveAll();
    renderGold();
    renderInventory();
    renderQuests();
    var rarityLabel = { common: '커먼', rare: '레어', epic: '에픽', legend: '레전드' }[rarity];
    var tierLabel = TIER_LABELS[item.tier] || '스탠다드';
    showToast(getItemIcon(newItem) + ' ' + item.name + ' (' + tierLabel + ' · ' + rarityLabel + ') 뽑기 성공!');
  }
  function renderEnhanceTable() {
    var tbody = document.getElementById('enhanceTableBody');
    if (!tbody) return;
    tbody.innerHTML = '';
    for (var i = 0; i <= ENHANCE_MAX; i++) {
      var tr = document.createElement('tr');
      var next = i + 1;
      var rate = i < ENHANCE_MAX ? ENHANCE_RATES[i] : 0;
      var failText = i < 4 ? '장비 파괴' : (i < ENHANCE_MAX ? '시도 시 ' + ENHANCE_ATTEMPT_GOLD[i] + ' G' : '최대 강화');
      var col1 = i < ENHANCE_MAX ? ('+' + i + ' → +' + next) : ('+' + i + ' (최대)');
      var rateClass = rate >= 75 ? 'rate-ok' : (rate >= 45 ? 'rate-mid' : 'rate-low');
      tr.innerHTML = '<td class="enhance-col">' + col1 + '</td><td class="' + rateClass + '">' + (i < ENHANCE_MAX ? rate + '%' : '-') + '</td><td>' + failText + '</td>';
      tbody.appendChild(tr);
    }
  }
  function renderEnhanceSelect() {
    renderEnhanceTable();
    var sel = document.getElementById('enhanceSelect');
    if (!sel) return;
    sel.innerHTML = '<option value="">-- 장비 선택 --</option>';
    inventory.forEach(function(item) {
      if (item.type === 'supply_kit') return;
      var enh = item.enhance != null ? item.enhance : 0;
      var opt = document.createElement('option');
      opt.value = item.id;
      opt.textContent = (item.emoji || '') + ' ' + item.name + ' +' + enh + (enh >= ENHANCE_MAX ? ' (최대)' : '');
      sel.appendChild(opt);
    });
  }
  function tryEnhance() {
    var sel = document.getElementById('enhanceSelect');
    if (!sel || !sel.value) { showToast('강화할 장비를 선택해 주세요.'); return; }
    var item = inventory.find(function(i){ return i.id === sel.value; });
    if (!item) { showToast('장비를 찾을 수 없어요.'); return; }
    var enh = item.enhance != null ? item.enhance : 0;
    if (enh >= ENHANCE_MAX) { showToast('이미 최대 강화(+7)입니다.'); return; }
    var attemptGold = ENHANCE_ATTEMPT_GOLD[enh];
    if (attemptGold > 0) {
      if (gold < attemptGold) { showToast('강화 시도에 ' + attemptGold + ' G가 필요해요.'); return; }
      gold -= attemptGold;
      saveAll();
      renderGold();
    }
    var successRate = ENHANCE_RATES[enh];
    if (Math.random() * 100 >= successRate) {
      if (enh < 4) {
        var idx = inventory.indexOf(item);
        inventory.splice(idx, 1);
        saveAll();
        renderEnhanceSelect();
        renderInventory();
        renderEquipped();
        renderAvatar();
        showToast('강화 실패... ' + item.name + '이(가) 파괴되었어요.');
      } else {
        renderEnhanceSelect();
        showToast('강화 실패. (장비 유지, 시도 비용 ' + attemptGold + ' G 소모)');
      }
      return;
    }
    item.enhance = enh + 1;
    saveAll();
    renderEnhanceSelect();
    renderInventory();
    showToast(item.name + ' +' + (enh + 1) + ' 강화 성공!');
  }
  function renderAchievements() {
    var grid = document.getElementById('achievementGrid');
    if (!grid) return;
    grid.innerHTML = '';
    ACHIEVEMENTS.forEach(function(a) {
      var unlocked = a.check();
      var div = document.createElement('div');
      div.className = 'achievement-item' + (unlocked ? ' unlocked' : ' locked');
      div.innerHTML = '<span class="ach-icon">' + a.icon + '</span><div><span class="ach-name">' + a.name + '</span><div class="ach-desc">' + a.desc + '</div></div>';
      grid.appendChild(div);
    });
  }

  function renderQuests() {
    var list = document.getElementById('questList');
    if (!list) return;
    list.innerHTML = '';
    DAILY_QUESTS.forEach(function(q) {
      var progress = q.getProgress();
      var done = progress >= q.goal;
      var claimed = questClaimed[q.id];
      var item = document.createElement('div');
      item.className = 'quest-item' + (claimed ? ' done' : '');
      var progressText = q.goal === 1 ? (progress + ' / ' + q.goal) : (progress.toLocaleString() + ' / ' + q.goal.toLocaleString());
      if (claimed) {
        item.innerHTML = '<div class="quest-info"><span class="quest-name">' + q.name + '</span><div class="quest-progress">' + q.desc + '</div></div><span class="quest-done-label">✓ 완료</span>';
      } else if (done) {
        item.innerHTML = '<div class="quest-info"><span class="quest-name">' + q.name + '</span><div class="quest-progress">' + progressText + '</div></div><span class="quest-reward">+' + q.reward + ' G</span><button type="button" class="btn-claim" data-quest="' + q.id + '">보상 수령</button>';
      } else {
        item.innerHTML = '<div class="quest-info"><span class="quest-name">' + q.name + '</span><div class="quest-progress">' + progressText + '</div></div><span class="quest-reward">+' + q.reward + ' G</span>';
      }
      list.appendChild(item);
    });
    list.querySelectorAll('.btn-claim').forEach(function(btn) {
      btn.addEventListener('click', function() { claimQuest(this.getAttribute('data-quest')); });
    });
  }
  function claimQuest(questId) {
    var q = DAILY_QUESTS.find(function(x){ return x.id === questId; });
    if (!q || questClaimed[questId]) return;
    if (q.getProgress() < q.goal) { showToast('아직 목표를 달성하지 못했어요'); return; }
    questClaimed[questId] = true;
    gold += q.reward;
    saveAll();
    renderQuests();
    renderGold();
    showToast('+' + q.reward + ' G 획득!');
  }
  function doShare() {
    var url = location.href;
    var text = 'WalkStory - 걸음으로 키우는 나만의 동물 친구';
    if (navigator.share) {
      navigator.share({ title: 'WalkStory', text: text, url: url }).then(function() {
        onShareSuccess();
      }).catch(function() { onShareSuccess(); });
    } else {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(function() { onShareSuccess(); }).catch(function() { onShareSuccess(); });
      } else { onShareSuccess(); }
    }
  }
  function onShareSuccess() {
    if (sharedToday) { showToast('오늘은 이미 공유 보상을 받았어요'); return; }
    sharedToday = true;
    gold += 40;
    saveAll();
    renderGold();
    renderQuests();
    showToast('공유 감사해요! +40 G');
  }
  function renderHeaderAuth() {
    var btn = document.getElementById('btnHeaderAuth');
    var logoutBtn = document.getElementById('btnLogout');
    if (!btn) return;
    if (isLoggedIn && userProfile && userProfile.nickname) {
      btn.textContent = userProfile.nickname;
      btn.classList.add('logged-in');
      btn.setAttribute('aria-label', '프로필');
      if (logoutBtn) {
        logoutBtn.style.display = 'block';
      }
    } else {
      btn.textContent = '🔐 로그인';
      btn.classList.remove('logged-in');
      btn.setAttribute('aria-label', '로그인');
      if (logoutBtn) {
        logoutBtn.style.display = 'none';
      }
    }
    renderAuthGate();
  }
  function renderAuthGate() {
    var appMain = document.getElementById('appMain');
    var authOverlay = document.getElementById('authOverlay');
    if (!appMain || !authOverlay) return;
    if (isLoggedIn) {
      appMain.classList.remove('hidden');
      authOverlay.style.display = 'none';
      authOverlay.classList.remove('auth-gate');
    } else {
      appMain.classList.add('hidden');
      authOverlay.style.display = 'flex';
      authOverlay.classList.add('auth-gate');
    }
  }
  function openAuthModal() {
    var overlay = document.getElementById('authOverlay');
    if (overlay) { overlay.style.display = 'flex'; overlay.classList.remove('auth-gate'); }
    document.getElementById('authLoginPanel').style.display = 'block';
    document.getElementById('authSignupPanel').style.display = 'none';
    document.querySelectorAll('.auth-tab').forEach(function(t){ t.classList.remove('active'); if (t.getAttribute('data-auth-tab') === 'login') t.classList.add('active'); });
    document.getElementById('authTitle').textContent = '로그인';
  }
  function closeAuthModal() {
    var overlay = document.getElementById('authOverlay');
    if (overlay && isLoggedIn) {
      // 페이드아웃 애니메이션
      overlay.classList.add('fade-out');
      setTimeout(function() {
        overlay.style.display = 'none';
        overlay.classList.remove('fade-out');
      }, 300);
    }
    if (overlay && !isLoggedIn) { 
      overlay.style.display = 'flex'; 
      overlay.classList.add('auth-gate'); 
    }
  }
  
  function showWelcomeModal(nickname) {
    var modal = document.getElementById('welcomeModal');
    var title = document.getElementById('welcomeTitle');
    var message = document.getElementById('welcomeMessage');
    if (modal && title && message) {
      title.textContent = nickname ? nickname + '님 환영합니다!' : '환영합니다!';
      message.textContent = 'WalkStory와 함께 걸어요!';
      modal.classList.add('show');
    }
  }
  
  function hideWelcomeModal() {
    var modal = document.getElementById('welcomeModal');
    if (modal) {
      modal.classList.remove('show');
    }
    // 튜토리얼이 완료되지 않았으면 표시
    if (!tutorialCompleted && isLoggedIn) {
      setTimeout(function() {
        showTutorial();
      }, 500);
    }
  }
  
  var tutorialSteps = [
    { icon: '👋', title: 'WalkStory에 오신 것을 환영합니다!', text: '걸음으로 키우는 나만의 동물 친구와 함께 산책을 즐겨보세요.' },
    { icon: '🚶', title: '산책 시작하기', text: '산책 탭에서 코스를 선택하고 "산책 시작" 버튼을 눌러보세요. GPS로 이동 거리가 자동으로 기록됩니다.' },
    { icon: '🦋', title: '야생 동물 포획하기', text: '산책 중 주변에 나타나는 동물을 발견하면 포획할 수 있어요! 희귀한 동물일수록 골드 보상이 큽니다.' },
    { icon: '📦', title: '보급 키트 받기', text: '코스를 완주하면 보급 키트를 받을 수 있어요. 장비를 뽑아 캐릭터를 강화하세요!' },
    { icon: '🎯', title: '퀘스트 완료하기', text: '매일 새로운 퀘스트가 주어집니다. 완료하면 골드를 받을 수 있어요.' },
    { icon: '🏆', title: '업적 달성하기', text: '다양한 업적을 달성하고 스토리 탭에서 컬렉션을 확인해보세요!' }
  ];
  var currentTutorialStep = 0;
  
  function showTutorial() {
    var modal = document.getElementById('tutorialModal');
    if (!modal) return;
    currentTutorialStep = 0;
    updateTutorialSlide();
    modal.style.display = 'flex';
  }
  
  function hideTutorial() {
    var modal = document.getElementById('tutorialModal');
    if (modal) modal.style.display = 'none';
    tutorialCompleted = true;
    saveAll();
  }
  
  function updateTutorialSlide() {
    var slide = tutorialSteps[currentTutorialStep];
    if (!slide) {
      hideTutorial();
      return;
    }
    
    var iconEl = document.getElementById('tutorialIcon');
    var titleEl = document.getElementById('tutorialTitle');
    var textEl = document.getElementById('tutorialText');
    var progressEl = document.getElementById('tutorialProgress');
    var prevBtn = document.getElementById('btnTutorialPrev');
    var nextBtn = document.getElementById('btnTutorialNext');
    
    if (iconEl) iconEl.textContent = slide.icon;
    if (titleEl) titleEl.textContent = slide.title;
    if (textEl) textEl.textContent = slide.text;
    if (progressEl) progressEl.textContent = (currentTutorialStep + 1) + ' / ' + tutorialSteps.length;
    if (prevBtn) prevBtn.style.display = currentTutorialStep === 0 ? 'none' : 'block';
    if (nextBtn) nextBtn.textContent = currentTutorialStep === tutorialSteps.length - 1 ? '시작하기' : '다음';
  }
  
  function nextTutorialStep() {
    if (currentTutorialStep < tutorialSteps.length - 1) {
      currentTutorialStep++;
      updateTutorialSlide();
    } else {
      hideTutorial();
    }
  }
  
  function prevTutorialStep() {
    if (currentTutorialStep > 0) {
      currentTutorialStep--;
      updateTutorialSlide();
    }
  }
  
  // 야생 동물 만료 체크
  function checkExpiredWildAnimals() {
    var now = Date.now();
    wildAnimals = wildAnimals.filter(function(animal) {
      return animal.expiresAt > now;
    });
    saveAll();
  }
  
  function showAuthLoading() {
    var loading = document.getElementById('authLoading');
    var overlay = document.getElementById('authOverlay');
    if (loading) loading.classList.add('active');
    if (overlay) overlay.style.display = 'flex';
  }
  
  function hideAuthLoading() {
    var loading = document.getElementById('authLoading');
    if (loading) loading.classList.remove('active');
  }
  function doLogin() {
    var nick = (document.getElementById('authLoginNick') || {}).value.trim();
    var pw = (document.getElementById('authLoginPw') || {}).value;
    if (!nick || !pw) { showToast('닉네임과 비밀번호를 입력해 주세요.'); return; }
    var url = API_BASE + '/api/auth/login';
    console.log('Login attempt:', { url: url, API_BASE: API_BASE, location: typeof location !== 'undefined' ? location.href : 'N/A', isCapacitorApp: typeof window !== 'undefined' && window.isCapacitorApp });
    
    // 모바일 앱에서 네트워크 요청 시 타임아웃 설정
    var fetchOptions = {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nickname: nick, password: pw }),
      mode: 'cors',
      credentials: 'omit'
    };
    
    // 타임아웃 추가 (30초)
    var timeoutPromise = new Promise(function(_, reject) {
      setTimeout(function() {
        reject(new Error('요청 시간 초과 (30초)'));
      }, 30000);
    });
    
    Promise.race([
      fetch(url, fetchOptions),
      timeoutPromise
    ]).then(function (r) {
      console.log('Login response status:', r.status, 'URL:', r.url);
      if (!r.ok) {
        return r.text().then(function (text) {
          console.error('Login error response:', text);
          try { return { ok: false, body: JSON.parse(text) }; }
          catch { return { ok: false, body: { error: 'HTTP ' + r.status + ': ' + text.substring(0, 50) } }; }
        });
      }
      return r.json().then(function (j) { 
        console.log('Login success:', { userId: j.user?.id, nickname: j.user?.nickname });
        return { ok: true, body: j }; 
      });
    })
      .then(function (x) {
        if (!x || !x.ok) { 
          var errorMsg = x && x.body && x.body.error ? x.body.error : '로그인에 실패했어요.';
          console.error('Login failed:', x);
          showToast(errorMsg);
          return; 
        }
        setAuthToken(x.body.token);
        userProfile = x.body.user;
        isLoggedIn = true;
        return fetch(API_BASE + '/api/user/data', { headers: { 'Authorization': 'Bearer ' + x.body.token } });
      })
      .then(function (r) {
        if (!r) return;
        if (!r.ok) {
          console.warn('User data fetch failed:', r.status);
          return null;
        }
        return r.json();
      })
      .then(function (body) {
        if (body && body.data) {
          try {
            var data = typeof body.data === 'string' ? JSON.parse(body.data) : body.data;
            applyGameState(data);
            renderPet();
          } catch (e) {
            console.error('Failed to parse user data:', e);
          }
        }
        saveAll();
        closeAuthModal();
        setTimeout(function() {
          renderHeaderAuth();
          renderAuthGate();
          renderPet();
          renderAttendance();
          var card = document.getElementById('attendanceCard');
          if (card) card.style.display = 'block';
          if (userProfile && userProfile.nickname) {
            showWelcomeModal(userProfile.nickname);
          } else {
            showWelcomeModal();
          }
        }, 300);
      })
      .catch(function (err) {
        console.error('Login error:', err);
        console.error('Error details:', { 
          message: err.message, 
          name: err.name, 
          stack: err.stack,
          url: url, 
          API_BASE: API_BASE,
          location: typeof location !== 'undefined' ? location.href : 'N/A',
          isCapacitorApp: typeof window !== 'undefined' && window.isCapacitorApp,
          online: navigator.onLine,
          userAgent: navigator.userAgent
        });
        var errorMsg = '서버에 연결할 수 없어요.';
        if (err.message && err.message.includes('Failed to fetch')) {
          // 모바일 앱에서 네트워크 오류인 경우 더 자세한 정보 제공
          if (typeof window !== 'undefined' && window.isCapacitorApp) {
            errorMsg = '모바일 앱 네트워크 오류: ' + API_BASE + '에 연결할 수 없어요. 인터넷 연결을 확인해 주세요.';
          } else {
            errorMsg = '네트워크 연결을 확인해 주세요. (API: ' + API_BASE + ')';
          }
        } else if (err.message && err.message.includes('요청 시간 초과')) {
          errorMsg = '서버 응답 시간이 초과되었어요. 다시 시도해 주세요.';
        } else if (err.message) {
          errorMsg = '오류: ' + err.message;
        }
        showToast(errorMsg);
      });
  }
  function doSignup() {
    var nick = (document.getElementById('authSignupNick') || {}).value.trim();
    var email = (document.getElementById('authSignupEmail') || {}).value.trim();
    var pw = (document.getElementById('authSignupPw') || {}).value;
    var pw2 = (document.getElementById('authSignupPw2') || {}).value;
    if (!nick || nick.length < 2) { showToast('닉네임은 2자 이상이에요.'); return; }
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showToast('올바른 이메일을 입력해 주세요.'); return; }
    if (!pw || pw.length < 6) { showToast('비밀번호는 6자 이상이에요.'); return; }
    if (pw !== pw2) { showToast('비밀번호가 일치하지 않아요.'); return; }
    var url = API_BASE + '/api/auth/signup';
    console.log('Signup attempt:', { url: url, API_BASE: API_BASE });
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nickname: nick, password: pw, email: email })
    }).then(function (r) {
      console.log('Signup response status:', r.status);
      if (!r.ok) {
        return r.text().then(function (text) {
          console.error('Signup error response:', text);
          try { return { ok: false, body: JSON.parse(text) }; }
          catch { return { ok: false, body: { error: 'HTTP ' + r.status + ': ' + text.substring(0, 50) } }; }
        });
      }
      return r.json().then(function (j) { 
        console.log('Signup success:', { userId: j.user?.id, nickname: j.user?.nickname });
        return { ok: true, body: j }; 
      });
    })
      .then(function (x) {
        if (!x || !x.ok) { 
          var errorMsg = x && x.body && x.body.error ? x.body.error : '가입에 실패했어요.';
          console.error('Signup failed:', x);
          showToast(errorMsg);
          return; 
        }
        setAuthToken(x.body.token);
        userProfile = x.body.user;
        isLoggedIn = true;
        saveAll();
        closeAuthModal();
        setTimeout(function() {
          renderHeaderAuth();
          renderAuthGate();
          renderPet();
          renderAttendance();
          var card = document.getElementById('attendanceCard');
          if (card) card.style.display = 'block';
          if (userProfile && userProfile.nickname) {
            showWelcomeModal(userProfile.nickname);
          } else {
            showWelcomeModal();
          }
        }, 300);
      })
      .catch(function (err) {
        console.error('Signup error:', err);
        console.error('Error details:', { 
          message: err.message, 
          name: err.name, 
          stack: err.stack,
          url: url, 
          API_BASE: API_BASE,
          location: typeof location !== 'undefined' ? location.href : 'N/A',
          isCapacitorApp: typeof window !== 'undefined' && window.isCapacitorApp,
          online: navigator.onLine,
          userAgent: navigator.userAgent
        });
        var errorMsg = '서버에 연결할 수 없어요.';
        if (err.message && err.message.includes('Failed to fetch')) {
          // 모바일 앱에서 네트워크 오류인 경우 더 자세한 정보 제공
          if (typeof window !== 'undefined' && window.isCapacitorApp) {
            errorMsg = '모바일 앱 네트워크 오류: ' + API_BASE + '에 연결할 수 없어요. 인터넷 연결을 확인해 주세요.';
          } else {
            errorMsg = '네트워크 연결을 확인해 주세요. (API: ' + API_BASE + ')';
          }
        } else if (err.message && err.message.includes('요청 시간 초과')) {
          errorMsg = '서버 응답 시간이 초과되었어요. 다시 시도해 주세요.';
        } else if (err.message) {
          errorMsg = '오류: ' + err.message;
        }
        showToast(errorMsg);
      });
  }
  function doFindId() {
    var email = (document.getElementById('authFindIdEmail') || {}).value.trim();
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      showToast('올바른 이메일을 입력해 주세요.'); return;
    }
    var url = API_BASE + '/api/auth/find-id';
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: email })
    }).then(function (r) {
      if (!r.ok) {
        return r.text().then(function (text) {
          try { return { ok: false, body: JSON.parse(text) }; }
          catch { return { ok: false, body: { error: 'HTTP ' + r.status + ': ' + text.substring(0, 50) } }; }
        });
      }
      return r.json().then(function (j) { return { ok: true, body: j }; });
    }).then(function (x) {
      var resultDiv = document.getElementById('findIdResult');
      if (!x.ok) {
        if (resultDiv) {
          resultDiv.style.display = 'block';
          resultDiv.innerHTML = '<div style="color: #ef4444;">' + (x.body.error || '아이디 찾기에 실패했어요.') + '</div>';
        } else {
          showToast(x.body.error || '아이디 찾기에 실패했어요.');
        }
        return;
      }
      if (resultDiv) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div style="color: var(--accent);">닉네임: <strong>' + x.body.fullNickname + '</strong></div>';
      }
    }).catch(function (err) {
      console.error('Find ID error:', err);
      showToast('서버에 연결할 수 없어요.');
    });
  }
  function doFindPw() {
    var email = (document.getElementById('authFindPwEmail') || {}).value.trim();
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      showToast('올바른 이메일을 입력해 주세요.'); return;
    }
    var url = API_BASE + '/api/auth/reset-password-request';
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: email })
    }).then(function (r) {
      if (!r.ok) {
        return r.text().then(function (text) {
          try { return { ok: false, body: JSON.parse(text) }; }
          catch { return { ok: false, body: { error: 'HTTP ' + r.status + ': ' + text.substring(0, 50) } }; }
        });
      }
      return r.json().then(function (j) { return { ok: true, body: j }; });
    }).then(function (x) {
      var resultDiv = document.getElementById('findPwResult');
      var resetPanel = document.getElementById('authResetPwPanel');
      if (!x.ok) {
        if (resultDiv) {
          resultDiv.style.display = 'block';
          resultDiv.innerHTML = '<div style="color: #ef4444;">' + (x.body.error || '비밀번호 재설정 요청에 실패했어요.') + '</div>';
        } else {
          showToast(x.body.error || '비밀번호 재설정 요청에 실패했어요.');
        }
        return;
      }
      if (resultDiv) {
        resultDiv.style.display = 'block';
        var msg = x.body.message || '비밀번호 재설정 링크를 발송했어요.';
        if (x.body.resetToken) {
          msg += '<br><small style="color: var(--text-muted); margin-top: 0.5rem; display: block;">개발 모드: 토큰 = ' + x.body.resetToken + '</small>';
        }
        resultDiv.innerHTML = '<div style="color: var(--accent);">' + msg + '</div>';
      }
      if (resetPanel && x.body.resetToken) {
        resetPanel.style.display = 'block';
        document.getElementById('authResetToken').value = x.body.resetToken;
      }
    }).catch(function (err) {
      console.error('Find PW error:', err);
      showToast('서버에 연결할 수 없어요.');
    });
  }
  function doResetPw() {
    var token = (document.getElementById('authResetToken') || {}).value.trim();
    var pw = (document.getElementById('authResetPw') || {}).value;
    var pw2 = (document.getElementById('authResetPw2') || {}).value;
    if (!token) { showToast('토큰을 입력해 주세요.'); return; }
    if (!pw || pw.length < 6) { showToast('비밀번호는 6자 이상이에요.'); return; }
    if (pw !== pw2) { showToast('비밀번호가 일치하지 않아요.'); return; }
    var url = API_BASE + '/api/auth/reset-password';
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token: token, newPassword: pw })
    }).then(function (r) {
      if (!r.ok) {
        return r.text().then(function (text) {
          try { return { ok: false, body: JSON.parse(text) }; }
          catch { return { ok: false, body: { error: 'HTTP ' + r.status + ': ' + text.substring(0, 50) } }; }
        });
      }
      return r.json().then(function (j) { return { ok: true, body: j }; });
    }).then(function (x) {
      if (!x.ok) {
        showToast(x.body.error || '비밀번호 재설정에 실패했어요.');
        return;
      }
      showToast('비밀번호가 재설정되었어요. 로그인해 주세요.');
      switchAuthTab('login');
    }).catch(function (err) {
      console.error('Reset PW error:', err);
      showToast('서버에 연결할 수 없어요.');
    });
  }
  function doSocialLogin(provider) {
    // 카카오/구글 OAuth는 프론트엔드에서 처리하고, 백엔드에 사용자 정보 전송
    if (provider === 'kakao') {
      // 카카오 로그인 (Kakao SDK 필요)
      if (typeof Kakao === 'undefined') {
        showToast('카카오 SDK가 로드되지 않았어요. 카카오 개발자 앱 설정이 필요해요.');
        return;
      }
      // 로딩 표시
      showAuthLoading();
      Kakao.Auth.login({
        // 닉네임만 요청 (이메일은 권한 없음 상태이므로 제외)
        scope: 'profile_nickname',
        success: function(authObj) {
          Kakao.API.request({
            url: '/v2/user/me',
            success: function(res) {
              console.log('Kakao API response:', res);
              console.log('Kakao account:', res.kakao_account);
              console.log('Properties:', res.properties);
              try {
                var socialId = res.id ? res.id.toString() : null;
                if (!socialId) {
                  showToast('카카오 사용자 정보를 가져올 수 없어요.');
                  return;
                }
                
                // 닉네임 추출 (안전하게 - 여러 경로 확인)
                var nickname = '카카오사용자' + Math.floor(Math.random() * 1000); // 기본값에 랜덤 숫자 추가
                if (res.kakao_account) {
                  if (res.kakao_account.profile && res.kakao_account.profile.nickname) {
                    nickname = res.kakao_account.profile.nickname;
                  } else if (res.kakao_account.profile_nickname) {
                    nickname = res.kakao_account.profile_nickname;
                  }
                }
                if (res.properties) {
                  if (res.properties.nickname) {
                    nickname = res.properties.nickname;
                  }
                }
                
                // 이메일은 권한 없음이므로 null로 설정
                var email = null;
                
                console.log('Extracted nickname:', nickname, 'socialId:', socialId);
                sendSocialLogin(provider, socialId, nickname, email);
              } catch (err) {
                console.error('Kakao API response processing error:', err);
                showToast('카카오 사용자 정보 처리 중 오류가 났어요.');
              }
            },
            fail: function(err) {
              console.error('Kakao API error:', err);
              hideAuthLoading();
              showToast('카카오 사용자 정보를 가져올 수 없어요: ' + (err.error_description || err.error || '알 수 없는 오류'));
            }
          });
        },
        fail: function(err) {
          console.error('Kakao Auth error:', err);
          hideAuthLoading();
          showToast('카카오 로그인에 실패했어요: ' + (err.error_description || err.error || '알 수 없는 오류'));
        }
      });
    } else if (provider === 'google') {
      // 구글 로그인 (Google Sign-In API 필요)
      if (typeof gapi === 'undefined') {
        showToast('구글 SDK가 로드되지 않았어요. Google OAuth 설정이 필요해요.');
        return;
      }
      var googleClientId = (typeof window !== 'undefined' && window.APP_CONFIG && window.APP_CONFIG.google) 
        ? window.APP_CONFIG.google.clientId 
        : 'YOUR_GOOGLE_CLIENT_ID';
      if (googleClientId === 'YOUR_GOOGLE_CLIENT_ID') {
        showToast('구글 클라이언트 ID가 설정되지 않았어요.');
        return;
      }
      gapi.load('auth2', function() {
        gapi.auth2.init({
          client_id: googleClientId
        }).then(function() {
          var authInstance = gapi.auth2.getAuthInstance();
          authInstance.signIn().then(function(googleUser) {
            var profile = googleUser.getBasicProfile();
            var socialId = profile.getId();
            var nickname = profile.getName() || '구글사용자';
            var email = profile.getEmail() || null;
            sendSocialLogin(provider, socialId, nickname, email);
          }).catch(function(err) {
            console.error('Google Sign-In error:', err);
            showToast('구글 로그인에 실패했어요.');
          });
        });
      });
    }
  }
  function sendSocialLogin(provider, socialId, nickname, email) {
    console.log('sendSocialLogin called:', { provider, socialId: socialId?.substring(0, 10) + '...', nickname: nickname?.substring(0, 20), email: email ? 'provided' : 'null' });
    var url = API_BASE + '/api/auth/social';
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ provider: provider, socialId: socialId, nickname: nickname, email: email })
    }).then(function (r) {
      console.log('Social login response status:', r.status);
      if (!r.ok) {
        return r.text().then(function (text) {
          console.error('Social login error response:', text);
          try { 
            var parsed = JSON.parse(text);
            console.error('Parsed error:', parsed);
            return { ok: false, body: parsed, status: r.status }; 
          }
          catch { 
            console.error('Failed to parse error response:', text);
            return { ok: false, body: { error: 'HTTP ' + r.status + ': ' + text.substring(0, 100) }, status: r.status }; 
          }
        });
      }
      return r.json().then(function (j) { 
        console.log('Social login success:', { userId: j.user?.id, nickname: j.user?.nickname });
        return { ok: true, body: j }; 
      });
    }).catch(function(err) {
      console.error('sendSocialLogin fetch error:', err);
      return { ok: false, body: { error: '네트워크 오류: ' + err.message } };
    }).then(function (x) {
      if (!x || !x.ok) {
        hideAuthLoading();
        var errorMsg = x && x.body && x.body.error ? x.body.error : '소셜 로그인에 실패했어요.';
        if (x && x.body && x.body.details) {
          console.error('Server error details:', x.body.details);
        }
        if (x && x.body && x.body.code) {
          console.error('Server error code:', x.body.code);
        }
        showToast(errorMsg);
        return null;
      }
      if (!x.body || !x.body.user || !x.body.token) {
        hideAuthLoading();
        showToast('서버 응답이 올바르지 않아요.');
        return null;
      }
      setAuthToken(x.body.token);
      userProfile = x.body.user;
      isLoggedIn = true;
      
      // userProfile이 제대로 설정되었는지 확인
      if (!userProfile || !userProfile.nickname) {
        hideAuthLoading();
        console.error('userProfile is invalid:', userProfile);
        showToast('사용자 정보를 가져오는 중 오류가 났어요.');
        return null;
      }
      
      hideAuthLoading();
      return fetch(API_BASE + '/api/user/data', { headers: { 'Authorization': 'Bearer ' + x.body.token } });
    }).then(function (r) {
      if (!r) {
        // 로그인은 성공했지만 데이터 로드는 스킵
        if (userProfile && userProfile.nickname) {
          saveAll();
          closeAuthModal();
          setTimeout(function() {
            renderHeaderAuth();
            renderAuthGate();
            renderPet();
            renderAttendance();
            var card = document.getElementById('attendanceCard');
            if (card) card.style.display = 'block';
            showWelcomeModal(userProfile.nickname);
          }, 300);
        }
        return null;
      }
      if (!r.ok) {
        // 데이터 로드 실패해도 로그인은 성공
        console.warn('Failed to load user data:', r.status);
        if (userProfile && userProfile.nickname) {
          saveAll();
          closeAuthModal();
          setTimeout(function() {
            renderHeaderAuth();
            renderAuthGate();
            renderPet();
            renderAttendance();
            var card = document.getElementById('attendanceCard');
            if (card) card.style.display = 'block';
            showWelcomeModal(userProfile.nickname);
          }, 300);
        }
        return null;
      }
      return r.json();
    }).then(function (body) {
      if (!body) return;
      if (body && body.data) {
        try {
          var data = typeof body.data === 'string' ? JSON.parse(body.data) : body.data;
          applyGameState(data);
        } catch (e) {
          console.error('Failed to apply game state:', e);
        }
      }
      saveAll();
      closeAuthModal();
      setTimeout(function() {
        renderHeaderAuth();
        renderAuthGate();
        renderPet();
        renderAttendance();
        var card = document.getElementById('attendanceCard');
        if (card) card.style.display = 'block';
        if (userProfile && userProfile.nickname) {
          showWelcomeModal(userProfile.nickname);
        } else {
          showWelcomeModal();
        }
      }, 300);
    }).catch(function(err) {
      hideAuthLoading();
      console.error('User data load error:', err);
      if (userProfile && userProfile.nickname) {
        saveAll();
        closeAuthModal();
        setTimeout(function() {
          renderHeaderAuth();
          renderAuthGate();
          renderPet();
          renderAttendance();
          var card = document.getElementById('attendanceCard');
          if (card) card.style.display = 'block';
          showWelcomeModal(userProfile.nickname);
        }, 300);
      } else {
        showToast('로그인 중 오류가 났어요: ' + (err.message || '알 수 없는 오류'));
      }
    }).catch(function (err) {
      hideAuthLoading();
      console.error('Social login error:', err);
      // 로그인은 성공했지만 데이터 로드 실패
      if (userProfile && userProfile.nickname) {
        saveAll();
        closeAuthModal();
        setTimeout(function() {
          renderHeaderAuth();
          renderAuthGate();
          renderPet();
          renderAttendance();
          var card = document.getElementById('attendanceCard');
          if (card) card.style.display = 'block';
          showWelcomeModal(userProfile.nickname);
        }, 300);
      } else {
        showToast('로그인 중 오류가 났어요: ' + (err.message || '알 수 없는 오류'));
      }
    });
  }
  function switchAuthTab(tab) {
    document.getElementById('authLoginPanel').style.display = tab === 'login' ? 'block' : 'none';
    document.getElementById('authSignupPanel').style.display = tab === 'signup' ? 'block' : 'none';
    document.getElementById('authFindIdPanel').style.display = tab === 'findId' ? 'block' : 'none';
    document.getElementById('authFindPwPanel').style.display = tab === 'findPw' ? 'block' : 'none';
    document.querySelectorAll('.auth-tab').forEach(function(t){ 
      t.classList.remove('active'); 
      if (t.getAttribute('data-auth-tab') === tab) t.classList.add('active'); 
    });
    document.getElementById('authTitle').textContent = 
      tab === 'login' ? '로그인' : 
      tab === 'signup' ? '회원가입' : 
      tab === 'findId' ? '아이디 찾기' : 
      tab === 'findPw' ? '비밀번호 찾기' : '로그인';
  }
  function doLogout() {
    // 카카오 로그인인 경우 카카오 로그아웃도 처리
    if (typeof Kakao !== 'undefined' && Kakao.Auth.getAccessToken()) {
      Kakao.Auth.logout(function() {
        console.log('카카오 로그아웃 완료');
      });
    }
    clearAuthToken();
    userProfile = null;
    isLoggedIn = false;
    saveAll();
    renderHeaderAuth();
    renderAuthGate();
    renderAttendance();
    var card = document.getElementById('attendanceCard');
    if (card) card.style.display = 'none';
    showToast('로그아웃되었어요.');
  }
  function renderAttendance() {
    var card = document.getElementById('attendanceCard');
    var statusEl = document.getElementById('attendanceStatus');
    var btn = document.getElementById('btnAttendance');
    if (!card || !statusEl) return;
    if (!isLoggedIn) {
      card.style.display = 'none';
      return;
    }
    card.style.display = 'block';
    var today = todayStr();
    var already = lastAttendanceDate === today;
    if (already) {
      statusEl.textContent = '오늘 출석 완료! 연속 ' + attendanceStreak + '일';
      if (btn) btn.style.display = 'none';
    } else {
      var nextDay = attendanceStreak + 1;
      if (nextDay <= 7) {
        statusEl.textContent = '오늘 출석하면 ' + (nextDay === 7 ? ATTENDANCE_7DAY_BOX_NAME : nextDay + '일차 보상') + ' 받기';
        if (btn) { btn.style.display = 'block'; btn.textContent = nextDay === 7 ? '출석하고 선물상자 받기' : '출석 체크'; }
      } else {
        statusEl.textContent = '연속 ' + attendanceStreak + '일 달성! 내일 다시 1일차부터 시작해요.';
        if (btn) btn.style.display = 'none';
      }
    }
  }
  function doAttendance() {
    if (!isLoggedIn) { showToast('로그인 후 출석할 수 있어요.'); return; }
    var today = todayStr();
    if (lastAttendanceDate === today) { showToast('오늘은 이미 출석했어요.'); return; }
    var yesterday = (function(){
      var d = new Date(); d.setDate(d.getDate() - 1);
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    })();
    if (lastAttendanceDate !== yesterday && lastAttendanceDate !== '') attendanceStreak = 0;
    attendanceStreak++;
    lastAttendanceDate = today;
    if (attendanceStreak <= 6) {
      var reward = ATTENDANCE_DAILY_GOLD[attendanceStreak - 1] || 10;
      gold += reward;
      saveAll();
      renderGold();
      renderAttendance();
      showToast('출석 ' + attendanceStreak + '일차! +' + reward + ' G');
    } else {
      attendanceStreak = 7;
      saveAll();
      openWeekMasterBox();
    }
  }
  function openWeekMasterBox() {
    if (Math.random() < 0.5) {
      gold += ATTENDANCE_7DAY_GOLD;
      saveAll();
      renderGold();
      renderAttendance();
      showToast(ATTENDANCE_7DAY_BOX_NAME + '에서 ' + ATTENDANCE_7DAY_GOLD + ' G 획득!');
    } else {
      var item = pickItemByTierWeight(true);
      var rarity = rollRarityPremium();
      var newItem = { id: item.id + '_' + Date.now(), name: item.name, type: item.type, emoji: item.emoji, rarity: rarity, enhance: 0, tier: item.tier || 'standard' };
      inventory.push(newItem);
      saveAll();
      renderInventory();
      renderAttendance();
      var tierLabel = TIER_LABELS[newItem.tier] || newItem.tier;
      var rarityLabel = (RARITY_NAMES.indexOf(rarity) >= 0 ? rarity : 'common');
      showToast(getItemIcon(newItem) + ' ' + newItem.name + ' (' + tierLabel + ' · ' + rarityLabel + ') 획득!');
    }
    attendanceStreak = 0;
    saveAll();
    renderAttendance();
    showToast('공유 감사해요! +40 G');
  }

  function renderPet() {
    var petEmoji = document.getElementById('petEmoji');
    var petName = document.getElementById('petName');
    var petLevel = document.getElementById('petLevel');
    var petExpFill = document.getElementById('petExpFill');
    var petExpText = document.getElementById('petExpText');
    
    if (!pet.type) {
      if (petEmoji) petEmoji.textContent = '🐾';
      if (petName) petName.textContent = '동물을 선택해주세요';
      if (petLevel) petLevel.textContent = '';
      if (petExpFill) petExpFill.style.width = '0%';
      if (petExpText) petExpText.textContent = '';
      return;
    }
    
    var petType = PET_TYPES.find(function(p) { return p.id === pet.type; });
    if (!petType) return;
    
    var expForNextLevel = pet.level * 100; // 레벨당 100 경험치 필요
    var expPercent = (pet.exp / expForNextLevel) * 100;
    
    if (petEmoji) petEmoji.textContent = petType.emoji;
    if (petName) petName.textContent = pet.name || petType.name;
    if (petLevel) petLevel.textContent = 'Lv.' + pet.level;
    if (petExpFill) petExpFill.style.width = Math.min(expPercent, 100) + '%';
    if (petExpText) petExpText.textContent = '경험치: ' + pet.exp + ' / ' + expForNextLevel;
  }
  
  function addPetExp(amount) {
    if (!pet.type) return;
    pet.exp += amount;
    var expForNextLevel = pet.level * 100;
    while (pet.exp >= expForNextLevel) {
      pet.exp -= expForNextLevel;
      pet.level++;
      showToast('🎉 ' + (PET_TYPES.find(function(p) { return p.id === pet.type; }) || {}).name + '이(가) 레벨업했어요! Lv.' + pet.level);
      expForNextLevel = pet.level * 100;
    }
    saveAll();
    renderPet();
  }
  
  function renderAvatar() {
    var nameEl = document.getElementById('avatarName');
    var inputEl = document.getElementById('inputAvatarName');
    if (nameEl) nameEl.textContent = avatar.name || '산책러';
    if (inputEl) inputEl.value = avatar.name || '';
    var skin = avatar.skin || '#f5d0b0';
    var human = document.getElementById('avatarHuman');
    if (human) {
      human.style.setProperty('--skin', skin);
      var topItem = equipped.top ? inventory.find(function(i){ return i.id === equipped.top; }) : null;
      var bottomItem = equipped.bottom ? inventory.find(function(i){ return i.id === equipped.bottom; }) : null;
      human.style.setProperty('--top-color', topItem ? '#4a6fa5' : '#6b7280');
      human.style.setProperty('--bottom-color', bottomItem ? '#374151' : '#4b5563');
    }
    var headEl = document.getElementById('previewHead');
    var bodyEl = document.getElementById('previewBody');
    var armL = document.getElementById('previewArmL');
    var armR = document.getElementById('previewArmR');
    var legL = document.getElementById('previewLegL');
    var legR = document.getElementById('previewLegR');
    if (headEl) headEl.style.background = skin;
    if (bodyEl) bodyEl.style.background = (equipped.top ? inventory.find(function(i){ return i.id === equipped.top; }) : null) ? '#4a6fa5' : '#6b7280';
    if (armL) armL.style.background = skin;
    if (armR) armR.style.background = skin;
    if (legL) legL.style.background = (equipped.bottom ? inventory.find(function(i){ return i.id === equipped.bottom; }) : null) ? '#374151' : '#4b5563';
    if (legR) legR.style.background = (equipped.bottom ? inventory.find(function(i){ return i.id === equipped.bottom; }) : null) ? '#374151' : '#4b5563';
    var hatEl = document.getElementById('previewHat');
    var weaponEl = document.getElementById('previewWeapon');
    if (hatEl) { hatEl.textContent = ''; hatEl.style.display = 'none'; }
    var accSlot = equipped.watch || equipped.earphones || equipped.bag || equipped.glove;
    var accItem = accSlot ? inventory.find(function(i){ return i.id === accSlot; }) : null;
    if (weaponEl) { weaponEl.textContent = accItem ? getItemIcon(accItem) : ''; weaponEl.style.display = accItem ? 'block' : 'none'; }
    var selectHair = document.getElementById('selectHair');
    if (selectHair) selectHair.value = avatar.hair || 'short';
  }

  var routesMapPathEl = null;
  function initRoutesMap() {
    var el = document.getElementById('routesMap');
    if (!el) return;
    if (routesMapPathEl) return;
    el.innerHTML = '';
    var w = 400, h = 180;
    var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('viewBox', '0 0 ' + w + ' ' + h);
    svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
    var grid = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    grid.setAttribute('class', 'our-map-grid');
    for (var i = 0; i <= 8; i++) {
      var v = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      v.setAttribute('x1', (i * w / 8));
      v.setAttribute('y1', 0);
      v.setAttribute('x2', (i * w / 8));
      v.setAttribute('y2', h);
      grid.appendChild(v);
      var hor = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      hor.setAttribute('x1', 0);
      hor.setAttribute('y1', (i * h / 8));
      hor.setAttribute('x2', w);
      hor.setAttribute('y2', (i * h / 8));
      grid.appendChild(hor);
    }
    svg.appendChild(grid);
    var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('class', 'our-map-path');
    path.setAttribute('d', '');
    svg.appendChild(path);
    el.appendChild(svg);
    var label = document.createElement('span');
    label.className = 'our-map-label';
    label.textContent = '완주한 경로';
    el.appendChild(label);
    routesMapPathEl = path;
  }
  function updateRoutesMap(routeId) {
    if (!routesMapPathEl) return;
    var r = routeId ? userRoutes.find(function(x){ return x.id === routeId; }) : null;
    var coords = (r && r.path && r.path.length) ? r.path : [];
    var w = 400, h = 180;
    if (coords.length === 0) {
      routesMapPathEl.setAttribute('d', '');
      return;
    }
    var bounds = ourMapBounds(coords);
    var pts = coords.map(function(c) { return ourMapLatLonToXY(c.lat, c.lon, bounds, w, h); });
    var d = 'M ' + pts[0].x + ' ' + pts[0].y;
    for (var i = 1; i < pts.length; i++) d += ' L ' + pts[i].x + ' ' + pts[i].y;
    routesMapPathEl.setAttribute('d', d);
  }
  function renderRoutes() {
    initRoutesMap();
    var list = document.getElementById('routeList');
    if (!list) return;
    list.innerHTML = '';
    if (userRoutes.length === 0) {
      list.innerHTML = '<p class="story-text" style="color:var(--text-muted);font-size:0.9rem;">아직 만든 코스가 없어요.<br>산책 탭에서 새 코스를 만들어 보세요!</p>';
      return;
    }
    userRoutes.forEach(function (r) {
      var card = document.createElement('div');
      card.className = 'route-card' + (r.completedAt ? '' : '');
      card.setAttribute('data-route-id', r.id);
      var status = r.completedAt ? 'done' : 'claim';
      var statusText = r.completedAt ? '완주' : r.goalKm + ' km';
      var bestText = '';
      if (r.bestTimeMs) {
        bestText = ' · 베스트 ' + formatDuration(r.bestTimeMs);
      }
      card.innerHTML =
        '<div class="route-icon">' + (r.completedAt ? '✅' : '🗺️') + '</div>' +
        '<div class="route-info">' +
          '<div class="route-name">' + r.name + '</div>' +
          '<div class="route-steps">목표 ' + r.goalKm + ' km' + (r.path && r.path.length ? ' · 경로 기록됨' : '') + bestText + '</div>' +
        '</div>' +
        '<span class="route-status ' + status + '">' + statusText + '</span>';
      card.onclick = function () { updateRoutesMap(r.id); };
      list.appendChild(card);
    });
  }

  function renderEquipped() {
    var wrap = document.getElementById('equippedSlots');
    if (!wrap) return;
    wrap.innerHTML = '';
    SLOT_ORDER.forEach(function (slot) {
      var itemId = equipped[slot];
      var item = itemId ? inventory.find(function (i) { return i.id === itemId; }) : null;
      var slotEl = document.createElement('div');
      slotEl.className = 'equipped-slot' + (item ? ' filled tier-' + (item.tier || 'standard') : '');
      slotEl.setAttribute('data-slot', slot);
      var tierLabel = item ? (TIER_LABELS[item.tier] || '스탠다드') : '';
      var icon = item ? getItemIcon(item) : '＋';
      var nameLine = item ? '<span class="slot-item-name" title="' + (item.name || '') + '">' + (item.name || '') + '</span>' : '';
      slotEl.innerHTML = '<span class="slot-label">' + SLOT_LABELS[slot] + '</span>' + icon + nameLine + (item ? '<span class="inv-tier">' + tierLabel + (item.enhance > 0 ? ' +' + item.enhance : '') + '</span>' : '');
      slotEl.onclick = function () { openEquipModal(slot); };
      wrap.appendChild(slotEl);
    });
    var sumEl = document.getElementById('equipBonusSummary');
    if (sumEl) {
      var b = getEquipmentBonus();
      var parts = [];
      if (b.xp > 0) parts.push('XP +' + b.xp + '%');
      if (b.distance > 0) parts.push('이동 거리 +' + b.distance + '%');
      if (b.gold > 0) parts.push('골드 +' + b.gold + '%');
      sumEl.innerHTML = parts.length ? '<strong>장비 보너스</strong>: ' + parts.join(', ') : '<strong>장비 보너스</strong>: 착용 장비에 따라 XP·거리·골드 보너스 적용 (걸음 수는 정확한 기록 유지를 위해 보너스 없음)';
    }
  }

  function openEquipModal(slot) {
    var list = inventory.filter(function (i) { return itemSlot(i) === slot; });
    if (list.length === 0) { showToast('해당 슬롯에 착용할 장비가 없어요'); return; }
    var current = equipped[slot];
    var idx = list.findIndex(function (i) { return i.id === current; });
    idx = (idx + 1) % list.length;
    equipped[slot] = list[idx].id;
    saveAll();
    renderEquipped();
    renderInventory();
    renderAvatar();
    showToast(list[idx].name + ' 착용');
  }

  function renderInventory() {
    var wrap = document.getElementById('inventoryBySlot');
    if (!wrap) return;
    wrap.innerHTML = '';
    var kits = inventory.filter(function(i){ return i.type === 'supply_kit'; });
    if (kits.length > 0) {
      var kitSec = document.createElement('div');
      kitSec.className = 'inventory-slot-section';
      kitSec.innerHTML = '<h4>📦 보급 키트</h4>';
      var kitList = document.createElement('div');
      kitList.className = 'inventory-slot-list';
      kits.forEach(function() {
        var div = document.createElement('div');
        div.className = 'inv-item inv-item-kit';
        div.innerHTML = '<span>📦</span><span class="inv-name">트레이닝 보급 키트</span><span class="inv-open">열기</span>';
        div.onclick = function () { openSupplyKit(); };
        kitList.appendChild(div);
      });
      kitSec.appendChild(kitList);
      wrap.appendChild(kitSec);
    }
    SLOT_ORDER.forEach(function (slot) {
      var list = inventory.filter(function (i) { return i.type !== 'supply_kit' && itemSlot(i) === slot; });
      if (list.length === 0) return;
      var sec = document.createElement('div');
      sec.className = 'inventory-slot-section';
      sec.innerHTML = '<h4>' + SLOT_LABELS[slot] + '</h4>';
      var listEl = document.createElement('div');
      listEl.className = 'inventory-slot-list';
      list.forEach(function (item) {
        var isEquipped = equipped[slot] === item.id;
        var rarity = item.rarity || 'common';
        var tier = item.tier || 'standard';
        var tierLabel = TIER_LABELS[tier] || '스탠다드';
        var div = document.createElement('div');
        div.className = 'inv-item rarity-' + rarity + ' tier-' + tier + (isEquipped ? ' equipped' : '');
        var enh = (item.enhance != null && item.enhance > 0) ? item.enhance : 0;
        var enhHtml = enh > 0 ? '<span class="inv-enhance">+' + enh + '</span>' : '';
        div.innerHTML = '<span class="rarity-dot"></span><span>' + getItemIcon(item) + '</span><span class="inv-name">' + (item.name || item.id) + '</span>' + enhHtml + '<span class="inv-tier">' + tierLabel + '</span>';
        div.onclick = function () {
          equipped[slot] = equipped[slot] === item.id ? null : item.id;
          saveAll();
          renderEquipped();
          renderInventory();
          renderAvatar();
        };
        listEl.appendChild(div);
      });
      sec.appendChild(listEl);
      wrap.appendChild(sec);
    });
  }

  function getStoryContent() {
    var completedCourses = userRoutes.filter(function(r){ return r.completedAt; });
    var lines = [];
    if (lifetimeSteps < 500 && totalXp < 10) {
      lines.push('아직 산책이 시작되지 않았어요.');
      lines.push('산책 탭에서 코스를 만들고 걸어 보세요.');
    } else {
      lines.push('당신은 걸음을 걸으며 세상을 탐험하고 있습니다.');
      if (completedCourses.length > 0) {
        var lastCourse = completedCourses[completedCourses.length - 1];
        lines.push('최근에 ' + lastCourse.name + ' 코스를 완주했어요.');
      }
      if (totalXp > 0) lines.push('트레이닝 보급 키트로 장비를 모으며 성장하고 있어요. (총 XP ' + totalXp + ')');
      if (lifetimeSteps >= 10000) lines.push('등산로 정상까지 오른 당신은 이제 진정한 산책의 달인입니다.');
      else if (lifetimeSteps >= 5000) lines.push('숲과 호수를 지나 더 높은 곳을 바라보고 있어요.');
      else if (lifetimeSteps >= 2000) lines.push('시내를 벗어나 강과 공원을 탐험하고 있어요.');
    }
    var coursesDone = userRoutes.filter(function(r){ return r.completedAt; }).length;
    return { text: lines.join('\n\n'), milestone: '누적 ' + lifetimeSteps.toLocaleString() + '걸음 · Lv.' + xpToLevel(totalXp).level + ' · 완주 코스 ' + coursesDone + '개' };
  }

  function renderStory() {
    var s = getStoryContent();
    var st = document.getElementById('storyText');
    var sm = document.getElementById('storyMilestone');
    if (st) st.textContent = s.text;
    if (sm) sm.textContent = s.milestone;
    renderAnimalCollection();
  }
  
  function renderAnimalCollection() {
    var grid = document.getElementById('animalCollectionGrid');
    if (!grid) return;
    grid.innerHTML = '';
    
    if (capturedAnimals.length === 0) {
      grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--text-muted);">아직 포획한 동물이 없어요.<br>산책을 시작하면 주변에 동물이 나타날 거예요!</div>';
      return;
    }
    
    // 희귀도별로 정렬
    var rarityOrder = { legend: 0, epic: 1, rare: 2, common: 3 };
    var sorted = capturedAnimals.slice().sort(function(a, b) {
      return rarityOrder[a.rarity] - rarityOrder[b.rarity];
    });
    
    sorted.forEach(function(animal) {
      var rarityColor = { 
        common: 'var(--rarity-common)', 
        rare: 'var(--rarity-rare)', 
        epic: 'var(--rarity-epic)', 
        legend: 'var(--rarity-legend)' 
      }[animal.rarity];
      var rarityLabel = { common: '커먼', rare: '레어', epic: '에픽', legend: '레전드' }[animal.rarity];
      
      var card = document.createElement('div');
      card.style.cssText = 'background: var(--card); border: 2px solid ' + rarityColor + '; border-radius: var(--radius-lg); padding: 1rem; text-align: center; transition: transform 0.2s ease;';
      card.onmouseover = function() { this.style.transform = 'scale(1.05)'; };
      card.onmouseout = function() { this.style.transform = 'scale(1)'; };
      card.innerHTML = '<div style="font-size: 3rem; margin-bottom: 0.5rem;">' + animal.emoji + '</div><div style="font-weight: 600; margin-bottom: 0.25rem;">' + animal.name + '</div><div style="font-size: 0.75rem; color: ' + rarityColor + ';">' + rarityLabel + '</div>';
      grid.appendChild(card);
    });
  }

  function openCodexModal(initialTab) {
    var overlay = document.getElementById('codexOverlay');
    if (!overlay) return;
    overlay.classList.add('show');
    document.body.style.overflow = 'hidden';
    switchCodexTab(initialTab || 'equip');
    renderEquipmentCodex();
    renderCodexAnimals();
  }

  function closeCodexModal() {
    var overlay = document.getElementById('codexOverlay');
    if (!overlay) return;
    overlay.classList.remove('show');
    document.body.style.overflow = '';
  }

  function switchCodexTab(tab) {
    var equipBtn = document.getElementById('codexTabEquip');
    var animalBtn = document.getElementById('codexTabAnimal');
    var equipPanel = document.getElementById('codexEquipPanel');
    var animalPanel = document.getElementById('codexAnimalPanel');
    if (!equipBtn || !animalBtn || !equipPanel || !animalPanel) return;
    var isEquip = tab === 'animal' ? false : true;
    equipBtn.classList.toggle('active', isEquip);
    animalBtn.classList.toggle('active', !isEquip);
    equipPanel.style.display = isEquip ? 'block' : 'none';
    animalPanel.style.display = isEquip ? 'none' : 'block';
  }

  function getOwnedBaseItemIds() {
    var owned = {};
    function addFromItem(item) {
      if (!item || !item.id) return;
      var baseId = item.baseId || String(item.id).split('_')[0];
      owned[baseId] = true;
    }
    inventory.forEach(addFromItem);
    storage.forEach(addFromItem);
    Object.keys(equipped).forEach(function(slot) {
      var id = equipped[slot];
      if (!id) return;
      var item = inventory.find(function(i){ return i.id === id; });
      if (item) addFromItem(item);
    });
    return owned;
  }

  function renderEquipmentCodex() {
    var grid = document.getElementById('codexEquipGrid');
    if (!grid) return;
    grid.innerHTML = '';
    var owned = getOwnedBaseItemIds();
    // 장비를 type별로 그룹화
    var sorted = SUPPLY_POOL.slice().sort(function(a, b) {
      var at = a.type.localeCompare(b.type);
      if (at !== 0) return at;
      var atier = TIER_LABELS[a.tier] || a.tier;
      var btier = TIER_LABELS[b.tier] || b.tier;
      if (atier === btier) return a.name.localeCompare(b.name);
      return atier.localeCompare(btier);
    });
    sorted.forEach(function(baseItem) {
      var baseId = baseItem.id;
      var isOwned = !!owned[baseId];
      var rarity = baseItem.rarity || 'common';
      var rarityLabel = {
        common: '커먼',
        rare: '레어',
        epic: '에픽',
        legend: '레전드',
        specialist: '스페셜리스트'
      }[rarity] || rarity;
      var rarityColor = {
        common: 'var(--rarity-common)',
        rare: 'var(--rarity-rare)',
        epic: 'var(--rarity-epic)',
        legend: 'var(--rarity-legend)',
        specialist: 'var(--gold)'
      }[rarity] || 'var(--text-muted)';
      var tierLabel = TIER_LABELS[baseItem.tier] || '스탠다드';
      var card = document.createElement('div');
      card.className = 'codex-card' + (isOwned ? ' owned' : '');
      var emoji = isOwned ? baseItem.emoji : '❓';
      var name = isOwned ? baseItem.name : '???';
      card.innerHTML =
        '<div class="codex-emoji">' + emoji + '</div>' +
        '<div class="codex-name">' + name + '</div>' +
        '<div class="codex-meta" style="color:' + rarityColor + ';">' + rarityLabel + ' · ' + tierLabel + '</div>';
      grid.appendChild(card);
    });
  }

  function renderCodexAnimals() {
    var grid = document.getElementById('codexAnimalGrid');
    if (!grid) return;
    grid.innerHTML = '';
    var capturedMap = {};
    capturedAnimals.forEach(function(c) {
      capturedMap[c.animalId] = true;
    });
    // 희귀도 순서대로 정렬
    var rarityOrder = { specialist: 0, legend: 1, epic: 2, rare: 3, common: 4 };
    var sorted = WILD_ANIMALS.slice().sort(function(a, b) {
      var ra = rarityOrder[a.rarity] != null ? rarityOrder[a.rarity] : 5;
      var rb = rarityOrder[b.rarity] != null ? rarityOrder[b.rarity] : 5;
      if (ra !== rb) return ra - rb;
      return a.name.localeCompare(b.name);
    });
    sorted.forEach(function(animal) {
      var captured = !!capturedMap[animal.id];
      var rarity = animal.rarity || 'common';
      var rarityLabel = {
        common: '커먼',
        rare: '레어',
        epic: '에픽',
        legend: '레전드',
        specialist: '스페셜리스트'
      }[rarity] || rarity;
      var rarityColor = {
        common: 'var(--rarity-common)',
        rare: 'var(--rarity-rare)',
        epic: 'var(--rarity-epic)',
        legend: 'var(--rarity-legend)',
        specialist: 'var(--gold)'
      }[rarity] || 'var(--text-muted)';
      var card = document.createElement('div');
      card.className = 'codex-card' + (captured ? ' owned' : '');
      var emoji = captured ? animal.emoji : '❓';
      var name = captured ? animal.name : '???';
      var desc = captured ? animal.description : '아직 만나지 못한 동물이에요.';
      card.innerHTML =
        '<div class="codex-emoji">' + emoji + '</div>' +
        '<div class="codex-name">' + name + '</div>' +
        '<div class="codex-meta" style="color:' + rarityColor + ';">' + rarityLabel + '</div>' +
        '<div class="codex-meta" style="margin-top:0.15rem;">' + desc + '</div>';
      grid.appendChild(card);
    });
  }
  
  function openPetSelectModal() {
    var overlay = document.getElementById('petSelectOverlay');
    var grid = document.getElementById('petGrid');
    if (!overlay || !grid) return;
    
    grid.innerHTML = '';
    var selectedPetId = pet.type;
    
    PET_TYPES.forEach(function(petType) {
      var item = document.createElement('div');
      item.className = 'pet-item' + (selectedPetId === petType.id ? ' selected' : '');
      item.setAttribute('data-pet-id', petType.id);
      item.innerHTML = '<div class="pet-item-emoji">' + petType.emoji + '</div><div class="pet-item-name">' + petType.name + '</div><div class="pet-item-desc">' + petType.description + '</div>';
      item.onclick = function() {
        document.querySelectorAll('.pet-item').forEach(function(el) { el.classList.remove('selected'); });
        item.classList.add('selected');
        selectedPetId = petType.id;
      };
      grid.appendChild(item);
    });
    
    overlay.style.display = 'flex';
  }
  
  function closePetSelectModal() {
    var overlay = document.getElementById('petSelectOverlay');
    if (overlay) overlay.style.display = 'none';
  }
  
  function confirmPetSelection() {
    var selectedItem = document.querySelector('.pet-item.selected');
    if (!selectedItem) {
      showToast('동물을 선택해주세요.');
      return;
    }
    
    var petTypeId = selectedItem.getAttribute('data-pet-id');
    if (!petTypeId) return;
    
    var petType = PET_TYPES.find(function(p) { return p.id === petTypeId; });
    if (!petType) return;
    
    pet.type = petTypeId;
    pet.name = petType.name;
    if (!pet.level) pet.level = 1;
    if (pet.exp == null) pet.exp = 0;
    
    saveAll();
    renderPet();
    closePetSelectModal();
    showToast(petType.name + '을(를) 선택했어요! 함께 걸어 성장해봐요! 🐾');
  }

  function attachListeners() {
    document.querySelectorAll('.tab-btn').forEach(function (btn) {
      btn.addEventListener('click', function () { switchTab(btn.getAttribute('data-tab')); });
    });
    var btnAdd = document.getElementById('btnAdd');
    var btnReset = document.getElementById('btnReset');
    if (btnAdd) btnAdd.addEventListener('click', addStep);
    if (btnReset) btnReset.addEventListener('click', function () {
      if (confirm('오늘의 걸음 수만 0으로 초기화할까요? (누적 걸음과 장비는 유지됩니다)')) {
        steps = 0;
        saveAll();
        renderSteps();
      }
    });
    var inputName = document.getElementById('inputAvatarName');
    if (inputName) {
      inputName.addEventListener('input', function () {
        avatar.name = this.value.trim() || '산책러';
        var an = document.getElementById('avatarName');
        if (an) an.textContent = avatar.name;
        saveAll();
      });
      inputName.addEventListener('blur', saveAll);
    }
    document.querySelectorAll('.color-swatch[data-skin]').forEach(function (sw) {
      sw.addEventListener('click', function () {
        document.querySelectorAll('.color-swatch[data-skin]').forEach(function (s) { s.classList.remove('active'); });
        sw.classList.add('active');
        avatar.skin = sw.getAttribute('data-skin');
        var b = document.getElementById('previewBody'), h = document.getElementById('previewHead');
        if (b) b.style.background = avatar.skin;
        if (h) h.style.background = avatar.skin;
        saveAll();
      });
    });
    document.querySelectorAll('.color-swatch.hair-color').forEach(function (sw) {
      sw.addEventListener('click', function () {
        document.querySelectorAll('.color-swatch.hair-color').forEach(function (s) { s.classList.remove('active'); });
        sw.classList.add('active');
        avatar.hairColor = sw.getAttribute('data-hair');
        var hair = document.getElementById('previewHair');
        if (hair) hair.style.background = avatar.hairColor;
        saveAll();
      });
    });
    var selectHair = document.getElementById('selectHair');
    if (selectHair) selectHair.addEventListener('change', function () {
      avatar.hair = this.value;
      renderAvatar();
      saveAll();
    });
    var btnWalkStart = document.getElementById('btnWalkStart');
    var btnWalkStop = document.getElementById('btnWalkStop');
    if (btnWalkStart) btnWalkStart.addEventListener('click', startWalk);
    if (btnWalkStop) btnWalkStop.addEventListener('click', stopWalk);
    var courseInput = document.getElementById('courseGoalKm');
    var routeCreateCard = document.getElementById('routeCreateCard');
    var btnAddRoute = document.getElementById('btnAddRoute');
    var btnSaveRoute = document.getElementById('btnSaveRoute');
    if (btnAddRoute) btnAddRoute.addEventListener('click', function () { routeCreateCard.style.display = routeCreateCard.style.display === 'none' ? 'block' : 'none'; });
    if (btnSaveRoute) btnSaveRoute.addEventListener('click', addNewRoute);
    var themeToggle = document.getElementById('themeToggle');
    if (themeToggle) themeToggle.addEventListener('click', function () {
      var next = document.body.getAttribute('data-theme') === 'night' ? 'morning' : 'night';
      document.body.setAttribute('data-theme', next);
      localStorage.setItem(STORAGE_KEYS.theme, next);
      themeToggle.textContent = next === 'night' ? '🌙' : '☀️';
    });
    if (document.body.getAttribute('data-theme') === 'morning') themeToggle.textContent = '☀️';
    var btnGacha = document.getElementById('btnGacha');
    if (btnGacha) btnGacha.addEventListener('click', function() { doGachaPull(false); });
    var btnGachaPremium = document.getElementById('btnGachaPremium');
    if (btnGachaPremium) btnGachaPremium.addEventListener('click', function() { doGachaPull(true); });
    var btnShare = document.getElementById('btnShare');
    if (btnShare) btnShare.addEventListener('click', doShare);
    var btnEnhance = document.getElementById('btnEnhance');
    if (btnEnhance) btnEnhance.addEventListener('click', tryEnhance);
    var btnHeaderAuth = document.getElementById('btnHeaderAuth');
    if (btnHeaderAuth) btnHeaderAuth.addEventListener('click', function() {
      if (isLoggedIn) {
        // 로그인 상태일 때는 프로필 표시 (또는 아무 동작 안 함)
        // 로그아웃은 별도 버튼으로 처리
      } else {
        openAuthModal();
      }
    });
    var btnLogout = document.getElementById('btnLogout');
    if (btnLogout) btnLogout.addEventListener('click', function() {
      if (confirm('로그아웃할까요?')) {
        doLogout();
      }
    });
    document.querySelectorAll('.auth-tab').forEach(function(t) {
      t.addEventListener('click', function() {
        var tab = this.getAttribute('data-auth-tab');
        switchAuthTab(tab);
      });
    });
    var authClose = document.getElementById('authClose');
    if (authClose) authClose.addEventListener('click', closeAuthModal);
    var authOverlay = document.getElementById('authOverlay');
    if (authOverlay) authOverlay.addEventListener('click', function(e) { if (e.target === authOverlay && !authOverlay.classList.contains('auth-gate')) closeAuthModal(); });
    var btnAuthLogin = document.getElementById('btnAuthLogin');
    if (btnAuthLogin) btnAuthLogin.addEventListener('click', doLogin);
    var btnAuthSignup = document.getElementById('btnAuthSignup');
    if (btnAuthSignup) btnAuthSignup.addEventListener('click', doSignup);
    var btnFindId = document.getElementById('btnFindId');
    if (btnFindId) btnFindId.addEventListener('click', function() { switchAuthTab('findId'); });
    var btnFindPw = document.getElementById('btnFindPw');
    if (btnFindPw) btnFindPw.addEventListener('click', function() { switchAuthTab('findPw'); });
    var btnFindIdSubmit = document.getElementById('btnFindIdSubmit');
    if (btnFindIdSubmit) btnFindIdSubmit.addEventListener('click', doFindId);
    var btnFindPwSubmit = document.getElementById('btnFindPwSubmit');
    if (btnFindPwSubmit) btnFindPwSubmit.addEventListener('click', doFindPw);
    var btnResetPwSubmit = document.getElementById('btnResetPwSubmit');
    if (btnResetPwSubmit) btnResetPwSubmit.addEventListener('click', doResetPw);
    var btnBackToLogin = document.getElementById('btnBackToLogin');
    if (btnBackToLogin) btnBackToLogin.addEventListener('click', function() { switchAuthTab('login'); });
    var btnBackToLogin2 = document.getElementById('btnBackToLogin2');
    if (btnBackToLogin2) btnBackToLogin2.addEventListener('click', function() { switchAuthTab('login'); });
    var btnKakaoLogin = document.getElementById('btnKakaoLogin');
    if (btnKakaoLogin) btnKakaoLogin.addEventListener('click', function() { doSocialLogin('kakao'); });
    var btnKakaoSignup = document.getElementById('btnKakaoSignup');
    if (btnKakaoSignup) btnKakaoSignup.addEventListener('click', function() { doSocialLogin('kakao'); });
    var btnGoogleLogin = document.getElementById('btnGoogleLogin');
    if (btnGoogleLogin) btnGoogleLogin.addEventListener('click', function() { doSocialLogin('google'); });
    var btnGoogleSignup = document.getElementById('btnGoogleSignup');
    if (btnGoogleSignup) btnGoogleSignup.addEventListener('click', function() { doSocialLogin('google'); });
    var btnWelcomeClose = document.getElementById('btnWelcomeClose');
    if (btnWelcomeClose) btnWelcomeClose.addEventListener('click', hideWelcomeModal);
    var welcomeModal = document.getElementById('welcomeModal');
    if (welcomeModal) welcomeModal.addEventListener('click', function(e) {
      if (e.target === welcomeModal) hideWelcomeModal();
    });
    var btnTutorialNext = document.getElementById('btnTutorialNext');
    if (btnTutorialNext) btnTutorialNext.addEventListener('click', nextTutorialStep);
    var btnTutorialPrev = document.getElementById('btnTutorialPrev');
    if (btnTutorialPrev) btnTutorialPrev.addEventListener('click', prevTutorialStep);
    var tutorialClose = document.getElementById('tutorialClose');
    if (tutorialClose) tutorialClose.addEventListener('click', hideTutorial);
    var tutorialModal = document.getElementById('tutorialModal');
    if (tutorialModal) tutorialModal.addEventListener('click', function(e) {
      if (e.target === tutorialModal) hideTutorial();
    });
    var btnSelectPet = document.getElementById('btnSelectPet');
    if (btnSelectPet) btnSelectPet.addEventListener('click', openPetSelectModal);
    var btnConfirmPet = document.getElementById('btnConfirmPet');
    if (btnConfirmPet) btnConfirmPet.addEventListener('click', confirmPetSelection);
    var petSelectClose = document.getElementById('petSelectClose');
    if (petSelectClose) petSelectClose.addEventListener('click', closePetSelectModal);
    var petSelectOverlay = document.getElementById('petSelectOverlay');
    if (petSelectOverlay) petSelectOverlay.addEventListener('click', function(e) {
      if (e.target === petSelectOverlay) closePetSelectModal();
    });
    var btnAttendance = document.getElementById('btnAttendance');
    if (btnAttendance) btnAttendance.addEventListener('click', doAttendance);
  }

  var lastAcc = 0, lastPeakTime = 0;
  function onMotion(e) {
    var acc = e.accelerationIncludingGravity;
    if (acc.x == null || acc.y == null || acc.z == null) return;
    var magnitude = Math.sqrt(acc.x * acc.x + acc.y * acc.y + acc.z * acc.z);
    var now = Date.now();
    if (magnitude > 12 && (now - lastPeakTime) > 400 && lastAcc > 0 && lastAcc < magnitude) {
      lastPeakTime = now;
      addStep();
    }
    lastAcc = magnitude;
  }
  function initSensorAndStatus() {
    var statusEl = document.getElementById('status');
    if (!statusEl) return;
    if (typeof DeviceMotionEvent !== 'undefined') {
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        statusEl.textContent = 'iOS: 화면을 한 번 탭하면 센서를 켤 수 있어요. 버튼으로도 걸음을 추가할 수 있어요.';
        document.body.addEventListener('click', function req() {
          DeviceMotionEvent.requestPermission()
            .then(function (p) {
              if (p === 'granted') {
                window.addEventListener('devicemotion', onMotion);
                statusEl.textContent = '걸음 감지 켜짐';
                statusEl.classList.add('sensor-ok');
              }
            }, function () { statusEl.textContent = '센서 사용 불가. 버튼으로 걸음을 추가해 주세요.'; });
        }, { once: true });
      } else {
        window.addEventListener('devicemotion', onMotion);
        statusEl.textContent = '걸음 감지 켜짐 (버튼으로도 추가 가능)';
        statusEl.classList.add('sensor-ok');
      }
    } else {
      statusEl.textContent = '버튼을 눌러 걸음을 추가해 주세요.';
    }
  }

  function init() {
    attachListeners();
    attachCodexListeners();
    loadAll();
    initAuth().then(function () {
      checkRouteRewards();
      renderSteps();
      renderWalk();
      renderAvatar();
      renderPet();
      renderRoutes();
      renderStorage();
      renderQuests();
      renderHeaderAuth();
      renderAttendance();
      renderEquipped();
      renderInventory();
      renderStory();
      renderLevel();
      renderRouteSelect();
      renderAchievements();
      renderGold();
      renderEnhanceSelect();
      renderEquipmentCodex();
      renderCodexAnimals();
      var themeToggle = document.getElementById('themeToggle');
      if (themeToggle && document.body.getAttribute('data-theme') === 'morning') themeToggle.textContent = '☀️';
      initSensorAndStatus();
      // 만료된 야생 동물 제거
      checkExpiredWildAnimals();
      // 30초마다 만료 체크
      setInterval(checkExpiredWildAnimals, 30000);
    });
  }

  function attachCodexListeners() {
    var btnCodex = document.getElementById('btnCodex');
    var codexOverlay = document.getElementById('codexOverlay');
    var codexClose = document.getElementById('codexClose');
    var codexTabEquip = document.getElementById('codexTabEquip');
    var codexTabAnimal = document.getElementById('codexTabAnimal');
    if (btnCodex) btnCodex.addEventListener('click', function() { openCodexModal('equip'); });
    if (codexClose) codexClose.addEventListener('click', closeCodexModal);
    if (codexOverlay) codexOverlay.addEventListener('click', function(e) {
      if (e.target === codexOverlay) closeCodexModal();
    });
    if (codexTabEquip) codexTabEquip.addEventListener('click', function() { switchCodexTab('equip'); renderEquipmentCodex(); });
    if (codexTabAnimal) codexTabAnimal.addEventListener('click', function() { switchCodexTab('animal'); renderCodexAnimals(); });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();

  if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(function () {});
  </script>
</body>
</html>
